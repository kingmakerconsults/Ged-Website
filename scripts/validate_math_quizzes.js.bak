import { expandedQuizData } from '../frontend/data/quiz_data.js';

function validateQuiz(quiz, topicId) {
  if (!quiz.quizId || typeof quiz.quizId !== 'string') {
    throw new Error(`Invalid or missing quizId in topic ${topicId}`);
  }
  if (!Array.isArray(quiz.questions)) {
    throw new Error(`No questions array for quiz: ${quiz.quizId}`);
  }
  if (quiz.questions.length < 12) {
    console.warn(`WARNING: Quiz ${quiz.quizId} has fewer than 12 questions (${quiz.questions.length}).`);
  }

  quiz.questions.forEach((q, idx) => {
    if (q.questionNumber !== idx + 1) {
      console.warn(`WARNING: Question number mismatch in ${quiz.quizId}. Expected ${idx + 1}, found ${q.questionNumber}. Auto-fixing.`);
      q.questionNumber = idx + 1;
    }
    if (!q.question || typeof q.question !== 'string' || q.question.trim() === '') {
      throw new Error(`Bad or missing question text at index ${idx} in quiz ${quiz.quizId}`);
    }
    if (!Array.isArray(q.answerOptions) || q.answerOptions.length < 2) {
      throw new Error(`Bad answer options for question ${q.questionNumber} in quiz ${quiz.quizId}`);
    }

    const correctCount = q.answerOptions.filter(a => a.isCorrect).length;
    if (correctCount !== 1) {
      console.warn(`WARNING: Question ${q.questionNumber} in ${quiz.quizId} has ${correctCount} correct answers. Auto-fixing to one correct answer.`);
      q.answerOptions.forEach((a, i) => a.isCorrect = i === 0);
    }
    q.answerOptions.forEach(a => {
        if (!a.rationale || a.rationale.trim() === '') {
            a.rationale = 'Noted: choose the reason why this is correct/incorrect.';
            console.warn(`WARNING: Missing rationale for an answer in question ${q.questionNumber} of quiz ${quiz.quizId}. Added placeholder.`);
        }
    });

    // LaTeX validation
    const latexRegex = /\\\\[a-zA-Z]+|\$/g;
    const questionMatches = q.question.match(latexRegex) || [];
    if (q.question.includes('\\frac') && !q.question.includes('\\\\frac')) {
        console.warn(`WARNING: Found single backslash LaTeX in question ${q.questionNumber} of ${quiz.quizId}. Consider fixing to double backslash.`);
    }
  });

  return true;
}

function validateMathQuizzes() {
    const mathData = expandedQuizData.Math;
    if (!mathData || !mathData.categories) {
        throw new Error('Math data or categories are missing.');
    }

    let totalQuizzes = 0;
    let warnings = 0;

    for (const categoryName in mathData.categories) {
        const category = mathData.categories[categoryName];
        if (category.topics) {
            for (const topic of category.topics) {
                if (topic.quizzes) {
                    topic.quizzes.forEach(quiz => {
                        try {
                            validateQuiz(quiz, topic.id);
                            totalQuizzes++;
                        } catch (e) {
                            console.error(`Validation failed for quiz ${quiz.quizId}: ${e.message}`);
                            process.exit(1);
                        }
                    });
                }
            }
        }
    }
    console.log(`Validation complete. Checked ${totalQuizzes} Math quizzes.`);
    if (warnings > 0) {
        console.log(`${warnings} warnings were issued.`);
    } else {
        console.log("No warnings.");
    }
}

validateMathQuizzes();
