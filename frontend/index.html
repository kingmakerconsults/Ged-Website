    const [showAllCoreTopics, setShowAllCoreTopics] = React.useState(false);
    React.useEffect(() => {
        setShowAllCoreTopics(false);
    }, [activeClusterId, activeTab]);

    const topicOneLiner = (topic, max = 100) => {
        return truncate(line, max);
    const quizOneLiner = (quiz, topic, max = 100) => {
        return truncate(line, max);
    const renderTopicCard = (topic, idx, options = {}) => {
        const { variant = 'default', clusterLabel = null } = options;
        const supportsMultiple = quizSets.length > 0 && !['essay', 'simulation', 'graphing_tool', 'geometry_tool'].includes(topic.type);
        const attemptMeta = getAttemptMeta(topic.quizCode || topic.id || topic.title || '');
        const showStatusBadge = Boolean(variant === 'compact' && attemptMeta && attemptMeta.status && attemptMeta.status !== 'Not Attempted');
        const summary = topicOneLiner(topic, variant === 'compact' ? 80 : 100);
        const containerClassName = `rounded-xl border bg-white/95 dark:bg-slate-900/80 dark:border-slate-700 p-4 flex flex-col justify-between shadow-md ${variant === 'compact' ? 'min-w-[16rem] w-64 flex-shrink-0' : ''}`;
        const containerStyle = isDarkMode
            ? { borderColor: subjectColors.border || 'rgba(148,163,184,0.35)', color: subjectColors.text || '#f8fafc' }
            : { borderColor: subjectColors.border || 'rgba(148,163,184,0.35)', backgroundColor: '#ffffff', backgroundImage: lightCardBackground, color: cardTextColor };

        const launchQuizSet = (quiz, index, displayNameOverride) => {
        return (
                key={topic.id || `topic_${idx}`}
                className={containerClassName}
                style={containerStyle}
                    {variant === 'compact' && clusterLabel && (
                        <p
                            className="text-xs font-semibold uppercase tracking-wide mb-1"
                            style={{ color: isDarkMode ? 'rgba(226,232,240,0.7)' : 'rgba(15,23,42,0.6)' }}
                        >
                            {clusterLabel}
                        </p>
                    )}
                        title={summary}
                        {summary}
                    {showStatusBadge && (
                        <span
                            className="mt-3 inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-semibold"
                            style={{
                                backgroundColor: isDarkMode ? 'rgba(148,163,184,0.18)' : 'rgba(148,163,184,0.16)',
                                color: isDarkMode ? (subjectColors.accentText || '#f8fafc') : (subjectColors.accent || DEFAULT_COLOR_SCHEME.accent)
                            }}
                        >
                            <span
                                className="h-2 w-2 rounded-full"
                                style={{ backgroundColor: subjectColors.accent || DEFAULT_COLOR_SCHEME.accent }}
                            ></span>
                            {attemptMeta.status}
                        </span>
                    )}
                    if (variant === 'compact') {
                        const quickTarget = list[0];
                        const quickLabel = quickTarget ? quickTarget.name : 'Quiz';
                        return (
                            <div className="mt-3 space-y-2">
                                <button
                                    onClick={() => quickTarget && launchQuizSet(quickTarget.quiz, 0, quickTarget.name)}
                                    className="w-full px-3 py-2 rounded-lg font-semibold shadow-sm transition hover:opacity-95 disabled:opacity-60 disabled:cursor-not-allowed"
                                    style={buttonStyle}
                                    disabled={!quickTarget}
                                    title={quickTarget ? quizOneLiner(quickTarget.quiz, topic, 120) : undefined}
                                >
                                    Start {quickLabel}
                                </button>
                                {list.length > 1 && (
                                    <p
                                        className="text-xs"
                                        style={{ color: isDarkMode ? 'rgba(226,232,240,0.7)' : 'rgba(15,23,42,0.6)' }}
                                    >
                                        {list.length - 1 === 1
                                            ? 'Plus 1 more set waiting in the full library.'
                                            : `Plus ${list.length - 1} more sets waiting in the full library.`}
                                    </p>
                                )}
                            </div>
                        );
                    }
                        className={`w-full mt-3 px-3 py-2 rounded-lg font-semibold shadow-sm transition hover:opacity-95 ${variant === 'compact' ? '' : ''}`}
                        {variant === 'compact' ? (showStatusBadge ? 'Resume Practice' : 'Start Practice') : (showStatusBadge ? 'Resume Practice' : 'Start Quiz')}
        const prioritizedTopics = filtered.map((topic, idx) => ({
            topic,
            key: topic?.quizCode || topic?.id || `${topic?.title || 'topic'}__${idx}`,
            meta: getAttemptMeta(topic?.quizCode || topic?.id || topic?.title || '')
        }));
        const attempted = prioritizedTopics.filter(item => item.meta && item.meta.status && item.meta.status !== 'Not Attempted');
        const attemptedKeys = new Set(attempted.map(item => item.key));
        const untouched = prioritizedTopics.filter(item => !attemptedKeys.has(item.key));
        const prioritized = [...attempted, ...untouched];
        const quickStartEntries = prioritized.slice(0, Math.min(4, prioritized.length));
        const remainderCount = Math.max(filtered.length - quickStartEntries.length, 0);
        const hasAnyTopics = topicsForActive.length > 0;
        const quickStartHasProgress = attempted.length > 0;
        const quickStartTitle = quickStartHasProgress ? 'Jump back in' : 'Quick start practice';
        const quickStartSubtitle = quickStartHasProgress
            ? 'Pick up where you left off with recently attempted sets.'
            : 'Start with a curated mix of approachable practice sets.';
        const clusterLabel = active?.label || subjectName;
        const quickStartEmptyMessage = hasAnyTopics
            ? 'No practice sets match the current filters yet. Open the full library to adjust filters or explore other clusters.'
            : 'No topics are available for this cluster yet.';
        const fullLibraryButtonLabel = showAllCoreTopics
            ? 'Hide full library'
            : remainderCount > 0
                ? `Browse ${remainderCount} more`
                : 'Open full library';

                    {clusters.map((cluster) => {
                        const selected = cluster.id === activeClusterId;
                        return (
                            <button
                                key={cluster.id}
                                type="button"
                                onClick={() => setActiveClusterId(cluster.id)}
                                className={`whitespace-nowrap px-3 py-1.5 rounded-full border text-sm font-semibold transition ${selected ? 'shadow' : ''}`}
                                style={selected
                                    ? { backgroundColor: subjectColors.accent || '#0ea5e9', color: subjectColors.accentText || '#ffffff', borderColor: subjectColors.accent || '#0ea5e9' }
                                    : { backgroundColor: isDarkMode ? 'rgba(148,163,184,0.12)' : '#ffffff', color: subjectColors.text || '#0f172a', borderColor: subjectColors.border || 'rgba(148,163,184,0.35)' }}
                                aria-pressed={selected}
                            >
                                {cluster.label}
                            </button>
                        );
                    })}
                {hasAnyTopics ? (
                    <section
                        className="mt-4 space-y-3 rounded-2xl border p-4"
                        style={{
                            borderColor: subjectColors.border || 'rgba(148,163,184,0.35)',
                            backgroundColor: isDarkMode ? 'rgba(15,23,42,0.45)' : 'rgba(255,255,255,0.92)'
                        }}
                    >
                        <div className="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                            <div>
                                <h3 className="text-lg font-semibold" style={{ color: subjectColors.text || cardTextColor }}>
                                    {quickStartTitle}
                                </h3>
                                <p
                                    className="text-sm"
                                    style={{ color: isDarkMode ? 'rgba(226,232,240,0.78)' : 'rgba(15,23,42,0.66)' }}
                                >
                                    {quickStartSubtitle}
                                </p>
                            </div>
                            <div className="flex gap-2">
                                <button
                                    type="button"
                                    className="text-sm font-semibold underline"
                                    onClick={() => setShowAllCoreTopics(prev => !prev)}
                                >
                                    {fullLibraryButtonLabel}
                                </button>
                            </div>
                        </div>
                        {quickStartEntries.length > 0 ? (
                            <div className="flex gap-4 overflow-x-auto pb-2 no-scrollbar">
                                {quickStartEntries.map(({ topic }, idx) => (
                                    renderTopicCard(topic, idx, { variant: 'compact', clusterLabel })
                                ))}
                            </div>
                        ) : (
                            <div
                                className="rounded-xl border border-dashed px-4 py-6 text-center text-sm"
                                style={{ borderColor: subjectColors.border || 'rgba(148,163,184,0.35)', color: isDarkMode ? 'rgba(226,232,240,0.78)' : 'rgba(15,23,42,0.66)' }}
                            >
                                {quickStartEmptyMessage}
                            </div>
                        )}
                        {remainderCount > 0 && !showAllCoreTopics && (
                            <p
                                className="text-xs uppercase tracking-wide"
                                style={{ color: isDarkMode ? 'rgba(226,232,240,0.6)' : 'rgba(15,23,42,0.55)' }}
                            >
                                Browse the full library to see {remainderCount} more {remainderCount === 1 ? 'set' : 'sets'} in this cluster.
                            </p>
                        )}
                    </section>
                ) : (
                    <div
                        className="mt-4 rounded-xl border border-dashed px-4 py-6 text-center text-sm"
                        style={{ borderColor: subjectColors.border || 'rgba(148,163,184,0.35)', color: isDarkMode ? 'rgba(226,232,240,0.78)' : 'rgba(15,23,42,0.66)' }}
                    >
                        No topics are available for this cluster yet.
                )}
                {showAllCoreTopics && (
                    <div className="mt-4 space-y-3">
                        {renderFilterBar()}
                        {filtered.length > 0 ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {filtered.map((topic, idx) => renderTopicCard(topic, idx))}
                            </div>
                        ) : (
                            <div
                                className="rounded-xl border border-dashed px-4 py-6 text-center text-sm"
                                style={{ borderColor: subjectColors.border || 'rgba(148,163,184,0.35)', color: isDarkMode ? 'rgba(226,232,240,0.78)' : 'rgba(15,23,42,0.66)' }}
                            >
                                {quickStartEmptyMessage}
                            </div>
                        )}
                    </div>
                )}
