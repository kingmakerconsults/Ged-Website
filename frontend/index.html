<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mr. Smith's Learning Canvas</title>
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📚</text></svg>"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      window.__COACH_ENABLED__ = true;
      window.__ASK_COACH_ENABLED__ = false;
    </script>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      html {
        -webkit-text-size-adjust: 100%;
        text-size-adjust: 100%;
      }
      body,
      h1,
      h2,
      h3,
      p,
      ul,
      ol {
        margin: 0;
        padding: 0;
      }
      ul,
      ol {
        list-style: none;
      }
      html,
      body {
        min-height: 100%;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      img,
      video,
      canvas,
      svg {
        max-width: 100%;
        height: auto;
        display: block;
      }
    </style>
    <script src="https://ged-website.onrender.com/client-config.js"></script>
    <script>
      (function ensureApiBase() {
        try {
          const base =
            (window.__APP_CONFIG__ && window.__APP_CONFIG__.apiBaseUrl) ||
            'https://ged-website.onrender.com';
          window.API_BASE_URL = base;
        } catch {
          window.API_BASE_URL = 'https://ged-website.onrender.com';
        }
      })();
    </script>
    <script>
      (function ensurePremadeKatexFlag() {
        try {
          if (!window.__APP_CONFIG__) window.__APP_CONFIG__ = {};
          if (typeof window.__APP_CONFIG__.premadeUsesKatex === 'undefined') {
            window.__APP_CONFIG__.premadeUsesKatex = true;
          }
        } catch {}
      })();
    </script>
    <script>
      if (window.__APP_CONFIG__) {
        window.__APP_CONFIG__.geometryFiguresEnabled = true;
      }
    </script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
      crossorigin="anonymous"
    />
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/jsxgraph@1.4.6/distrib/jsxgraph.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/jsxgraph@1.4.6/distrib/jsxgraphcore.js"></script>
    <script>
      (function preloadPreferences() {
        if (typeof window === 'undefined' || typeof document === 'undefined')
          return;
        const root = document.documentElement;
        const sizeClasses = ['fs-sm', 'fs-md', 'fs-lg', 'fs-xl'];
        try {
          const stored = localStorage.getItem('prefs');
          if (!stored) return;
          const parsed = JSON.parse(stored);
          if (parsed && typeof parsed === 'object') {
            sizeClasses.forEach((c) => root.classList.remove(c));
            const sizes = new Set(['sm', 'md', 'lg', 'xl']);
            const fontSize = sizes.has(parsed.fontSize)
              ? parsed.fontSize
              : 'md';
            root.classList.add(`fs-${fontSize}`);
          }
        } catch (e) {
          console.warn('Failed to preload saved preferences:', e);
        }
      })();
    </script>
    <script>
      (function preloadTheme() {
        if (typeof window === 'undefined' || typeof document === 'undefined')
          return;
        let theme = 'light';
        try {
          const saved = window.localStorage
            ? window.localStorage.getItem('appTheme')
            : null;
          const prefersDark =
            window.matchMedia &&
            typeof window.matchMedia === 'function' &&
            window.matchMedia('(prefers-color-scheme: dark)').matches;
          theme =
            saved === 'light' || saved === 'dark'
              ? saved
              : prefersDark
              ? 'dark'
              : 'light';
        } catch (e) {
          console.warn('theme preload failed', e);
        }
        const root = document.documentElement;
        root.setAttribute('data-theme', theme);
        root.classList.toggle('dark', theme === 'dark');
        try {
          Object.defineProperty(window, '__START_THEME__', {
            value: theme,
            writable: false,
            configurable: false,
          });
        } catch {
          window.__START_THEME__ = theme;
        }
      })();
    </script>

    <!-- Quiz Data Loader: Fetch all premade quizzes and build unified catalog -->
    <script>
      (async function loadQuizData() {
        try {
          if (typeof window === 'undefined') return;

          // Determine API base URL
          const API_BASE =
            window.__CLIENT_CONFIG__?.API_BASE_URL ||
            (typeof window.API_BASE_URL === 'string' && window.API_BASE_URL) ||
            window.location.origin;

          console.log('[quiz-loader] Starting quiz data load from:', API_BASE);

          // Define quiz files to fetch
          const QUIZ_FILENAMES = [
            'math.quizzes.part1.json',
            'math.quizzes.part2.json',
            'rla.quizzes.part1.json',
            'rla.quizzes.part2.json',
            'science.quizzes.part1.json',
            'science.quizzes.part2.json',
            'social-studies.quizzes.json',
            'social-studies.extras.json',
            'workforce.quizzes.json',
          ];

          // Fetch all quiz JSON files in parallel
          const quizPromises = QUIZ_FILENAMES.map((filename) =>
            fetch(`${API_BASE}/quizzes/${filename}`)
              .then((res) => {
                if (!res.ok) {
                  console.warn(
                    `[quiz-loader] Failed to fetch ${filename}: ${res.status}`
                  );
                  return null;
                }
                return res.json();
              })
              .catch((err) => {
                console.warn(`[quiz-loader] Error fetching ${filename}:`, err);
                return null;
              })
          );

          // Fetch the unified catalog from backend
          const catalogPromise = fetch(`${API_BASE}/api/all-quizzes`)
            .then((res) => {
              if (!res.ok) {
                console.warn(
                  `[quiz-loader] Failed to fetch all-quizzes: ${res.status}`
                );
                return null;
              }
              return res.json();
            })
            .catch((err) => {
              console.warn('[quiz-loader] Error fetching all-quizzes:', err);
              return null;
            });

          // Wait for all fetches
          const [catalog, ...quizData] = await Promise.all([
            catalogPromise,
            ...quizPromises,
          ]);

          // Merge quiz data from files
          const merged = {};
          quizData.forEach((data) => {
            if (data && typeof data === 'object') {
              Object.entries(data).forEach(([subject, content]) => {
                if (!merged[subject]) {
                  merged[subject] = { categories: {} };
                }
                if (content?.categories) {
                  Object.entries(content.categories).forEach(
                    ([catName, catData]) => {
                      if (!merged[subject].categories[catName]) {
                        merged[subject].categories[catName] = {
                          topics: [],
                          ...catData,
                        };
                      } else {
                        // Merge topics
                        const existing = merged[subject].categories[catName];
                        if (Array.isArray(catData.topics)) {
                          existing.topics = [
                            ...(existing.topics || []),
                            ...catData.topics,
                          ];
                        }
                      }
                    }
                  );
                }
              });
            }
          });

          // Merge with catalog from backend (prefer backend catalog structure)
          if (catalog && typeof catalog === 'object') {
            Object.entries(catalog).forEach(([subject, content]) => {
              if (!merged[subject]) {
                merged[subject] = content;
              } else {
                // Deep merge categories
                if (content?.categories) {
                  Object.entries(content.categories).forEach(
                    ([catName, catData]) => {
                      if (!merged[subject].categories[catName]) {
                        merged[subject].categories[catName] = catData;
                      } else {
                        // Merge topics array
                        const existing = merged[subject].categories[catName];
                        if (Array.isArray(catData.topics)) {
                          const existingTopics = existing.topics || [];
                          existing.topics = [
                            ...existingTopics,
                            ...catData.topics,
                          ];
                        }
                      }
                    }
                  );
                }
              }
            });
          }

          // Set global variables for legacy compatibility
          window.UnifiedQuizCatalog = merged;
          window.AppData = merged;
          window.ExpandedQuizData = merged;
          window.MergedExpandedQuizData = merged;

          if (!window.Data) window.Data = {};
          window.Data.expandedQuizData = merged;

          console.log('[quiz-loader] Quiz data loaded successfully:', {
            subjects: Object.keys(merged),
            totalCategories: Object.values(merged).reduce(
              (sum, subj) => sum + Object.keys(subj?.categories || {}).length,
              0
            ),
          });

          // Dispatch event to notify app that quiz data is ready
          window.dispatchEvent(
            new CustomEvent('quizDataLoaded', { detail: merged })
          );
        } catch (error) {
          console.error('[quiz-loader] Fatal error loading quiz data:', error);
          // Initialize empty structure to prevent crashes
          window.UnifiedQuizCatalog = {};
          window.AppData = {};
          window.ExpandedQuizData = {};
          window.MergedExpandedQuizData = {};
          if (!window.Data) window.Data = {};
          window.Data.expandedQuizData = {};
        }
      })();
    </script>

    <!-- Legacy compatibility shim: ensure aliases exist -->
    <script>
      (function () {
        try {
          if (typeof window === 'undefined') return;
          // If legacy globals are missing but new catalogs exist, alias them.
          const catalog =
            window.UnifiedQuizCatalog ||
            window.AppData ||
            window.Data?.expandedQuizData ||
            {};
          if (!window.ExpandedQuizData && catalog) {
            window.ExpandedQuizData = catalog;
          }
          if (!window.MergedExpandedQuizData && window.ExpandedQuizData) {
            window.MergedExpandedQuizData = window.ExpandedQuizData;
          }
        } catch (e) {
          // no-op
        }
      })();
    </script>
  </head>
  <body data-theme="light">
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
