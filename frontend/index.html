    const getSelectedChallengeIds = (profileState) => {
        const opts = Array.isArray(profileState?.challengeOptions)
            ? profileState.challengeOptions
            : [];
        return opts
            .filter((opt) => opt && opt.selected)
            .map((opt) => String(opt.id));
    };

    const handleSaveChallenges = useCallback(async () => {

        try {
            const token = authToken || localStorage.getItem('appToken');
            if (!token) {
                window.alert('You must be logged in to save challenges.');
                return;
            }

            const selectedIds = getSelectedChallengeIds(localProfile);

            const res = await fetch(`${API_BASE_URL}/api/profile/challenges/tags`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ selectedIds }),
            });

            if (!res.ok) {
                const errorText = await res.text().catch(() => '');
                console.error('Failed to save challenges:', res.status, errorText);
                window.alert('Error: challenges not saved to server.');
                return;
            }

            const bundle = await res.json();

            setLocalProfile((prev) => ({
                ...prev,
                profile: bundle.profile || prev.profile,
                testPlan: bundle.testPlan || prev.testPlan,
                challengeOptions: bundle.challengeOptions || prev.challengeOptions,
            }));

            window.alert('Challenges saved.');
        } catch (err) {
            console.error('Failed to save challenges:', err);
            window.alert('Network error while saving challenges.');
        } finally {
            setChallengesSaving(false);
        }
    }, [authToken, localProfile]);
