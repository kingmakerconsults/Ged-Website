    const [weeklyCoachPlan, setWeeklyCoachPlan] = useState(null);
    // daily coach progress snapshot
    const [coachDailySubjects, setCoachDailySubjects] = useState([]);
    const [weeklyCoachSummary, setWeeklyCoachSummary] = useState([]);
    const canonicalSubjectId = (value) => {
        const str = (value || '').toString().toLowerCase();
        if (!str) return '';
        if (str.startsWith('math')) return 'math';
        if (str.startsWith('science')) return 'science';
        if (str === 'rla' || str.includes('language')) return 'rla';
        if (str.includes('social')) return 'social_studies';
        return str.replace(/[^a-z0-9]+/g, '_');
    };

    const displaySubjectName = (value) => {
        const id = canonicalSubjectId(value);
        if (id === 'rla') return 'Reasoning Through Language Arts (RLA)';
        if (id === 'social_studies') return 'Social Studies';
        if (id === 'math') return 'Math';
        if (id === 'science') return 'Science';
        return value || 'Subject';
    };

    const practiceSubjectParam = (value) => {
        const id = canonicalSubjectId(value);
        if (!id) return '';
        if (id === 'math') return 'math';
        if (id === 'science') return 'science';
        if (id === 'rla') return 'rla';
        return 'social-studies';
    };

    const addDaysToDate = (iso, offset = 0) => {
        if (!iso) return null;
        try {
            const base = new Date(`${iso}T00:00:00`);
            const shifted = new Date(base.getTime() + offset * 24 * 60 * 60 * 1000);
            return shifted.toISOString().slice(0, 10);
        } catch {
            return null;
        }
    };

    const normalizeCoachTask = (task = {}, dayFallback = {}, dayIndex = 0, taskIndex = 0) => {
        const rawSubject = task.subject || dayFallback.subject || dayFallback.subjectLabel || '';
        const subjectId = canonicalSubjectId(rawSubject);
        const subjectLabel = task.subjectLabel || dayFallback.subjectLabel || displaySubjectName(rawSubject || subjectId);
        const focus = Array.isArray(task.focus) ? task.focus : (task.focus ? [task.focus] : []);
        const minutesFromTask = Number(task.minutes);
        const minutesFallback = Number(dayFallback.minutes);
        return {
            id: task.id || `${subjectId || 'task'}-${dayIndex}-${taskIndex}`,
            subject: subjectId,
            subjectLabel,
            title: task.title || task.label || dayFallback.label || dayFallback.task || task.type || 'Practice',
            type: task.type || dayFallback.type || 'practice',
            minutes: Number.isFinite(minutesFromTask) ? minutesFromTask : (Number.isFinite(minutesFallback) ? minutesFallback : 20),
            quizId: task.quizId || task.quizCode || null,
            quizPath: task.quizPath || null,
            focus,
            message: task.message || dayFallback.message || null,
        };
    };

    const adaptWeeklyCoachResponse = (raw) => {
        if (!raw) return { weekStart: null, weekEnd: null, days: [] };
        const plan = raw.plan || raw;
        const weekStart = plan.weekStart || raw.weekStart || null;
        const weekEnd = plan.weekEnd || raw.weekEnd || null;
        const daysInput = Array.isArray(plan.days) ? plan.days : [];
        const normalizedDays = daysInput.map((day, idx) => {
            const dayNumber = Number(day.day);
            const resolvedIndex = Number.isFinite(dayNumber) && dayNumber >= 1 ? dayNumber - 1 : idx;
            const label = day.label || `Day ${resolvedIndex + 1}`;
            const date = day.date || addDaysToDate(weekStart, resolvedIndex);
            const tasks = Array.isArray(day.tasks) ? day.tasks.map((task, taskIndex) => normalizeCoachTask(task, day, resolvedIndex, taskIndex)) : [];
            return {
                day: resolvedIndex + 1,
                label,
                date,
                tasks,
            };
        });
        return {
            weekStart,
            weekEnd,
            generatedAt: plan.generatedAt || null,
            subjects: plan.subjects || {},
            days: normalizedDays,
        };
    };

    const getTodayIndex = (weekStartISO) => {
        if (!weekStartISO) return -1;
        try {
            const today = new Date();
            const localToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const start = new Date(weekStartISO + 'T00:00:00');
            const diff = Math.floor((localToday - start) / (24 * 60 * 60 * 1000));
            if (diff < 0 || diff > 6) return -1;
            return diff;
        } catch {
            return -1;
        }
    };

    const fetchWeeklyCoachPlan = async () => {
            if (!token) {
                setWeeklyCoachPlan(null);
                setWeeklyCoachSummary([]);
                return;
            }
            const res = await fetch(`${API_BASE_URL}/api/coach/weekly`, { headers: { Authorization: `Bearer ${token}` } });
            if (!res.ok) {
                setWeeklyCoachPlan((prev) => prev || { weekStart: null, weekEnd: null, days: [] });
                if (res.status !== 404) setCoachError('Unable to load weekly coach plan.');
                return;
            }
            const data = await res.json();
            const normalized = adaptWeeklyCoachResponse(data);
            setWeeklyCoachPlan(normalized);
            setWeeklyCoachSummary(Array.isArray(data?.subjects) ? data.subjects : []);
        } catch (e) {
            setCoachError('Unable to load weekly coach plan.');
            setWeeklyCoachPlan((prev) => prev || { weekStart: null, weekEnd: null, days: [] });
        } finally {
            setCoachLoading(false);
        }
    };

    const fetchCoachDailyProgress = async () => {
        try {
            setDailyLoading(true);
            setDailyError('');
            const token = (typeof localStorage !== 'undefined' && localStorage.getItem('appToken')) || null;
            if (!token) {
                setCoachDailySubjects([]);
                return;
            }
            const res = await fetch(`${API_BASE_URL}/api/coach/daily`, { headers: { Authorization: `Bearer ${token}` } });
                if (data && data.ok) {
                    setCoachDailySubjects(Array.isArray(data.subjects) ? data.subjects : []);
                } else {
                    setCoachDailySubjects([]);
                }
                setDailyError("Unable to load today's coach goals.");
            setDailyError("Unable to load today's coach goals.");
            setDailyLoading(false);

    const refreshCoachPanels = async () => {
        await Promise.all([fetchWeeklyCoachPlan(), fetchCoachDailyProgress()]);
    };

            const subjectParam = practiceSubjectParam(selectedSubject);
            const apiSubject = subjectParam === 'social-studies' ? 'Social Studies' : (subjectParam === 'rla' ? 'RLA' : subjectParam.charAt(0).toUpperCase() + subjectParam.slice(1));
            const res = await fetch(`${API_BASE_URL}/api/coach/${encodeURIComponent(apiSubject)}/generate-week`, {
            await fetchWeeklyCoachPlan();
            await fetchCoachDailyProgress();
    const todaysTasks = React.useMemo(() => {
        if (!weeklyCoachPlan || !Array.isArray(weeklyCoachPlan?.days) || weeklyCoachPlan.days.length === 0) return [];
        let idx = getTodayIndex(weeklyCoachPlan.weekStart);
        if (idx < 0 || idx >= weeklyCoachPlan.days.length) idx = 0;
        const day = weeklyCoachPlan.days[idx];
        return Array.isArray(day.tasks) ? day.tasks : [];
    }, [weeklyCoachPlan]);

    const todaysTaskGroups = React.useMemo(() => {
        const groups = new Map();
        todaysTasks.forEach((task) => {
            if (!task) return;
            const subjectId = canonicalSubjectId(task.subject || task.subjectLabel || '');
            const subjectLabel = displaySubjectName(task.subjectLabel || task.subject);
            if (!groups.has(subjectId)) {
                groups.set(subjectId, { subjectId, subjectLabel, tasks: [] });
            groups.get(subjectId).tasks.push(task);
        });
        return Array.from(groups.values());
    }, [todaysTasks]);

    const dailyProgressMap = React.useMemo(() => {
        const map = new Map();
        (Array.isArray(coachDailySubjects) ? coachDailySubjects : []).forEach((entry) => {
            if (!entry) return;
            const id = canonicalSubjectId(entry.subject);
            map.set(id, entry);
        });
        return map;
    }, [coachDailySubjects]);

    const openCoachTask = (task) => {
        if (!task) return;
        const subjectLabel = displaySubjectName(task.subjectLabel || task.subject);
        const subjectId = canonicalSubjectId(task.subject || task.subjectLabel || '');
        if (task.type === 'coach-quiz') {
            const progress = dailyProgressMap.get(subjectId);
            const sourceId = progress?.coach_quiz_source_id || task.quizId || null;
            startCoachQuizForSubject(subjectLabel, sourceId);
            return;
        }
        if (task.quizId) {
            const launched = launchPremadeByCodeGlobal(subjectLabel, task.quizId);
            if (!launched) {
                if (task.quizPath) {
                    window.location.href = task.quizPath;
                } else {
                    alert('Unable to open this quiz right now.');
                }
            }
            return;
        }
        if (task.quizPath) {
            window.location.href = task.quizPath;
            return;
        }
        if (task.message) {
            alert(task.message);
        }
    };

            if (!profilePassedMap || typeof profilePassedMap !== 'object') return false;
            let count = 0;
            for (const id of required) {
                if (profilePassedMap[id] === true) count += 1;
            }
            return count === required.length;
                        ) : todaysTaskGroups.length ? (
                                {todaysTaskGroups.map((group) => {
                                    const progress = dailyProgressMap.get(group.subjectId) || {};
                                    return (
                                        <div key={group.subjectId || group.subjectLabel} className="border rounded-md p-3" style={{ borderColor: panelBorderColor }}>
                                            <div className="flex items-center justify-between gap-3">
                                                <div>
                                                    <div className="font-semibold" style={{ color: heroTextColor }}>{group.subjectLabel}</div>
                                                    <div className="text-sm" style={heroMutedTextStyle}>
                                                        {Math.max(0, progress.completed_minutes || 0)} / {progress.expected_minutes || 45} minutes
                                                    </div>
                                                {progress.coach_quiz_id && (
                                                    progress.coach_quiz_completed ? (
                                                    ) : null
                                                )}
                                            <div className="mt-3 space-y-2">
                                                {group.tasks.map((task) => {
                                                    const focusText = Array.isArray(task.focus) && task.focus.length ? `Focus: ${task.focus.join(', ')}` : '';
                                                    const buttonLabel = task.type === 'coach-quiz'
                                                        ? `Start Coach Quiz`
                                                        : task.quizId || task.quizPath
                                                            ? `Start ${group.subjectLabel.split(' ')[0]} Practice`
                                                            : '';
                                                    return (
                                                        <div key={task.id} className="rounded-md border px-3 py-2" style={{ borderColor: panelBorderColor }}>
                                                            <div className="flex items-start justify-between gap-3">
                                                                <div>
                                                                    <div className="font-medium" style={{ color: heroTextColor }}>{task.title}</div>
                                                                    {focusText ? <div className="text-xs" style={heroMutedTextStyle}>{focusText}</div> : null}
                                                                    {task.message ? (
                                                                        <p className="text-sm mt-1" style={heroMutedTextStyle}>{task.message}</p>
                                                                    ) : null}
                                                                </div>
                                                                <span className="text-xs font-semibold" style={heroMutedTextStyle}>{task.minutes} min</span>
                                                            </div>
                                                            {buttonLabel && (
                                                                <button
                                                                    onClick={() => openCoachTask(task)}
                                                                    className="mt-2 px-4 py-2 bg-purple-600 text-white text-sm font-semibold rounded-md shadow-sm hover:bg-purple-700 transition"
                                                                >
                                                                    {buttonLabel}
                                                                </button>
                                                            )}
                                                        </div>
                                                    );
                                            </div>
                                        </div>
                                    );
                                })}
                                const subjectId = canonicalSubjectId(subj);
                                const subjectKey = subjectId === 'science' ? 'science' : subjectId === 'math' ? 'math' : subjectId === 'rla' ? 'rla' : 'social';
                                const match = Array.isArray(weeklyCoachSummary)
                                    ? weeklyCoachSummary.find((ws) => canonicalSubjectId(ws.subject) === subjectId || (subjectId === 'rla' && canonicalSubjectId(ws.subject) === 'rla'))
                                const subjectPlanDays = Array.isArray(weeklyCoachPlan?.days)
                                    ? weeklyCoachPlan.days
                                        .map((day) => ({
                                            ...day,
                                            tasks: Array.isArray(day.tasks)
                                                ? day.tasks.filter((task) => canonicalSubjectId(task.subject || task.subjectLabel || '') === subjectId)
                                                : []
                                        }))
                                        .filter((day) => day.tasks.length > 0)
                                    : [];
                                const fallbackTarget = subjectPlanDays.reduce((acc, day) => acc + day.tasks.reduce((sum, task) => sum + (Number(task.minutes) || 0), 0), 0) || 140;
                                const hasPlan = subjectPlanDays.length > 0;
                                    ) : hasPlan ? (
                                            {subjectPlanDays.slice(0,7).map((d, idx) => {
                                                const focusList = d.tasks.flatMap((task) => Array.isArray(task.focus) ? task.focus : []);
                                                const focus = focusList.length ? Array.from(new Set(focusList)).join(', ') : '';
                                                const minutes = d.tasks.reduce((sum, task) => sum + (Number(task.minutes) || 0), 0) || 0;
                                                const titles = d.tasks.map((task) => task.title).join(' • ');
                                                    <div key={`${d.day}-${idx}`} className="text-sm flex flex-col">
                                                        <span>{focus ? `${focus} — ` : ''}{titles || 'Practice'} ({minutes}m)</span>
                                        {hasPlan ? 'Generate / Refresh Plan' : 'Generate Plan'}
                                    const match = Array.isArray(weeklyCoachSummary)
                                        ? weeklyCoachSummary.find((ws) => {
                                                if (label === 'Reasoning Through Language Arts (RLA)') {
                                                    return ws.subject === 'RLA' || ws.subject === label;
                                                }
                                                return ws.subject === label;
                                            })
