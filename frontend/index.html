        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-10px); } }
        .quiz-container {
            min-height: 450px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .answer-text { display: block; }
        .answer-consequence {
            display: block;
            font-size: 0.875rem;
            color: #475569;
            margin-top: 4px;
        }
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            padding: 0.5rem;
            background-color: #f1f5f9;
            border-radius: 0.75rem;
        }
        .stat { text-align: center; }
        .stat button {
            width: 100%;
            height: 100%;
            padding: 0.5rem 0.25rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .stat button:hover {
            background-color: #e2e8f0;
        }
        .stat-value {
            font-weight: 700;
            font-size: 1rem;
            color: #1e293b;
            display: block;
        }
        .stat-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            display: block;
        }
        .modal {
            transition: opacity 0.3s, transform 0.3s;
        }
        .avatar-icon {
            animation: popIn 0.3s ease-out;
        }
        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
function AppHeader({ currentUser, onLogout, onShowHome, onShowProfile, onShowSettings, onShowSimulations, activePanel, theme, onToggleTheme }) {
    const isSimulationsActive = activePanel === 'simulations';
                            <button
                                type="button"
                                id="btnSimulations"
                                onClick={onShowSimulations}
                                className={`px-3 py-2 text-xs sm:text-sm font-semibold rounded-lg border transition ${isSimulationsActive ? 'bg-cyan-600 dark:bg-cyan-500 text-white border-transparent' : 'text-cyan-700 dark:text-cyan-300 border-cyan-200/70 dark:border-cyan-500/50 hover:bg-cyan-50 dark:hover:bg-slate-800/70'}`}
                                aria-controls="simulationsView"
                                aria-expanded={isSimulationsActive}
                            >
                                Simulations
                            </button>
function initLifeChoices() {
    const root = document.getElementById('life-choices-root');
    if (!root || root.dataset.initialized === 'true') {
        if (!root) {
            console.warn('Life Choices root not found.');
        }
        return;
    }
    const quizContainer = document.getElementById('quiz');
    if (!quizContainer) {
        console.warn('Life Choices simulation markup not found.');
        return;
    }
    root.dataset.initialized = 'true';

    const avatarIcons = {
                briefcase: `<svg class="avatar-icon w-10 h-10 text-amber-700 dark:text-amber-300 bg-white dark:bg-slate-800/80 p-1.5 rounded-full shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>`,
                wrench: `<svg class="avatar-icon w-10 h-10 text-sky-600 dark:text-sky-300 bg-white dark:bg-slate-800/80 p-1.5 rounded-full shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>`,
                palette: `<svg class="avatar-icon w-10 h-10 text-purple-500 dark:text-purple-300 bg-white dark:bg-slate-800/80 p-1.5 rounded-full shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path></svg>`,
                health: `<svg class="avatar-icon w-10 h-10 text-green-500 dark:text-green-300 bg-white dark:bg-slate-800/80 p-1.5 rounded-full shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>`,
                apartment: `<svg class="avatar-icon w-full h-full text-slate-200 dark:text-slate-500 opacity-50" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd"></path></svg>`,
                house: `<svg class="avatar-icon w-full h-full text-slate-200 dark:text-slate-500 opacity-50" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>`,
                nomad: `<svg class="avatar-icon w-full h-full text-slate-200 dark:text-slate-500 opacity-50" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.72 7 7.25 7 8.5c0 1.25.488 2.78 1.668 3.177a6.01 6.01 0 01-1.415 2.553c-.328.328-.328.86 0 1.188a.839.839 0 001.188 0l1.414-1.414a.839.839 0 000-1.188l-1.414-1.414a.839.839 0 00-1.188 0l-.328.328a4.509 4.509 0 00-1.255 2.25l-.328.328a.839.839 0 000 1.188l1.414 1.414a.839.839 0 001.188 0l1.414-1.414a.839.839 0 000-1.188l-1.414-1.414a.839.839 0 00-1.188 0l-.328.328A4.509 4.509 0 008.5 11c-1.25 0-2.78-.488-3.177-1.668a6.01 6.01 0 012.553-1.415c.328-.328.86-.328 1.188 0a.839.839 0 001.188-1.188l-1.414-1.414a.839.839 0 00-1.188 0l-1.414 1.414a.839.839 0 000 1.188l1.414 1.414a.839.839 0 001.188 0l.328-.328a4.509 4.509 0 001.255-2.25l-.328-.328a.839.839 0 000-1.188l-1.414-1.414a.839.839 0 00-1.188 0l-1.414 1.414a.839.839 0 000 1.188l1.414 1.414a.839.839 0 001.188 0l.328-.328c.34-.34.62-.72.836-1.12a5.99 5.99 0 01-.432-6.848 6.012 6.012 0 01-2.706 1.912c-.328.328-.86.328-1.188 0a.839.839 0 00-1.188 1.188l1.414 1.414a.839.839 0 001.188 0l1.414-1.414a.839.839 0 000-1.188l-1.414-1.414a.839.839 0 00-1.188 0z" clip-rule="evenodd"></path></svg>`,
                family: `<svg class="avatar-icon w-9 h-9 text-red-500 dark:text-red-400 bg-white dark:bg-slate-800/80 p-1.5 rounded-full shadow-md" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>`,
                pet: `<svg class="avatar-icon w-9 h-9 text-orange-500 dark:text-orange-300 bg-white dark:bg-slate-800/80 p-1.5 rounded-full shadow-md" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 14.95a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 3v1a1 1 0 11-2 0V3a1 1 0 112 0z"></path><path d="M12.25 10.25a.75.75 0 010-1.5.75.75 0 010 1.5zM10 12.25a.75.75 0 01-1.5 0 .75.75 0 011.5 0zM7.75 10.25a.75.75 0 010-1.5.75.75 0 010 1.5z"></path></svg>`,
            };
    
            const personalityQuestions = [
                { question: "When facing a difficult problem, you are more likely to:", answers: [ { text: "Rely on a logical, data-driven approach.", type: 'ambitious' }, { text: "Trust your intuition and creativity.", type: 'creative' }, { text: "Consult with friends and family for advice.", type: 'guardian' }, { text: "Take a bold risk and see what happens.", type: 'adventurous' } ] },
                { question: "A perfect weekend involves:", answers: [ { text: "Networking and working on a side project.", type: 'ambitious' }, { text: "Visiting a new city or trying an extreme sport.", type: 'adventurous' }, { text: "Spending quality time with loved ones at home.", type: 'guardian' }, { text: "Visiting a museum or working on a creative hobby.", type: 'creative' } ] },
                { question: "You receive an unexpected $5,000. Your first instinct is to:", answers: [ { text: "Invest it for long-term growth.", type: 'ambitious' }, { text: "Book a spontaneous trip abroad.", type: 'adventurous' }, { text: "Put it in an emergency fund or pay off debt.", type: 'guardian' }, { text: "Buy a new instrument or high-end art supplies.", type: 'creative' } ] },
                { question: "Success is best measured by:", answers: [ { text: "Your professional title and income.", type: 'ambitious' }, { text: "The impact you have on your community.", type: 'guardian' }, { text: "The variety and richness of your experiences.", type: 'adventurous' }, { text: "The quality of the work you create.", type: 'creative' } ] },
                { question: "You are offered a promotion that requires moving away from your family.", answers: [ { text: "Take it without hesitation.", type: 'ambitious' }, { text: "Decline it; your relationships are more important.", type: 'guardian' }, { text: "See it as an exciting new adventure.", type: 'adventurous' }, { text: "Worry it will disrupt your creative flow.", type: 'creative' } ] },
                { question: "When it comes to your living space, you prioritize:", answers: [ { text: "Proximity to work and important city hubs.", type: 'ambitious' }, { text: "A unique space that reflects your personality.", type: 'creative' }, { text: "Comfort, safety, and stability.", type: 'guardian' }, { text: "Minimalism, so you can pack up and leave easily.", type: 'adventurous' } ] },
                { question: "Your ideal job would be:", answers: [ { text: "A high-powered executive role.", type: 'ambitious' }, { text: "A freelance artist or musician.", type: 'creative' }, { text: "A teacher or a nurse.", type: 'guardian' }, { text: "A travel blogger or a tour guide.", type: 'adventurous' } ] },
                { question: "You feel most fulfilled when you are:", answers: [ { text: "Achieving a difficult goal.", type: 'ambitious' }, { text: "Creating something new.", type: 'creative' }, { text: "Helping someone in need.", type: 'guardian' }, { text: "Exploring an unfamiliar place.", type: 'adventurous' } ] },
                { question: "In a team project, you are usually the one who:", answers: [ { text: "Takes charge and directs the strategy.", type: 'ambitious' }, { text: "Makes sure everyone feels heard and supported.", type: 'guardian' }, { text: "Comes up with the most unconventional ideas.", type: 'creative' }, { text: "Pushes the team to try a new, untested approach.", type: 'adventurous' } ] },
                { question: "Looking back on your life, you would regret not having:", answers: [ { text: "Reached your full career potential.", type: 'ambitious' }, { text: "Taken more risks and traveled more.", type: 'adventurous' }, { text: "Built strong, lasting relationships.", type: 'guardian' }, { text: "Dedicated more time to your passions.", type: 'creative' } ] }
            ];
    
            const gameData = [
                { time_skip: 0, question: "Stage 1: Choose your career sector.", back: false, answers: [ { text: "Technology", consequence: "High growth, high demand, but competitive.", effects: { sector: 'tech' } }, { text: "Skilled Trades", consequence: "Good job security, physically demanding.", effects: { sector: 'trades' } }, { text: "Creative Arts", consequence: "High passion, high risk, low initial stability.", effects: { sector: 'creative' } }, { text: "Healthcare", consequence: "Stable, meaningful, but high stress.", effects: { sector: 'health' } } ] },
                { condition: (gs) => gs.sector === 'tech', back: true, time_skip: 4, question: "Stage 2 (Tech): Choose your profession.", answers: [ { text: "AI/ML Specialist", consequence: "Loan: $80k. Salary: $90k/yr.", effects: { career_type: 'stable', career_level: 1, expense_add: {id: 'student_loan', label: 'Student Loan', amount: 8000}, salary_add: {id: 'main_job', label: 'AI Specialist', amount: 90000}, avatar: {type: 'item', icon: 'briefcase'}, creditScore_change: -30, add_qualification: 'B.S. CompSci', personality_match: 'ambitious' } }, { text: "Cybersecurity Analyst", consequence: "Loan: $60k. Salary: $80k/yr.", effects: { career_type: 'stable', career_level: 1, expense_add: {id: 'student_loan', label: 'Student Loan', amount: 6000}, salary_add: {id: 'main_job', label: 'Cybersecurity Analyst', amount: 80000}, avatar: {type: 'item', icon: 'briefcase'}, creditScore_change: -30, add_qualification: 'B.S. IT', personality_match: 'guardian' } }, { text: "UX/UI Designer", consequence: "Loan: $50k. Salary: $85k/yr.", effects: { career_type: 'stable', career_level: 1, expense_add: {id: 'student_loan', label: 'Student Loan', amount: 5000}, salary_add: {id: 'main_job', label: 'UX/UI Designer', amount: 85000}, avatar: {type: 'item', icon: 'palette'}, creditScore_change: -25, add_qualification: 'B.A. Design', personality_match: 'creative' } } ] },
                { condition: (gs) => gs.sector === 'trades', back: true, time_skip: 2, question: "Stage 2 (Trades): Choose your profession.", answers: [ { text: "Electrician", consequence: "Loan: $25k. Salary: $65k/yr.", effects: { career_type: 'stable', career_level: 1, expense_add: {id: 'student_loan', label: 'Student Loan', amount: 2500}, salary_add: {id: 'main_job', label: 'Electrician', amount: 65000}, avatar: {type: 'item', icon: 'wrench'}, creditScore_change: -20, add_qualification: 'Journeyman License', personality_match: 'guardian' } }, { text: "HVAC Technician", consequence: "Loan: $20k. Salary: $55k/yr.", effects: { career_type: 'stable', career_level: 1, expense_add: {id: 'student_loan', label: 'Student Loan', amount: 2000}, salary_add: {id: 'main_job', label: 'HVAC Tech', amount: 55000}, avatar: {type: 'item', icon: 'wrench'}, creditScore_change: -20, add_qualification: 'Trade Certification', personality_match: 'guardian' } } ] },
                { condition: (gs) => gs.sector === 'creative', back: true, time_skip: 4, question: "Stage 2 (Creative): Choose your profession.", answers: [ { text: "Graphic Designer", consequence: "Loan: $40k. Salary: $50k/yr.", effects: { career_type: 'stable', career_level: 1, expense_add: {id: 'student_loan', label: 'Student Loan', amount: 4000}, salary_add: {id: 'main_job', label: 'Graphic Designer', amount: 50000}, avatar: {type: 'item', icon: 'palette'}, creditScore_change: -25, add_qualification: 'B.F.A.', personality_match: 'creative' } }, { text: "Content Creator", consequence: "Cost: $5k. Salary: Highly volatile.", effects: { career_type: 'creator', career_level: 1, cash_change: -5000, salary_add: {id: 'main_job', label: 'Content Creator', amount: 30000}, happiness: 10, avatar: {type: 'item', icon: 'palette'}, personality_match: 'adventurous' } }, { text: "Writer/Journalist", consequence: "Loan: $35k. Salary: $48k/yr.", effects: { career_type: 'stable', career_level: 1, expense_add: {id: 'student_loan', label: 'Student Loan', amount: 3500}, salary_add: {id: 'main_job', label: 'Writer', amount: 48000}, avatar: {type: 'item', icon: 'palette'}, creditScore_change: -25, add_qualification: 'B.A. English', personality_match: 'creative' } } ] },
                { condition: (gs) => gs.sector === 'health', back: true, time_skip: 4, question: "Stage 2 (Health): Choose your profession.", answers: [ { text: "Registered Nurse", consequence: "Loan: $60k. Salary: $75k/yr.", effects: { career_type: 'stable', career_level: 1, expense_add: {id: 'student_loan', label: 'Student Loan', amount: 6000}, salary_add: {id: 'main_job', label: 'Nurse', amount: 75000}, avatar: {type: 'item', icon: 'health'}, creditScore_change: -30, add_qualification: 'B.S.N.', personality_match: 'guardian' } }, { text: "Pharmacist", consequence: "Loan: $150k. Salary: $120k/yr.", effects: { career_type: 'stable', career_level: 1, expense_add: {id: 'student_loan', label: 'Student Loan', amount: 15000}, salary_add: {id: 'main_job', label: 'Pharmacist', amount: 120000}, avatar: {type: 'item', icon: 'health'}, creditScore_change: -50, add_qualification: 'Pharm.D.', personality_match: 'ambitious' } }, { text: "Medical Assistant", consequence: "Loan: $10k. Salary: $40k/yr.", effects: { career_type: 'stable', career_level: 1, expense_add: {id: 'student_loan', label: 'Student Loan', amount: 1000}, salary_add: {id: 'main_job', label: 'Medical Assistant', amount: 40000}, avatar: {type: 'item', icon: 'health'}, creditScore_change: -10, add_qualification: 'Certificate', personality_match: 'guardian' } } ] },
                { time_skip: 3, question: "Stage 3: Where will you live for the next few years?", answers: [ { text: "Rent a Downtown Apartment", consequence: "Expenses: +$36k/yr. Great social life.", effects: { housing_type: 'rent', expense_add: {id: 'housing', label: 'Housing', amount: 36000}, happiness: 10, avatar: {type: 'bg', icon: 'apartment'}, personality_match: 'adventurous' } }, { text: "Live with Family", consequence: "Expenses: +$7.2k/yr. Saves money.", effects: { housing_type: 'family', expense_add: {id: 'housing', label: 'Housing', amount: 7200}, happiness: -5, personality_match: 'guardian' } }, { text: "Rent a room", consequence: "Expenses: +$12k/yr. Cheapest option.", effects: { housing_type: 'rent', expense_add: {id: 'housing', label: 'Housing', amount: 12000}, happiness: -5, avatar: {type: 'bg', icon: 'apartment'}, personality_match: 'ambitious' } } ] },
                { time_skip: 2, question: "Stage 4: Start contributing to your retirement?", answers: [ { text: "Yes, 10% of my salary", consequence: "Aggressive savings for a secure future.", effects: { special_effect: 'start_401k', rate: 0.10, personality_match: 'guardian' } }, { text: "Yes, 5% of my salary", consequence: "A modest start to saving.", effects: { special_effect: 'start_401k', rate: 0.05, personality_match: 'guardian' } }, { text: "No, I need the cash right now", consequence: "You'll have more spending money, but may regret it later.", effects: { happiness: -5, personality_match: 'adventurous' } } ] },
                { time_skip: 3, question: "Stage 5: How do you handle your finances?", answers: [ { text: "Invest in a crypto/stock portfolio (High-Risk)", consequence: "Gamble: Huge potential gains or massive losses.", effects: { set_investment_multiplier: 1.7, set_investment_risk: 0.5, personality_match: 'adventurous' } }, { text: "Invest in Index Funds (Safe)", consequence: "Benefit: Slow, steady, reliable growth.", effects: { set_investment_multiplier: 1.1, set_investment_risk: 0.1, personality_match: 'guardian' } }, { text: "Invest in Real Estate", consequence: "Cost: $20k down. Builds equity.", effects: { cash_change: -20000, equity_change: 40000, expense_add: {id: 'rental', label: 'Rental Property', amount: 5000}, creditScore_change: -15, personality_match: 'ambitious'} } ] },
                { time_skip: 2, question: "Stage 6: What about relationships?", answers: [ { text: "Get Married", consequence: "Expenses: +$5k/yr. Deep companionship.", effects: { expense_add: {id: 'partner', label: 'Partner Costs', amount: 5000}, happiness: 20, avatar: {type: 'accessory', icon: 'family'}, personality_match: 'guardian' } }, { text: "Adopt a Pet", consequence: "Expenses: +$2k/yr. Great companionship.", effects: { expense_add: {id: 'pet', label: 'Pet Costs', amount: 2000}, happiness: 10, avatar: {type: 'accessory', icon: 'pet'}, personality_match: 'creative' } }, { text: "Focus on your career for now", consequence: "More time for work, less for connection.", effects: { salary_boost: {id: 'main_job', amount: 10000}, happiness: -5, career_level_change: 1, burnout_change: 5, personality_match: 'ambitious' } } ] },
                { condition: (gs) => gs.expenseBreakdown.student_loan, time_skip: 2, question: "Stage 7: You have student loans. How do you approach them?", answers: [ { text: "Pay aggressively to eliminate them", consequence: "Cost: $50k now. Frees up cash flow for good.", effects: { cash_change: -50000, expense_remove: 'student_loan', happiness: 10, creditScore_change: 50, personality_match: 'guardian' } }, { text: "Continue making minimum payments", consequence: "Benefit: Keep your cash for other things.", effects: { } }, { text: "Refinance for a lower payment", consequence: "Lowers yearly cost, but extends the loan.", effects: { expense_boost: {id: 'student_loan', amount: -2000} } } ] },
                { condition: (gs) => gs.housingType !== 'own', time_skip: 2, question: "Stage 8: You've been renting. What's your next housing move?", answers: [ { text: "Buy a starter home", consequence: "Cost: $25k down. Expenses: +$30k/yr mortgage.", effects: { cash_change: -25000, housing_type: 'own', expense_remove: 'housing', expense_add: {id: 'housing', label: 'Mortgage', amount: 30000}, equity_change: 50000, avatar: {type: 'bg', icon: 'house'}, creditScore_change: -20, personality_match: 'guardian' } }, { text: "Buy a condo", consequence: "Cost: $15k down. Expenses: +$22k/yr mortgage & fees.", effects: { cash_change: -15000, housing_type: 'own', expense_remove: 'housing', expense_add: {id: 'housing', label: 'Mortgage', amount: 22000}, equity_change: 30000, avatar: {type: 'bg', icon: 'apartment'}, creditScore_change: -15, personality_match: 'ambitious' } }, { text: "Move to a nicer apartment", consequence: "Expenses: +$12k/yr. Upgrade your lifestyle.", effects: { expense_boost: {id: 'housing', amount: 12000}, happiness: 5, personality_match: 'creative' } } ] },
                { time_skip: 2, question: "Stage 9: Your company offers a professional development course.", answers: [ { text: "Take it. It's an investment in yourself.", consequence: "Cost: $5k. Could lead to a promotion.", effects: { cash_change: -5000, career_level_change: 1, burnout_change: 5, personality_match: 'ambitious' } }, { text: "Decline. You'd rather have the free time.", consequence: "No cost, but a missed opportunity?", effects: { burnout_change: -5, personality_match: 'adventurous' } } ] },
                { condition: (gs) => gs.avatar.accessory === 'family', time_skip: 2, question: "Stage 10: You're married. Time to think about kids?", answers: [ { text: "Yes, have a child", consequence: "Expenses: +$20k/yr. A new chapter begins!", effects: { expense_add: {id: 'child1', label: 'Child 1 Costs', amount: 20000}, happiness: 25, children_add: 1, personality_match: 'guardian' } }, { text: "Not right now, focus on us", consequence: "Enjoy your time as a couple.", effects: { happiness: 5 } } ] },
                { time_skip: 2, question: "Stage 11: How do you spend your free time?", answers: [ { text: "On expensive hobbies and travel", consequence: "Expenses: +$10k/yr. Live life to the fullest!", effects: { expense_add: {id: 'hobbies', label: 'Hobbies', amount: 10000}, happiness: 15, burnout_change: -10, personality_match: 'adventurous' } }, { text: "On cheap hobbies", consequence: "Low cost, high reward.", effects: { expense_add: {id: 'hobbies', label: 'Hobbies', amount: 1000}, happiness: 10, burnout_change: -5, personality_match: 'creative' } }, { text: "Volunteering in your community", consequence: "Great for happiness, but takes time.", effects: { happiness: 10, personality_match: 'guardian' } } ] },
                { time_skip: 2, question: "Stage 12: A new technology is disrupting your field.", answers: [ { text: "Adapt and learn the new skills", consequence: "Salary: +$20k/yr. Stay relevant.", effects: { salary_boost: {id: 'main_job', amount: 20000}, career_level_change: 1, personality_match: 'ambitious' } }, { text: "Ignore it and hope for the best", consequence: "Risk: Your skills could become obsolete.", effects: { salary_boost: {id: 'main_job', amount: (Math.random() > 0.4 ? -30000 : 0)}, happiness: -5 } } ] },
                { condition: (gs) => gs.children.length > 0 && gs.children.length < 3, time_skip: 2, question: "Stage 13: You have a child. Do you want to have another?", answers: [ { text: "Yes, have another child", consequence: "Expenses: +$18k/yr. A growing family!", effects: { special_effect: 'add_child', personality_match: 'guardian' } }, { text: "No, one is enough", consequence: "Focus your resources and energy.", effects: { happiness: 5 } } ] },
                { time_skip: 2, question: "Stage 14: You're entering mid-life. What is your career focus?", answers: [ { text: "Push for a major promotion", consequence: "Salary: +$30k/yr. High stress.", effects: { career_level_change: 1, salary_boost: {id: 'main_job', amount: 30000}, happiness: -10, burnout_change: 15, personality_match: 'ambitious' } }, { text: "Switch to a less stressful job", consequence: "Salary: -$25k/yr. Better work-life balance.", effects: { career_level_change: -1, salary_boost: {id: 'main_job', amount: -25000}, happiness: 20, burnout_change: -10, personality_match: 'guardian' } } ] },
                { time_skip: 2, question: "Stage 15: Your parents are aging and need some support.", answers: [ { text: "Help them financially", consequence: "Expenses: +$10k/yr. A sense of duty.", effects: { expense_add: {id: 'parents', label: 'Parent Support', amount: 10000}, happiness: 5, personality_match: 'guardian' } }, { text: "Offer your time and support", consequence: "No direct cost, but emotionally taxing.", effects: { happiness: 5, burnout_change: 5, personality_match: 'guardian' } }, { text: "Do nothing", consequence: "Strained relationships.", effects: { happiness: -10 } } ] },
                { time_skip: 2, question: "Stage 16: You're established. How do you spend surplus income?", answers: [ { text: "Luxury Lifestyle", consequence: "Expenses: +$30k/yr. Live for today.", effects: { expense_add: {id: 'luxury', label: 'Luxury', amount: 30000}, happiness: 15, personality_match: 'adventurous' } }, { text: "Save Aggressively for Retirement", consequence: "Benefit: +$100k to retirement. Live frugally.", effects: { retirement_change: 100000, happiness: -5, personality_match: 'ambitious' } } ] },
                { condition: (gs) => gs.housingType === 'own', time_skip: 2, question: "Stage 17: Your home has appreciated. What do you do?", answers: [ { text: "Sell and upgrade to a bigger house", consequence: "Expenses: +$20k/yr. More space, more costs.", effects: { cash_change: (gs) => gs.equity * 0.5, equity_change: (gs) => gs.equity * 0.7, expense_boost: {id: 'housing', amount: 20000}, personality_match: 'ambitious' } }, { text: "Stay put and enjoy the low mortgage", consequence: "Benefit: Financial stability.", effects: { happiness: 10, personality_match: 'guardian' } } ] },
                { time_skip: 2, question: "Stage 18: You're a senior in your field.", answers: [ { text: "Mentor junior colleagues", consequence: "Share your knowledge and give back.", effects: { happiness: 15, career_level_change: 1, personality_match: 'guardian' } }, { text: "Coast to retirement", consequence: "Less stress, but you might get bored.", effects: { burnout_change: -10, personality_match: 'adventurous' } } ] },
                { time_skip: 2, question: "Stage 19: Thinking about your legacy.", answers: [ { text: "Start a scholarship or donate to charity", consequence: "Cost: $50k. Make a difference.", effects: { cash_change: -50000, happiness: 20, personality_match: 'guardian' } }, { text: "Focus on family and travel", consequence: "Enjoy the fruits of your labor.", effects: { expense_add: {id: 'travel', label: 'Travel', amount: 15000}, happiness: 15, personality_match: 'adventurous' } } ] },
                { time_skip: 2, question: "Stage 20: You are approaching retirement. What's your final plan?", answers: [ { text: "Retire completely", consequence: "No more salary. Ultimate freedom.", effects: { happiness: 25, salary_remove: 'main_job', salary_remove: 'side_hustle', personality_match: 'adventurous' } }, { text: "Work part-time in a fun job", consequence: "Salary set to $25k/yr. Stay active.", effects: { salary_remove: 'main_job', salary_remove: 'side_hustle', salary_add: {id: 'main_job', label: 'Part-time Job', amount: 25000}, happiness: 10, personality_match: 'creative' } } ] }
            ];
    
            const minorEvents = [
                { description: "The stock market has a great year! Your investments grow.", effects: { cash_change: (c) => c * 0.1, happiness: 5 } },
                { description: "Inflation is high this year, increasing all your expenses by 10%.", effects: { expense_boost_all: 0.1, happiness: -5 } },
                { description: "You win a small lottery prize!", effects: { cash_change: 15000, happiness: 10 } },
                { description: "Your car breaks down, requiring an expensive repair.", effects: { cash_change: -8000, happiness: -5, creditScore_change: -10 } },
                { description: "You get an unexpected promotion and raise at work!", effects: { salary_boost: {id: 'main_job', amount: 15000}, happiness: 10, career_level_change: 1 } },
                { description: "Your insurance premiums skyrocketed after a policy change.", effects: { expense_add: {id: 'insurance', label: 'Insurance Hike', amount: 5000}, happiness: -5 } },
                { description: "The housing market is booming, increasing your home equity.", effects: { equity_change: 30000, happiness: 5 } },
                { description: "You discover an amazing, inexpensive new hobby.", effects: { happiness: 10 } },
                { description: "A water pipe bursts in your home, requiring a costly fix.", effects: { cash_change: -10000, happiness: -5, creditScore_change: -15 } }
            ];
    
            const majorEvents = [
                {
                    description: "A catastrophic market crash occurs, wiping out 40% of your invested cash.",
                    question: "This is devastating. How do you respond?",
                    choices: [
                        { text: "Panic and sell everything to prevent further loss.", consequence: "Locks in your losses permanently.", effects: { cash_change: (c) => c * -0.1, happiness: -25 } },
                        { text: "Stay the course and hope for recovery.", consequence: "A test of nerve. It could get worse before it gets better.", effects: { happiness: -15, set_investment_risk: 0.7 } },
                        { text: "Delay retirement and start saving aggressively.", consequence: "A painful but practical solution.", effects: { salary_boost: {id: 'main_job', amount: 20000}, happiness: -20 } }
                    ]
                },
                {
                    description: "A global pandemic occurs. Your field is in high demand, but you face immense stress and burnout risk.",
                    question: "Your work-life balance is gone. What do you do?",
                    choices: [
                        { text: "Work insane hours to capitalize on the opportunity.", consequence: "Massive income boost, massive happiness cost.", effects: { salary_boost: {id: 'main_job', amount: 50000}, happiness: -30, burnout_change: 20 } },
                        { text: "Quit your job to protect your mental health.", consequence: "A drastic move for self-preservation.", effects: { salary_remove: 'main_job', cash_change: -10000, happiness: 20 } },
                        { text: "Negotiate for better conditions or hazard pay.", consequence: "A gamble, but could lead to a better outcome.", effects: { salary_boost: {id: 'main_job', amount: (Math.random() > 0.5 ? 25000 : 0)}, happiness: 5 } }
                    ]
                },
                {
                    description: "You've been diagnosed with a serious but manageable health condition.",
                    question: "This changes your perspective. How do you adjust your life?",
                    choices: [
                        { text: "Prioritize health above all. Reduce work hours and stress.", consequence: "Less income, but more years to enjoy life.", effects: { salary_boost: {id: 'main_job', amount: -30000}, happiness: 20, burnout_change: -15 } },
                        { text: "Sell your large house and downsize.", consequence: "Gain cash, lose equity, lower expenses.", effects: { cash_change: 100000, equity_change: (e)=>-e, expense_remove: 'housing', expense_add: {id: 'housing', label: 'New Housing', amount: 18000}, happiness: 10, avatar: {type: 'bg', icon: 'apartment'} } },
                        { text: "Ignore the doctor's advice and keep pushing hard at work.", consequence: "High risk of future health crises.", effects: { happiness: (Math.random() > 0.3 ? -40 : -15), burnout_change: 10 } }
                    ]
                }
            ];
            
            const childEvents = [
                { description: "Your child is a gifted athlete! Lessons and travel cost an extra $5k/yr.", effects: { expense_add: {id: 'child_sports', label: 'Child Sports', amount: 5000}, happiness: 10 } },
                { description: "Uh oh, braces are needed. That's a one-time $8,000 cost.", effects: { cash_change: -8000, happiness: -5 } },
                { description: "Your child wins a university scholarship, saving you $50,000 in future costs!", effects: { cash_change: 50000, happiness: 25 } },
                { description: "Your child needs a tutor, adding $4k/yr to your expenses.", effects: { expense_add: {id: 'child_tutor', label: 'Child Tutor', amount: 4000}, happiness: -5 } }
            ];
    
            let currentQuestionIndex = 0;
            let gameState = { cash: 5000, retirement: 0, equity: 0, salaryBreakdown: {}, expenseBreakdown: {'base': {label: 'Base Living Costs', amount: 40000}}, happiness: 50, investment_multiplier: 1.0, investment_risk: 0, avatar: { bg: null, item: null, accessory: null }, currentAge: 18, currentYear: 2025, housingType: null, children: [], careerType: null, sector: null, careerLevel: 0, burnout: 0, creditScore: 650, qualifications: [], personality: null, personalityScores: { ambitious: 0, guardian: 0, creative: 0, adventurous: 0 } };
            let filteredGameData = [];
            let currentEffects = {};
            let personalityQuizIndex = 0;
    
            const startScreen = document.getElementById('start-screen'), quizScreen = document.getElementById('quiz-screen'), resultScreen = document.getElementById('result-screen');
            const questionText = document.getElementById('question-text'), answersContainer = document.getElementById('answers-container');
            const progressBar = document.getElementById('progress-bar');
            const cashStat = document.getElementById('cash-stat'), retirementStat = document.getElementById('retirement-stat'), salaryStat = document.getElementById('salary-stat'), expenseStat = document.getElementById('expense-stat'), happinessStat = document.getElementById('happiness-stat');
            const creditScoreValue = document.getElementById('credit-stat-value'), creditScoreRank = document.getElementById('credit-stat-rank');
            const eventModal = document.getElementById('event-modal'), eventText = document.getElementById('event-text');
            const majorEventModal = document.getElementById('major-event-modal'), majorEventDescription = document.getElementById('major-event-description'), majorEventQuestion = document.getElementById('major-event-question'), majorEventChoices = document.getElementById('major-event-choices');
            const startError = document.getElementById('start-error');
            const breakdownModal = document.getElementById('breakdown-modal');
            const debtModal = document.getElementById('debt-modal');
            const backButton = document.getElementById('back-button');
            const profileModal = document.getElementById('profile-modal');
            const confirmationModal = document.getElementById('confirmation-modal');
            const personalityQuizScreen = document.getElementById('personality-quiz-screen');
    
            const startQuiz = () => {
                const startAgeInput = document.getElementById('startAge');
                const startYearInput = document.getElementById('startYear');
                const startAge = startAgeInput.value;
                const startYear = startYearInput.value;
    
                if (!startAge || !startYear || parseInt(startAge) < 1 || parseInt(startYear) < 1950) {
                    startError.classList.remove('hidden');
                    return;
                }
                startError.classList.add('hidden');
                
                gameState.currentAge = parseInt(startAge);
                gameState.currentYear = parseInt(startYear);
    
                startScreen.classList.add('hidden');
                personalityQuizScreen.classList.remove('hidden');
                personalityQuizScreen.classList.add('fade-in');
                displayPersonalityQuestion();
            }
    
            const displayPersonalityQuestion = () => {
                if (personalityQuizIndex < personalityQuestions.length) {
                    const stage = personalityQuestions[personalityQuizIndex];
                    document.getElementById('personality-question-text').textContent = stage.question;
                    const container = document.getElementById('personality-answers-container');
                    container.innerHTML = '';
                    stage.answers.forEach(answer => {
                        const button = document.createElement('button');
                        button.className = "w-full text-center p-4 rounded-lg bg-slate-100 dark:bg-slate-800/70 hover:bg-cyan-100 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-all duration-200 font-semibold";
                        button.textContent = answer.text;
                        button.onclick = () => {
                            gameState.personalityScores[answer.type]++;
                            personalityQuizIndex++;
                            displayPersonalityQuestion();
                        };
                        container.appendChild(button);
                    });
                    document.getElementById('personality-progress-bar').style.width = `${(personalityQuizIndex / personalityQuestions.length) * 100}%`;
                } else {
                    const scores = gameState.personalityScores;
                    const personality = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
                    gameState.personality = personality;
                    startMainGame();
                }
            };
    
            const startMainGame = () => {
                personalityQuizScreen.classList.add('hidden');
                quizScreen.classList.remove('hidden');
                quizScreen.classList.add('fade-in');
                displayQuestion();
            };
            
            const filterGameStages = () => {
                filteredGameData = gameData.filter(stage => {
                    if (stage.condition) {
                        return stage.condition(gameState);
                    }
                    return true;
                });
            }
            
            const showBreakdown = (type) => {
                const data = (type === 'salary') ? gameState.salaryBreakdown : gameState.expenseBreakdown;
                const title = (type === 'salary') ? 'Salary Breakdown' : 'Expense Breakdown';
                const listEl = document.getElementById('breakdown-list');
                
                document.getElementById('breakdown-title').textContent = title;
                listEl.innerHTML = '';
    
                if(Object.keys(data).length === 0) {
                     const li = document.createElement('li');
                     li.className = 'text-slate-500';
                     li.textContent = 'No items to display.';
                     listEl.appendChild(li);
                } else {
                    Object.values(data).forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center text-slate-700';
                        const sign = (type === 'expenses') ? '-' : '+';
                        li.innerHTML = `<span>${item.label}</span><span class="font-semibold">${sign}$${item.amount.toLocaleString()}/yr</span>`;
                        listEl.appendChild(li);
                    });
                }
                breakdownModal.classList.remove('hidden');
                setTimeout(() => { breakdownModal.classList.remove('opacity-0', 'scale-95'); }, 10);
            }
    
            const hideBreakdown = () => {
                breakdownModal.classList.add('opacity-0', 'scale-95');
                setTimeout(() => { breakdownModal.classList.add('hidden'); }, 300);
            }
    
            const showProfileModal = () => {
                document.getElementById('profile-profession').textContent = gameState.salaryBreakdown.main_job?.label || 'Unemployed';
                document.getElementById('profile-qualifications').textContent = gameState.qualifications.join(', ') || 'None';
                
                const lifestyleList = document.getElementById('profile-lifestyle');
                lifestyleList.innerHTML = '';
                const lifestyleItems = Object.keys(gameState.expenseBreakdown)
                    .filter(key => ['hobbies', 'luxury', 'travel', 'pet', 'partner'].includes(key))
                    .map(key => gameState.expenseBreakdown[key].label);
    
                if(lifestyleItems.length > 0) {
                    lifestyleItems.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        lifestyleList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.textContent = 'A simple life.';
                    lifestyleList.appendChild(li);
                }
                
                document.getElementById('profile-main-view').classList.remove('hidden');
                document.getElementById('profile-action-view').classList.add('hidden');
                profileModal.classList.remove('hidden');
                setTimeout(() => { profileModal.classList.remove('opacity-0', 'scale-95'); }, 10);
            };
    
            const hideProfileModal = () => {
                profileModal.classList.add('opacity-0', 'scale-95');
                setTimeout(() => { profileModal.classList.add('hidden'); }, 300);
            };
    
            const showActionModal = (type) => {
                 document.getElementById('profile-main-view').classList.add('hidden');
                 const actionView = document.getElementById('profile-action-view')
                 actionView.classList.remove('hidden');
                 const container = document.getElementById('action-options-container');
                 const title = document.getElementById('action-title');
                 container.innerHTML = '';
    
                 if(type === 'career') {
                    title.textContent = 'Change Career';
                    const backToSchool = document.createElement('button');
                    backToSchool.className = 'w-full text-left p-4 rounded-lg bg-slate-100 dark:bg-slate-800/70 hover:bg-cyan-100 dark:hover:bg-slate-700';
                    backToSchool.innerHTML = `<span class="answer-text font-semibold">Go back to school (4 years)</span><span class="answer-consequence">Cost: $80k. Reset your career path.</span>`;
                    backToSchool.onclick = () => {
                        selectAnswer({cash_change: -80000, time_skip: 4, salary_remove: 'main_job', salary_remove: 'side_hustle', sector: null, career_type: null, career_level: 0, qualifications: []});
                        hideProfileModal();
                    };
                    container.appendChild(backToSchool);
                 } else { // lifestyle
                    title.textContent = 'Adjust Lifestyle';
                    const addHobby = document.createElement('button');
                    addHobby.className = 'w-full text-left p-4 rounded-lg bg-slate-100 dark:bg-slate-800/70 hover:bg-cyan-100 dark:hover:bg-slate-700';
                    addHobby.innerHTML = `<span class="answer-text font-semibold">Take up an expensive hobby</span><span class="answer-consequence">Expenses: +$10k/yr. Happiness +15</span>`;
                    addHobby.onclick = () => {
                        applyEffects({expense_add: {id: 'hobbies', label: 'Hobbies', amount: 10000}, happiness: 15});
                        hideProfileModal();
                        updateFinancialsUI();
                    };
                    container.appendChild(addHobby);
                    
                    if(gameState.expenseBreakdown.hobbies){
                        const removeHobby = document.createElement('button');
                        removeHobby.className = 'w-full text-left p-4 rounded-lg bg-slate-100 dark:bg-slate-800/70 hover:bg-cyan-100 dark:hover:bg-slate-700';
                        removeHobby.innerHTML = `<span class="answer-text font-semibold">Drop expensive hobby</span><span class="answer-consequence">Expenses: -$10k/yr. Happiness -10</span>`;
                        removeHobby.onclick = () => {
                            const amountToRemove = gameState.expenseBreakdown.hobbies.amount;
                            applyEffects({expense_remove: 'hobbies', happiness: -10});
                            hideProfileModal();
                            updateFinancialsUI();
                        };
                        container.appendChild(removeHobby);
                    }
                 }
            }
    
    
            const updateAvatar = () => {
                const bgContainer = document.getElementById('avatar-bg');
                const itemContainer = document.getElementById('avatar-item');
                const accessoryContainer = document.getElementById('avatar-accessory');
                const newBg = gameState.avatar.bg ? avatarIcons[gameState.avatar.bg] : '';
                const newItem = gameState.avatar.item ? avatarIcons[gameState.avatar.item] : '';
                const newAccessory = gameState.avatar.accessory ? avatarIcons[gameState.avatar.accessory] : '';
                if (bgContainer.innerHTML !== newBg) bgContainer.innerHTML = newBg;
                if (itemContainer.innerHTML !== newItem) itemContainer.innerHTML = newItem;
                if (accessoryContainer.innerHTML !== newAccessory) accessoryContainer.innerHTML = newAccessory;
            }
            
            const updateTimeline = () => {
                 document.getElementById('current-age').textContent = `Age: ${gameState.currentAge}`;
                 document.getElementById('current-year').textContent = `Year: ${gameState.currentYear}`;
            }
    
            const updateFinancialsUI = () => {
                const totalSalary = Object.values(gameState.salaryBreakdown).reduce((sum, item) => sum + item.amount, 0);
                const totalExpenses = Object.values(gameState.expenseBreakdown).reduce((sum, item) => sum + item.amount, 0);
    
                cashStat.textContent = `$${Math.round(gameState.cash).toLocaleString()}`;
                retirementStat.textContent = `$${Math.round(gameState.retirement).toLocaleString()}`;
                salaryStat.textContent = `$${Math.round(totalSalary/1000)}k/yr`;
                expenseStat.textContent = `-$${Math.round(totalExpenses/1000)}k/yr`;
                
                creditScoreValue.textContent = gameState.creditScore;
                if (gameState.creditScore >= 800) creditScoreRank.textContent = "Excellent";
                else if (gameState.creditScore >= 740) creditScoreRank.textContent = "Very Good";
                else if (gameState.creditScore >= 670) creditScoreRank.textContent = "Good";
                else if (gameState.creditScore >= 580) creditScoreRank.textContent = "Fair";
                else creditScoreRank.textContent = "Poor";
    
                let happinessEmoji = "ðŸ˜";
                if (gameState.happiness >= 80) happinessEmoji = "ðŸ˜";
                else if (gameState.happiness >= 60) happinessEmoji = "ðŸ˜Š";
                else if (gameState.happiness < 40) happinessEmoji = "ðŸ˜’";
                else if (gameState.happiness < 25) happinessEmoji = "ðŸ˜«";
                happinessStat.textContent = happinessEmoji;
            }
    
            const runTimeSkipUpdate = (years) => {
                if(!years) return;
                
                for(let i = 0; i < years; i++) {
                     if (gameState.careerType === 'creator' && gameState.salaryBreakdown.main_job) {
                        gameState.salaryBreakdown.main_job.amount = (Math.random() > 0.65 ? 120000 : 20000) + (gameState.careerLevel * 5000);
                    }
    
                    const inflationRate = gameState.currentYear < 2027 ? 0.03 : 0.02;
                    Object.keys(gameState.expenseBreakdown).forEach(key => {
                        if(key !== 'student_loan' && !key.startsWith('loan_'))
                            gameState.expenseBreakdown[key].amount *= (1 + inflationRate);
                    });
    
                    const totalSalary = Object.values(gameState.salaryBreakdown).reduce((sum, item) => sum + item.amount, 0);
                    const totalExpenses = Object.values(gameState.expenseBreakdown).reduce((sum, item) => sum + item.amount, 0);
                    const netIncome = totalSalary - totalExpenses;
                    gameState.cash += netIncome;
    
                    const marketFluctuation = (Math.random() - 0.45) / 10;
                    gameState.equity *= (1 + marketFluctuation);
    
                    if (gameState.cash > 0 && gameState.investment_multiplier > 1.0) {
                        let investedAmount = gameState.cash * 0.5;
                        let investmentReturn = investedAmount * (gameState.investment_multiplier - 1);
                        if (Math.random() < gameState.investment_risk) {
                            gameState.cash -= investmentReturn * 2.5; 
                        } else {
                            gameState.cash += investmentReturn;
                        }
                    }
                    if(gameState.retirement > 0) {
                         gameState.retirement *= 1.07;
                    }
                    
                    if(gameState.cash > 0 && Object.keys(gameState.expenseBreakdown).some(k => k.includes('loan'))) {
                        updateCreditScore(2);
                    } else if (gameState.cash < 0) {
                        updateCreditScore(-5);
                    }
    
                    gameState.currentAge++;
                    gameState.currentYear++;
                    gameState.children.forEach(child => child.age++);
                }
    
                if(gameState.burnout >= 25) {
                    triggerBurnoutEvent();
                    gameState.burnout = 0;
                }
            }
    
            const displayQuestion = () => {
                if (currentQuestionIndex > 0) {
                    const prevStage = filteredGameData[currentQuestionIndex - 1];
                    runTimeSkipUpdate(prevStage.time_skip);
                }
                filterGameStages(); 
                updateAvatar();
                updateTimeline();
                updateFinancialsUI();
    
                if (currentQuestionIndex < filteredGameData.length) {
                    const stage = filteredGameData[currentQuestionIndex];
                    questionText.textContent = stage.question;
                    answersContainer.innerHTML = '';
                    
                    if (stage.back) {
                        backButton.classList.remove('hidden');
                    } else {
                        backButton.classList.add('hidden');
                    }
    
                    stage.answers.forEach(answer => {
                        const button = document.createElement('button');
                        
                        button.className = "w-full text-left p-4 rounded-lg bg-slate-100 dark:bg-slate-800/70 hover:bg-cyan-100 dark:hover:bg-slate-700 hover:ring-2 hover:ring-cyan-200 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-all duration-200";
                        button.addEventListener('click', () => {
                            showConfirmation(answer.effects);
                        });
                        
                        const answerTextEl = document.createElement('span');
                        answerTextEl.className = 'answer-text font-semibold';
                        answerTextEl.textContent = answer.text;
                        const consequenceText = document.createElement('span');
                        consequenceText.className = 'answer-consequence';
                        consequenceText.textContent = answer.consequence;
                        button.appendChild(answerTextEl);
                        button.appendChild(consequenceText);
                        answersContainer.appendChild(button);
                    });
                    
                    if (stage.question.includes("How do you handle your finances?")) {
                        if (gameState.cash < 2000) {
                            answersContainer.querySelectorAll('button').forEach(button => {
                                 button.disabled = true;
                                 button.classList.add('cursor-not-allowed', 'text-gray-400');
                            });
                            const noInvest = document.createElement('p');
                            noInvest.className = 'md:col-span-2 text-center text-slate-500';
                            noInvest.textContent = 'You need at least $2,000 cash to start investing.';
                            answersContainer.appendChild(noInvest);
                        }
                    }
    
                    updateProgressBar();
                } else {
                    showResult();
                }
            }
    
            const showConfirmation = (effects) => {
                currentEffects = effects;
                const effectsContainer = document.getElementById('confirmation-effects');
                effectsContainer.innerHTML = '';
                
                const addEffectToList = (label, value, color = 'text-slate-800') => {
                    const p = document.createElement('p');
                    p.className = `flex justify-between ${color}`;
                    p.innerHTML = `<span>${label}:</span><span class="font-bold">${value}</span>`;
                    effectsContainer.appendChild(p);
                }
                
                if(effects.cash_change && typeof effects.cash_change === 'number') addEffectToList('Cash', `${effects.cash_change > 0 ? '+' : ''}$${effects.cash_change.toLocaleString()}`, effects.cash_change > 0 ? 'text-green-600' : 'text-red-600');
                if(effects.expense_add) addEffectToList('Annual Expenses', `+$${effects.expense_add.amount.toLocaleString()}`, 'text-red-600');
                if(effects.salary_add) addEffectToList('Annual Salary', `+$${effects.salary_add.amount.toLocaleString()}`, 'text-green-600');
                
                let happinessChange = effects.happiness || 0;
                if (effects.personality_match) {
                    if (effects.personality_match === gameState.personality) {
                        happinessChange *= 1.5;
                    } else {
                        happinessChange *= 0.5;
                    }
                }
                happinessChange = Math.round(happinessChange);
                if(happinessChange !== 0) addEffectToList('Happiness', `${happinessChange > 0 ? '+' : ''}${happinessChange}`, happinessChange > 0 ? 'text-green-600' : 'text-red-600');
                
                if (effectsContainer.innerHTML === '') {
                     const p = document.createElement('p');
                     p.className = `text-slate-600`;
                     p.textContent = 'No immediate financial or happiness changes.';
                     effectsContainer.appendChild(p);
                }
    
                confirmationModal.classList.remove('hidden');
                setTimeout(() => confirmationModal.classList.remove('opacity-0', 'scale-95'), 10);
            }
    
            const hideConfirmationModal = () => {
                 confirmationModal.classList.add('opacity-0', 'scale-95');
                 setTimeout(() => confirmationModal.classList.add('hidden'), 300);
            }
    
            const confirmAndProceed = () => {
                hideConfirmationModal();
                let cost = 0;
                if (currentEffects.cash_change && currentEffects.cash_change < 0) {
                    cost = Math.abs(currentEffects.cash_change);
                }
                if (cost > 0 && gameState.cash < cost) {
                    promptForDebt(cost, currentEffects);
                } else {
                    selectAnswer(currentEffects);
                }
            }
    
            const promptForDebt = (cost, effects) => {
                const debtAmount = cost - gameState.cash;
                const debtButtons = document.getElementById('debt-buttons');
                const debtTitle = document.getElementById('debt-title');
    
                if (gameState.creditScore < 580) { // Poor credit
                    document.getElementById('debt-description').textContent = `You are short $${debtAmount.toLocaleString()}. Unfortunately, with a poor credit score of ${gameState.creditScore}, your loan application was denied.`;
                    debtButtons.classList.add('hidden');
                    debtTitle.textContent = "Loan Denied";
                } else {
                    debtButtons.classList.remove('hidden');
                    debtTitle.textContent = "Unaffordable Choice";
                    let interestRate = 0.25; // Fair credit
                    if (gameState.creditScore >= 670) interestRate = 0.20; // Good
                    if (gameState.creditScore >= 740) interestRate = 0.15; // Very Good/Excellent
    
                    const debtPayment = Math.round(debtAmount * interestRate);
                    document.getElementById('debt-description').textContent = `You are short $${debtAmount.toLocaleString()}. Based on your credit score, you can take a high-interest personal loan. This will add $${debtPayment.toLocaleString()}/yr to your expenses and cause significant stress.`;
                    
                    const takeDebtButton = document.getElementById('take-debt-button');
                    
                    const takeDebtHandler = () => {
                        const loanEffects = {
                            cash_change: debtAmount,
                            expense_add: {id: `loan_${Math.random()}`, label: 'Personal Loan', amount: debtPayment},
                            happiness: -20,
                            creditScore_change: -50
                        };
                        const finalEffects = {...effects, ...loanEffects, cash_change: (effects.cash_change || 0) + debtAmount};
                        selectAnswer(finalEffects);
                        hideDebtModal();
                    };
                    takeDebtButton.onclick = takeDebtHandler;
                }
    
                debtModal.classList.remove('hidden');
                setTimeout(() => debtModal.classList.remove('opacity-0', 'scale-95'), 10);
            }
    
            const hideDebtModal = () => {
                debtModal.classList.add('opacity-0', 'scale-95');
                setTimeout(() => debtModal.classList.add('hidden'), 300);
            }
    
            const updateCreditScore = (change) => {
                gameState.creditScore += change;
                if (gameState.creditScore > 850) gameState.creditScore = 850;
                if (gameState.creditScore < 300) gameState.creditScore = 300;
            }
            
            const applyEffects = (effects) => {
                if (!effects) return;
                
                let happinessChange = effects.happiness || 0;
                if (effects.personality_match) {
                    if (effects.personality_match === gameState.personality) {
                        happinessChange *= 1.5;
                    } else {
                        happinessChange *= 0.5;
                    }
                }
                gameState.happiness += Math.round(happinessChange);
    
    
                if (effects.special_effect === 'add_child') {
                    const childNum = gameState.children.length + 1;
                    gameState.expenseBreakdown[`child${childNum}`] = { label: `Child ${childNum} Costs`, amount: 18000 };
                    gameState.children.push({ age: 0 });
                }
                if (effects.special_effect === 'start_401k') {
                    const totalSalary = Object.values(gameState.salaryBreakdown).reduce((sum, item) => sum + item.amount, 0);
                    const contribution = totalSalary * effects.rate;
                    gameState.expenseBreakdown['401k'] = {label: '401k Contribution', amount: contribution};
                    gameState.retirement += contribution;
                }
                
                if (effects.cash_change) gameState.cash += (typeof effects.cash_change === 'function') ? effects.cash_change(gameState.cash) : effects.cash_change;
                if (effects.equity_change) gameState.equity += (typeof effects.equity_change === 'function') ? effects.equity_change(gameState.equity) : effects.equity_change;
                if (effects.set_investment_multiplier) gameState.investment_multiplier = effects.set_investment_multiplier;
                if (effects.set_investment_risk) gameState.investment_risk = effects.set_investment_risk;
    
                if (effects.salary_add) gameState.salaryBreakdown[effects.salary_add.id] = { label: effects.salary_add.label, amount: effects.salary_add.amount };
                if (effects.salary_remove && gameState.salaryBreakdown[effects.salary_remove]) delete gameState.salaryBreakdown[effects.salary_remove];
                if (effects.salary_boost && gameState.salaryBreakdown[effects.salary_boost.id]) gameState.salaryBreakdown[effects.salary_boost.id].amount += effects.salary_boost.amount;
                
                if (effects.expense_add) gameState.expenseBreakdown[effects.expense_add.id] = { label: effects.expense_add.label, amount: effects.expense_add.amount };
                if (effects.expense_remove && gameState.expenseBreakdown[effects.expense_remove]) delete gameState.expenseBreakdown[effects.expense_remove];
                if (effects.expense_boost && gameState.expenseBreakdown[effects.expense_boost.id]) gameState.expenseBreakdown[effects.expense_boost.id].amount += effects.expense_boost.amount;
                if (effects.expense_boost_all) {
                    for (const key in gameState.expenseBreakdown) {
                        gameState.expenseBreakdown[key].amount *= (1 + effects.expense_boost_all);
                    }
                }
                if(effects.retirement_change) gameState.retirement += effects.retirement_change;
                if(effects.career_level_change) gameState.careerLevel += effects.career_level_change;
                if(effects.burnout_change) gameState.burnout += effects.burnout_change;
                if(effects.creditScore_change) updateCreditScore(effects.creditScore_change);
    
                if (effects.children_add) {
                    for(let i=0; i<effects.children_add; i++) {
                        gameState.children.push({ age: 0 });
                    }
                }
                if (effects.housing_type) gameState.housingType = effects.housing_type;
                if (effects.career_type) gameState.careerType = effects.career_type;
                if (effects.sector) gameState.sector = effects.sector;
                if (effects.avatar) gameState.avatar[effects.avatar.type] = effects.avatar.icon;
                if (effects.add_qualification) gameState.qualifications.push(effects.add_qualification);
            }
    
            const selectAnswer = (effects) => {
                applyEffects(effects);
                currentQuestionIndex++;
                
                const majorEventChance = 0.15; 
                const minorEventChance = 0.20;
                const childEventChance = 0.25;
    
                if (gameState.careerType) {
                    if (gameState.children.length > 0 && Math.random() < childEventChance) {
                        triggerChildEvent();
                    } else if (Math.random() < majorEventChance && currentQuestionIndex < filteredGameData.length - 2 && currentQuestionIndex > 2) {
                        triggerMajorEvent();
                    } else if (Math.random() < minorEventChance && currentQuestionIndex < filteredGameData.length) {
                        triggerMinorEvent();
                    } else {
                        continueToNextQuestion();
                    }
                } else {
                     continueToNextQuestion();
                }
            }
            
            const goBack = () => {
                gameState.sector = null;
                currentQuestionIndex = 0;
                continueToNextQuestion();
            }
    
            const continueToNextQuestion = () => {
                quizScreen.classList.remove('fade-in');
                void quizScreen.offsetWidth;
                quizScreen.classList.add('fade-in');
                displayQuestion();
            }
    
            const triggerMinorEvent = () => {
                const event = minorEvents[Math.floor(Math.random() * minorEvents.length)];
                applyEffects(event.effects);
                eventText.textContent = event.description;
                
                eventModal.classList.remove('hidden');
                eventModal.style.display = 'flex';
                setTimeout(() => { eventModal.classList.remove('opacity-0', 'scale-95'); }, 10);
    
                setTimeout(() => {
                    eventModal.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => {
                        eventModal.classList.add('hidden');
                        eventModal.style.display = 'none';
                        continueToNextQuestion();
                    }, 300);
                }, 3000);
            }
    
            const triggerChildEvent = () => {
                const event = childEvents[Math.floor(Math.random() * childEvents.length)];
                applyEffects(event.effects);
                eventText.textContent = `A Child Event: ${event.description}`;
                
                eventModal.classList.remove('hidden');
                eventModal.style.display = 'flex';
                setTimeout(() => { eventModal.classList.remove('opacity-0', 'scale-95'); }, 10);
    
                setTimeout(() => {
                    eventModal.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => {
                        eventModal.classList.add('hidden');
                        eventModal.style.display = 'none';
                        continueToNextQuestion();
                    }, 300);
                }, 3000);
            }
            
            const triggerBurnoutEvent = () => {
                eventText.textContent = "You've pushed yourself too hard and burned out! You're forced to take a lower-stress, lower-paying job to recover.";
                applyEffects({ salary_remove: 'main_job', salary_add: {id: 'main_job', label: 'Recovery Job', amount: 40000}, happiness: -20, salary_remove: 'side_hustle' });
                
                eventModal.classList.remove('hidden');
                eventModal.style.display = 'flex';
                setTimeout(() => { eventModal.classList.remove('opacity-0', 'scale-95'); }, 10);
    
                setTimeout(() => {
                    eventModal.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => {
                        eventModal.classList.add('hidden');
                        eventModal.style.display = 'none';
                        continueToNextQuestion();
                    }, 300);
                }, 3500);
            }
    
            const triggerMajorEvent = () => {
                const event = majorEvents[Math.floor(Math.random() * majorEvents.length)];
                majorEventDescription.textContent = event.description;
                majorEventQuestion.textContent = event.question;
                majorEventChoices.innerHTML = '';
    
                event.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = "w-full text-left p-3 rounded-lg bg-slate-200 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-red-500 transition-all duration-200";
                    
                    const answerTextEl = document.createElement('span');
                    answerTextEl.className = 'answer-text font-semibold';
                    answerTextEl.textContent = choice.text;
    
                    const consequenceText = document.createElement('span');
                    consequenceText.className = 'answer-consequence text-slate-600';
                    consequenceText.textContent = choice.consequence;
                    
                    button.appendChild(answerTextEl);
                    button.appendChild(consequenceText);
                    button.addEventListener('click', () => resolveMajorEvent(choice.effects));
                    majorEventChoices.appendChild(button);
                });
                
                majorEventModal.classList.remove('hidden');
                majorEventModal.style.display = 'flex';
                setTimeout(() => { majorEventModal.classList.remove('opacity-0', 'scale-95'); }, 10);
            }
    
            const resolveMajorEvent = (effects) => {
                applyEffects(effects);
                majorEventModal.classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    majorEventModal.classList.add('hidden');
                    majorEventModal.style.display = 'none';
                    continueToNextQuestion();
                }, 300);
            }
    
            const updateProgressBar = () => {
                progressBar.style.width = `${(filteredGameData.indexOf(filteredGameData[currentQuestionIndex]) / filteredGameData.length) * 100}%`;
            }
    
            const showResult = () => {
                let finalNetWorth = Math.round(gameState.cash + gameState.equity + gameState.retirement);
                updateFinancialsUI();
    
                resultScreen.classList.remove('hidden');
                quizScreen.classList.add('hidden');
    
                let finalHappiness = gameState.happiness;
                let description = "";
    
                if (finalNetWorth > 1000000 && finalHappiness >= 80) {
                    description = `A true master of life! You achieved incredible financial success, ending with a net worth of $${finalNetWorth.toLocaleString()}, while also cultivating deep happiness. Your journey is a testament to smart choices, resilience through unexpected events, and prioritizing what truly matters.`;
                } else if (finalNetWorth > 1500000 && finalHappiness < 50) {
                    description = `Your ambition was boundless, and it paid off. You built a financial empire, ending with a staggering net worth of $${finalNetWorth.toLocaleString()}. This relentless pursuit of wealth, however, left little room for personal joy. You won the game, but at what cost?`;
                } else if (finalNetWorth < 150000 && finalHappiness >= 95) {
                    description = `You defined success on your own terms. Though your final net worth is a modest $${finalNetWorth.toLocaleString()}, your life was overflowing with joy, relationships, and fulfillment. Your story is a powerful reminder that the richest life isn't always about money.`;
                } else if (finalNetWorth < 0) {
                    description = `Life threw its toughest challenges at you. A series of difficult circumstances and major unforeseen events led to ending in debt with a net worth of $${finalNetWorth.toLocaleString()}. It's a tough outcome, but every journey has lessons, and yours is one of resilience in the face of hardship.`;
                } else {
                    description = `You navigated life with a steady hand, weathering its storms and embracing its opportunities. You built a comfortable, stable life, ending with a net worth of $${finalNetWorth.toLocaleString()} and a content state of mind. Your journey was one of balance, security, and quiet satisfaction.`;
                }
                document.getElementById('result-description').textContent = description;
            }
            
            document.getElementById('start-button').addEventListener('click', startQuiz);
            document.getElementById('salary-breakdown-button').addEventListener('click', () => showBreakdown('salary'));
            document.getElementById('expenses-breakdown-button').addEventListener('click', () => showBreakdown('expenses'));
            document.getElementById('hide-breakdown-button').addEventListener('click', hideBreakdown);
            document.getElementById('cancel-debt-button').addEventListener('click', hideDebtModal);
            document.getElementById('back-button').addEventListener('click', goBack);
            document.getElementById('avatar-button').addEventListener('click', showProfileModal);
            document.getElementById('hide-profile-button').addEventListener('click', hideProfileModal);
            document.getElementById('change-career-button').addEventListener('click', () => showActionModal('career'));
            document.getElementById('change-lifestyle-button').addEventListener('click', () => showActionModal('lifestyle'));
            document.getElementById('confirm-choice-button').addEventListener('click', confirmAndProceed);
            document.getElementById('cancel-choice-button').addEventListener('click', hideConfirmationModal);
}


    useEffect(() => {
        if (view === 'life') {
            initLifeChoices();
        }
    }, [view]);

            handleStartLifeSimulation();
    const handleShowSimulationsView = useCallback(() => {
        setActiveQuiz(null);
        setView('simulations');
    }, []);

    const handleStartLifeSimulation = useCallback(() => {
        setActiveQuiz(null);
        setView('life');
    }, []);

            case 'simulations':
                return <SimulationsView onStartLifeSimulation={handleStartLifeSimulation} />;
            case 'life':
                return <LifeChoicesView />;
                    onShowSimulations={handleShowSimulationsView}
                    activePanel={
                        view === 'profile'
                            ? 'profile'
                            : view === 'settings'
                            ? 'settings'
                            : view === 'simulations' || view === 'life'
                            ? 'simulations'
                            : null
                    }
function SimulationsView({ onStartLifeSimulation }) {
    return (
        <div className="w-full flex flex-col gap-8 fade-in text-slate-800 dark:text-slate-100">
            <div className="space-y-4">
                <span className="inline-flex items-center w-fit rounded-full bg-cyan-600 dark:bg-cyan-500 px-3 py-1 text-sm font-semibold text-white">
                    Interactive practice scenarios
                </span>
                <div className="space-y-3">
                    <h1 className="text-3xl font-bold text-slate-900 dark:text-slate-100">Simulations Hub</h1>
                    <p className="text-base text-slate-600 dark:text-slate-300 max-w-3xl">
                        Explore immersive decision-making experiences. These simulations are ungraded sandboxes where your choices change the story in real time.
                    </p>
                </div>
            </div>
            <div className="grid gap-6 lg:grid-cols-2">
                <article className="content-card bg-white dark:bg-slate-900/90 border border-cyan-200/70 dark:border-cyan-500/50 rounded-2xl shadow-xl p-6 sm:p-8 flex flex-col gap-5">
                    <div className="space-y-3">
                        <span className="inline-flex items-center w-fit rounded-full px-3 py-1 text-sm font-semibold text-cyan-700 dark:text-cyan-300 border border-cyan-200/70 dark:border-cyan-500/50 bg-cyan-50 dark:bg-slate-800/70">
                            Life simulation
                        </span>
                        <h2 className="text-2xl font-semibold text-slate-900 dark:text-slate-100">Life Choices</h2>
                        <p className="text-slate-600 dark:text-slate-300">
                            Build a life from age 18 to retirement. Choose jobs, housing, saving habits, and respond to surprise events while you watch cash, debt, and happiness move together.
                        </p>
                    </div>
                    <ul className="space-y-2 text-sm text-slate-600 dark:text-slate-300">
                        <li className="flex items-start gap-2">
                            <span className="mt-1 h-2 w-2 rounded-full bg-cyan-500"></span>
                            <span>Experiment with career paths, housing, and lifestyle trade-offs.</span>
                        </li>
                        <li className="flex items-start gap-2">
                            <span className="mt-1 h-2 w-2 rounded-full bg-cyan-500"></span>
                            <span>Track cash flow, retirement savings, credit, and happiness with every move.</span>
                        </li>
                        <li className="flex items-start gap-2">
                            <span className="mt-1 h-2 w-2 rounded-full bg-cyan-500"></span>
                            <span>Face random twistsâ€”from market booms to family milestonesâ€”and adapt on the fly.</span>
                        </li>
                    </ul>
                    <button
                        type="button"
                        onClick={onStartLifeSimulation}
                        className="self-start px-4 py-2 rounded-lg font-semibold bg-cyan-600 dark:bg-cyan-500 text-white hover:bg-cyan-700 dark:hover:bg-cyan-400 transition focus:outline-none focus-visible:ring-2 focus-visible:ring-cyan-400 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-slate-900"
                    >
                        Start Simulation
                    </button>
                </article>
            </div>
        </div>
    );
}

function LifeChoicesView() {
    return (
        <div className="w-full flex flex-col items-center fade-in">
            <div
                id="life-choices-root"
                className="w-full max-w-2xl mx-auto bg-white dark:bg-slate-900/90 border border-slate-200/70 dark:border-slate-700/70 rounded-2xl shadow-xl p-6 sm:p-8 lg:p-10 text-slate-800 dark:text-slate-100 relative"
            >
            <div id="quiz" className="w-full max-w-2xl mx-auto bg-white dark:bg-slate-900/90 rounded-2xl shadow-xl p-6 sm:p-8 lg:p-10 transition-all duration-300 relative">
            
                    {/*Start Screen*/}
                    <div id="start-screen" className="text-center fade-in">
                        <h1 className="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-slate-100 mb-4">The Game of Life</h1>
                        <p className="text-slate-600 dark:text-slate-300 mb-6 sm:text-lg">Welcome to a simulation of your future. Your choices and random events will shape your life. Enter your starting point below.</p>
                        <div className="max-w-md mx-auto">
                            <div className="grid grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label htmlFor="startAge" className="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1">Your Current Age</label>
                                    <input
                                        type="number"
                                        id="startAge"
                                        className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500"
                                        defaultValue="18"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="startYear" className="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1">Current Year</label>
                                    <input
                                        type="number"
                                        id="startYear"
                                        className="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500"
                                        defaultValue="2025"
                                    />
                                </div>
                            </div>
                             <p id="start-error" className="text-red-500 text-sm mb-4 hidden">Please enter a valid age and year.</p>
                            <button id="start-button" className="w-full sm:w-auto bg-cyan-600 dark:bg-cyan-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-cyan-700 dark:hover:bg-cyan-400 focus:outline-none focus:ring-4 focus:ring-cyan-300 transition-all duration-300 transform hover:scale-105">
                                Begin Your Life
                            </button>
                        </div>
                    </div>
            
                    {/*Personality Quiz Screen*/}
                    <div id="personality-quiz-screen" className="hidden quiz-container">
                        <div>
                            <h2 id="personality-question-text" className="text-2xl font-bold my-6 text-center text-slate-900 dark:text-slate-100"></h2>
                            <div id="personality-answers-container" className="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        </div>
                        <div className="mt-8">
                            <div className="w-full bg-slate-200 dark:bg-slate-700/60 rounded-full h-2.5">
                                <div
                                    id="personality-progress-bar"
                                    className="bg-cyan-600 dark:bg-cyan-500 h-2.5 rounded-full"
                                    style={{ width: '0%' }}
                                ></div>
                            </div>
                        </div>
                    </div>
            
                    {/*Quiz Screen*/}
                    <div id="quiz-screen" className="hidden quiz-container">
                        <div>
                             {/*Avatar Display*/}
                            <div className="flex justify-between items-center mb-4">
                                 <button id="avatar-button" className="relative w-24 h-24 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 rounded-full">
                                    <div id="avatar-bg" className="absolute inset-0 z-0"></div>
                                    <div id="avatar-body" className="absolute z-10">
                                        <svg
                                            className="w-16 h-16 text-slate-300 dark:text-slate-400"
                                            fill="currentColor"
                                            viewBox="0 0 20 20"
                                            xmlns="http://www.w3.org/2000/svg"
                                        >
                                            <path
                                                fillRule="evenodd"
                                                d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                                                clipRule="evenodd"
                                            ></path>
                                        </svg>
                                    </div>
                                    <div id="avatar-item" className="absolute z-20 bottom-0 -left-2"></div>
                                    <div id="avatar-accessory" className="absolute z-20 top-0 -right-2"></div>
                                </button>
                                 <div className="flex-grow text-right pl-4">
                                    <div id="timeline" className="mb-2">
                                        <span id="current-age" className="text-2xl font-bold text-cyan-600 dark:text-cyan-300">Age: 18</span>
                                        <span id="current-year" className="text-lg text-slate-500 dark:text-slate-400 ml-2">Year: 2025</span>
                                    </div>
                                    <div id="happiness-container" className="flex items-center justify-end">
                                         <span id="happiness-stat" className="stat-value text-2xl">ðŸ˜Š</span>
                                         <span className="stat-label ml-2">Happiness</span>
                                    </div>
                                </div>
                            </div>
            
                            <div id="stats-bar" className="stats-bar">
                                <div className="stat">
                                    <span id="cash-stat" className="stat-value">$5,000</span>
                                    <span className="stat-label">Cash</span>
                                </div>
                                 <div className="stat">
                                    <span id="retirement-stat" className="stat-value">$0</span>
                                    <span className="stat-label">Retirement</span>
                                </div>
                                 <div className="stat">
                                    <span id="credit-stat-value" className="stat-value">650</span>
                                    <span id="credit-stat-rank" className="stat-label">Fair</span>
                                </div>
                                <div className="stat">
                                     <button id="salary-breakdown-button">
                                        <span id="salary-stat" className="stat-value">$0/yr</span>
                                        <span className="stat-label">Salary</span>
                                    </button>
                                </div>
                                 <div className="stat">
                                    <button id="expenses-breakdown-button">
                                        <span id="expense-stat" className="stat-value text-red-600 dark:text-red-400">-$40k/yr</span>
                                        <span className="stat-label">Expenses</span>
                                    </button>
                                </div>
                            </div>
                            <h2 id="question-text" className="text-2xl font-bold my-6 text-slate-900 dark:text-slate-100"></h2>
                            <div id="answers-container" className="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        </div>
                        <div className="mt-8 flex justify-between items-center">
                            <button id="back-button" className="hidden bg-slate-200 dark:bg-slate-700/60 text-slate-800 dark:text-slate-200 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600/60 transition-all duration-300">
                                &larr; Back
                            </button>
                            <div id="progress-container" className="w-full bg-slate-200 dark:bg-slate-700/60 rounded-full h-2.5 ml-4">
                                <div
                                    id="progress-bar"
                                    className="bg-cyan-600 dark:bg-cyan-500 h-2.5 rounded-full"
                                    style={{ width: '0%' }}
                                ></div>
                            </div>
                        </div>
                    </div>
            
                    {/*Result Screen*/}
                    <div id="result-screen" className="hidden text-center fade-in">
                        <h2 id="result-title" className="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-slate-100 mb-4">Your Life Story</h2>
                        <p id="result-description" className="text-slate-600 dark:text-slate-300 mb-6 sm:text-lg bg-slate-50 dark:bg-slate-800/60 p-4 rounded-lg"></p>
                    </div>
            
                    {/*Modals*/}
                    <div id="profile-modal" className="modal hidden absolute inset-0 bg-black/60 dark:bg-black/70 items-center justify-center p-4 z-50 opacity-0 transform scale-95">
                         <div className="bg-white dark:bg-slate-900/90 rounded-2xl shadow-2xl p-6 w-full max-w-md mx-auto">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-xl font-bold text-slate-800 dark:text-slate-100">Your Profile</h3>
                                <button id="hide-profile-button" className="text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:text-slate-100 text-3xl font-bold">&times;</button>
                            </div>
                            <div id="profile-main-view">
                                <div className="space-y-4">
                                    <div>
                                        <h4 className="font-semibold text-slate-600 dark:text-slate-300">Profession:</h4>
                                        <p id="profile-profession" className="text-slate-800 dark:text-slate-100"></p>
                                    </div>
                                    <div>
                                        <h4 className="font-semibold text-slate-600 dark:text-slate-300">Qualifications:</h4>
                                        <p id="profile-qualifications" className="text-slate-800 dark:text-slate-100"></p>
                                    </div>
                                    <div>
                                        <h4 className="font-semibold text-slate-600 dark:text-slate-300">Lifestyle:</h4>
                                        <ul id="profile-lifestyle" className="list-disc list-inside text-slate-800 dark:text-slate-100"></ul>
                                    </div>
                                    <div className="flex gap-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                                        <button id="change-career-button" className="flex-1 bg-cyan-600 dark:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-700 dark:hover:bg-cyan-400">Change Career</button>
                                        <button id="change-lifestyle-button" className="flex-1 bg-slate-200 dark:bg-slate-700/60 text-slate-800 dark:text-slate-200 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600/60">Adjust Lifestyle</button>
                                    </div>
                                </div>
                            </div>
                            <div id="profile-action-view" className="hidden">
                                 <h3 id="action-title" className="text-xl font-bold text-slate-800 dark:text-slate-100 mb-4"></h3>
                                 <div id="action-options-container" className="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="confirmation-modal" className="modal hidden absolute inset-0 bg-black/70 dark:bg-black/80 items-center justify-center p-4 z-50 opacity-0 transform scale-95">
                         <div className="bg-white dark:bg-slate-900/90 rounded-2xl shadow-2xl p-8 text-center max-w-lg mx-auto">
                            <h3 className="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-3">Confirm Your Choice</h3>
                            <p className="text-slate-600 dark:text-slate-300 mb-4">This choice will have the following immediate effects:</p>
                            <div id="confirmation-effects" className="text-left space-y-2 mb-6 bg-slate-50 dark:bg-slate-800/60 p-4 rounded-lg"></div>
                            <div className="flex justify-center gap-4">
                                <button id="confirm-choice-button" className="bg-emerald-600 dark:bg-emerald-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-emerald-700 dark:hover:bg-emerald-400">Confirm</button>
                                <button id="cancel-choice-button" className="bg-slate-200 dark:bg-slate-700/60 text-slate-800 dark:text-slate-200 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600/60">Cancel</button>
                            </div>
                        </div>
                    </div>
            
                    <div id="breakdown-modal" className="modal hidden absolute inset-0 bg-black/60 dark:bg-black/70 items-center justify-center p-4 z-50 opacity-0 transform scale-95">
                         <div className="bg-white dark:bg-slate-900/90 rounded-2xl shadow-2xl p-6 w-full max-w-sm mx-auto">
                            <div className="flex justify-between items-center mb-4">
                                <h3 id="breakdown-title" className="text-xl font-bold text-slate-800 dark:text-slate-100"></h3>
                                <button id="hide-breakdown-button" className="text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:text-slate-100 text-3xl font-bold">&times;</button>
                            </div>
                            <ul id="breakdown-list" className="space-y-2"></ul>
                        </div>
                    </div>
            
                    <div id="debt-modal" className="modal hidden absolute inset-0 bg-black/70 dark:bg-black/80 items-center justify-center p-4 z-50 opacity-0 transform scale-95">
                         <div className="bg-white dark:bg-slate-900/90 rounded-2xl shadow-2xl p-8 text-center max-w-lg mx-auto">
                            <h3 id="debt-title" className="text-2xl font-bold text-yellow-500 dark:text-yellow-300 mb-3">Unaffordable Choice</h3>
                            <p id="debt-description" className="text-slate-600 dark:text-slate-300 mb-4"></p>
                            <div id="debt-buttons" className="flex justify-center gap-4">
                                <button id="take-debt-button" className="bg-red-600 dark:bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 dark:hover:bg-red-400">Take Loan</button>
                                <button id="cancel-debt-button" className="bg-slate-200 dark:bg-slate-700/60 text-slate-800 dark:text-slate-200 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600/60">Cancel</button>
                            </div>
                        </div>
                    </div>
            
                    <div id="event-modal" className="modal hidden absolute inset-0 bg-black/60 dark:bg-black/70 items-center justify-center p-4 z-30 opacity-0 transform scale-95">
                        <div className="bg-white dark:bg-slate-900/90 rounded-2xl shadow-2xl p-6 text-center max-w-sm mx-auto">
                            <h3 className="text-xl font-bold text-cyan-600 dark:text-cyan-300 mb-2">A Life Event Occurred!</h3>
                            <p id="event-text" className="text-slate-600 dark:text-slate-300"></p>
                        </div>
                    </div>
                    
                    <div id="major-event-modal" className="modal hidden absolute inset-0 bg-black/70 dark:bg-black/80 items-center justify-center p-4 z-40 opacity-0 transform scale-95">
                        <div className="bg-white dark:bg-slate-900/90 rounded-2xl shadow-2xl p-8 text-center max-w-lg mx-auto">
                            <h3 className="text-2xl font-bold text-red-600 dark:text-red-400 mb-3">A Major Life Event!</h3>
                            <p id="major-event-description" className="text-slate-600 dark:text-slate-300 mb-4"></p>
                            <h4 id="major-event-question" className="text-lg font-semibold text-slate-800 dark:text-slate-100 mb-4"></h4>
                            <div id="major-event-choices" className="grid grid-cols-1 gap-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
}

