const b=(n,t=2)=>{if(!Number.isFinite(n))return n;const e=Math.pow(10,t);return Math.round(n*e)/e},z=n=>n*180/Math.PI,g=(n,t)=>Math.hypot(t.x-n.x,t.y-n.y),X=n=>{if(!n||n.length<2)return 0;let t=0;for(let e=0;e<n.length;e++){const s=n[e],a=n[(e+1)%n.length];t+=g(s,a)}return t},L=n=>{if(!n||n.length<3)return 0;let t=0;for(let e=0;e<n.length;e++){const s=n[e],a=n[(e+1)%n.length];t+=s.x*a.y-a.x*s.y}return Math.abs(t)/2},U=n=>!n||n.length<3?0:L(n.slice(0,3)),W=n=>Math.PI*n*n,Y=n=>2*Math.PI*n,I=(n,t,e)=>{const s=n.x-t.x,a=n.y-t.y,i=e.x-t.x,l=e.y-t.y,r=s*i+a*l,o=Math.hypot(s,a),c=Math.hypot(i,l);if(o===0||c===0)return 0;const u=Math.min(1,Math.max(-1,r/(o*c)));return z(Math.acos(u))},f=(n,t=2)=>Number.isFinite(n)?b(n,t).toFixed(t):String(n),V=n=>{const t="ABCDEFGHIJKLMNOPQRSTUVWXYZ",e=Math.floor(n/t.length),s=n%t.length;return t[s]+(e>0?`${e}`:"")},v=n=>n.map((t,e)=>({...t,label:t.label||V(e)})),j=n=>{const t=v(n),[e,s,a]=t,i=g(e,s),l=g(s,a),r=g(a,e);return{sides:{[`${e.label}${s.label}`]:b(i),[`${s.label}${a.label}`]:b(l),[`${a.label}${e.label}`]:b(r)},angles:{[`∠${e.label}${s.label}${a.label}`]:b(I(e,s,a)),[`∠${s.label}${a.label}${e.label}`]:b(I(s,a,e)),[`∠${a.label}${e.label}${s.label}`]:b(I(a,e,s))},perimeter:b(i+l+r),area:b(U(t))}},Z=n=>{const t=v(n),e={};for(let s=0;s<t.length;s++){const a=t[s],i=t[(s+1)%t.length];e[`${a.label}${i.label}`]=b(g(a,i))}return{sides:e,perimeter:b(X(t)),area:b(L(t))}},q=({center:n,radius:t})=>({center:n,radius:b(t),diameter:b(t*2),circumference:b(Y(t)),area:b(W(t))}),K=(n,t)=>{var e,s,a;switch(n.shape){case"point":{const[i]=n.params.points;return`Point ${i.label||""} at (${f(i.x)}, ${f(i.y)})`}case"segment":case"line_segment":{const[i,l]=v(n.params.points),r=t.length||t.distance;return`Segment ${i.label}${l.label} with length ${f(r||g(i,l))} units`}case"triangle":{const i=v(n.params.points),[l,r,o]=i;return`Triangle ${l.label}${r.label}${o.label} with sides ${l.label}${r.label} = ${f(((e=t.sides)==null?void 0:e[`${l.label}${r.label}`])??g(l,r))} units, ${r.label}${o.label} = ${f(((s=t.sides)==null?void 0:s[`${r.label}${o.label}`])??g(r,o))} units, ${o.label}${l.label} = ${f(((a=t.sides)==null?void 0:a[`${o.label}${l.label}`])??g(o,l))} units`}case"polygon":return`Polygon ${v(n.params.points).map(r=>r.label).join("")} with perimeter ${f(t.perimeter)} units and area ${f(t.area)} square units`;case"circle":return`${n.params.label||"Circle"} with radius ${f(t.radius)} units`;default:return`${n.shape} element`}},Q=n=>{if(!n)return null;switch(n.shape){case"point":{const[t]=v(n.params.points);return{point:t}}case"segment":case"line_segment":{const[t,e]=v(n.params.points);return{length:b(g(t,e)),points:[t,e]}}case"triangle":return j(n.params.points);case"polygon":return Z(n.params.points);case"circle":return q(n.params);default:return null}};let H=1;const J=()=>({ruler:{visible:!1,x:-50,y:-20,rotation:0,length:100},protractor:{visible:!1,x:-40,y:-40,rotation:0},compass:{visible:!1,x:20,y:20,rotation:0,radius:40}}),y={theme:"light",tool:"select",shapes:[],selectedId:null,aiHelpEnabled:!1,overlays:J(),measurement:null},G=new Set,O=n=>JSON.parse(JSON.stringify(n)),P=()=>{const n=O(y);G.forEach(t=>{try{t(n)}catch(e){console.error("geometryStore listener error",e)}})},tt=n=>(G.add(n),()=>G.delete(n)),et=()=>O(y),T=n=>Array.isArray(n)?v(n).map(t=>({id:t.id||`${t.label}`,label:t.label,x:t.x,y:t.y})):[],_=n=>{var s;if(n.shape==="circle")return n.params.label||(n.params.label=`Circle ${H}`),n;const e=(((s=n.params)==null?void 0:s.points)||[]).map(a=>a.label).join("");if(!n.label){const a=e?`${n.shape.charAt(0).toUpperCase()}${n.shape.slice(1)} ${e}`:`${n.shape}`;n.label=a}return n},D=(n={})=>{var s;const t=n.id||`shape-${H++}`,e={id:t,shape:n.shape||"point",params:{...n.params},style:n.style||{}};return Array.isArray((s=e.params)==null?void 0:s.points)&&(e.params.points=T(e.params.points)),_(e),y.shapes=[...y.shapes,e],y.selectedId=t,P(),t},k=(n,t={})=>{const e=y.shapes.findIndex(i=>i.id===n);if(e===-1)return;const s=y.shapes[e],a={...s,...t,params:{...s.params,...t.params},style:{...s.style,...t.style||{}}};Array.isArray(a.params.points)&&(a.params.points=T(a.params.points)),_(a),y.shapes=[...y.shapes.slice(0,e),a,...y.shapes.slice(e+1)],P()},M=n=>{y.selectedId=n,P()},N=(n,t)=>{y.overlays[n]&&(y.overlays[n]={...y.overlays[n],...t},P())},B=n=>{y.measurement=n,P()},d="http://www.w3.org/2000/svg",w=10,st=.35,rt=4,F={light:{background:"#ffffff",gridStroke:"#e5e5e5",primaryStroke:"#1d1d1f",primaryFill:"rgba(33, 33, 33, 0.06)",text:"#111111",glow:"drop-shadow(0 2px 6px rgba(0,0,0,0.2))",handleFill:"#ffffff",handleStroke:"#333333",overlayStroke:"#2c3e50",overlayFill:"rgba(52, 152, 219, 0.08)",measurementText:"#0f172a"},dark:{background:"#050505",gridStroke:"rgba(0,255,255,0.12)",primaryStroke:"#ffffff",primaryFill:"rgba(0,255,255,0.12)",text:"#e2fdff",glow:"drop-shadow(0 0 8px rgba(0,255,255,0.3))",handleFill:"#001a1d",handleStroke:"#8af3ff",overlayStroke:"#8af3ff",overlayFill:"rgba(0,255,255,0.08)",measurementText:"#ffffff"}},it=()=>{if(document.getElementById("geometry-canvas-styles"))return;const n=document.createElement("style");n.id="geometry-canvas-styles",n.textContent=`
    .geometry-canvas-root {
      position: relative;
      width: 100%;
      height: 100%;
      touch-action: none;
      border-radius: 12px;
      overflow: hidden;
    }
    .geometry-canvas-svg {
      width: 100%;
      height: 100%;
      display: block;
      transition: background-color 160ms ease;
    }
    .geometry-shape {
      transition: opacity 150ms ease, stroke 160ms ease, fill 160ms ease;
      opacity: 0;
      animation: geometry-shape-fade 150ms ease forwards;
      filter: var(--geometry-shape-shadow, none);
    }
    .geometry-handle {
      cursor: pointer;
      transition: transform 120ms ease;
    }
    .geometry-handle:hover {
      transform: scale(1.15);
    }
    .geometry-overlay {
      cursor: move;
      transition: opacity 150ms ease;
    }
    .geometry-overlay-handle {
      cursor: grab;
    }
    .geometry-overlay-handle:active {
      cursor: grabbing;
    }
    .geometry-measure-label {
      font-size: 10px;
      user-select: none;
      pointer-events: none;
    }
    @keyframes geometry-shape-fade {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  `,document.head.appendChild(n)};class at{constructor(t,e={}){if(!t)throw new Error("GeometryCanvas requires a container element.");it(),this.container=t,this.container.classList.add("geometry-canvas-root"),this.state=et(),this.viewBox={x:-200,y:-200,width:400,height:400},this.panStart=null,this.draft=null,this.measurePoints=[],this.dragContext=null,this.options=e,this.svg=document.createElementNS(d,"svg"),this.svg.setAttribute("class","geometry-canvas-svg"),this.svg.setAttribute("role","application"),this.svg.setAttribute("aria-label","Interactive geometry canvas"),this.svg.setAttribute("viewBox",`${this.viewBox.x} ${this.viewBox.y} ${this.viewBox.width} ${this.viewBox.height}`),this.defs=document.createElementNS(d,"defs"),this.gridPattern=document.createElementNS(d,"pattern"),this.gridPattern.setAttribute("id",`grid-pattern-${Math.random().toString(36).slice(2,8)}`),this.gridPattern.setAttribute("patternUnits","userSpaceOnUse"),this.gridPattern.setAttribute("width",w),this.gridPattern.setAttribute("height",w),this.gridPath=document.createElementNS(d,"path"),this.gridPath.setAttribute("d",`M ${w} 0 L 0 0 0 ${w}`),this.gridPath.setAttribute("fill","none"),this.gridPath.setAttribute("stroke-width","0.5"),this.gridPattern.appendChild(this.gridPath),this.defs.appendChild(this.gridPattern),this.dropShadowFilter=document.createElementNS(d,"filter"),this.dropShadowFilter.setAttribute("id","geometry-shadow");const s=document.createElementNS(d,"feDropShadow");s.setAttribute("dx","0"),s.setAttribute("dy","2"),s.setAttribute("stdDeviation","2"),s.setAttribute("flood-color","rgba(0,0,0,0.18)"),this.dropShadowFilter.appendChild(s),this.defs.appendChild(this.dropShadowFilter),this.svg.appendChild(this.defs),this.gridRect=document.createElementNS(d,"rect"),this.gridRect.setAttribute("x","-1000"),this.gridRect.setAttribute("y","-1000"),this.gridRect.setAttribute("width","2000"),this.gridRect.setAttribute("height","2000"),this.gridRect.setAttribute("fill",`url(#${this.gridPattern.getAttribute("id")})`),this.svg.appendChild(this.gridRect),this.overlayGroup=document.createElementNS(d,"g"),this.overlayGroup.setAttribute("class","geometry-overlays"),this.svg.appendChild(this.overlayGroup),this.shapeGroup=document.createElementNS(d,"g"),this.shapeGroup.setAttribute("class","geometry-shapes"),this.svg.appendChild(this.shapeGroup),this.measureGroup=document.createElementNS(d,"g"),this.measureGroup.setAttribute("class","geometry-measurements"),this.svg.appendChild(this.measureGroup),this.handleGroup=document.createElementNS(d,"g"),this.handleGroup.setAttribute("class","geometry-handles"),this.svg.appendChild(this.handleGroup),t.appendChild(this.svg),this.shapeElements=new Map,this.overlayElements=new Map,this.svg.addEventListener("pointerdown",this.onPointerDown.bind(this)),this.svg.addEventListener("pointermove",this.onPointerMove.bind(this)),this.svg.addEventListener("pointerup",this.onPointerUp.bind(this)),this.svg.addEventListener("pointerleave",this.onPointerUp.bind(this)),this.svg.addEventListener("wheel",this.onWheel.bind(this),{passive:!1}),this.svg.addEventListener("dblclick",this.onDoubleClick.bind(this)),this.unsubscribe=tt(a=>{var l;const i=(l=this.state)==null?void 0:l.tool;this.state=a,i==="measure"&&a.tool!=="measure"&&(this.measurePoints=[]),this.render()}),this.render()}destroy(){var t;(t=this.unsubscribe)==null||t.call(this),this.svg.remove()}get theme(){return F[this.state.theme]||F.light}setViewBox(t){this.viewBox=t,this.svg.setAttribute("viewBox",`${t.x} ${t.y} ${t.width} ${t.height}`),this.updateGridPattern()}updateGridPattern(){const{gridStroke:t}=this.theme;this.gridPath.setAttribute("stroke",t);const e=this.viewBox.width/this.svg.clientWidth||1;this.gridPath.setAttribute("stroke-width",`${.5*Math.max(e,.5)}`),this.gridPattern.setAttribute("patternTransform",`translate(${this.viewBox.x} ${this.viewBox.y})`)}toWorldPoint(t){const e=this.svg.getBoundingClientRect(),s=(t.clientX-e.left)/e.width,a=(t.clientY-e.top)/e.height,i=this.viewBox.x+s*this.viewBox.width,l=this.viewBox.y+a*this.viewBox.height;return{x:i,y:l}}snapPoint(t){const e=s=>Math.round(s/w)*w;return{x:e(t.x),y:e(t.y)}}onPointerDown(t){var c,u,p;const e=this.state.tool,s=this.toWorldPoint(t),a=this.snapPoint(s),i=t.target;t.preventDefault();const l=i.dataset.overlayHandle;if(l){const h=i.dataset.overlayName,m=this.state.overlays[h];if(!m)return;l==="rotate"?this.dragContext={type:"overlay-rotate",overlay:h,origin:{x:m.x,y:m.y}}:l==="resize"?this.dragContext={type:"overlay-resize",overlay:h,origin:{x:m.x,y:m.y}}:this.dragContext={type:"overlay",overlay:h,offset:{x:s.x-m.x,y:s.y-m.y}};return}const r=i.dataset.vertexIndex;if(r){const h=i.dataset.shapeId;if(r==="radius"){const m=this.getCircleParams(h);this.dragContext={type:"circle-radius",shapeId:h,center:m==null?void 0:m.center},M(h);return}if(r==="center"){const m=this.getCircleParams(h);this.dragContext={type:"circle-center",shapeId:h,circle:m},M(h);return}this.dragContext={type:"vertex",shapeId:h,index:Number(r)},M(h);return}const o=(p=(u=(c=i.closest)==null?void 0:c.call(i,"[data-shape-id]"))==null?void 0:u.dataset)==null?void 0:p.shapeId;if(o&&e==="select"){M(o),this.dragContext={type:"shape",shapeId:o,startPoint:a,rawStart:s,originalPoints:this.getShapePoints(o),originalCircle:this.getCircleParams(o)};return}if(e==="select"){this.dragContext={type:"pan",start:{x:t.clientX,y:t.clientY},viewBox:{...this.viewBox}},M(null);return}if(e==="measure"){this.handleMeasurePoint(a);return}this.handleDrawingPoint(a)}onPointerMove(t){if(!this.dragContext&&!this.draft)return;const e=this.toWorldPoint(t),s=this.snapPoint(e);if(this.dragContext)switch(this.dragContext.type){case"pan":{const{start:a,viewBox:i}=this.dragContext,l=(t.clientX-a.x)/this.svg.clientWidth*i.width,r=(t.clientY-a.y)/this.svg.clientHeight*i.height;this.setViewBox({x:i.x-l,y:i.y-r,width:i.width,height:i.height});break}case"vertex":{k(this.dragContext.shapeId,{params:{points:this.getShapePoints(this.dragContext.shapeId).map((a,i)=>i===this.dragContext.index?{...a,x:s.x,y:s.y}:a)}});break}case"shape":{const{shapeId:a,rawStart:i,originalPoints:l,originalCircle:r}=this.dragContext,o=e.x-i.x,c=e.y-i.y;l?k(a,{params:{points:l.map(u=>({...u,x:u.x+o,y:u.y+c}))}}):r&&k(a,{params:{center:{x:r.center.x+o,y:r.center.y+c},radius:r.radius}});break}case"circle-radius":{const{shapeId:a,center:i}=this.dragContext;if(!i)break;const l=g(i,e);k(a,{params:{center:i,radius:l}});break}case"circle-center":{const{shapeId:a,circle:i}=this.dragContext;if(!i)break;k(a,{params:{center:{x:e.x,y:e.y},radius:i.radius}});break}case"overlay":{N(this.dragContext.overlay,{x:e.x-this.dragContext.offset.x,y:e.y-this.dragContext.offset.y});break}case"overlay-rotate":{const{origin:a,overlay:i}=this.dragContext,l=Math.atan2(e.y-a.y,e.x-a.x);N(i,{rotation:l});break}case"overlay-resize":{const{origin:a,overlay:i}=this.dragContext,l=g(a,e);i==="ruler"?N(i,{length:l}):i==="compass"&&N(i,{radius:l});break}}this.draft&&this.updateDraft(s)}onPointerUp(){var t;if(((t=this.dragContext)==null?void 0:t.type)==="overlay"){this.dragContext=null;return}this.dragContext=null}onWheel(t){if(!t.ctrlKey)return;t.preventDefault();const s=t.deltaY>0?1.1:.9,a=Math.min(Math.max(this.viewBox.width*s,200*st),2e3*rt),i=a/this.viewBox.width*this.viewBox.height,l=this.toWorldPoint(t),r=l.x-this.viewBox.x,o=l.y-this.viewBox.y,c=r/this.viewBox.width,u=o/this.viewBox.height,p={width:a,height:i,x:l.x-c*a,y:l.y-u*i};this.setViewBox(p)}onDoubleClick(t){var e,s;this.state.tool==="polygon"&&((s=(e=this.draft)==null?void 0:e.points)==null?void 0:s.length)>=3&&(t.preventDefault(),this.finalizeDraft())}handleDrawingPoint(t){const e=this.state.tool,a={point:"point",segment:"segment",line:"segment",triangle:"triangle",circle:"circle",polygon:"polygon"}[e];if(a){if(a==="point"){D({shape:"point",params:{points:[{x:t.x,y:t.y,label:"A"}]}});return}if(!this.draft){this.draft={shape:a,points:[t]},this.renderDraft();return}this.draft.points.push(t),a==="segment"&&this.draft.points.length===2||a==="triangle"&&this.draft.points.length===3||a==="circle"&&this.draft.points.length===2?this.finalizeDraft():this.renderDraft()}}handleMeasurePoint(t){if(this.measurePoints.push(t),this.measurePoints.length===2){const[e,s]=this.measurePoints,a=b(g(e,s),2);B({type:"distance",label:`Distance ≈ ${f(a)}`,value:a,points:[e,s]})}if(this.measurePoints.length===3){const[e,s,a]=this.measurePoints,i=g(e,s),l=g(a,s);if(i>0&&l>0){let o=(Math.atan2(e.y-s.y,e.x-s.x)-Math.atan2(a.y-s.y,a.x-s.x))*180/Math.PI;o=Math.abs((o+540)%360-180);const c=b(o,2);B({type:"angle",label:`Angle ≈ ${f(c)}°`,value:c,points:[e,s,a]})}this.measurePoints=[]}this.renderMeasurementOverlay()}updateDraft(t){if(!this.draft)return;const{shape:e,points:s}=this.draft;e==="circle"?s.length===1?this.draft.preview={center:s[0],radius:g(s[0],t)}:this.draft.points[this.draft.points.length-1]=t:this.draft.points[this.draft.points.length-1]=t,this.renderDraft()}finalizeDraft(){if(!this.draft)return;const{shape:t,points:e}=this.draft;if(t==="circle"){if(e.length<2){this.draft=null;return}const[s,a]=e,i=g(s,a);D({shape:"circle",params:{center:s,radius:i,label:"Circle"}})}else{if(t==="polygon"&&e.length<3){this.draft=null,this.renderDraft();return}const a=v(e).map(i=>({...i}));D({shape:t,params:{points:a}})}this.draft=null,this.renderDraft()}getShapePoints(t){var s,a;const e=this.state.shapes.find(i=>i.id===t);return e&&((a=(s=e.params)==null?void 0:s.points)==null?void 0:a.map(i=>({...i})))||null}getCircleParams(t){const e=this.state.shapes.find(s=>s.id===t);return(e==null?void 0:e.shape)!=="circle"?null:{center:{...e.params.center},radius:e.params.radius}}render(){const{background:t,primaryStroke:e}=this.theme;this.svg.style.background=t,this.container.style.background=t,this.svg.style.color=e,this.svg.style.setProperty("--geometry-shape-shadow",this.theme.glow),this.updateGridPattern(),this.renderShapes(),this.renderHandles(),this.renderOverlays(),this.renderMeasurementOverlay()}renderShapes(){const t=new Set(this.state.shapes.map(e=>e.id));for(const[e,s]of this.shapeElements.entries())t.has(e)||(s.remove(),this.shapeElements.delete(e));this.state.shapes.forEach(e=>{const s=Q(e)||{},a=K(e,s);let i=this.shapeElements.get(e.id);i||(i=document.createElementNS(d,"g"),i.dataset.shapeId=e.id,i.setAttribute("class","geometry-shape"),this.shapeGroup.appendChild(i),this.shapeElements.set(e.id,i)),i.setAttribute("aria-label",a),i.replaceChildren(...this.createShapeElements(e)),this.state.selectedId===e.id?i.classList.add("selected"):i.classList.remove("selected")})}createShapeElements(t){var l;const{primaryStroke:e,primaryFill:s,text:a}=this.theme,i=[];if(t.shape==="point"){const[r]=t.params.points,o=document.createElementNS(d,"circle");o.setAttribute("cx",r.x),o.setAttribute("cy",r.y),o.setAttribute("r",3.5),o.setAttribute("fill",e),i.push(o)}else if(t.shape==="segment"){const[r,o]=t.params.points,c=document.createElementNS(d,"line");c.setAttribute("x1",r.x),c.setAttribute("y1",r.y),c.setAttribute("x2",o.x),c.setAttribute("y2",o.y),c.setAttribute("stroke",e),c.setAttribute("stroke-width","2"),c.setAttribute("stroke-linecap","round"),i.push(c)}else if(t.shape==="triangle"||t.shape==="polygon"){const r=document.createElementNS(d,"polygon"),o=t.params.points.map(c=>`${c.x},${c.y}`).join(" ");r.setAttribute("points",o),r.setAttribute("stroke",e),r.setAttribute("fill",s),r.setAttribute("stroke-width","2"),r.setAttribute("stroke-linejoin","round"),i.push(r)}else if(t.shape==="circle"){const{center:r,radius:o}=t.params,c=document.createElementNS(d,"circle");c.setAttribute("cx",r.x),c.setAttribute("cy",r.y),c.setAttribute("r",o),c.setAttribute("stroke",e),c.setAttribute("fill",s),c.setAttribute("stroke-width","2"),i.push(c)}return(l=t.params)!=null&&l.points&&t.params.points.forEach(r=>{const o=document.createElementNS(d,"text");o.setAttribute("x",r.x+4),o.setAttribute("y",r.y-6),o.setAttribute("fill",a),o.setAttribute("font-size","10"),o.setAttribute("pointer-events","none"),o.textContent=r.label,i.push(o)}),i}renderHandles(){var a;this.handleGroup.replaceChildren();const{handleFill:t,handleStroke:e}=this.theme,s=this.state.shapes.find(i=>i.id===this.state.selectedId);if(s&&((a=s.params)!=null&&a.points&&s.params.points.forEach((i,l)=>{const r=document.createElementNS(d,"circle");r.dataset.vertexIndex=l,r.dataset.shapeId=s.id,r.setAttribute("class","geometry-handle"),r.setAttribute("cx",i.x),r.setAttribute("cy",i.y),r.setAttribute("r",5),r.setAttribute("fill",t),r.setAttribute("stroke",e),r.setAttribute("stroke-width","1.5"),this.handleGroup.appendChild(r)}),s.shape==="circle")){const{center:i,radius:l}=s.params,r=document.createElementNS(d,"circle");r.dataset.vertexIndex="center",r.dataset.shapeId=s.id,r.setAttribute("class","geometry-handle"),r.setAttribute("cx",i.x),r.setAttribute("cy",i.y),r.setAttribute("r",5),r.setAttribute("fill",t),r.setAttribute("stroke",e),r.setAttribute("stroke-width","1.5"),this.handleGroup.appendChild(r);const o=document.createElementNS(d,"circle");o.dataset.vertexIndex="radius",o.dataset.shapeId=s.id,o.setAttribute("class","geometry-handle"),o.setAttribute("cx",i.x+l),o.setAttribute("cy",i.y),o.setAttribute("r",5),o.setAttribute("fill",t),o.setAttribute("stroke",e),o.setAttribute("stroke-width","1.5"),this.handleGroup.appendChild(o)}}renderOverlays(){const t=this.state.overlays||{};Object.keys(t).forEach(s=>{const a=t[s];let i=this.overlayElements.get(s);if(!a.visible){i&&(i.remove(),this.overlayElements.delete(s));return}i||(i=document.createElementNS(d,"g"),i.dataset.overlayName=s,i.setAttribute("class","geometry-overlay"),this.overlayGroup.appendChild(i),this.overlayElements.set(s,i)),i.replaceChildren(...this.createOverlayElements(s,a))})}createOverlayElements(t,e){const{overlayStroke:s,overlayFill:a,text:i}=this.theme;if(t==="ruler"){const l=document.createElementNS(d,"g");l.setAttribute("transform",`translate(${e.x} ${e.y}) rotate(${e.rotation*180/Math.PI})`);const r=document.createElementNS(d,"rect");r.setAttribute("x","0"),r.setAttribute("y","-6"),r.setAttribute("width",e.length),r.setAttribute("height",12),r.setAttribute("rx",3),r.setAttribute("fill",a),r.setAttribute("stroke",s),r.setAttribute("stroke-width","1.4"),r.dataset.overlayHandle="move",r.dataset.overlayName="ruler",l.appendChild(r);const o=document.createElementNS(d,"g"),c=w/2,u=Math.floor(e.length/c);for(let m=0;m<=u;m++){const x=document.createElementNS(d,"line"),S=m*c;x.setAttribute("x1",S),x.setAttribute("x2",S),x.setAttribute("y1",m%2===0?-6:-3),x.setAttribute("y2",6),x.setAttribute("stroke",s),x.setAttribute("stroke-width",m%2===0?"1.2":"0.8"),o.appendChild(x)}l.appendChild(o);const p=document.createElementNS(d,"text");p.setAttribute("x",e.length/2),p.setAttribute("y",-10),p.setAttribute("fill",i),p.setAttribute("font-size","10"),p.setAttribute("text-anchor","middle"),p.textContent=`≈ ${f(e.length/w)} units`,l.appendChild(p);const h=document.createElementNS(d,"circle");return h.setAttribute("cx",e.length+8),h.setAttribute("cy",0),h.setAttribute("r",4),h.setAttribute("fill",a),h.setAttribute("stroke",s),h.dataset.overlayHandle="rotate",h.dataset.overlayName="ruler",l.appendChild(h),l.dataset.overlayHandle="move",l.dataset.overlayName="ruler",[l]}if(t==="protractor"){const l=document.createElementNS(d,"g");l.setAttribute("transform",`translate(${e.x} ${e.y}) rotate(${e.rotation*180/Math.PI})`);const r=document.createElementNS(d,"path"),o=60,c=`M 0 0 A ${o} ${o} 0 0 1 ${o} 0`;r.setAttribute("d",c),r.setAttribute("fill",a),r.setAttribute("stroke",s),r.setAttribute("stroke-width","1.4"),l.appendChild(r);for(let p=0;p<=180;p+=10){const h=document.createElementNS(d,"line"),m=o-(p%30===0?8:4),x=o,S=p*Math.PI/180,C=Math.cos(S),E=Math.sin(S);if(h.setAttribute("x1",C*m),h.setAttribute("y1",-E*m),h.setAttribute("x2",C*x),h.setAttribute("y2",-E*x),h.setAttribute("stroke",s),h.setAttribute("stroke-width",p%30===0?"1.2":"0.6"),l.appendChild(h),p%30===0){const A=document.createElementNS(d,"text");A.setAttribute("x",C*(m-6)),A.setAttribute("y",-E*(m-6)),A.setAttribute("fill",i),A.setAttribute("font-size","9"),A.setAttribute("text-anchor","middle"),A.setAttribute("alignment-baseline","middle"),A.textContent=`${p}°`,l.appendChild(A)}}const u=document.createElementNS(d,"circle");return u.setAttribute("cx",o+10),u.setAttribute("cy",0),u.setAttribute("r",5),u.setAttribute("fill",a),u.setAttribute("stroke",s),u.dataset.overlayHandle="rotate",u.dataset.overlayName="protractor",l.appendChild(u),l.dataset.overlayHandle="move",l.dataset.overlayName="protractor",[l]}if(t==="compass"){const l=document.createElementNS(d,"g");l.setAttribute("transform",`translate(${e.x} ${e.y}) rotate(${e.rotation*180/Math.PI})`);const r=document.createElementNS(d,"line");r.setAttribute("x1",0),r.setAttribute("y1",0),r.setAttribute("x2",0),r.setAttribute("y2",-e.radius),r.setAttribute("stroke",s),r.setAttribute("stroke-width","2"),l.appendChild(r);const o=document.createElementNS(d,"line");o.setAttribute("x1",8),o.setAttribute("y1",0),o.setAttribute("x2",8),o.setAttribute("y2",-e.radius),o.setAttribute("stroke",s),o.setAttribute("stroke-width","2"),l.appendChild(o);const c=document.createElementNS(d,"path"),u=`M 0 ${-e.radius} A ${e.radius} ${e.radius} 0 0 0 8 ${-e.radius}`;c.setAttribute("d",u),c.setAttribute("stroke",s),c.setAttribute("fill","none"),c.setAttribute("stroke-width","1.2"),l.appendChild(c);const p=document.createElementNS(d,"text");p.setAttribute("x",4),p.setAttribute("y",-e.radius-8),p.setAttribute("fill",i),p.setAttribute("font-size","10"),p.setAttribute("text-anchor","middle"),p.textContent=`r ≈ ${f(e.radius)} units`,l.appendChild(p);const h=document.createElementNS(d,"circle");return h.setAttribute("cx",4),h.setAttribute("cy",-e.radius),h.setAttribute("r",5),h.setAttribute("fill",a),h.setAttribute("stroke",s),h.dataset.overlayHandle="resize",h.dataset.overlayName="compass",l.appendChild(h),l.dataset.overlayHandle="move",l.dataset.overlayName="compass",[l]}return[]}renderMeasurementOverlay(){var i,l;this.measureGroup.replaceChildren();const t=this.state.measurement;if(!t)return;const{measurementText:e,primaryStroke:s,overlayFill:a}=this.theme;if(t.type==="distance"&&((i=t.points)==null?void 0:i.length)===2){const[r,o]=t.points,c=document.createElementNS(d,"line");c.setAttribute("x1",r.x),c.setAttribute("y1",r.y),c.setAttribute("x2",o.x),c.setAttribute("y2",o.y),c.setAttribute("stroke",s),c.setAttribute("stroke-width","1.2"),c.setAttribute("stroke-dasharray","4 2"),this.measureGroup.appendChild(c);const u=document.createElementNS(d,"text");u.setAttribute("class","geometry-measure-label"),u.setAttribute("x",(r.x+o.x)/2),u.setAttribute("y",(r.y+o.y)/2-6),u.setAttribute("fill",e),u.setAttribute("text-anchor","middle"),u.textContent=t.label,this.measureGroup.appendChild(u)}if(t.type==="angle"&&((l=t.points)==null?void 0:l.length)===3){const[r,o,c]=t.points,u=document.createElementNS(d,"path"),p=20,h=Math.atan2(r.y-o.y,r.x-o.x),m=Math.atan2(c.y-o.y,c.x-o.x),x=Math.abs(m-h)>Math.PI?1:0,S=o.x+p*Math.cos(h),C=o.y+p*Math.sin(h),E=o.x+p*Math.cos(m),A=o.y+p*Math.sin(m),R=`M ${o.x} ${o.y} L ${S} ${C} A ${p} ${p} 0 ${x} 0 ${E} ${A} Z`;u.setAttribute("d",R),u.setAttribute("fill",a||"rgba(52, 152, 219, 0.15)"),u.setAttribute("stroke",s),u.setAttribute("stroke-width","1"),this.measureGroup.appendChild(u);const $=document.createElementNS(d,"text");$.setAttribute("class","geometry-measure-label"),$.setAttribute("x",o.x+p+6),$.setAttribute("y",o.y-p-6),$.setAttribute("fill",e),$.textContent=`${t.label}`,this.measureGroup.appendChild($)}}renderDraft(){if(this.draftGroup&&(this.draftGroup.remove(),this.draftGroup=null),!this.draft)return;const{shape:t,points:e,preview:s}=this.draft,{primaryStroke:a,primaryFill:i}=this.theme,l=document.createElementNS(d,"g");if(l.setAttribute("class","geometry-shape"),t==="segment"&&e.length>=2){const[r,o]=e,c=document.createElementNS(d,"line");c.setAttribute("x1",r.x),c.setAttribute("y1",r.y),c.setAttribute("x2",o.x),c.setAttribute("y2",o.y),c.setAttribute("stroke",a),c.setAttribute("stroke-width","1.4"),c.setAttribute("stroke-dasharray","4 3"),l.appendChild(c)}if((t==="triangle"||t==="polygon")&&e.length>=2){const r=document.createElementNS(d,"polyline"),o=e.map(c=>`${c.x},${c.y}`).join(" ");r.setAttribute("points",o),r.setAttribute("stroke",a),r.setAttribute("fill","none"),r.setAttribute("stroke-width","1.4"),r.setAttribute("stroke-dasharray","4 2"),l.appendChild(r)}if(t==="circle"&&s){const r=document.createElementNS(d,"circle");r.setAttribute("cx",s.center.x),r.setAttribute("cy",s.center.y),r.setAttribute("r",s.radius),r.setAttribute("stroke",a),r.setAttribute("fill",i),r.setAttribute("stroke-width","1.2"),r.setAttribute("opacity","0.4"),l.appendChild(r)}this.draftGroup=l,this.svg.appendChild(l)}}export{at as default};
