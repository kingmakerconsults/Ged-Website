<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mr. Smith's Learning Canvas</title>
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“š</text></svg>"
    />
    <!-- KaTeX for Math Rendering -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
      integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV"
      crossorigin="anonymous"
    />
    <!-- DOMPurify for safe HTML rendering (tables, lists, images) -->
    <script
      src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"
      integrity="sha384-Ja0V5w2wDci3OaMvt0yC/1wXj7mQe1KQqZ1o2b1vJ6m3Wv9h1sW3vI2d8qg4q7bT"
      crossorigin="anonymous"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
      integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8"
      crossorigin="anonymous"
    ></script>
    <!-- Canvas Confetti for Celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      window.__COACH_ENABLED__ = true;
      window.__ASK_COACH_ENABLED__ = false;
    </script>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      html {
        -webkit-text-size-adjust: 100%;
        text-size-adjust: 100%;
      }
      body,
      h1,
      h2,
      h3,
      p,
      ul,
      ol {
        margin: 0;
        padding: 0;
      }
      ul,
      ol {
        list-style: none;
      }
      html,
      body {
        min-height: 100%;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      img,
      video,
      canvas,
      svg {
        max-width: 100%;
        height: auto;
        display: block;
      }
    </style>
    <script src="https://ged-website.onrender.com/client-config.js"></script>
    <script>
      (function ensureApiBase() {
        try {
          const base =
            (window.__APP_CONFIG__ && window.__APP_CONFIG__.apiBaseUrl) ||
            'https://ged-website.onrender.com';
          window.API_BASE_URL = base;
        } catch {
          window.API_BASE_URL = 'https://ged-website.onrender.com';
        }
      })();
    </script>
    <script>
      (function ensurePremadeKatexFlag() {
        try {
          if (!window.__APP_CONFIG__) window.__APP_CONFIG__ = {};
          if (typeof window.__APP_CONFIG__.premadeUsesKatex === 'undefined') {
            window.__APP_CONFIG__.premadeUsesKatex = true;
          }
        } catch {}
      })();
    </script>
    <script>
      if (window.__APP_CONFIG__) {
        window.__APP_CONFIG__.geometryFiguresEnabled = true;
      }
    </script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
      crossorigin="anonymous"
    />
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/jsxgraph@1.4.6/distrib/jsxgraph.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/jsxgraph@1.4.6/distrib/jsxgraphcore.js"></script>
    <script>
      (function preloadPreferences() {
        if (typeof window === 'undefined' || typeof document === 'undefined')
          return;
        const root = document.documentElement;
        const sizeClasses = ['fs-sm', 'fs-md', 'fs-lg', 'fs-xl'];
        try {
          const stored = localStorage.getItem('prefs');
          if (!stored) return;
          const parsed = JSON.parse(stored);
          if (parsed && typeof parsed === 'object') {
            sizeClasses.forEach((c) => root.classList.remove(c));
            const sizes = new Set(['sm', 'md', 'lg', 'xl']);
            const fontSize = sizes.has(parsed.fontSize)
              ? parsed.fontSize
              : 'md';
            root.classList.add(`fs-${fontSize}`);
          }
        } catch (e) {
          console.warn('Failed to preload saved preferences:', e);
        }
      })();
    </script>
    <script>
      (function preloadTheme() {
        if (typeof window === 'undefined' || typeof document === 'undefined')
          return;
        let theme = 'light';
        try {
          const saved = window.localStorage
            ? window.localStorage.getItem('appTheme')
            : null;
          const prefersDark =
            window.matchMedia &&
            typeof window.matchMedia === 'function' &&
            window.matchMedia('(prefers-color-scheme: dark)').matches;
          theme =
            saved === 'light' || saved === 'dark'
              ? saved
              : prefersDark
              ? 'dark'
              : 'light';
        } catch (e) {
          console.warn('theme preload failed', e);
        }
        const root = document.documentElement;
        root.setAttribute('data-theme', theme);
        root.classList.toggle('dark', theme === 'dark');
        try {
          Object.defineProperty(window, '__START_THEME__', {
            value: theme,
            writable: false,
            configurable: false,
          });
        } catch {
          window.__START_THEME__ = theme;
        }
      })();
    </script>

    <!-- Quiz Data Loader: Fetch all premade quizzes and build unified catalog -->
    <script>
      (async function loadQuizData() {
        try {
          if (typeof window === 'undefined') return;

          // Determine API base URL
          const API_BASE =
            window.__CLIENT_CONFIG__?.API_BASE_URL ||
            window.__APP_CONFIG__?.apiBaseUrl ||
            (typeof window.API_BASE_URL === 'string' && window.API_BASE_URL) ||
            (window.location.hostname === 'localhost'
              ? window.location.origin
              : 'https://ged-website.onrender.com');

          console.log('[quiz-loader] Starting quiz data load from:', API_BASE);

          // Define quiz files to fetch
          const QUIZ_FILENAMES = [
            'math.quizzes.part1.json',
            'math.quizzes.part2.json',
            'rla.quizzes.part1.json',
            'rla.quizzes.part2.json',
            'science.quizzes.part1.json',
            'science.quizzes.part2.json',
            'social-studies.quizzes.json',
            'social-studies.extras.json',
            'workforce.quizzes.json',
          ];

          // Helper: Normalize string keys for consistent merging
          function normalizeKey(str) {
            if (!str) return '';
            return str
              .toString()
              .trim()
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-+|-+$/g, '');
          }

          // Fetch all quiz JSON files in parallel
          const quizPromises = QUIZ_FILENAMES.map((filename) =>
            fetch(`${API_BASE}/quizzes/${filename}`)
              .then((res) => {
                if (!res.ok) {
                  console.warn(
                    `[quiz-loader] Failed to fetch ${filename}: ${res.status}`
                  );
                  return null;
                }
                return res.json();
              })
              .catch((err) => {
                console.warn(`[quiz-loader] Error fetching ${filename}:`, err);
                return null;
              })
          );

          // Fetch the unified catalog from backend
          const catalogPromise = fetch(`${API_BASE}/api/all-quizzes`)
            .then((res) => {
              if (!res.ok) {
                console.warn(
                  `[quiz-loader] Failed to fetch all-quizzes: ${res.status}`
                );
                return null;
              }
              return res.json();
            })
            .catch((err) => {
              console.warn('[quiz-loader] Error fetching all-quizzes:', err);
              return null;
            });

          // Wait for all fetches
          const [catalog, ...quizData] = await Promise.all([
            catalogPromise,
            ...quizPromises,
          ]);

          // Build merged structure with proper quiz extraction
          const merged = {};

          // Process individual quiz files first
          quizData.forEach((data) => {
            if (data && typeof data === 'object') {
              // Each quiz file has a "subject" field and "categories" field
              const subjectName = data.subject;
              if (!subjectName) return;

              if (!merged[subjectName]) {
                merged[subjectName] = {
                  icon: data.icon || null,
                  categories: {},
                };
              }

              if (data.categories) {
                Object.entries(data.categories).forEach(
                  ([catName, catData]) => {
                    if (!merged[subjectName].categories[catName]) {
                      merged[subjectName].categories[catName] = {
                        description: catData.description || '',
                        topics: [],
                        quizzes: [],
                      };
                    }

                    const targetCat = merged[subjectName].categories[catName];

                    // Merge topics and extract quizzes from each topic
                    if (Array.isArray(catData.topics)) {
                      catData.topics.forEach((topic) => {
                        if (topic && typeof topic === 'object') {
                          targetCat.topics.push(topic);

                          // Extract quizzes from topic into category-level quizzes array
                          if (Array.isArray(topic.quizzes)) {
                            topic.quizzes.forEach((quiz) => {
                              if (quiz && typeof quiz === 'object') {
                                targetCat.quizzes.push(quiz);
                              }
                            });
                          }
                        }
                      });
                    }

                    // Also merge category-level quizzes if present
                    if (Array.isArray(catData.quizzes)) {
                      catData.quizzes.forEach((quiz) => {
                        if (quiz && typeof quiz === 'object') {
                          targetCat.quizzes.push(quiz);
                        }
                      });
                    }
                  }
                );
              }
            }
          });

          // Merge with catalog from backend (supplement with any additional data)
          if (catalog && typeof catalog === 'object') {
            Object.entries(catalog).forEach(([subject, content]) => {
              if (!merged[subject]) {
                merged[subject] = {
                  icon: content.icon || null,
                  categories: {},
                };
              }

              // Preserve icon from backend if not already set
              if (content.icon && !merged[subject].icon) {
                merged[subject].icon = content.icon;
              }

              if (content?.categories) {
                Object.entries(content.categories).forEach(
                  ([catName, catData]) => {
                    if (!merged[subject].categories[catName]) {
                      merged[subject].categories[catName] = {
                        description: catData.description || '',
                        topics: [],
                        quizzes: [],
                      };
                    }

                    const targetCat = merged[subject].categories[catName];

                    // Merge topics from backend catalog
                    if (Array.isArray(catData.topics)) {
                      catData.topics.forEach((topic) => {
                        if (topic && typeof topic === 'object') {
                          targetCat.topics.push(topic);

                          // Extract quizzes from backend topics
                          if (Array.isArray(topic.quizzes)) {
                            topic.quizzes.forEach((quiz) => {
                              if (quiz && typeof quiz === 'object') {
                                targetCat.quizzes.push(quiz);
                              }
                            });
                          }
                        }
                      });
                    }

                    // Merge backend category-level quizzes
                    if (Array.isArray(catData.quizzes)) {
                      catData.quizzes.forEach((quiz) => {
                        if (quiz && typeof quiz === 'object') {
                          targetCat.quizzes.push(quiz);
                        }
                      });
                    }
                  }
                );
              }
            });
          }

          // Filter merged data to only include valid GED subject keys
          const VALID_SUBJECTS = [
            'Math',
            'Reasoning Through Language Arts (RLA)',
            'Science',
            'Social Studies',
            'Workforce Readiness',
          ];

          const filtered = {};
          VALID_SUBJECTS.forEach((subject) => {
            if (merged[subject]) {
              filtered[subject] = merged[subject];
            }
          });

          // Set global variables for legacy compatibility
          window.UnifiedQuizCatalog = filtered;
          window.AppData = filtered;
          window.ExpandedQuizData = filtered;
          window.MergedExpandedQuizData = filtered;

          if (!window.Data) window.Data = {};
          window.Data.expandedQuizData = filtered;

          // Log summary
          const summary = Object.entries(filtered).map(([subj, data]) => {
            const catCount = Object.keys(data?.categories || {}).length;
            const quizCount = Object.values(data?.categories || {}).reduce(
              (sum, cat) => sum + (cat?.quizzes?.length || 0),
              0
            );
            return `${subj}: ${catCount} categories, ${quizCount} quizzes`;
          });

          console.log('[quiz-loader] Quiz data loaded successfully:');
          summary.forEach((line) => console.log('  ' + line));

          // Dispatch event to notify app that quiz data is ready
          window.dispatchEvent(
            new CustomEvent('quizDataLoaded', { detail: filtered })
          );
        } catch (error) {
          console.error('[quiz-loader] Fatal error loading quiz data:', error);
          // Initialize empty structure to prevent crashes
          window.UnifiedQuizCatalog = {};
          window.AppData = {};
          window.ExpandedQuizData = {};
          window.MergedExpandedQuizData = {};
          if (!window.Data) window.Data = {};
          window.Data.expandedQuizData = {};
        }
      })();
    </script>

    <!-- Legacy compatibility shim: ensure aliases exist -->
    <script>
      (function () {
        try {
          if (typeof window === 'undefined') return;
          // If legacy globals are missing but new catalogs exist, alias them.
          const catalog =
            window.UnifiedQuizCatalog ||
            window.AppData ||
            window.Data?.expandedQuizData ||
            {};
          if (!window.ExpandedQuizData && catalog) {
            window.ExpandedQuizData = catalog;
          }
          if (!window.MergedExpandedQuizData && window.ExpandedQuizData) {
            window.MergedExpandedQuizData = window.ExpandedQuizData;
          }
        } catch (e) {
          // no-op
        }
      })();
    </script>

    <!-- Science Practice Tool Data -->
    <script src="/data/science_formula_practice.js"></script>
    <script src="/data/science_concept_questions.js"></script>

    <!-- Practice Tool Components -->
    <script src="/components/practice-tools/ScienceFormulaPracticeTool.jsx"></script>
    <script src="/components/practice-tools/ScienceConceptPracticeTool.jsx"></script>
    <script type="module" crossorigin src="/assets/index-CO9BMHr7.js"></script>
  </head>
  <body data-theme="light">
    <div id="root"></div>

    <!-- Wait for quiz data before starting React app -->
  </body>
</html>
