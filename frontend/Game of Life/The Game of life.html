<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Game of Life: A Choices Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Inter', sans-serif;
        touch-action: manipulation;
      }
      .quiz-container {
        min-height: 450px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      .fade-out {
        animation: fadeOut 0.5s ease-in-out forwards;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes fadeOut {
        from {
          opacity: 1;
          transform: translateY(0);
        }
        to {
          opacity: 0;
          transform: translateY(-10px);
        }
      }
      .answer-text {
        display: block;
      }
      .answer-consequence {
        display: block;
        font-size: 0.875rem; /* text-sm */
        color: #475569; /* text-slate-600, darker for readability */
        margin-top: 4px;
      }
      .stats-bar {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 0.5rem;
        padding: 0.5rem;
        background-color: #f1f5f9; /* bg-slate-100 */
        border-radius: 0.75rem; /* rounded-xl */
      }
      .stat {
        text-align: center;
      }
      .stat button {
        width: 100%;
        height: 100%;
        padding: 0.5rem 0.25rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s;
      }
      .stat button:hover {
        background-color: #e2e8f0;
      }
      .stat-value {
        font-weight: 700;
        font-size: 1rem;
        color: #1e293b;
        display: block;
      }
      .stat-label {
        font-size: 0.75rem;
        color: #64748b;
        text-transform: uppercase;
        display: block;
      }
      .modal {
        transition: opacity 0.3s, transform 0.3s;
      }
      .avatar-icon {
        animation: popIn 0.3s ease-out;
      }
      @keyframes popIn {
        from {
          transform: scale(0.5);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body
    class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4"
  >
    <div
      id="quiz"
      class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-6 sm:p-8 lg:p-10 transition-all duration-300 relative"
    >
      <!-- Start Screen (Refactored) -->
      <div id="start-screen" class="text-center fade-in">
        <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 mb-4">
          The Game of Life
        </h1>
        <p class="text-slate-600 mb-6 sm:text-lg">
          Welcome to a simulation of your future. Your choices and random events
          will shape your life. Enter your starting point below.
        </p>
        <div class="max-w-md mx-auto space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label
                for="startAge"
                class="block text-sm font-medium text-slate-700 mb-1"
                >Your Current Age</label
              >
              <input
                type="number"
                id="startAge"
                class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                value="18"
              />
            </div>
            <div>
              <label
                for="startYear"
                class="block text-sm font-medium text-slate-700 mb-1"
                >Current Year</label
              >
              <input
                type="number"
                id="startYear"
                class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                value="2025"
              />
            </div>
          </div>
          <div>
            <label
              for="scenario-select"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Scenario Preset</label
            >
            <select
              id="scenario-select"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
            ></select>
          </div>
          <div>
            <label
              for="region-select"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Region</label
            >
            <select
              id="region-select"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
            >
              <option value="LOW">Low Cost</option>
              <option value="MED">Medium Cost</option>
              <option value="HIGH">High Cost</option>
            </select>
          </div>
          <div>
            <label
              for="career-select"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Career</label
            >
            <select
              id="career-select"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
            ></select>
          </div>
          <div>
            <label
              for="dwelling-select"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Dwelling (optional)</label
            >
            <select
              id="dwelling-select"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
            >
              <option value="">No dwelling yet</option>
              <option value="rent_roommate">Roommate</option>
              <option value="rent_studio">Studio</option>
              <option value="rent_1br">1BR Apartment</option>
              <option value="rent_2br">2BR Apartment</option>
            </select>
          </div>
          <div
            id="budget-preview"
            class="bg-slate-50 rounded-lg p-4 mt-2 text-left"
          >
            <div class="font-semibold mb-1">Budget Preview</div>
            <div id="budget-preview-content" class="text-sm"></div>
            <div
              id="rent-badge"
              class="inline-block mt-2 px-2 py-1 rounded bg-green-100 text-green-700 text-xs font-semibold"
            >
              Rent: $0 (choose a dwelling)
            </div>
          </div>
          <p id="start-error" class="text-red-500 text-sm mb-4 hidden">
            Please enter a valid age and year.
          </p>
          <button
            id="start-button"
            class="w-full sm:w-auto bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-all duration-300 transform hover:scale-105"
          >
            Begin Your Life
          </button>
        </div>
      </div>

      <!-- Personality Quiz Screen -->
      <div id="personality-quiz-screen" class="hidden quiz-container">
        <div>
          <h2
            id="personality-question-text"
            class="text-2xl font-bold my-6 text-center text-slate-900"
          ></h2>
          <div
            id="personality-answers-container"
            class="grid grid-cols-1 md:grid-cols-2 gap-4"
          ></div>
        </div>
        <div class="mt-8">
          <div class="w-full bg-slate-200 rounded-full h-2.5">
            <div
              id="personality-progress-bar"
              class="bg-indigo-600 h-2.5 rounded-full"
              style="width: 0%"
            ></div>
          </div>
        </div>
      </div>

      <!-- Quiz Screen -->
      <div id="quiz-screen" class="hidden quiz-container">
        <div>
          <!-- Avatar Display -->
          <div class="flex justify-between items-center mb-4">
            <button
              id="avatar-button"
              class="relative w-24 h-24 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 rounded-full"
            >
              <div id="avatar-bg" class="absolute inset-0 z-0"></div>
              <div id="avatar-body" class="absolute z-10">
                <svg
                  class="w-16 h-16 text-slate-300"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    fill-rule="evenodd"
                    d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
              </div>
              <div
                id="avatar-item"
                class="absolute z-20 bottom-0 -left-2"
              ></div>
              <div
                id="avatar-accessory"
                class="absolute z-20 top-0 -right-2"
              ></div>
            </button>
            <div class="flex-grow text-right pl-4">
              <div id="timeline" class="mb-2">
                <span
                  id="current-age"
                  class="text-2xl font-bold text-indigo-600"
                  >Age: 18</span
                >
                <span id="current-year" class="text-lg text-slate-500 ml-2"
                  >Year: 2025</span
                >
              </div>
              <div
                id="happiness-container"
                class="flex items-center justify-end"
              >
                <span id="happiness-stat" class="stat-value text-2xl">ðŸ˜Š</span>
                <span class="stat-label ml-2">Happiness</span>
              </div>
            </div>
          </div>

          <div id="stats-bar" class="stats-bar">
            <div class="stat">
              <span id="cash-stat" class="stat-value">$5,000</span>
              <span class="stat-label">Cash</span>
            </div>
            <div class="stat">
              <span id="retirement-stat" class="stat-value">$0</span>
              <span class="stat-label">Retirement</span>
            </div>
            <div class="stat">
              <span id="credit-stat-value" class="stat-value">650</span>
              <span id="credit-stat-rank" class="stat-label">Fair</span>
            </div>
            <div class="stat">
              <button id="salary-breakdown-button">
                <span id="salary-stat" class="stat-value">$0/yr</span>
                <span class="stat-label">Salary</span>
              </button>
            </div>
            <div class="stat">
              <button id="expenses-breakdown-button">
                <span id="expense-stat" class="stat-value text-red-600"
                  >-$40k/yr</span
                >
                <span class="stat-label">Expenses</span>
              </button>
            </div>
          </div>
          <h2
            id="question-text"
            class="text-2xl font-bold my-6 text-slate-900"
          ></h2>
          <div
            id="answers-container"
            class="grid grid-cols-1 md:grid-cols-2 gap-4"
          ></div>
        </div>
        <div class="mt-8 flex justify-between items-center">
          <button
            id="back-button"
            class="hidden bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 transition-all duration-300"
          >
            &larr; Back
          </button>
          <div
            id="progress-container"
            class="w-full bg-slate-200 rounded-full h-2.5 ml-4"
          >
            <div
              id="progress-bar"
              class="bg-indigo-600 h-2.5 rounded-full"
              style="width: 0%"
            ></div>
          </div>
        </div>
      </div>

      <!-- Result Screen -->
      <div id="result-screen" class="hidden text-center fade-in">
        <h2
          id="result-title"
          class="text-3xl sm:text-4xl font-bold text-slate-900 mb-4"
        >
          Your Life Story
        </h2>
        <p
          id="result-description"
          class="text-slate-600 mb-6 sm:text-lg bg-slate-50 p-4 rounded-lg"
        ></p>
        <div class="grid gap-6 md:grid-cols-2 mt-8">
          <div class="bg-white rounded-xl shadow p-4">
            <h3 class="text-lg font-semibold mb-2">Net Worth Over Time</h3>
            <canvas
              id="networth-chart"
              aria-label="Net Worth line chart"
              role="img"
            ></canvas>
          </div>
          <div class="bg-white rounded-xl shadow p-4">
            <h3 class="text-lg font-semibold mb-2">Income Split</h3>
            <canvas
              id="income-split-chart"
              aria-label="Income split stacked bar"
              role="img"
            ></canvas>
          </div>
        </div>
      </div>

      <!-- Lifetime Mode Screen -->
      <div id="lifetime-screen" class="hidden fade-in">
        <div class="mb-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
          <h2 class="text-3xl font-bold mb-2">Your Life Journey</h2>
          <div id="lifetime-timeline" class="mt-4 flex items-center justify-between">
            <div class="text-sm">
              <span class="font-semibold">Age:</span>
              <span id="lifetime-age" class="text-xl font-bold ml-2">20</span>
            </div>
            <div class="flex-1 mx-6 bg-white bg-opacity-20 rounded-full h-3 overflow-hidden">
              <div id="lifetime-progress" class="bg-white h-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div class="text-sm">
              <span class="font-semibold">Target:</span>
              <span class="text-xl font-bold ml-2">67</span>
            </div>
          </div>
        </div>
        
        <div class="grid md:grid-cols-3 gap-6 mb-6">
          <!-- Household Panel -->
          <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
              <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
              </svg>
              Household
            </h3>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-slate-600">Partner:</span>
                <span id="household-partner" class="font-semibold text-slate-800">No</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-600">Children:</span>
                <span id="household-children" class="font-semibold text-slate-800">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-600">Childcare:</span>
                <span id="household-childcare" class="font-semibold text-green-600">$0/mo</span>
              </div>
            </div>
          </div>
          
          <!-- Finances Panel -->
          <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
              <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Finances
            </h3>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-slate-600">Cash:</span>
                <span id="lifetime-cash" class="font-semibold text-slate-800">$0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-600">Investments:</span>
                <span id="lifetime-investments" class="font-semibold text-blue-600">$0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-600">Home Equity:</span>
                <span id="lifetime-equity" class="font-semibold text-purple-600">$0</span>
              </div>
            </div>
          </div>
          
          <!-- Loans Panel -->
          <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
              <svg class="w-5 h-5 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
              </svg>
              Loans
            </h3>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-slate-600">Total Balance:</span>
                <span id="lifetime-loan-balance" class="font-semibold text-red-600">$0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-600">Monthly Payment:</span>
                <span id="lifetime-loan-payment" class="font-semibold text-slate-800">$0/mo</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-600">Mortgage:</span>
                <span id="lifetime-mortgage" class="font-semibold text-slate-800">$0/mo</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Event Log -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
          <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
            <svg class="w-5 h-5 mr-2 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Recent Events
          </h3>
          <div id="lifetime-events" class="space-y-2 max-h-48 overflow-y-auto">
            <p class="text-slate-500 text-sm italic">Your life story will appear here...</p>
          </div>
        </div>
        
        <!-- Controls -->
        <div class="flex justify-center gap-4">
          <button id="lifetime-pause" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all">
            Pause
          </button>
          <button id="lifetime-resume" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all">
            Resume
          </button>
        </div>
      </div>

      <!-- Modals -->
      <div
        id="profile-modal"
        class="modal hidden absolute inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50 opacity-0 transform scale-95"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md mx-auto"
        >
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-slate-800">Your Profile</h3>
            <button
              id="hide-profile-button"
              class="text-slate-500 hover:text-slate-800 text-3xl font-bold"
            >
              &times;
            </button>
          </div>
          <div id="profile-main-view">
            <div class="space-y-4">
              <div>
                <h4 class="font-semibold text-slate-600">Profession:</h4>
                <p id="profile-profession" class="text-slate-800"></p>
              </div>
              <div>
                <h4 class="font-semibold text-slate-600">Qualifications:</h4>
                <p id="profile-qualifications" class="text-slate-800"></p>
              </div>
              <div>
                <h4 class="font-semibold text-slate-600">Lifestyle:</h4>
                <ul
                  id="profile-lifestyle"
                  class="list-disc list-inside text-slate-800"
                ></ul>
              </div>
              <div class="flex gap-4 pt-4 border-t">
                <button
                  id="change-career-button"
                  class="flex-1 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700"
                >
                  Change Career
                </button>
                <button
                  id="change-lifestyle-button"
                  class="flex-1 bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300"
                >
                  Adjust Lifestyle
                </button>
              </div>
            </div>
          </div>
          <div id="profile-action-view" class="hidden">
            <h3
              id="action-title"
              class="text-xl font-bold text-slate-800 mb-4"
            ></h3>
            <div id="action-options-container" class="space-y-3"></div>
          </div>
        </div>
      </div>

      <!-- Lifetime Checkpoint Modal -->
      <div
        id="checkpoint-modal"
        class="modal hidden absolute inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50 opacity-0 transform scale-95"
      >
        <div
          class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl shadow-2xl p-8 max-w-2xl mx-auto"
        >
          <div class="text-center mb-6">
            <div class="inline-block bg-indigo-100 rounded-full p-3 mb-4">
              <svg class="w-12 h-12 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
              </svg>
            </div>
            <h3 class="text-3xl font-bold text-slate-800 mb-2">
              Life Checkpoint
            </h3>
            <p id="checkpoint-age" class="text-xl text-indigo-600 font-semibold mb-4">
              Age 25
            </p>
            <p class="text-slate-600">
              Take a moment to make an important decision about your future.
            </p>
          </div>
          
          <div class="bg-white rounded-xl p-6 mb-6">
            <h4 class="font-bold text-slate-800 mb-4">Your Current Situation:</h4>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <span class="text-slate-600">Net Worth:</span>
                <span id="checkpoint-networth" class="font-semibold text-slate-800 ml-2">$0</span>
              </div>
              <div>
                <span class="text-slate-600">Monthly Income:</span>
                <span id="checkpoint-income" class="font-semibold text-green-600 ml-2">$0</span>
              </div>
              <div>
                <span class="text-slate-600">Loan Balance:</span>
                <span id="checkpoint-loans" class="font-semibold text-red-600 ml-2">$0</span>
              </div>
              <div>
                <span class="text-slate-600">Home Equity:</span>
                <span id="checkpoint-equity" class="font-semibold text-purple-600 ml-2">$0</span>
              </div>
            </div>
          </div>
          
          <div id="checkpoint-choices" class="space-y-3">
            <!-- Choices populated by JS -->
          </div>
        </div>
      </div>

      <div
        id="confirmation-modal"
        class="modal hidden absolute inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50 opacity-0 transform scale-95"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-lg mx-auto"
        >
          <h3 class="text-2xl font-bold text-slate-800 mb-3">
            Confirm Your Choice
          </h3>
          <p class="text-slate-600 mb-4">
            This choice will have the following immediate effects:
          </p>
          <div
            id="confirmation-effects"
            class="text-left space-y-2 mb-6 bg-slate-50 p-4 rounded-lg"
          ></div>
          <div class="flex justify-center gap-4">
            <button
              id="confirm-choice-button"
              class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700"
            >
              Confirm
            </button>
            <button
              id="cancel-choice-button"
              class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>

      <div
        id="breakdown-modal"
        class="modal hidden absolute inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50 opacity-0 transform scale-95"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm mx-auto"
        >
          <div class="flex justify-between items-center mb-4">
            <h3
              id="breakdown-title"
              class="text-xl font-bold text-slate-800"
            ></h3>
            <button
              id="hide-breakdown-button"
              class="text-slate-500 hover:text-slate-800 text-3xl font-bold"
            >
              &times;
            </button>
          </div>
          <ul id="breakdown-list" class="space-y-2"></ul>
        </div>
      </div>

      <div
        id="debt-modal"
        class="modal hidden absolute inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50 opacity-0 transform scale-95"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-lg mx-auto"
        >
          <h3 id="debt-title" class="text-2xl font-bold text-yellow-500 mb-3">
            Unaffordable Choice
          </h3>
          <p id="debt-description" class="text-slate-600 mb-4"></p>
          <div id="debt-buttons" class="flex justify-center gap-4">
            <button
              id="take-debt-button"
              class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700"
            >
              Take Loan
            </button>
            <button
              id="cancel-debt-button"
              class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>

      <div
        id="event-modal"
        class="modal hidden absolute inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-30 opacity-0 transform scale-95"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-6 text-center max-w-sm mx-auto"
        >
          <h3 class="text-xl font-bold text-indigo-600 mb-2">
            A Life Event Occurred!
          </h3>
          <p id="event-text" class="text-slate-600"></p>
        </div>
      </div>

      <div
        id="major-event-modal"
        class="modal hidden absolute inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-40 opacity-0 transform scale-95"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-lg mx-auto"
        >
          <h3 class="text-2xl font-bold text-red-600 mb-3">
            A Major Life Event!
          </h3>
          <p id="major-event-description" class="text-slate-600 mb-4"></p>
          <h4
            id="major-event-question"
            class="text-lg font-semibold text-slate-800 mb-4"
          ></h4>
          <div id="major-event-choices" class="grid grid-cols-1 gap-3"></div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Data containers loaded via fetch (front-end only)
        let costOfLiving = null;
        let careers = [];
        let scenarios = [];
        // Lightweight helpers for preview (mirror of sim/economy.js behavior)
        function calcRegionMultiplier(region) {
          if (region === 'LOW') return 1.0;
          if (region === 'MED') return 1.25;
          if (region === 'HIGH') return 1.6;
          return 1.0;
        }
        function buildMonthlyExpenses(player, regionCfg, regionMult) {
          const basket = regionCfg.basket;
          const expenses = {};
          expenses.rent = player.dwelling
            ? basket[player.dwelling] * regionMult
            : 0; // Rent rule
          expenses.utilities = basket.utilities * regionMult;
          expenses.groceries =
            (player.has_child
              ? basket.groceries_family
              : basket.groceries_single) * regionMult;
          expenses.transport =
            (player.has_car ? basket.transport_car : basket.transport_transit) *
            regionMult;
          expenses.health = basket.health * regionMult;
          expenses.phone = basket.phone;
          expenses.internet = basket.internet;
          expenses.misc = basket.misc * regionMult;
          if (player.recurringAdjustments) {
            for (const adj of player.recurringAdjustments) {
              expenses[adj.key] = (expenses[adj.key] || 0) + adj.amount;
            }
          }
          return expenses;
        }
        
        // ========== LIFETIME MODE HELPERS ==========
        // Clock/Age tracking
        function initClock(birthYear, ageMonths, retirementTargetAge = 67, maxYears = 50) {
          return {
            birthYear,
            ageMonths,
            currentYear: birthYear + Math.floor(ageMonths / 12),
            currentMonth: 0,
            retirementAge: retirementTargetAge,
            maxYears
          };
        }
        function advanceOneMonth(clock) {
          clock.ageMonths++;
          clock.currentMonth++;
          clock.currentYear = clock.birthYear + Math.floor(clock.ageMonths / 12);
        }
        function getAgeYears(clock) {
          return Math.floor(clock.ageMonths / 12);
        }
        function shouldPauseForCheckpoint(clock, lastCheckpoint) {
          const age = getAgeYears(clock);
          return age >= 25 && age % 5 === 0 && age !== lastCheckpoint;
        }
        function isRetirementAge(clock) {
          return getAgeYears(clock) >= clock.retirementAge;
        }
        function reachedEnd(clock) {
          const yearsElapsed = (clock.ageMonths / 12) - (clock.ageMonths / 12 - clock.currentMonth / 12);
          return yearsElapsed >= clock.maxYears;
        }
        function formatAge(ageMonths) {
          const years = Math.floor(ageMonths / 12);
          const months = ageMonths % 12;
          return `${years} years ${months} months`;
        }
        
        // Household
        function initHousehold() {
          return { partner: false, children: [] };
        }
        function addPartner(household) {
          household.partner = true;
        }
        function removePartner(household) {
          household.partner = false;
        }
        function addChild(household, childcareCost) {
          household.children.push({ ageMonths: 0, childcareCost });
        }
        function advanceHouseholdOneMonth(household) {
          household.children.forEach(child => child.ageMonths++);
        }
        function getActiveChildcareCosts(household) {
          return household.children
            .filter(child => child.ageMonths < 48)
            .reduce((sum, child) => sum + child.childcareCost, 0);
        }
        function applySharedExpenses(expenses, hasPartner) {
          if (!hasPartner) return expenses;
          const sharedKeys = ['utilities', 'groceries', 'transport', 'internet', 'misc'];
          sharedKeys.forEach(key => {
            if (expenses[key]) expenses[key] *= 0.75; // 25% reduction
          });
          return expenses;
        }
        
        // Housing
        function initHousing() {
          return { owned: false };
        }
        function canAffordHome(grossIncome, homePrice, downPaymentPct) {
          const maxPrice = grossIncome * 12 * 3.5;
          const downPayment = homePrice * downPaymentPct;
          return homePrice <= maxPrice;
        }
        function purchaseHome(housing, player, homePrice, downPaymentPct, apr, termMonths, closingCostPct) {
          const downPayment = homePrice * downPaymentPct;
          const closingCosts = homePrice * closingCostPct;
          const totalUpfront = downPayment + closingCosts;
          
          if (player.cash < totalUpfront) return false;
          
          player.cash -= totalUpfront;
          housing.owned = true;
          housing.purchasePrice = homePrice;
          housing.currentValue = homePrice;
          housing.principal = homePrice - downPayment;
          housing.apr = apr;
          housing.termMonths = termMonths;
          housing.monthsPaid = 0;
          housing.monthlyPayment = mortgagePayment(housing.principal, apr, termMonths);
          
          player.owns_home = true;
          player.dwelling = '2BR'; // Assume home ownership = 2BR equivalent
          
          return true;
        }
        function mortgagePayment(principal, apr, termMonths) {
          if (principal <= 0 || termMonths <= 0) return 0;
          const monthlyRate = apr / 12;
          if (monthlyRate === 0) return principal / termMonths;
          return principal * (monthlyRate * Math.pow(1 + monthlyRate, termMonths)) / 
                 (Math.pow(1 + monthlyRate, termMonths) - 1);
        }
        function advanceMortgageOneMonth(housing, appreciationRate) {
          if (!housing.owned || housing.principal <= 0) return;
          
          const interest = (housing.principal * housing.apr) / 12;
          const principalPaid = Math.min(housing.monthlyPayment - interest, housing.principal);
          housing.principal -= principalPaid;
          housing.monthsPaid++;
          
          // Annual appreciation applied monthly
          housing.currentValue *= (1 + appreciationRate);
        }
        function getHomeEquity(housing) {
          if (!housing.owned) return 0;
          return housing.currentValue - housing.principal;
        }
        function sellHome(housing, sellingCostPct) {
          if (!housing.owned) return 0;
          const sellingCosts = housing.currentValue * sellingCostPct;
          const netProceeds = housing.currentValue - housing.principal - sellingCosts;
          housing.owned = false;
          return Math.max(0, netProceeds);
        }
        function getMonthlyHousingCost(player, housing, basket, regionMult) {
          if (!player.dwelling) return 0; // Rent rule: $0 until dwelling chosen
          
          if (housing.owned) {
            const mortgage = housing.monthlyPayment || 0;
            const propertyTax = (housing.currentValue * 0.012) / 12; // 1.2% annual
            const insurance = (housing.currentValue * 0.005) / 12; // 0.5% annual
            const maintenance = (housing.currentValue * 0.01) / 12; // 1% annual
            return mortgage + propertyTax + insurance + maintenance;
          } else {
            return basket[player.dwelling] * regionMult;
          }
        }
        
        // Loans
        function initLoans() {
          return { student: [], car: [], personal: [] };
        }
        function addLoan(loans, type, { principal, apr, termMonths, label = '' }) {
          if (!loans[type]) loans[type] = [];
          loans[type].push({
            label: label || `${type} loan`,
            originalPrincipal: principal,
            principal,
            apr,
            termMonths,
            monthsPaid: 0,
            monthlyPayment: calculateMonthlyPayment(principal, apr, termMonths)
          });
        }
        function calculateMonthlyPayment(principal, apr, termMonths) {
          if (principal <= 0 || termMonths <= 0) return 0;
          const monthlyRate = apr / 12;
          if (monthlyRate === 0) return principal / termMonths;
          return principal * (monthlyRate * Math.pow(1 + monthlyRate, termMonths)) / 
                 (Math.pow(1 + monthlyRate, termMonths) - 1);
        }
        function advanceLoansOneMonth(loans) {
          let totalPayment = 0;
          let totalInterest = 0;
          
          ['student', 'car', 'personal'].forEach(type => {
            if (!loans[type]) return;
            loans[type] = loans[type].filter(loan => {
              if (loan.principal <= 0) return false;
              const interest = (loan.principal * loan.apr) / 12;
              const principalPaid = Math.min(loan.monthlyPayment - interest, loan.principal);
              loan.principal -= principalPaid;
              loan.monthsPaid++;
              totalPayment += loan.monthlyPayment;
              totalInterest += interest;
              return loan.principal > 0.01;
            });
          });
          
          return { totalPayment, totalInterest };
        }
        function getTotalLoanBalance(loans) {
          let total = 0;
          ['student', 'car', 'personal'].forEach(type => {
            if (!loans[type]) return;
            loans[type].forEach(loan => { total += loan.principal; });
          });
          return total;
        }
        
        // Event log
        function initEventLog() {
          return { history: [], lastOccurrence: {} };
        }
        
        // Retirement
        function estimateSocialSecurity(avgMonthlyWage, retirementConfig) {
          const annualWage = avgMonthlyWage * 12;
          const bands = retirementConfig.ss_replacement_bands;
          let ssAnnual = 0;
          let remaining = annualWage;
          
          for (const band of bands) {
            if (remaining <= 0) break;
            const covered = Math.min(remaining, band.up_to);
            ssAnnual += covered * band.rate;
            remaining -= covered;
          }
          
          return ssAnnual / 12;
        }
        function calculateWithdrawal(investments, retirementConfig, ageYears) {
          const balance = investments || 0;
          const policy = retirementConfig.withdrawal_policy;
          let rate = policy.floor;
          if (ageYears > 75) rate = policy.ceiling;
          else if (ageYears > 70) rate = (policy.floor + policy.ceiling) / 2;
          return (balance * rate) / 12;
        }
        function getHealthInsuranceCost(ageYears, retirementConfig) {
          if (ageYears >= retirementConfig.medicare_eligible_age) {
            return retirementConfig.medicare_monthly_cost;
          }
          return retirementConfig.pre_medicare_insurance_monthly;
        }
        function initRetirementIncome(player, careerState, retirementConfig) {
          const ageYears = Math.floor(player.ageMonths / 12);
          const avgWage = careerState.currentBasePay / (careerState.type === 'salary' ? 12 : 1);
          
          return {
            social_security: estimateSocialSecurity(avgWage, retirementConfig),
            pension: 0, // TODO: implement pension calculation
            withdrawal: calculateWithdrawal(player.investments, retirementConfig, ageYears),
            health_insurance: getHealthInsuranceCost(ageYears, retirementConfig)
          };
        }
        function gradeRetirementOutcome(netWorth, monthlyIncome, monthlyExpenses, ageAtRetirement) {
          const replacementRatio = monthlyIncome / monthlyExpenses;
          if (netWorth >= 500000 && replacementRatio >= 1.0 && ageAtRetirement <= 67) return 'A';
          if (netWorth >= 300000 && replacementRatio >= 0.8) return 'B';
          if (netWorth >= 100000 && replacementRatio >= 0.6) return 'C';
          if (netWorth >= 0 && replacementRatio >= 0.4) return 'D';
          return 'F';
        }

        async function loadData() {
          const [col, car, sc, lel, ret] = await Promise.all([
            fetch('../config/cost_of_living.json').then((r) => r.json()),
            fetch('../data/careers.json').then((r) => r.json()),
            fetch('../data/scenarios.json').then((r) => r.json()),
            fetch('../data/life_events_long.json').then((r) => r.json()),
            fetch('../data/retirement.json').then((r) => r.json()),
          ]);
          costOfLiving = col;
          careers = car;
          scenarios = sc;
          window.lifeEventsLong = lel;
          window.retirementConfig = ret;
        }
        // After data loads, populate selectors and preview
        (async function initSelectors() {
          await loadData();
          const scenarioSelect = document.getElementById('scenario-select');
          scenarios.forEach((s) => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = s.label;
            scenarioSelect.appendChild(opt);
          });
          const careerSelect = document.getElementById('career-select');
          careers.forEach((c) => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.title;
            careerSelect.appendChild(opt);
          });
          function updateBudgetPreview() {
            const region = document.getElementById('region-select').value;
            const dwelling = document.getElementById('dwelling-select').value;
            const regionMult = calcRegionMultiplier(region);
            const basket = costOfLiving.regions[region].basket;
            const previewPlayer = {
              dwelling,
              has_child: false,
              recurringAdjustments: [],
            };
            const expenses = buildMonthlyExpenses(
              previewPlayer,
              costOfLiving.regions[region],
              regionMult
            );
            const lines = [];
            for (const [k, v] of Object.entries(expenses)) {
              if (k === 'rent' && !dwelling) continue; // badge covers rent when not selected
              lines.push(
                `<span>${k.charAt(0).toUpperCase() + k.slice(1)}: $${Math.round(
                  v
                )}</span>`
              );
            }
            document.getElementById('budget-preview-content').innerHTML =
              lines.join(' &bull; ');
            const rentBadge = document.getElementById('rent-badge');
            if (!dwelling) {
              rentBadge.textContent = 'Rent: $0 (choose a dwelling)';
              rentBadge.className =
                'inline-block mt-2 px-2 py-1 rounded bg-green-100 text-green-700 text-xs font-semibold';
            } else {
              rentBadge.textContent = `Rent: $${Math.round(
                basket[dwelling] * regionMult
              )}`;
              rentBadge.className =
                'inline-block mt-2 px-2 py-1 rounded bg-blue-100 text-blue-700 text-xs font-semibold';
            }
          }
          document
            .getElementById('region-select')
            .addEventListener('change', updateBudgetPreview);
          document
            .getElementById('dwelling-select')
            .addEventListener('change', updateBudgetPreview);
          scenarioSelect.addEventListener('change', () => {
            const s = scenarios.find((x) => x.id === scenarioSelect.value);
            if (!s) return;
            document.getElementById('region-select').value = s.region;
            document.getElementById('dwelling-select').value = s.dwelling || '';
            updateBudgetPreview();
          });
          updateBudgetPreview();
        })();
        const avatarIcons = {
          briefcase: `<svg class="avatar-icon w-10 h-10 text-amber-700 bg-white p-1.5 rounded-full shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>`,
          wrench: `<svg class="avatar-icon w-10 h-10 text-sky-600 bg-white p-1.5 rounded-full shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>`,
          palette: `<svg class="avatar-icon w-10 h-10 text-purple-500 bg-white p-1.5 rounded-full shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path></svg>`,
          health: `<svg class="avatar-icon w-10 h-10 text-green-500 bg-white p-1.5 rounded-full shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>`,
          apartment: `<svg class="avatar-icon w-full h-full text-slate-200 opacity-50" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd"></path></svg>`,
          house: `<svg class="avatar-icon w-full h-full text-slate-200 opacity-50" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>`,
          nomad: `<svg class="avatar-icon w-full h-full text-slate-200 opacity-50" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.72 7 7.25 7 8.5c0 1.25.488 2.78 1.668 3.177a6.01 6.01 0 01-1.415 2.553c-.328.328-.328.86 0 1.188a.839.839 0 001.188 0l1.414-1.414a.839.839 0 000-1.188l-1.414-1.414a.839.839 0 00-1.188 0l-.328.328a4.509 4.509 0 00-1.255 2.25l-.328.328a.839.839 0 000 1.188l1.414 1.414a.839.839 0 001.188 0l1.414-1.414a.839.839 0 000-1.188l-1.414-1.414a.839.839 0 00-1.188 0l-.328.328A4.509 4.509 0 008.5 11c-1.25 0-2.78-.488-3.177-1.668a6.01 6.01 0 012.553-1.415c.328-.328.86-.328 1.188 0a.839.839 0 001.188-1.188l-1.414-1.414a.839.839 0 00-1.188 0l-1.414 1.414a.839.839 0 000 1.188l1.414 1.414a.839.839 0 001.188 0l.328-.328a4.509 4.509 0 001.255-2.25l-.328-.328a.839.839 0 000-1.188l-1.414-1.414a.839.839 0 00-1.188 0l-1.414 1.414a.839.839 0 000 1.188l1.414 1.414a.839.839 0 001.188 0l.328-.328c.34-.34.62-.72.836-1.12a5.99 5.99 0 01-.432-6.848 6.012 6.012 0 01-2.706 1.912c-.328.328-.86.328-1.188 0a.839.839 0 00-1.188 1.188l1.414 1.414a.839.839 0 001.188 0l1.414-1.414a.839.839 0 000-1.188l-1.414-1.414a.839.839 0 00-1.188 0z" clip-rule="evenodd"></path></svg>`,
          family: `<svg class="avatar-icon w-9 h-9 text-red-500 bg-white p-1.5 rounded-full shadow-md" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>`,
          pet: `<svg class="avatar-icon w-9 h-9 text-orange-500 bg-white p-1.5 rounded-full shadow-md" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 14.95a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 3v1a1 1 0 11-2 0V3a1 1 0 112 0z"></path><path d="M12.25 10.25a.75.75 0 010-1.5.75.75 0 010 1.5zM10 12.25a.75.75 0 01-1.5 0 .75.75 0 011.5 0zM7.75 10.25a.75.75 0 010-1.5.75.75 0 010 1.5z"></path></svg>`,
        };

        const personalityQuestions = [
          {
            question:
              'When facing a difficult problem, you are more likely to:',
            answers: [
              {
                text: 'Rely on a logical, data-driven approach.',
                type: 'ambitious',
              },
              {
                text: 'Trust your intuition and creativity.',
                type: 'creative',
              },
              {
                text: 'Consult with friends and family for advice.',
                type: 'guardian',
              },
              {
                text: 'Take a bold risk and see what happens.',
                type: 'adventurous',
              },
            ],
          },
          {
            question: 'A perfect weekend involves:',
            answers: [
              {
                text: 'Networking and working on a side project.',
                type: 'ambitious',
              },
              {
                text: 'Visiting a new city or trying an extreme sport.',
                type: 'adventurous',
              },
              {
                text: 'Spending quality time with loved ones at home.',
                type: 'guardian',
              },
              {
                text: 'Visiting a museum or working on a creative hobby.',
                type: 'creative',
              },
            ],
          },
          {
            question:
              'You receive an unexpected $5,000. Your first instinct is to:',
            answers: [
              { text: 'Invest it for long-term growth.', type: 'ambitious' },
              { text: 'Book a spontaneous trip abroad.', type: 'adventurous' },
              {
                text: 'Put it in an emergency fund or pay off debt.',
                type: 'guardian',
              },
              {
                text: 'Buy a new instrument or high-end art supplies.',
                type: 'creative',
              },
            ],
          },
          {
            question: 'Success is best measured by:',
            answers: [
              {
                text: 'Your professional title and income.',
                type: 'ambitious',
              },
              {
                text: 'The impact you have on your community.',
                type: 'guardian',
              },
              {
                text: 'The variety and richness of your experiences.',
                type: 'adventurous',
              },
              { text: 'The quality of the work you create.', type: 'creative' },
            ],
          },
          {
            question:
              'You are offered a promotion that requires moving away from your family.',
            answers: [
              { text: 'Take it without hesitation.', type: 'ambitious' },
              {
                text: 'Decline it; your relationships are more important.',
                type: 'guardian',
              },
              {
                text: 'See it as an exciting new adventure.',
                type: 'adventurous',
              },
              {
                text: 'Worry it will disrupt your creative flow.',
                type: 'creative',
              },
            ],
          },
          {
            question: 'When it comes to your living space, you prioritize:',
            answers: [
              {
                text: 'Proximity to work and important city hubs.',
                type: 'ambitious',
              },
              {
                text: 'A unique space that reflects your personality.',
                type: 'creative',
              },
              { text: 'Comfort, safety, and stability.', type: 'guardian' },
              {
                text: 'Minimalism, so you can pack up and leave easily.',
                type: 'adventurous',
              },
            ],
          },
          {
            question: 'Your ideal job would be:',
            answers: [
              { text: 'A high-powered executive role.', type: 'ambitious' },
              { text: 'A freelance artist or musician.', type: 'creative' },
              { text: 'A teacher or a nurse.', type: 'guardian' },
              {
                text: 'A travel blogger or a tour guide.',
                type: 'adventurous',
              },
            ],
          },
          {
            question: 'You feel most fulfilled when you are:',
            answers: [
              { text: 'Achieving a difficult goal.', type: 'ambitious' },
              { text: 'Creating something new.', type: 'creative' },
              { text: 'Helping someone in need.', type: 'guardian' },
              { text: 'Exploring an unfamiliar place.', type: 'adventurous' },
            ],
          },
          {
            question: 'In a team project, you are usually the one who:',
            answers: [
              {
                text: 'Takes charge and directs the strategy.',
                type: 'ambitious',
              },
              {
                text: 'Makes sure everyone feels heard and supported.',
                type: 'guardian',
              },
              {
                text: 'Comes up with the most unconventional ideas.',
                type: 'creative',
              },
              {
                text: 'Pushes the team to try a new, untested approach.',
                type: 'adventurous',
              },
            ],
          },
          {
            question: 'Looking back on your life, you would regret not having:',
            answers: [
              {
                text: 'Reached your full career potential.',
                type: 'ambitious',
              },
              {
                text: 'Taken more risks and traveled more.',
                type: 'adventurous',
              },
              {
                text: 'Built strong, lasting relationships.',
                type: 'guardian',
              },
              {
                text: 'Dedicated more time to your passions.',
                type: 'creative',
              },
            ],
          },
        ];

        const gameData = [
          {
            time_skip: 0,
            question: 'Stage 1: Choose your career sector.',
            back: false,
            answers: [
              {
                text: 'Technology',
                consequence: 'High growth, high demand, but competitive.',
                effects: { sector: 'tech' },
              },
              {
                text: 'Skilled Trades',
                consequence: 'Good job security, physically demanding.',
                effects: { sector: 'trades' },
              },
              {
                text: 'Creative Arts',
                consequence: 'High passion, high risk, low initial stability.',
                effects: { sector: 'creative' },
              },
              {
                text: 'Healthcare',
                consequence: 'Stable, meaningful, but high stress.',
                effects: { sector: 'health' },
              },
            ],
          },
          {
            condition: (gs) => gs.sector === 'tech',
            back: true,
            time_skip: 4,
            question: 'Stage 2 (Tech): Choose your profession.',
            answers: [
              {
                text: 'AI/ML Specialist',
                consequence: 'Loan: $80k. Salary: $90k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 8000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'AI Specialist',
                    amount: 90000,
                  },
                  avatar: { type: 'item', icon: 'briefcase' },
                  creditScore_change: -30,
                  add_qualification: 'B.S. CompSci',
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Cybersecurity Analyst',
                consequence: 'Loan: $60k. Salary: $80k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 6000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Cybersecurity Analyst',
                    amount: 80000,
                  },
                  avatar: { type: 'item', icon: 'briefcase' },
                  creditScore_change: -30,
                  add_qualification: 'B.S. IT',
                  personality_match: 'guardian',
                },
              },
              {
                text: 'UX/UI Designer',
                consequence: 'Loan: $50k. Salary: $85k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 5000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'UX/UI Designer',
                    amount: 85000,
                  },
                  avatar: { type: 'item', icon: 'palette' },
                  creditScore_change: -25,
                  add_qualification: 'B.A. Design',
                  personality_match: 'creative',
                },
              },
            ],
          },
          {
            condition: (gs) => gs.sector === 'trades',
            back: true,
            time_skip: 2,
            question: 'Stage 2 (Trades): Choose your profession.',
            answers: [
              {
                text: 'Electrician',
                consequence: 'Loan: $25k. Salary: $65k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 2500,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Electrician',
                    amount: 65000,
                  },
                  avatar: { type: 'item', icon: 'wrench' },
                  creditScore_change: -20,
                  add_qualification: 'Journeyman License',
                  personality_match: 'guardian',
                },
              },
              {
                text: 'HVAC Technician',
                consequence: 'Loan: $20k. Salary: $55k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 2000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'HVAC Tech',
                    amount: 55000,
                  },
                  avatar: { type: 'item', icon: 'wrench' },
                  creditScore_change: -20,
                  add_qualification: 'Trade Certification',
                  personality_match: 'guardian',
                },
              },
            ],
          },
          {
            condition: (gs) => gs.sector === 'creative',
            back: true,
            time_skip: 4,
            question: 'Stage 2 (Creative): Choose your profession.',
            answers: [
              {
                text: 'Graphic Designer',
                consequence: 'Loan: $40k. Salary: $50k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 4000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Graphic Designer',
                    amount: 50000,
                  },
                  avatar: { type: 'item', icon: 'palette' },
                  creditScore_change: -25,
                  add_qualification: 'B.F.A.',
                  personality_match: 'creative',
                },
              },
              {
                text: 'Content Creator',
                consequence: 'Cost: $5k. Salary: Highly volatile.',
                effects: {
                  career_type: 'creator',
                  career_level: 1,
                  cash_change: -5000,
                  salary_add: {
                    id: 'main_job',
                    label: 'Content Creator',
                    amount: 30000,
                  },
                  happiness: 10,
                  avatar: { type: 'item', icon: 'palette' },
                  personality_match: 'adventurous',
                },
              },
              {
                text: 'Writer/Journalist',
                consequence: 'Loan: $35k. Salary: $48k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 3500,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Writer',
                    amount: 48000,
                  },
                  avatar: { type: 'item', icon: 'palette' },
                  creditScore_change: -25,
                  add_qualification: 'B.A. English',
                  personality_match: 'creative',
                },
              },
            ],
          },
          {
            condition: (gs) => gs.sector === 'health',
            back: true,
            time_skip: 4,
            question: 'Stage 2 (Health): Choose your profession.',
            answers: [
              {
                text: 'Registered Nurse',
                consequence: 'Loan: $60k. Salary: $75k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 6000,
                  },
                  salary_add: { id: 'main_job', label: 'Nurse', amount: 75000 },
                  avatar: { type: 'item', icon: 'health' },
                  creditScore_change: -30,
                  add_qualification: 'B.S.N.',
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Pharmacist',
                consequence: 'Loan: $150k. Salary: $120k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 15000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Pharmacist',
                    amount: 120000,
                  },
                  avatar: { type: 'item', icon: 'health' },
                  creditScore_change: -50,
                  add_qualification: 'Pharm.D.',
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Medical Assistant',
                consequence: 'Loan: $10k. Salary: $40k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 1000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Medical Assistant',
                    amount: 40000,
                  },
                  avatar: { type: 'item', icon: 'health' },
                  creditScore_change: -10,
                  add_qualification: 'Certificate',
                  personality_match: 'guardian',
                },
              },
            ],
          },
          {
            time_skip: 3,
            question: 'Stage 3: Where will you live for the next few years?',
            answers: [
              {
                text: 'Rent a Downtown Apartment',
                consequence: 'Expenses: +$36k/yr. Great social life.',
                effects: {
                  housing_type: 'rent',
                  expense_add: {
                    id: 'housing',
                    label: 'Housing',
                    amount: 36000,
                  },
                  happiness: 10,
                  avatar: { type: 'bg', icon: 'apartment' },
                  personality_match: 'adventurous',
                },
              },
              {
                text: 'Live with Family',
                consequence: 'Expenses: +$7.2k/yr. Saves money.',
                effects: {
                  housing_type: 'family',
                  expense_add: {
                    id: 'housing',
                    label: 'Housing',
                    amount: 7200,
                  },
                  happiness: -5,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Rent a room',
                consequence: 'Expenses: +$12k/yr. Cheapest option.',
                effects: {
                  housing_type: 'rent',
                  expense_add: {
                    id: 'housing',
                    label: 'Housing',
                    amount: 12000,
                  },
                  happiness: -5,
                  avatar: { type: 'bg', icon: 'apartment' },
                  personality_match: 'ambitious',
                },
              },
            ],
          },
          {
            time_skip: 2,
            question: 'Stage 4: Start contributing to your retirement?',
            answers: [
              {
                text: 'Yes, 10% of my salary',
                consequence: 'Aggressive savings for a secure future.',
                effects: {
                  special_effect: 'start_401k',
                  rate: 0.1,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Yes, 5% of my salary',
                consequence: 'A modest start to saving.',
                effects: {
                  special_effect: 'start_401k',
                  rate: 0.05,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'No, I need the cash right now',
                consequence:
                  "You'll have more spending money, but may regret it later.",
                effects: { happiness: -5, personality_match: 'adventurous' },
              },
            ],
          },
          {
            time_skip: 3,
            question: 'Stage 5: How do you handle your finances?',
            answers: [
              {
                text: 'Invest in a crypto/stock portfolio (High-Risk)',
                consequence: 'Gamble: Huge potential gains or massive losses.',
                effects: {
                  set_investment_multiplier: 1.7,
                  set_investment_risk: 0.5,
                  personality_match: 'adventurous',
                },
              },
              {
                text: 'Invest in Index Funds (Safe)',
                consequence: 'Benefit: Slow, steady, reliable growth.',
                effects: {
                  set_investment_multiplier: 1.1,
                  set_investment_risk: 0.1,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Invest in Real Estate',
                consequence: 'Cost: $20k down. Builds equity.',
                effects: {
                  cash_change: -20000,
                  equity_change: 40000,
                  expense_add: {
                    id: 'rental',
                    label: 'Rental Property',
                    amount: 5000,
                  },
                  creditScore_change: -15,
                  personality_match: 'ambitious',
                },
              },
            ],
          },
          {
            time_skip: 2,
            question: 'Stage 6: What about relationships?',
            answers: [
              {
                text: 'Get Married',
                consequence: 'Expenses: +$5k/yr. Deep companionship.',
                effects: {
                  expense_add: {
                    id: 'partner',
                    label: 'Partner Costs',
                    amount: 5000,
                  },
                  happiness: 20,
                  avatar: { type: 'accessory', icon: 'family' },
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Adopt a Pet',
                consequence: 'Expenses: +$2k/yr. Great companionship.',
                effects: {
                  expense_add: { id: 'pet', label: 'Pet Costs', amount: 2000 },
                  happiness: 10,
                  avatar: { type: 'accessory', icon: 'pet' },
                  personality_match: 'creative',
                },
              },
              {
                text: 'Focus on your career for now',
                consequence: 'More time for work, less for connection.',
                effects: {
                  salary_boost: { id: 'main_job', amount: 10000 },
                  happiness: -5,
                  career_level_change: 1,
                  burnout_change: 5,
                  personality_match: 'ambitious',
                },
              },
            ],
          },
          {
            condition: (gs) => gs.expenseBreakdown.student_loan,
            time_skip: 2,
            question:
              'Stage 7: You have student loans. How do you approach them?',
            answers: [
              {
                text: 'Pay aggressively to eliminate them',
                consequence: 'Cost: $50k now. Frees up cash flow for good.',
                effects: {
                  cash_change: -50000,
                  expense_remove: 'student_loan',
                  happiness: 10,
                  creditScore_change: 50,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Continue making minimum payments',
                consequence: 'Benefit: Keep your cash for other things.',
                effects: {},
              },
              {
                text: 'Refinance for a lower payment',
                consequence: 'Lowers yearly cost, but extends the loan.',
                effects: {
                  expense_boost: { id: 'student_loan', amount: -2000 },
                },
              },
            ],
          },
          {
            condition: (gs) => gs.housingType !== 'own',
            time_skip: 2,
            question:
              "Stage 8: You've been renting. What's your next housing move?",
            answers: [
              {
                text: 'Buy a starter home',
                consequence: 'Cost: $25k down. Expenses: +$30k/yr mortgage.',
                effects: {
                  cash_change: -25000,
                  housing_type: 'own',
                  expense_remove: 'housing',
                  expense_add: {
                    id: 'housing',
                    label: 'Mortgage',
                    amount: 30000,
                  },
                  equity_change: 50000,
                  avatar: { type: 'bg', icon: 'house' },
                  creditScore_change: -20,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Buy a condo',
                consequence:
                  'Cost: $15k down. Expenses: +$22k/yr mortgage & fees.',
                effects: {
                  cash_change: -15000,
                  housing_type: 'own',
                  expense_remove: 'housing',
                  expense_add: {
                    id: 'housing',
                    label: 'Mortgage',
                    amount: 22000,
                  },
                  equity_change: 30000,
                  avatar: { type: 'bg', icon: 'apartment' },
                  creditScore_change: -15,
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Move to a nicer apartment',
                consequence: 'Expenses: +$12k/yr. Upgrade your lifestyle.',
                effects: {
                  expense_boost: { id: 'housing', amount: 12000 },
                  happiness: 5,
                  personality_match: 'creative',
                },
              },
            ],
          },
          {
            time_skip: 2,
            question:
              'Stage 9: Your company offers a professional development course.',
            answers: [
              {
                text: "Take it. It's an investment in yourself.",
                consequence: 'Cost: $5k. Could lead to a promotion.',
                effects: {
                  cash_change: -5000,
                  career_level_change: 1,
                  burnout_change: 5,
                  personality_match: 'ambitious',
                },
              },
              {
                text: "Decline. You'd rather have the free time.",
                consequence: 'No cost, but a missed opportunity?',
                effects: {
                  burnout_change: -5,
                  personality_match: 'adventurous',
                },
              },
            ],
          },
          {
            condition: (gs) => gs.avatar.accessory === 'family',
            time_skip: 2,
            question: "Stage 10: You're married. Time to think about kids?",
            answers: [
              {
                text: 'Yes, have a child',
                consequence: 'Expenses: +$20k/yr. A new chapter begins!',
                effects: {
                  expense_add: {
                    id: 'child1',
                    label: 'Child 1 Costs',
                    amount: 20000,
                  },
                  happiness: 25,
                  children_add: 1,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Not right now, focus on us',
                consequence: 'Enjoy your time as a couple.',
                effects: { happiness: 5 },
              },
            ],
          },
          {
            time_skip: 2,
            question: 'Stage 11: How do you spend your free time?',
            answers: [
              {
                text: 'On expensive hobbies and travel',
                consequence: 'Expenses: +$10k/yr. Live life to the fullest!',
                effects: {
                  expense_add: {
                    id: 'hobbies',
                    label: 'Hobbies',
                    amount: 10000,
                  },
                  happiness: 15,
                  burnout_change: -10,
                  personality_match: 'adventurous',
                },
              },
              {
                text: 'On cheap hobbies',
                consequence: 'Low cost, high reward.',
                effects: {
                  expense_add: {
                    id: 'hobbies',
                    label: 'Hobbies',
                    amount: 1000,
                  },
                  happiness: 10,
                  burnout_change: -5,
                  personality_match: 'creative',
                },
              },
              {
                text: 'Volunteering in your community',
                consequence: 'Great for happiness, but takes time.',
                effects: { happiness: 10, personality_match: 'guardian' },
              },
            ],
          },
          {
            time_skip: 2,
            question: 'Stage 12: A new technology is disrupting your field.',
            answers: [
              {
                text: 'Adapt and learn the new skills',
                consequence: 'Salary: +$20k/yr. Stay relevant.',
                effects: {
                  salary_boost: { id: 'main_job', amount: 20000 },
                  career_level_change: 1,
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Ignore it and hope for the best',
                consequence: 'Risk: Your skills could become obsolete.',
                effects: {
                  salary_boost: {
                    id: 'main_job',
                    amount: Math.random() > 0.4 ? -30000 : 0,
                  },
                  happiness: -5,
                },
              },
            ],
          },
          {
            condition: (gs) => gs.children.length > 0 && gs.children.length < 3,
            time_skip: 2,
            question:
              'Stage 13: You have a child. Do you want to have another?',
            answers: [
              {
                text: 'Yes, have another child',
                consequence: 'Expenses: +$18k/yr. A growing family!',
                effects: {
                  special_effect: 'add_child',
                  personality_match: 'guardian',
                },
              },
              {
                text: 'No, one is enough',
                consequence: 'Focus your resources and energy.',
                effects: { happiness: 5 },
              },
            ],
          },
          {
            time_skip: 2,
            question:
              "Stage 14: You're entering mid-life. What is your career focus?",
            answers: [
              {
                text: 'Push for a major promotion',
                consequence: 'Salary: +$30k/yr. High stress.',
                effects: {
                  career_level_change: 1,
                  salary_boost: { id: 'main_job', amount: 30000 },
                  happiness: -10,
                  burnout_change: 15,
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Switch to a less stressful job',
                consequence: 'Salary: -$25k/yr. Better work-life balance.',
                effects: {
                  career_level_change: -1,
                  salary_boost: { id: 'main_job', amount: -25000 },
                  happiness: 20,
                  burnout_change: -10,
                  personality_match: 'guardian',
                },
              },
            ],
          },
          {
            time_skip: 2,
            question: 'Stage 15: Your parents are aging and need some support.',
            answers: [
              {
                text: 'Help them financially',
                consequence: 'Expenses: +$10k/yr. A sense of duty.',
                effects: {
                  expense_add: {
                    id: 'parents',
                    label: 'Parent Support',
                    amount: 10000,
                  },
                  happiness: 5,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Offer your time and support',
                consequence: 'No direct cost, but emotionally taxing.',
                effects: {
                  happiness: 5,
                  burnout_change: 5,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Do nothing',
                consequence: 'Strained relationships.',
                effects: { happiness: -10 },
              },
            ],
          },
          {
            time_skip: 2,
            question:
              "Stage 16: You're established. How do you spend surplus income?",
            answers: [
              {
                text: 'Luxury Lifestyle',
                consequence: 'Expenses: +$30k/yr. Live for today.',
                effects: {
                  expense_add: { id: 'luxury', label: 'Luxury', amount: 30000 },
                  happiness: 15,
                  personality_match: 'adventurous',
                },
              },
              {
                text: 'Save Aggressively for Retirement',
                consequence: 'Benefit: +$100k to retirement. Live frugally.',
                effects: {
                  retirement_change: 100000,
                  happiness: -5,
                  personality_match: 'ambitious',
                },
              },
            ],
          },
          {
            condition: (gs) => gs.housingType === 'own',
            time_skip: 2,
            question: 'Stage 17: Your home has appreciated. What do you do?',
            answers: [
              {
                text: 'Sell and upgrade to a bigger house',
                consequence: 'Expenses: +$20k/yr. More space, more costs.',
                effects: {
                  cash_change: (gs) => gs.equity * 0.5,
                  equity_change: (gs) => gs.equity * 0.7,
                  expense_boost: { id: 'housing', amount: 20000 },
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Stay put and enjoy the low mortgage',
                consequence: 'Benefit: Financial stability.',
                effects: { happiness: 10, personality_match: 'guardian' },
              },
            ],
          },
          {
            time_skip: 2,
            question: "Stage 18: You're a senior in your field.",
            answers: [
              {
                text: 'Mentor junior colleagues',
                consequence: 'Share your knowledge and give back.',
                effects: {
                  happiness: 15,
                  career_level_change: 1,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Coast to retirement',
                consequence: 'Less stress, but you might get bored.',
                effects: {
                  burnout_change: -10,
                  personality_match: 'adventurous',
                },
              },
            ],
          },
          {
            time_skip: 2,
            question: 'Stage 19: Thinking about your legacy.',
            answers: [
              {
                text: 'Start a scholarship or donate to charity',
                consequence: 'Cost: $50k. Make a difference.',
                effects: {
                  cash_change: -50000,
                  happiness: 20,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Focus on family and travel',
                consequence: 'Enjoy the fruits of your labor.',
                effects: {
                  expense_add: { id: 'travel', label: 'Travel', amount: 15000 },
                  happiness: 15,
                  personality_match: 'adventurous',
                },
              },
            ],
          },
          {
            time_skip: 2,
            question:
              "Stage 20: You are approaching retirement. What's your final plan?",
            answers: [
              {
                text: 'Retire completely',
                consequence: 'No more salary. Ultimate freedom.',
                effects: {
                  happiness: 25,
                  salary_remove: 'main_job',
                  salary_remove: 'side_hustle',
                  personality_match: 'adventurous',
                },
              },
              {
                text: 'Work part-time in a fun job',
                consequence: 'Salary set to $25k/yr. Stay active.',
                effects: {
                  salary_remove: 'main_job',
                  salary_remove: 'side_hustle',
                  salary_add: {
                    id: 'main_job',
                    label: 'Part-time Job',
                    amount: 25000,
                  },
                  happiness: 10,
                  personality_match: 'creative',
                },
              },
            ],
          },
        ];

        const minorEvents = [
          {
            description:
              'The stock market has a great year! Your investments grow.',
            effects: { cash_change: (c) => c * 0.1, happiness: 5 },
          },
          {
            description:
              'Inflation is high this year, increasing all your expenses by 10%.',
            effects: { expense_boost_all: 0.1, happiness: -5 },
          },
          {
            description: 'You win a small lottery prize!',
            effects: { cash_change: 15000, happiness: 10 },
          },
          {
            description: 'Your car breaks down, requiring an expensive repair.',
            effects: {
              cash_change: -8000,
              happiness: -5,
              creditScore_change: -10,
            },
          },
          {
            description: 'You get an unexpected promotion and raise at work!',
            effects: {
              salary_boost: { id: 'main_job', amount: 15000 },
              happiness: 10,
              career_level_change: 1,
            },
          },
          {
            description:
              'Your insurance premiums skyrocketed after a policy change.',
            effects: {
              expense_add: {
                id: 'insurance',
                label: 'Insurance Hike',
                amount: 5000,
              },
              happiness: -5,
            },
          },
          {
            description:
              'The housing market is booming, increasing your home equity.',
            effects: { equity_change: 30000, happiness: 5 },
          },
          {
            description: 'You discover an amazing, inexpensive new hobby.',
            effects: { happiness: 10 },
          },
          {
            description:
              'A water pipe bursts in your home, requiring a costly fix.',
            effects: {
              cash_change: -10000,
              happiness: -5,
              creditScore_change: -15,
            },
          },
        ];

        const majorEvents = [
          {
            description:
              'A catastrophic market crash occurs, wiping out 40% of your invested cash.',
            question: 'This is devastating. How do you respond?',
            choices: [
              {
                text: 'Panic and sell everything to prevent further loss.',
                consequence: 'Locks in your losses permanently.',
                effects: { cash_change: (c) => c * -0.1, happiness: -25 },
              },
              {
                text: 'Stay the course and hope for recovery.',
                consequence:
                  'A test of nerve. It could get worse before it gets better.',
                effects: { happiness: -15, set_investment_risk: 0.7 },
              },
              {
                text: 'Delay retirement and start saving aggressively.',
                consequence: 'A painful but practical solution.',
                effects: {
                  salary_boost: { id: 'main_job', amount: 20000 },
                  happiness: -20,
                },
              },
            ],
          },
          {
            description:
              'A global pandemic occurs. Your field is in high demand, but you face immense stress and burnout risk.',
            question: 'Your work-life balance is gone. What do you do?',
            choices: [
              {
                text: 'Work insane hours to capitalize on the opportunity.',
                consequence: 'Massive income boost, massive happiness cost.',
                effects: {
                  salary_boost: { id: 'main_job', amount: 50000 },
                  happiness: -30,
                  burnout_change: 20,
                },
              },
              {
                text: 'Quit your job to protect your mental health.',
                consequence: 'A drastic move for self-preservation.',
                effects: {
                  salary_remove: 'main_job',
                  cash_change: -10000,
                  happiness: 20,
                },
              },
              {
                text: 'Negotiate for better conditions or hazard pay.',
                consequence: 'A gamble, but could lead to a better outcome.',
                effects: {
                  salary_boost: {
                    id: 'main_job',
                    amount: Math.random() > 0.5 ? 25000 : 0,
                  },
                  happiness: 5,
                },
              },
            ],
          },
          {
            description:
              "You've been diagnosed with a serious but manageable health condition.",
            question:
              'This changes your perspective. How do you adjust your life?',
            choices: [
              {
                text: 'Prioritize health above all. Reduce work hours and stress.',
                consequence: 'Less income, but more years to enjoy life.',
                effects: {
                  salary_boost: { id: 'main_job', amount: -30000 },
                  happiness: 20,
                  burnout_change: -15,
                },
              },
              {
                text: 'Sell your large house and downsize.',
                consequence: 'Gain cash, lose equity, lower expenses.',
                effects: {
                  cash_change: 100000,
                  equity_change: (e) => -e,
                  expense_remove: 'housing',
                  expense_add: {
                    id: 'housing',
                    label: 'New Housing',
                    amount: 18000,
                  },
                  happiness: 10,
                  avatar: { type: 'bg', icon: 'apartment' },
                },
              },
              {
                text: "Ignore the doctor's advice and keep pushing hard at work.",
                consequence: 'High risk of future health crises.',
                effects: {
                  happiness: Math.random() > 0.3 ? -40 : -15,
                  burnout_change: 10,
                },
              },
            ],
          },
        ];

        const childEvents = [
          {
            description:
              'Your child is a gifted athlete! Lessons and travel cost an extra $5k/yr.',
            effects: {
              expense_add: {
                id: 'child_sports',
                label: 'Child Sports',
                amount: 5000,
              },
              happiness: 10,
            },
          },
          {
            description:
              "Uh oh, braces are needed. That's a one-time $8,000 cost.",
            effects: { cash_change: -8000, happiness: -5 },
          },
          {
            description:
              'Your child wins a university scholarship, saving you $50,000 in future costs!',
            effects: { cash_change: 50000, happiness: 25 },
          },
          {
            description:
              'Your child needs a tutor, adding $4k/yr to your expenses.',
            effects: {
              expense_add: {
                id: 'child_tutor',
                label: 'Child Tutor',
                amount: 4000,
              },
              happiness: -5,
            },
          },
        ];

        let currentQuestionIndex = 0;
        let gameState = {
          cash: 5000,
          retirement: 0,
          equity: 0,
          salaryBreakdown: {},
          expenseBreakdown: {
            base: { label: 'Base Living Costs', amount: 40000 },
          },
          happiness: 50,
          investment_multiplier: 1.0,
          investment_risk: 0,
          avatar: { bg: null, item: null, accessory: null },
          currentAge: 18,
          currentYear: 2025,
          housingType: null,
          children: [],
          careerType: null,
          sector: null,
          careerLevel: 0,
          burnout: 0,
          creditScore: 650,
          qualifications: [],
          personality: null,
          personalityScores: {
            ambitious: 0,
            guardian: 0,
            creative: 0,
            adventurous: 0,
          },
        };
        let filteredGameData = [];
        let currentEffects = {};
        let personalityQuizIndex = 0;

        const startScreen = document.getElementById('start-screen'),
          quizScreen = document.getElementById('quiz-screen'),
          resultScreen = document.getElementById('result-screen');
        const questionText = document.getElementById('question-text'),
          answersContainer = document.getElementById('answers-container');
        const progressBar = document.getElementById('progress-bar');
        const cashStat = document.getElementById('cash-stat'),
          retirementStat = document.getElementById('retirement-stat'),
          salaryStat = document.getElementById('salary-stat'),
          expenseStat = document.getElementById('expense-stat'),
          happinessStat = document.getElementById('happiness-stat');
        const creditScoreValue = document.getElementById('credit-stat-value'),
          creditScoreRank = document.getElementById('credit-stat-rank');
        const eventModal = document.getElementById('event-modal'),
          eventText = document.getElementById('event-text');
        const majorEventModal = document.getElementById('major-event-modal'),
          majorEventDescription = document.getElementById(
            'major-event-description'
          ),
          majorEventQuestion = document.getElementById('major-event-question'),
          majorEventChoices = document.getElementById('major-event-choices');
        const startError = document.getElementById('start-error');
        const breakdownModal = document.getElementById('breakdown-modal');
        const debtModal = document.getElementById('debt-modal');
        const backButton = document.getElementById('back-button');
        const profileModal = document.getElementById('profile-modal');
        const confirmationModal = document.getElementById('confirmation-modal');
        const personalityQuizScreen = document.getElementById(
          'personality-quiz-screen'
        );

        // Override startQuiz to use new selectors and configs (after data is loaded)
        const startQuiz = () => {
          const startAgeInput = document.getElementById('startAge');
          const startYearInput = document.getElementById('startYear');
          const scenarioSelectEl = document.getElementById('scenario-select');
          const scenarioId = scenarioSelectEl.value;
          const region = document.getElementById('region-select').value;
          const careerId = document.getElementById('career-select').value;
          const dwelling =
            document.getElementById('dwelling-select').value || null;
          const startAge = startAgeInput.value;
          const startYear = startYearInput.value;
          if (
            !startAge ||
            !startYear ||
            parseInt(startAge) < 1 ||
            parseInt(startYear) < 1950
          ) {
            startError.classList.remove('hidden');
            return;
          }
          startError.classList.add('hidden');
          const scenario = scenarios.find((s) => s.id === scenarioId);
          const player = {
            region,
            cash: scenario ? scenario.starting_cash : 500,
            debt: scenario ? scenario.starting_debt : 0,
            has_child: scenario ? scenario.has_child : false,
            dwelling,
            recurringAdjustments: [],
            tempIncome: [],
            rentMultiplier: 1,
          };
          const careerDef = careers.find((c) => c.id === careerId);
          let careerState = null;
          if (careerDef) {
            careerState = {
              currentTitle: careerDef.title,
              currentBasePay:
                careerDef.type === 'salary'
                  ? careerDef.salary
                  : careerDef.hourly,
              type: careerDef.type,
              hours_per_week: careerDef.hours_per_week,
              raise: careerDef.raise,
              promotion: careerDef.promotion,
              monthsInRole: 0,
            };
          }
          window.lifeSimPlayer = player;
          window.lifeSimCareer = careerState;
          window.lifeSimScenarioGoal = scenario ? scenario.goal : null;
          
          // Initialize lifetime state
          const birthYear = parseInt(startYear) - parseInt(startAge);
          const ageMonths = parseInt(startAge) * 12;
          window.lifetimeClock = initClock(birthYear, ageMonths, 67, 50);
          window.lifetimeHousehold = initHousehold();
          window.lifetimeHousing = initHousing();
          window.lifetimeLoans = initLoans();
          window.lifetimeEventLog = initEventLog();
          window.lifetimeAutoAdvance = false; // Will activate after stage-based gameplay
          window.lifetimeLastCheckpoint = 0;
          
          player.ageMonths = ageMonths;
          player.investments = 0;
          player.monthsWorked = 0;
          
          startScreen.classList.add('hidden');
          personalityQuizScreen.classList.remove('hidden');
          personalityQuizScreen.classList.add('fade-in');
          displayPersonalityQuestion();
        };

        const displayPersonalityQuestion = () => {
          if (personalityQuizIndex < personalityQuestions.length) {
            const stage = personalityQuestions[personalityQuizIndex];
            document.getElementById('personality-question-text').textContent =
              stage.question;
            const container = document.getElementById(
              'personality-answers-container'
            );
            container.innerHTML = '';
            stage.answers.forEach((answer) => {
              const button = document.createElement('button');
              button.className =
                'w-full text-center p-4 rounded-lg bg-slate-100 hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200 font-semibold';
              button.textContent = answer.text;
              button.onclick = () => {
                gameState.personalityScores[answer.type]++;
                personalityQuizIndex++;
                displayPersonalityQuestion();
              };
              container.appendChild(button);
            });
            document.getElementById(
              'personality-progress-bar'
            ).style.width = `${
              (personalityQuizIndex / personalityQuestions.length) * 100
            }%`;
          } else {
            const scores = gameState.personalityScores;
            const personality = Object.keys(scores).reduce((a, b) =>
              scores[a] > scores[b] ? a : b
            );
            gameState.personality = personality;
            startMainGame();
          }
        };

        const startMainGame = () => {
          personalityQuizScreen.classList.add('hidden');
          quizScreen.classList.remove('hidden');
          quizScreen.classList.add('fade-in');
          displayQuestion();
        };

        const filterGameStages = () => {
          filteredGameData = gameData.filter((stage) => {
            if (stage.condition) {
              return stage.condition(gameState);
            }
            return true;
          });
        };

        const showBreakdown = (type) => {
          const data =
            type === 'salary'
              ? gameState.salaryBreakdown
              : gameState.expenseBreakdown;
          const title =
            type === 'salary' ? 'Salary Breakdown' : 'Expense Breakdown';
          const listEl = document.getElementById('breakdown-list');

          document.getElementById('breakdown-title').textContent = title;
          listEl.innerHTML = '';

          if (Object.keys(data).length === 0) {
            const li = document.createElement('li');
            li.className = 'text-slate-500';
            li.textContent = 'No items to display.';
            listEl.appendChild(li);
          } else {
            Object.values(data).forEach((item) => {
              const li = document.createElement('li');
              li.className = 'flex justify-between items-center text-slate-700';
              const sign = type === 'expenses' ? '-' : '+';
              li.innerHTML = `<span>${
                item.label
              }</span><span class="font-semibold">${sign}$${item.amount.toLocaleString()}/yr</span>`;
              listEl.appendChild(li);
            });
          }
          breakdownModal.classList.remove('hidden');
          setTimeout(() => {
            breakdownModal.classList.remove('opacity-0', 'scale-95');
          }, 10);
        };

        const hideBreakdown = () => {
          breakdownModal.classList.add('opacity-0', 'scale-95');
          setTimeout(() => {
            breakdownModal.classList.add('hidden');
          }, 300);
        };

        const showProfileModal = () => {
          document.getElementById('profile-profession').textContent =
            gameState.salaryBreakdown.main_job?.label || 'Unemployed';
          document.getElementById('profile-qualifications').textContent =
            gameState.qualifications.join(', ') || 'None';

          const lifestyleList = document.getElementById('profile-lifestyle');
          lifestyleList.innerHTML = '';
          const lifestyleItems = Object.keys(gameState.expenseBreakdown)
            .filter((key) =>
              ['hobbies', 'luxury', 'travel', 'pet', 'partner'].includes(key)
            )
            .map((key) => gameState.expenseBreakdown[key].label);

          if (lifestyleItems.length > 0) {
            lifestyleItems.forEach((item) => {
              const li = document.createElement('li');
              li.textContent = item;
              lifestyleList.appendChild(li);
            });
          } else {
            const li = document.createElement('li');
            li.textContent = 'A simple life.';
            lifestyleList.appendChild(li);
          }

          document
            .getElementById('profile-main-view')
            .classList.remove('hidden');
          document
            .getElementById('profile-action-view')
            .classList.add('hidden');
          profileModal.classList.remove('hidden');
          setTimeout(() => {
            profileModal.classList.remove('opacity-0', 'scale-95');
          }, 10);
        };

        const hideProfileModal = () => {
          profileModal.classList.add('opacity-0', 'scale-95');
          setTimeout(() => {
            profileModal.classList.add('hidden');
          }, 300);
        };

        const showActionModal = (type) => {
          document.getElementById('profile-main-view').classList.add('hidden');
          const actionView = document.getElementById('profile-action-view');
          actionView.classList.remove('hidden');
          const container = document.getElementById('action-options-container');
          const title = document.getElementById('action-title');
          container.innerHTML = '';

          if (type === 'career') {
            title.textContent = 'Change Career';
            const backToSchool = document.createElement('button');
            backToSchool.className =
              'w-full text-left p-4 rounded-lg bg-slate-100 hover:bg-indigo-100';
            backToSchool.innerHTML = `<span class="answer-text font-semibold">Go back to school (4 years)</span><span class="answer-consequence">Cost: $80k. Reset your career path.</span>`;
            backToSchool.onclick = () => {
              selectAnswer({
                cash_change: -80000,
                time_skip: 4,
                salary_remove: 'main_job',
                salary_remove: 'side_hustle',
                sector: null,
                career_type: null,
                career_level: 0,
                qualifications: [],
              });
              hideProfileModal();
            };
            container.appendChild(backToSchool);
          } else {
            // lifestyle
            title.textContent = 'Adjust Lifestyle';
            const addHobby = document.createElement('button');
            addHobby.className =
              'w-full text-left p-4 rounded-lg bg-slate-100 hover:bg-indigo-100';
            addHobby.innerHTML = `<span class="answer-text font-semibold">Take up an expensive hobby</span><span class="answer-consequence">Expenses: +$10k/yr. Happiness +15</span>`;
            addHobby.onclick = () => {
              applyEffects({
                expense_add: { id: 'hobbies', label: 'Hobbies', amount: 10000 },
                happiness: 15,
              });
              hideProfileModal();
              updateFinancialsUI();
            };
            container.appendChild(addHobby);

            if (gameState.expenseBreakdown.hobbies) {
              const removeHobby = document.createElement('button');
              removeHobby.className =
                'w-full text-left p-4 rounded-lg bg-slate-100 hover:bg-indigo-100';
              removeHobby.innerHTML = `<span class="answer-text font-semibold">Drop expensive hobby</span><span class="answer-consequence">Expenses: -$10k/yr. Happiness -10</span>`;
              removeHobby.onclick = () => {
                const amountToRemove =
                  gameState.expenseBreakdown.hobbies.amount;
                applyEffects({ expense_remove: 'hobbies', happiness: -10 });
                hideProfileModal();
                updateFinancialsUI();
              };
              container.appendChild(removeHobby);
            }
          }
        };

        const updateAvatar = () => {
          const bgContainer = document.getElementById('avatar-bg');
          const itemContainer = document.getElementById('avatar-item');
          const accessoryContainer =
            document.getElementById('avatar-accessory');
          const newBg = gameState.avatar.bg
            ? avatarIcons[gameState.avatar.bg]
            : '';
          const newItem = gameState.avatar.item
            ? avatarIcons[gameState.avatar.item]
            : '';
          const newAccessory = gameState.avatar.accessory
            ? avatarIcons[gameState.avatar.accessory]
            : '';
          if (bgContainer.innerHTML !== newBg) bgContainer.innerHTML = newBg;
          if (itemContainer.innerHTML !== newItem)
            itemContainer.innerHTML = newItem;
          if (accessoryContainer.innerHTML !== newAccessory)
            accessoryContainer.innerHTML = newAccessory;
        };

        const updateTimeline = () => {
          document.getElementById(
            'current-age'
          ).textContent = `Age: ${gameState.currentAge}`;
          document.getElementById(
            'current-year'
          ).textContent = `Year: ${gameState.currentYear}`;
        };

        const updateFinancialsUI = () => {
          const totalSalary = Object.values(gameState.salaryBreakdown).reduce(
            (sum, item) => sum + item.amount,
            0
          );
          const totalExpenses = Object.values(
            gameState.expenseBreakdown
          ).reduce((sum, item) => sum + item.amount, 0);

          cashStat.textContent = `$${Math.round(
            gameState.cash
          ).toLocaleString()}`;
          retirementStat.textContent = `$${Math.round(
            gameState.retirement
          ).toLocaleString()}`;
          salaryStat.textContent = `$${Math.round(totalSalary / 1000)}k/yr`;
          expenseStat.textContent = `-$${Math.round(totalExpenses / 1000)}k/yr`;

          creditScoreValue.textContent = gameState.creditScore;
          if (gameState.creditScore >= 800)
            creditScoreRank.textContent = 'Excellent';
          else if (gameState.creditScore >= 740)
            creditScoreRank.textContent = 'Very Good';
          else if (gameState.creditScore >= 670)
            creditScoreRank.textContent = 'Good';
          else if (gameState.creditScore >= 580)
            creditScoreRank.textContent = 'Fair';
          else creditScoreRank.textContent = 'Poor';

          let happinessEmoji = 'ðŸ˜';
          if (gameState.happiness >= 80) happinessEmoji = 'ðŸ˜';
          else if (gameState.happiness >= 60) happinessEmoji = 'ðŸ˜Š';
          else if (gameState.happiness < 40) happinessEmoji = 'ðŸ˜’';
          else if (gameState.happiness < 25) happinessEmoji = 'ðŸ˜«';
          happinessStat.textContent = happinessEmoji;
        };

        const runTimeSkipUpdate = (years) => {
          if (!years) return;

          for (let i = 0; i < years; i++) {
            if (
              gameState.careerType === 'creator' &&
              gameState.salaryBreakdown.main_job
            ) {
              gameState.salaryBreakdown.main_job.amount =
                (Math.random() > 0.65 ? 120000 : 20000) +
                gameState.careerLevel * 5000;
            }

            const inflationRate = gameState.currentYear < 2027 ? 0.03 : 0.02;
            Object.keys(gameState.expenseBreakdown).forEach((key) => {
              if (key !== 'student_loan' && !key.startsWith('loan_'))
                gameState.expenseBreakdown[key].amount *= 1 + inflationRate;
            });

            const totalSalary = Object.values(gameState.salaryBreakdown).reduce(
              (sum, item) => sum + item.amount,
              0
            );
            const totalExpenses = Object.values(
              gameState.expenseBreakdown
            ).reduce((sum, item) => sum + item.amount, 0);
            const netIncome = totalSalary - totalExpenses;
            gameState.cash += netIncome;

            const marketFluctuation = (Math.random() - 0.45) / 10;
            gameState.equity *= 1 + marketFluctuation;

            if (gameState.cash > 0 && gameState.investment_multiplier > 1.0) {
              let investedAmount = gameState.cash * 0.5;
              let investmentReturn =
                investedAmount * (gameState.investment_multiplier - 1);
              if (Math.random() < gameState.investment_risk) {
                gameState.cash -= investmentReturn * 2.5;
              } else {
                gameState.cash += investmentReturn;
              }
            }
            if (gameState.retirement > 0) {
              gameState.retirement *= 1.07;
            }

            if (
              gameState.cash > 0 &&
              Object.keys(gameState.expenseBreakdown).some((k) =>
                k.includes('loan')
              )
            ) {
              updateCreditScore(2);
            } else if (gameState.cash < 0) {
              updateCreditScore(-5);
            }

            gameState.currentAge++;
            gameState.currentYear++;
            gameState.children.forEach((child) => child.age++);
          }

          if (gameState.burnout >= 25) {
            triggerBurnoutEvent();
            gameState.burnout = 0;
          }
        };

        const displayQuestion = () => {
          if (currentQuestionIndex > 0) {
            const prevStage = filteredGameData[currentQuestionIndex - 1];
            runTimeSkipUpdate(prevStage.time_skip);
          }
          filterGameStages();
          updateAvatar();
          updateTimeline();
          updateFinancialsUI();

          if (currentQuestionIndex < filteredGameData.length) {
            const stage = filteredGameData[currentQuestionIndex];
            questionText.textContent = stage.question;
            answersContainer.innerHTML = '';

            if (stage.back) {
              backButton.classList.remove('hidden');
            } else {
              backButton.classList.add('hidden');
            }

            stage.answers.forEach((answer) => {
              const button = document.createElement('button');

              button.className =
                'w-full text-left p-4 rounded-lg bg-slate-100 hover:bg-indigo-100 hover:ring-2 hover:ring-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200';
              button.addEventListener('click', () => {
                showConfirmation(answer.effects);
              });

              const answerTextEl = document.createElement('span');
              answerTextEl.className = 'answer-text font-semibold';
              answerTextEl.textContent = answer.text;
              const consequenceText = document.createElement('span');
              consequenceText.className = 'answer-consequence';
              consequenceText.textContent = answer.consequence;
              button.appendChild(answerTextEl);
              button.appendChild(consequenceText);
              answersContainer.appendChild(button);
            });

            if (stage.question.includes('How do you handle your finances?')) {
              if (gameState.cash < 2000) {
                answersContainer
                  .querySelectorAll('button')
                  .forEach((button) => {
                    button.disabled = true;
                    button.classList.add('cursor-not-allowed', 'text-gray-400');
                  });
                const noInvest = document.createElement('p');
                noInvest.className = 'md:col-span-2 text-center text-slate-500';
                noInvest.textContent =
                  'You need at least $2,000 cash to start investing.';
                answersContainer.appendChild(noInvest);
              }
            }

            updateProgressBar();
          } else {
            showResult();
          }
        };

        const showConfirmation = (effects) => {
          currentEffects = effects;
          const effectsContainer = document.getElementById(
            'confirmation-effects'
          );
          effectsContainer.innerHTML = '';

          const addEffectToList = (label, value, color = 'text-slate-800') => {
            const p = document.createElement('p');
            p.className = `flex justify-between ${color}`;
            p.innerHTML = `<span>${label}:</span><span class="font-bold">${value}</span>`;
            effectsContainer.appendChild(p);
          };

          if (effects.cash_change && typeof effects.cash_change === 'number')
            addEffectToList(
              'Cash',
              `${
                effects.cash_change > 0 ? '+' : ''
              }$${effects.cash_change.toLocaleString()}`,
              effects.cash_change > 0 ? 'text-green-600' : 'text-red-600'
            );
          if (effects.expense_add)
            addEffectToList(
              'Annual Expenses',
              `+$${effects.expense_add.amount.toLocaleString()}`,
              'text-red-600'
            );
          if (effects.salary_add)
            addEffectToList(
              'Annual Salary',
              `+$${effects.salary_add.amount.toLocaleString()}`,
              'text-green-600'
            );

          let happinessChange = effects.happiness || 0;
          if (effects.personality_match) {
            if (effects.personality_match === gameState.personality) {
              happinessChange *= 1.5;
            } else {
              happinessChange *= 0.5;
            }
          }
          happinessChange = Math.round(happinessChange);
          if (happinessChange !== 0)
            addEffectToList(
              'Happiness',
              `${happinessChange > 0 ? '+' : ''}${happinessChange}`,
              happinessChange > 0 ? 'text-green-600' : 'text-red-600'
            );

          if (effectsContainer.innerHTML === '') {
            const p = document.createElement('p');
            p.className = `text-slate-600`;
            p.textContent = 'No immediate financial or happiness changes.';
            effectsContainer.appendChild(p);
          }

          confirmationModal.classList.remove('hidden');
          setTimeout(
            () => confirmationModal.classList.remove('opacity-0', 'scale-95'),
            10
          );
        };

        const hideConfirmationModal = () => {
          confirmationModal.classList.add('opacity-0', 'scale-95');
          setTimeout(() => confirmationModal.classList.add('hidden'), 300);
        };

        const confirmAndProceed = () => {
          hideConfirmationModal();
          let cost = 0;
          if (currentEffects.cash_change && currentEffects.cash_change < 0) {
            cost = Math.abs(currentEffects.cash_change);
          }
          if (cost > 0 && gameState.cash < cost) {
            promptForDebt(cost, currentEffects);
          } else {
            selectAnswer(currentEffects);
          }
        };

        const promptForDebt = (cost, effects) => {
          const debtAmount = cost - gameState.cash;
          const debtButtons = document.getElementById('debt-buttons');
          const debtTitle = document.getElementById('debt-title');

          if (gameState.creditScore < 580) {
            // Poor credit
            document.getElementById(
              'debt-description'
            ).textContent = `You are short $${debtAmount.toLocaleString()}. Unfortunately, with a poor credit score of ${
              gameState.creditScore
            }, your loan application was denied.`;
            debtButtons.classList.add('hidden');
            debtTitle.textContent = 'Loan Denied';
          } else {
            debtButtons.classList.remove('hidden');
            debtTitle.textContent = 'Unaffordable Choice';
            let interestRate = 0.25; // Fair credit
            if (gameState.creditScore >= 670) interestRate = 0.2; // Good
            if (gameState.creditScore >= 740) interestRate = 0.15; // Very Good/Excellent

            const debtPayment = Math.round(debtAmount * interestRate);
            document.getElementById(
              'debt-description'
            ).textContent = `You are short $${debtAmount.toLocaleString()}. Based on your credit score, you can take a high-interest personal loan. This will add $${debtPayment.toLocaleString()}/yr to your expenses and cause significant stress.`;

            const takeDebtButton = document.getElementById('take-debt-button');

            const takeDebtHandler = () => {
              const loanEffects = {
                cash_change: debtAmount,
                expense_add: {
                  id: `loan_${Math.random()}`,
                  label: 'Personal Loan',
                  amount: debtPayment,
                },
                happiness: -20,
                creditScore_change: -50,
              };
              const finalEffects = {
                ...effects,
                ...loanEffects,
                cash_change: (effects.cash_change || 0) + debtAmount,
              };
              selectAnswer(finalEffects);
              hideDebtModal();
            };
            takeDebtButton.onclick = takeDebtHandler;
          }

          debtModal.classList.remove('hidden');
          setTimeout(
            () => debtModal.classList.remove('opacity-0', 'scale-95'),
            10
          );
        };

        const hideDebtModal = () => {
          debtModal.classList.add('opacity-0', 'scale-95');
          setTimeout(() => debtModal.classList.add('hidden'), 300);
        };

        const updateCreditScore = (change) => {
          gameState.creditScore += change;
          if (gameState.creditScore > 850) gameState.creditScore = 850;
          if (gameState.creditScore < 300) gameState.creditScore = 300;
        };

        const applyEffects = (effects) => {
          if (!effects) return;

          let happinessChange = effects.happiness || 0;
          if (effects.personality_match) {
            if (effects.personality_match === gameState.personality) {
              happinessChange *= 1.5;
            } else {
              happinessChange *= 0.5;
            }
          }
          gameState.happiness += Math.round(happinessChange);

          if (effects.special_effect === 'add_child') {
            const childNum = gameState.children.length + 1;
            gameState.expenseBreakdown[`child${childNum}`] = {
              label: `Child ${childNum} Costs`,
              amount: 18000,
            };
            gameState.children.push({ age: 0 });
          }
          if (effects.special_effect === 'start_401k') {
            const totalSalary = Object.values(gameState.salaryBreakdown).reduce(
              (sum, item) => sum + item.amount,
              0
            );
            const contribution = totalSalary * effects.rate;
            gameState.expenseBreakdown['401k'] = {
              label: '401k Contribution',
              amount: contribution,
            };
            gameState.retirement += contribution;
          }

          if (effects.cash_change)
            gameState.cash +=
              typeof effects.cash_change === 'function'
                ? effects.cash_change(gameState.cash)
                : effects.cash_change;
          if (effects.equity_change)
            gameState.equity +=
              typeof effects.equity_change === 'function'
                ? effects.equity_change(gameState.equity)
                : effects.equity_change;
          if (effects.set_investment_multiplier)
            gameState.investment_multiplier = effects.set_investment_multiplier;
          if (effects.set_investment_risk)
            gameState.investment_risk = effects.set_investment_risk;

          if (effects.salary_add)
            gameState.salaryBreakdown[effects.salary_add.id] = {
              label: effects.salary_add.label,
              amount: effects.salary_add.amount,
            };
          if (
            effects.salary_remove &&
            gameState.salaryBreakdown[effects.salary_remove]
          )
            delete gameState.salaryBreakdown[effects.salary_remove];
          if (
            effects.salary_boost &&
            gameState.salaryBreakdown[effects.salary_boost.id]
          )
            gameState.salaryBreakdown[effects.salary_boost.id].amount +=
              effects.salary_boost.amount;

          if (effects.expense_add)
            gameState.expenseBreakdown[effects.expense_add.id] = {
              label: effects.expense_add.label,
              amount: effects.expense_add.amount,
            };
          if (
            effects.expense_remove &&
            gameState.expenseBreakdown[effects.expense_remove]
          )
            delete gameState.expenseBreakdown[effects.expense_remove];
          if (
            effects.expense_boost &&
            gameState.expenseBreakdown[effects.expense_boost.id]
          )
            gameState.expenseBreakdown[effects.expense_boost.id].amount +=
              effects.expense_boost.amount;
          if (effects.expense_boost_all) {
            for (const key in gameState.expenseBreakdown) {
              gameState.expenseBreakdown[key].amount *=
                1 + effects.expense_boost_all;
            }
          }
          if (effects.retirement_change)
            gameState.retirement += effects.retirement_change;
          if (effects.career_level_change)
            gameState.careerLevel += effects.career_level_change;
          if (effects.burnout_change)
            gameState.burnout += effects.burnout_change;
          if (effects.creditScore_change)
            updateCreditScore(effects.creditScore_change);

          if (effects.children_add) {
            for (let i = 0; i < effects.children_add; i++) {
              gameState.children.push({ age: 0 });
            }
          }
          if (effects.housing_type)
            gameState.housingType = effects.housing_type;
          if (effects.career_type) gameState.careerType = effects.career_type;
          if (effects.sector) gameState.sector = effects.sector;
          if (effects.avatar)
            gameState.avatar[effects.avatar.type] = effects.avatar.icon;
          if (effects.add_qualification)
            gameState.qualifications.push(effects.add_qualification);
        };

        const selectAnswer = (effects) => {
          applyEffects(effects);
          currentQuestionIndex++;

          const majorEventChance = 0.15;
          const minorEventChance = 0.2;
          const childEventChance = 0.25;

          if (gameState.careerType) {
            if (
              gameState.children.length > 0 &&
              Math.random() < childEventChance
            ) {
              triggerChildEvent();
            } else if (
              Math.random() < majorEventChance &&
              currentQuestionIndex < filteredGameData.length - 2 &&
              currentQuestionIndex > 2
            ) {
              triggerMajorEvent();
            } else if (
              Math.random() < minorEventChance &&
              currentQuestionIndex < filteredGameData.length
            ) {
              triggerMinorEvent();
            } else {
              continueToNextQuestion();
            }
          } else {
            continueToNextQuestion();
          }
        };

        const goBack = () => {
          gameState.sector = null;
          currentQuestionIndex = 0;
          continueToNextQuestion();
        };

        const continueToNextQuestion = () => {
          quizScreen.classList.remove('fade-in');
          void quizScreen.offsetWidth;
          quizScreen.classList.add('fade-in');
          displayQuestion();
        };

        const triggerMinorEvent = () => {
          const event =
            minorEvents[Math.floor(Math.random() * minorEvents.length)];
          applyEffects(event.effects);
          eventText.textContent = event.description;

          eventModal.classList.remove('hidden');
          eventModal.style.display = 'flex';
          setTimeout(() => {
            eventModal.classList.remove('opacity-0', 'scale-95');
          }, 10);

          setTimeout(() => {
            eventModal.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
              eventModal.classList.add('hidden');
              eventModal.style.display = 'none';
              continueToNextQuestion();
            }, 300);
          }, 3000);
        };

        const triggerChildEvent = () => {
          const event =
            childEvents[Math.floor(Math.random() * childEvents.length)];
          applyEffects(event.effects);
          eventText.textContent = `A Child Event: ${event.description}`;

          eventModal.classList.remove('hidden');
          eventModal.style.display = 'flex';
          setTimeout(() => {
            eventModal.classList.remove('opacity-0', 'scale-95');
          }, 10);

          setTimeout(() => {
            eventModal.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
              eventModal.classList.add('hidden');
              eventModal.style.display = 'none';
              continueToNextQuestion();
            }, 300);
          }, 3000);
        };

        const triggerBurnoutEvent = () => {
          eventText.textContent =
            "You've pushed yourself too hard and burned out! You're forced to take a lower-stress, lower-paying job to recover.";
          applyEffects({
            salary_remove: 'main_job',
            salary_add: {
              id: 'main_job',
              label: 'Recovery Job',
              amount: 40000,
            },
            happiness: -20,
            salary_remove: 'side_hustle',
          });

          eventModal.classList.remove('hidden');
          eventModal.style.display = 'flex';
          setTimeout(() => {
            eventModal.classList.remove('opacity-0', 'scale-95');
          }, 10);

          setTimeout(() => {
            eventModal.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
              eventModal.classList.add('hidden');
              eventModal.style.display = 'none';
              continueToNextQuestion();
            }, 300);
          }, 3500);
        };

        const triggerMajorEvent = () => {
          const event =
            majorEvents[Math.floor(Math.random() * majorEvents.length)];
          majorEventDescription.textContent = event.description;
          majorEventQuestion.textContent = event.question;
          majorEventChoices.innerHTML = '';

          event.choices.forEach((choice) => {
            const button = document.createElement('button');
            button.className =
              'w-full text-left p-3 rounded-lg bg-slate-200 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-red-500 transition-all duration-200';

            const answerTextEl = document.createElement('span');
            answerTextEl.className = 'answer-text font-semibold';
            answerTextEl.textContent = choice.text;

            const consequenceText = document.createElement('span');
            consequenceText.className = 'answer-consequence text-slate-600';
            consequenceText.textContent = choice.consequence;

            button.appendChild(answerTextEl);
            button.appendChild(consequenceText);
            button.addEventListener('click', () =>
              resolveMajorEvent(choice.effects)
            );
            majorEventChoices.appendChild(button);
          });

          majorEventModal.classList.remove('hidden');
          majorEventModal.style.display = 'flex';
          setTimeout(() => {
            majorEventModal.classList.remove('opacity-0', 'scale-95');
          }, 10);
        };

        const resolveMajorEvent = (effects) => {
          applyEffects(effects);
          majorEventModal.classList.add('opacity-0', 'scale-95');
          setTimeout(() => {
            majorEventModal.classList.add('hidden');
            majorEventModal.style.display = 'none';
            continueToNextQuestion();
          }, 300);
        };

        const updateProgressBar = () => {
          progressBar.style.width = `${
            (filteredGameData.indexOf(filteredGameData[currentQuestionIndex]) /
              filteredGameData.length) *
            100
          }%`;
        };

        const showResult = () => {
          let finalNetWorth = Math.round(
            gameState.cash + gameState.equity + gameState.retirement
          );
          updateFinancialsUI();

          resultScreen.classList.remove('hidden');
          quizScreen.classList.add('hidden');

          let finalHappiness = gameState.happiness;
          let description = '';

          if (finalNetWorth > 1000000 && finalHappiness >= 80) {
            description = `A true master of life! You achieved incredible financial success, ending with a net worth of $${finalNetWorth.toLocaleString()}, while also cultivating deep happiness. Your journey is a testament to smart choices, resilience through unexpected events, and prioritizing what truly matters.`;
          } else if (finalNetWorth > 1500000 && finalHappiness < 50) {
            description = `Your ambition was boundless, and it paid off. You built a financial empire, ending with a staggering net worth of $${finalNetWorth.toLocaleString()}. This relentless pursuit of wealth, however, left little room for personal joy. You won the game, but at what cost?`;
          } else if (finalNetWorth < 150000 && finalHappiness >= 95) {
            description = `You defined success on your own terms. Though your final net worth is a modest $${finalNetWorth.toLocaleString()}, your life was overflowing with joy, relationships, and fulfillment. Your story is a powerful reminder that the richest life isn't always about money.`;
          } else if (finalNetWorth < 0) {
            description = `Life threw its toughest challenges at you. A series of difficult circumstances and major unforeseen events led to ending in debt with a net worth of $${finalNetWorth.toLocaleString()}. It's a tough outcome, but every journey has lessons, and yours is one of resilience in the face of hardship.`;
          } else {
            description = `You navigated life with a steady hand, weathering its storms and embracing its opportunities. You built a comfortable, stable life, ending with a net worth of $${finalNetWorth.toLocaleString()} and a content state of mind. Your journey was one of balance, security, and quiet satisfaction.`;
          }
          
          // Add Lifetime Mode transition option
          description += `<div class="mt-6 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border-2 border-indigo-200">
            <h4 class="font-bold text-indigo-800 mb-2">Ready for the Full Journey?</h4>
            <p class="text-slate-700 text-sm mb-3">Continue your story in <strong>Lifetime Mode</strong>: Experience 40-50 years of life with realistic events, retirement planning, and see how your choices compound over decades.</p>
            <button id="start-lifetime-button" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-all">
              Begin Lifetime Mode â†’
            </button>
          </div>`;
          
          document.getElementById('result-description').innerHTML =
            description;
        };

        document
          .getElementById('start-button')
          .addEventListener('click', startQuiz);
        document
          .getElementById('salary-breakdown-button')
          .addEventListener('click', () => showBreakdown('salary'));
        document
          .getElementById('expenses-breakdown-button')
          .addEventListener('click', () => showBreakdown('expenses'));
        document
          .getElementById('hide-breakdown-button')
          .addEventListener('click', hideBreakdown);
        document
          .getElementById('cancel-debt-button')
          .addEventListener('click', hideDebtModal);
        document
          .getElementById('back-button')
          .addEventListener('click', goBack);
        document
          .getElementById('avatar-button')
          .addEventListener('click', showProfileModal);
        document
          .getElementById('hide-profile-button')
          .addEventListener('click', hideProfileModal);
        document
          .getElementById('change-career-button')
          .addEventListener('click', () => showActionModal('career'));
        document
          .getElementById('change-lifestyle-button')
          .addEventListener('click', () => showActionModal('lifestyle'));
        document
          .getElementById('confirm-choice-button')
          .addEventListener('click', confirmAndProceed);
        document
          .getElementById('cancel-choice-button')
          .addEventListener('click', hideConfirmationModal);
          
        // ========== LIFETIME MODE FUNCTIONS ==========
        let lifetimeTickInterval = null;
        
        function startLifetimeMode() {
          quizScreen.classList.add('hidden');
          document.getElementById('lifetime-screen').classList.remove('hidden');
          document.getElementById('lifetime-screen').classList.add('fade-in');
          
          window.lifetimeAutoAdvance = true;
          lifetimeTickInterval = setInterval(lifetimeTick, 100); // 100ms per month
        }
        
        function lifetimeTick() {
          if (!window.lifetimeAutoAdvance) return;
          
          const player = window.lifeSimPlayer;
          const careerState = window.lifeSimCareer;
          const clock = window.lifetimeClock;
          const household = window.lifetimeHousehold;
          const housing = window.lifetimeHousing;
          const loans = window.lifetimeLoans;
          const eventLog = window.lifetimeEventLog;
          const retCfg = window.retirementConfig;
          
          if (!player || !careerState || !clock) return;
          
          // Advance time
          advanceOneMonth(clock);
          const ageYears = getAgeYears(clock);
          player.ageMonths = clock.ageMonths;
          
          // Check for checkpoint pause
          if (shouldPauseForCheckpoint(clock, window.lifetimeLastCheckpoint)) {
            window.lifetimeAutoAdvance = false;
            window.lifetimeLastCheckpoint = ageYears;
            showCheckpointModal(ageYears);
            return;
          }
          
          // Check for retirement
          if (!player.isRetired && isRetirementAge(clock)) {
            player.isRetired = true;
            player.retirementIncome = initRetirementIncome(player, careerState, retCfg);
            addEventToLog(eventLog, clock, `Retired at age ${ageYears}!`);
          }
          
          // Check for end
          if (reachedEnd(clock)) {
            window.lifetimeAutoAdvance = false;
            clearInterval(lifetimeTickInterval);
            showRetirementOutcome();
            return;
          }
          
          // Monthly simulation logic
          const isEmployed = !player.unemployed;
          const regionCfg = costOfLiving.regions[player.region];
          const regionMult = calcRegionMultiplier(player.region);
          
          // Income
          let gross = 0;
          if (player.isRetired) {
            const retIncome = player.retirementIncome;
            gross = retIncome.social_security + retIncome.pension + retIncome.withdrawal;
            player.cash += gross - retIncome.health_insurance;
          } else if (player.unemployed) {
            const lastWage = careerState.type === 'salary' ? 
              careerState.currentBasePay / 12 : 
              careerState.currentBasePay * careerState.hours_per_week * 4.33;
            gross = lastWage * (player.unemploymentBenefit || 0.45);
            player.cash += gross;
            if (player.unemploymentRemaining) {
              player.unemploymentRemaining--;
              if (player.unemploymentRemaining <= 0) player.unemployed = false;
            }
          } else {
            gross = careerState.type === 'salary' ? 
              careerState.currentBasePay / 12 : 
              careerState.currentBasePay * careerState.hours_per_week * 4.33;
            player.cash += gross * 0.7; // Simplified net (70% take-home)
            player.monthsWorked = (player.monthsWorked || 0) + 1;
            
            // Raises (only if employed)
            const perfScore = 1.0;
            if (ageYears < 55) {
              const colaRate = (careerState.raise.cola || 0.02) / 12;
              const meritRate = ((careerState.raise.merit[0] + careerState.raise.merit[1]) / 2 / 12) * perfScore;
              careerState.currentBasePay *= (1 + colaRate + meritRate);
              careerState.monthsInRole++;
            } else {
              // Plateau: only COLA
              const colaRate = (careerState.raise.cola || 0.02) / 12;
              careerState.currentBasePay *= (1 + colaRate);
            }
          }
          
          // Household
          advanceHouseholdOneMonth(household);
          const childcareCosts = getActiveChildcareCosts(household);
          
          // Housing
          if (housing.owned) {
            advanceMortgageOneMonth(housing, 0.03 / 12); // 3% annual appreciation
          }
          
          // Loans
          const { totalPayment: loanPayment } = advanceLoansOneMonth(loans);
          
          // Investments
          if (isEmployed && !player.isRetired && player.investmentContribution) {
            const contribution = player.investmentContribution || 100;
            player.cash -= contribution;
            const employerMatch = contribution * 0.03; // 3% match
            const totalContribution = contribution + employerMatch;
            player.investments = (player.investments || 0) + totalContribution;
            
            // Monthly return (simplified)
            const monthlyReturn = (retCfg.investment.mean_return / 12);
            player.investments *= (1 + monthlyReturn);
          }
          
          // Expenses
          let expenses = buildMonthlyExpenses(player, regionCfg, regionMult);
          expenses = applySharedExpenses(expenses, household.partner);
          expenses.childcare = childcareCosts;
          expenses.housing = getMonthlyHousingCost(player, housing, regionCfg.basket, regionMult);
          expenses.loans = loanPayment;
          
          const totalExpenses = Object.values(expenses).reduce((a, b) => a + b, 0);
          player.cash -= totalExpenses;
          
          // Update UI every month
          updateLifetimeUI();
          
          // Log year-end summary
          if (clock.currentMonth % 12 === 0) {
            console.log(`Year ${clock.currentYear}: Age ${ageYears}, Cash $${Math.round(player.cash)}, Investments $${Math.round(player.investments || 0)}`);
          }
        }
        
        function updateLifetimeUI() {
          const player = window.lifeSimPlayer;
          const clock = window.lifetimeClock;
          const household = window.lifetimeHousehold;
          const housing = window.lifetimeHousing;
          const loans = window.lifetimeLoans;
          
          if (!player || !clock) return;
          
          const ageYears = getAgeYears(clock);
          const progress = (ageYears - 20) / 47 * 100; // Age 20-67
          
          document.getElementById('lifetime-age').textContent = ageYears;
          document.getElementById('lifetime-progress').style.width = `${Math.min(100, progress)}%`;
          
          document.getElementById('household-partner').textContent = household.partner ? 'Yes' : 'No';
          document.getElementById('household-children').textContent = household.children.length;
          document.getElementById('household-childcare').textContent = `$${Math.round(getActiveChildcareCosts(household))}/mo`;
          
          document.getElementById('lifetime-cash').textContent = `$${Math.round(player.cash).toLocaleString()}`;
          document.getElementById('lifetime-investments').textContent = `$${Math.round(player.investments || 0).toLocaleString()}`;
          document.getElementById('lifetime-equity').textContent = `$${Math.round(getHomeEquity(housing)).toLocaleString()}`;
          
          const loanBalance = getTotalLoanBalance(loans);
          document.getElementById('lifetime-loan-balance').textContent = `$${Math.round(loanBalance).toLocaleString()}`;
          
          let totalLoanPayment = 0;
          ['student', 'car', 'personal'].forEach(type => {
            if (loans[type]) {
              loans[type].forEach(loan => {
                totalLoanPayment += loan.monthlyPayment;
              });
            }
          });
          document.getElementById('lifetime-loan-payment').textContent = `$${Math.round(totalLoanPayment)}/mo`;
          document.getElementById('lifetime-mortgage').textContent = housing.owned ? 
            `$${Math.round(housing.monthlyPayment || 0)}/mo` : '$0/mo';
        }
        
        function showCheckpointModal(age) {
          const player = window.lifeSimPlayer;
          const housing = window.lifetimeHousing;
          const loans = window.lifetimeLoans;
          const careerState = window.lifeSimCareer;
          
          const modal = document.getElementById('checkpoint-modal');
          document.getElementById('checkpoint-age').textContent = `Age ${age}`;
          
          const netWorth = player.cash + (player.investments || 0) + getHomeEquity(housing) - getTotalLoanBalance(loans);
          const monthlyIncome = careerState.type === 'salary' ? 
            careerState.currentBasePay / 12 : 
            careerState.currentBasePay * careerState.hours_per_week * 4.33;
          
          document.getElementById('checkpoint-networth').textContent = `$${Math.round(netWorth).toLocaleString()}`;
          document.getElementById('checkpoint-income').textContent = `$${Math.round(monthlyIncome).toLocaleString()}/mo`;
          document.getElementById('checkpoint-loans').textContent = `$${Math.round(getTotalLoanBalance(loans)).toLocaleString()}`;
          document.getElementById('checkpoint-equity').textContent = `$${Math.round(getHomeEquity(housing)).toLocaleString()}`;
          
          // Generate choices
          const choicesEl = document.getElementById('checkpoint-choices');
          choicesEl.innerHTML = '';
          
          const choices = [
            {
              label: 'Continue as planned',
              description: 'Stay the course with your current strategy.',
              action: () => resumeLifetime()
            }
          ];
          
          // Conditional choices
          if (getTotalLoanBalance(loans) > 0 && player.cash > 1000) {
            choices.push({
              label: 'Make extra loan payment ($1,000)',
              description: 'Reduce your highest-interest debt.',
              action: () => {
                player.cash -= 1000;
                // Pay on highest APR loan
                let maxAPR = 0;
                let targetType = null;
                let targetLoan = null;
                ['student', 'car', 'personal'].forEach(type => {
                  if (loans[type] && loans[type].length > 0) {
                    const loan = loans[type][0];
                    if (loan.apr > maxAPR) {
                      maxAPR = loan.apr;
                      targetType = type;
                      targetLoan = loan;
                    }
                  }
                });
                if (targetLoan) {
                  const payment = Math.min(1000, targetLoan.principal);
                  targetLoan.principal -= payment;
                  addEventToLog(window.lifetimeEventLog, window.lifetimeClock, `Made extra $${payment} payment on ${targetType} loan`);
                }
                resumeLifetime();
              }
            });
          }
          
          if (!housing.owned && player.cash > 10000 && age < 50) {
            const retCfg = window.retirementConfig;
            const grossIncome = monthlyIncome * 12;
            const homePrice = grossIncome * 3.0; // Conservative estimate
            choices.push({
              label: `Consider buying a home (~$${Math.round(homePrice / 1000)}k)`,
              description: 'Build equity instead of renting.',
              action: () => {
                const success = purchaseHome(
                  housing, 
                  player, 
                  homePrice, 
                  0.20, // 20% down
                  retCfg.housing_purchase.apr, 
                  retCfg.housing_purchase.term_years * 12,
                  retCfg.housing_purchase.closing_cost_pct
                );
                if (success) {
                  addEventToLog(window.lifetimeEventLog, window.lifetimeClock, `Purchased home for $${Math.round(homePrice).toLocaleString()}`);
                }
                resumeLifetime();
              }
            });
          }
          
          if (age % 10 === 0 && player.investmentContribution < 500) {
            choices.push({
              label: 'Increase retirement contributions',
              description: 'Boost your monthly investment by $100.',
              action: () => {
                player.investmentContribution = (player.investmentContribution || 100) + 100;
                addEventToLog(window.lifetimeEventLog, window.lifetimeClock, `Increased retirement contributions to $${player.investmentContribution}/mo`);
                resumeLifetime();
              }
            });
          }
          
          choices.forEach(choice => {
            const btn = document.createElement('button');
            btn.className = 'w-full text-left p-4 rounded-lg bg-white hover:bg-indigo-50 border-2 border-slate-200 hover:border-indigo-400 transition-all';
            btn.innerHTML = `
              <div class="font-bold text-slate-800 mb-1">${choice.label}</div>
              <div class="text-sm text-slate-600">${choice.description}</div>
            `;
            btn.onclick = choice.action;
            choicesEl.appendChild(btn);
          });
          
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          setTimeout(() => {
            modal.style.opacity = '1';
            modal.style.transform = 'scale(1)';
          }, 10);
        }
        
        function resumeLifetime() {
          const modal = document.getElementById('checkpoint-modal');
          modal.style.opacity = '0';
          modal.style.transform = 'scale(0.95)';
          setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
          }, 300);
          
          window.lifetimeAutoAdvance = true;
        }
        
        function addEventToLog(eventLog, clock, description) {
          const ageYears = getAgeYears(clock);
          eventLog.history.push({
            month: clock.currentMonth,
            year: clock.currentYear,
            ageYears,
            description
          });
          
          // Update UI
          const eventsEl = document.getElementById('lifetime-events');
          const recentEvents = eventLog.history.slice(-10).reverse();
          eventsEl.innerHTML = recentEvents.map(e => 
            `<div class="text-sm"><span class="font-semibold text-indigo-600">Age ${e.ageYears}:</span> ${e.description}</div>`
          ).join('');
        }
        
        function showRetirementOutcome() {
          const player = window.lifeSimPlayer;
          const housing = window.lifetimeHousing;
          const loans = window.lifetimeLoans;
          const clock = window.lifetimeClock;
          
          const netWorth = player.cash + (player.investments || 0) + getHomeEquity(housing) - getTotalLoanBalance(loans);
          const retIncome = player.retirementIncome;
          const monthlyIncome = retIncome ? 
            retIncome.social_security + retIncome.pension + retIncome.withdrawal : 0;
          const monthlyExpenses = 3000; // Simplified
          
          const grade = gradeRetirementOutcome(netWorth, monthlyIncome, monthlyExpenses, getAgeYears(clock));
          
          document.getElementById('lifetime-screen').classList.add('hidden');
          resultScreen.classList.remove('hidden');
          resultScreen.classList.add('fade-in');
          
          document.getElementById('result-title').textContent = `Retirement Grade: ${grade}`;
          document.getElementById('result-description').innerHTML = `
            <div class="text-left space-y-2">
              <p><strong>Net Worth:</strong> $${Math.round(netWorth).toLocaleString()}</p>
              <p><strong>Monthly Retirement Income:</strong> $${Math.round(monthlyIncome).toLocaleString()}</p>
              <p><strong>Social Security:</strong> $${Math.round(retIncome.social_security).toLocaleString()}/mo</p>
              <p><strong>Investment Withdrawals:</strong> $${Math.round(retIncome.withdrawal).toLocaleString()}/mo</p>
              <p><strong>Income Replacement:</strong> ${Math.round(monthlyIncome / monthlyExpenses * 100)}%</p>
              <p class="mt-4 text-slate-700">${getGradeMessage(grade)}</p>
            </div>
          `;
        }
        
        function getGradeMessage(grade) {
          const messages = {
            'A': 'Excellent! You built substantial wealth and have a comfortable retirement ahead.',
            'B': 'Well done! You have a solid retirement plan with good income replacement.',
            'C': 'Not bad! Your retirement is secure, though you may need to be mindful of spending.',
            'D': 'Challenging. Your retirement income is tight, and you may need to make adjustments.',
            'F': 'Difficult situation. Consider working longer or finding additional income sources.'
          };
          return messages[grade] || 'Your retirement outcome has been calculated.';
        }
        
        // Pause/Resume buttons
        document.getElementById('lifetime-pause').addEventListener('click', () => {
          window.lifetimeAutoAdvance = false;
          document.getElementById('lifetime-pause').classList.add('hidden');
          document.getElementById('lifetime-resume').classList.remove('hidden');
        });
        
        document.getElementById('lifetime-resume').addEventListener('click', () => {
          window.lifetimeAutoAdvance = true;
          document.getElementById('lifetime-resume').classList.add('hidden');
          document.getElementById('lifetime-pause').classList.remove('hidden');
        });
        
        // Lifetime Mode button (added dynamically to result screen)
        document.addEventListener('click', (e) => {
          if (e.target && e.target.id === 'start-lifetime-button') {
            resultScreen.classList.add('hidden');
            
            // Initialize investment contribution if not set
            if (!window.lifeSimPlayer.investmentContribution) {
              window.lifeSimPlayer.investmentContribution = 100; // Default $100/mo
            }
            
            startLifetimeMode();
          }
        });
        
        // Expose startLifetimeMode globally for testing
        window.startLifetimeMode = startLifetimeMode;
      });
    </script>
  </body>
</html>
