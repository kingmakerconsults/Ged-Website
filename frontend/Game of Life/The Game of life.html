<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Game of Life: A Choices Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Inter', sans-serif;
        touch-action: manipulation;
      }
      .quiz-container {
        min-height: 450px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      .fade-out {
        animation: fadeOut 0.5s ease-in-out forwards;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes fadeOut {
        from {
          opacity: 1;
          transform: translateY(0);
        }
        to {
          opacity: 0;
          transform: translateY(-10px);
        }
      }
      .answer-text {
        display: block;
      }
      .answer-consequence {
        display: block;
        font-size: 0.875rem; /* text-sm */
        color: #475569; /* text-slate-600, darker for readability */
        margin-top: 4px;
      }
      .stats-bar {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 0.5rem;
        padding: 0.5rem;
        background-color: #f1f5f9; /* bg-slate-100 */
        border-radius: 0.75rem; /* rounded-xl */
      }
      .stat {
        text-align: center;
      }
      .stat button {
        width: 100%;
        height: 100%;
        padding: 0.5rem 0.25rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s;
      }
      .stat button:hover {
        background-color: #e2e8f0;
      }
      .stat-value {
        font-weight: 700;
        font-size: 1rem;
        color: #1e293b;
        display: block;
      }
      .stat-label {
        font-size: 0.75rem;
        color: #64748b;
        text-transform: uppercase;
        display: block;
      }
      .modal {
        transition: opacity 0.3s, transform 0.3s;
      }
      .avatar-icon {
        animation: popIn 0.3s ease-out;
      }
      @keyframes popIn {
        from {
          transform: scale(0.5);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body
    class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4"
  >
    <div
      id="quiz"
      class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-6 sm:p-8 lg:p-10 transition-all duration-300 relative"
    >
      <!-- Start Screen (Refactored) -->
      <div id="start-screen" class="text-center fade-in">
        <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 mb-4">
          The Game of Life
        </h1>
        <p class="text-slate-600 mb-6 sm:text-lg">
          Welcome to a simulation of your future. Your choices and random events
          will shape your life. Enter your starting point below.
        </p>
        <div class="max-w-md mx-auto space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label
                for="startAge"
                class="block text-sm font-medium text-slate-700 mb-1"
                >Your Current Age</label
              >
              <input
                type="number"
                id="startAge"
                class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                value="18"
              />
            </div>
            <div>
              <label
                for="startYear"
                class="block text-sm font-medium text-slate-700 mb-1"
                >Current Year</label
              >
              <input
                type="number"
                id="startYear"
                class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                value="2025"
              />
            </div>
          </div>
          <div class="hidden">
            <label
              for="scenario-select"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Scenario Preset</label
            >
            <select
              id="scenario-select"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
            ></select>
          </div>
          <div class="hidden">
            <label
              for="region-select"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Region</label
            >
            <select
              id="region-select"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
            >
              <option value="LOW">Low Cost</option>
              <option value="MED">Medium Cost</option>
              <option value="HIGH">High Cost</option>
            </select>
          </div>
          <div class="hidden">
            <label
              for="career-select"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Career</label
            >
            <select
              id="career-select"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
            ></select>
          </div>
          <div class="hidden">
            <label
              for="dwelling-select"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Dwelling (optional)</label
            >
            <select
              id="dwelling-select"
              class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
            >
              <option value="">No dwelling yet</option>
              <option value="rent_roommate">Roommate</option>
              <option value="rent_studio">Studio</option>
              <option value="rent_1br">1BR Apartment</option>
              <option value="rent_2br">2BR Apartment</option>
            </select>
          </div>
          <div
            id="budget-preview"
            class="bg-slate-50 rounded-lg p-4 mt-2 text-left"
          >
            <div class="font-semibold mb-1">Budget Preview</div>
            <div id="budget-preview-content" class="text-sm"></div>
            <div
              id="rent-badge"
              class="inline-block mt-2 px-2 py-1 rounded bg-green-100 text-green-700 text-xs font-semibold"
            >
              Rent: $0 (choose a dwelling)
            </div>
          </div>
          <p id="start-error" class="text-red-500 text-sm mb-4 hidden">
            Please enter a valid age and year.
          </p>
          <button
            id="start-button"
            class="w-full sm:w-auto bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-all duration-300 transform hover:scale-105"
          >
            Begin (Age â†’ Personality)
          </button>
        </div>
      </div>

      <!-- Personality Quiz Screen -->
      <div id="personality-quiz-screen" class="hidden quiz-container">
        <div>
          <h2
            id="personality-question-text"
            class="text-2xl font-bold my-6 text-center text-slate-900"
          ></h2>
          <div
            id="personality-answers-container"
            class="grid grid-cols-1 md:grid-cols-2 gap-4"
          ></div>
        </div>
        <div class="mt-8">
          <div class="w-full bg-slate-200 rounded-full h-2.5">
            <div
              id="personality-progress-bar"
              class="bg-indigo-600 h-2.5 rounded-full"
              style="width: 0%"
            ></div>
          </div>
        </div>
      </div>

      <!-- Quiz Screen -->
      <div id="quiz-screen" class="hidden quiz-container">
        <div>
          <!-- Avatar Display -->
          <div class="flex justify-between items-center mb-4">
            <button
              id="avatar-button"
              class="relative w-24 h-24 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 rounded-full"
            >
              <div id="avatar-bg" class="absolute inset-0 z-0"></div>
              <div id="avatar-body" class="absolute z-10">
                <svg
                  class="w-16 h-16 text-slate-300"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    fill-rule="evenodd"
                    d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
              </div>
              <div
                id="avatar-item"
                class="absolute z-20 bottom-0 -left-2"
              ></div>
              <div
                id="avatar-accessory"
                class="absolute z-20 top-0 -right-2"
              ></div>
            </button>
            <div class="flex-grow text-right pl-4">
              <div id="timeline" class="mb-2">
                <span
                  id="current-age"
                  class="text-2xl font-bold text-indigo-600"
                  >Age: 18</span
                >
                <span id="current-year" class="text-lg text-slate-500 ml-2"
                  >Year: 2025</span
                >
              </div>
              <div
                id="happiness-container"
                class="flex items-center justify-end"
              >
                <span id="happiness-stat" class="stat-value text-2xl">ðŸ˜Š</span>
                <span class="stat-label ml-2">Happiness</span>
              </div>
            </div>
          </div>

          <div id="stats-bar" class="stats-bar">
            <div class="stat">
              <span id="cash-stat" class="stat-value">$5,000</span>
              <span class="stat-label">Cash</span>
            </div>
            <div class="stat">
              <span id="savings-stat" class="stat-value">$0</span>
              <span class="stat-label">Savings</span>
            </div>
            <div class="stat">
              <span id="debt-stat" class="stat-value">$0</span>
              <span class="stat-label">Debt</span>
            </div>
            <div class="stat">
              <button id="salary-breakdown-button">
                <span id="salary-stat" class="stat-value">$0/yr</span>
                <span class="stat-label">Salary</span>
              </button>
            </div>
            <div class="stat">
              <span id="happiness-stat-value" class="stat-value">50</span>
              <span class="stat-label">Happiness</span>
            </div>
          </div>

          <!-- Savings Rate Control -->
          <div
            id="savings-rate-control"
            class="mt-4 p-4 bg-indigo-50 rounded-lg border border-indigo-200"
          >
            <label class="block text-sm font-semibold text-slate-700 mb-2"
              >ðŸ’° Your Savings Rate (% of salary to save each year):</label
            >
            <div class="grid grid-cols-5 gap-2 text-xs">
              <label
                class="flex flex-col items-center p-2 bg-white rounded border border-slate-200 cursor-pointer hover:bg-indigo-50 transition"
              >
                <input
                  type="radio"
                  name="savingsRate"
                  value="0.1"
                  class="mb-1"
                />
                <span class="font-semibold">10%</span>
                <span class="text-slate-500">Comfort</span>
              </label>
              <label
                class="flex flex-col items-center p-2 bg-white rounded border-2 border-indigo-500 cursor-pointer hover:bg-indigo-50 transition"
              >
                <input
                  type="radio"
                  name="savingsRate"
                  value="0.2"
                  checked
                  class="mb-1"
                />
                <span class="font-semibold">20%</span>
                <span class="text-slate-500">Balanced</span>
              </label>
              <label
                class="flex flex-col items-center p-2 bg-white rounded border border-slate-200 cursor-pointer hover:bg-indigo-50 transition"
              >
                <input
                  type="radio"
                  name="savingsRate"
                  value="0.3"
                  class="mb-1"
                />
                <span class="font-semibold">30%</span>
                <span class="text-slate-500">Disciplined</span>
              </label>
              <label
                class="flex flex-col items-center p-2 bg-white rounded border border-slate-200 cursor-pointer hover:bg-indigo-50 transition"
              >
                <input
                  type="radio"
                  name="savingsRate"
                  value="0.4"
                  class="mb-1"
                />
                <span class="font-semibold">40%</span>
                <span class="text-slate-500">Aggressive</span>
              </label>
              <label
                class="flex flex-col items-center p-2 bg-white rounded border border-slate-200 cursor-pointer hover:bg-indigo-50 transition"
              >
                <input
                  type="radio"
                  name="savingsRate"
                  value="0.5"
                  class="mb-1"
                />
                <span class="font-semibold">50%</span>
                <span class="text-slate-500">Extreme</span>
              </label>
            </div>
            <p class="text-xs text-slate-600 mt-2">
              ðŸ’¡ Higher savings = more security but less lifestyle spending
              (affects happiness)
            </p>

            <!-- Year Summary Panel -->
            <div
              id="year-summary"
              class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-300 text-sm"
            >
              <h3 class="font-bold text-slate-800 mb-3">
                ðŸ“Š Financial Overview
              </h3>
              <div class="grid grid-cols-2 gap-2 text-xs">
                <div class="flex justify-between">
                  <span class="text-slate-600">Age:</span>
                  <span id="summary-age" class="font-semibold">18</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-600">Annual Salary:</span>
                  <span id="summary-salary" class="font-semibold">$0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-600">Savings Rate:</span>
                  <span id="summary-savings-rate" class="font-semibold"
                    >20%</span
                  >
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-600">Saved This Year:</span>
                  <span id="summary-saved" class="font-semibold text-green-700"
                    >$0</span
                  >
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-600">Essential Expenses:</span>
                  <span
                    id="summary-essentials"
                    class="font-semibold text-orange-600"
                    >$0</span
                  >
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-600">Lifestyle Budget:</span>
                  <span
                    id="summary-lifestyle"
                    class="font-semibold text-blue-600"
                    >$0</span
                  >
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-600">Current Debt:</span>
                  <span id="summary-debt" class="font-semibold text-red-600"
                    >$0</span
                  >
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-600">Net Worth:</span>
                  <span
                    id="summary-net-worth"
                    class="font-semibold text-indigo-700"
                    >$0</span
                  >
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-600">Happiness:</span>
                  <span id="summary-happiness" class="font-semibold">50</span>
                </div>
              </div>
            </div>
          </div>
          <h2
            id="question-text"
            class="text-2xl font-bold my-6 text-slate-900"
          ></h2>
          <div
            id="answers-container"
            class="grid grid-cols-1 md:grid-cols-2 gap-4"
          ></div>
        </div>
        <div class="mt-8 flex justify-between items-center">
          <button
            id="back-button"
            class="hidden bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 transition-all duration-300"
          >
            &larr; Back
          </button>
          <div
            id="progress-container"
            class="w-full bg-slate-200 rounded-full h-2.5 ml-4"
          >
            <div
              id="progress-bar"
              class="bg-indigo-600 h-2.5 rounded-full"
              style="width: 0%"
            ></div>
          </div>
        </div>
      </div>

      <!-- Result Screen -->
      <div id="result-screen" class="hidden text-center fade-in">
        <h2
          id="result-title"
          class="text-3xl sm:text-4xl font-bold text-slate-900 mb-4"
        >
          Your Life Story
        </h2>
        <p
          id="result-description"
          class="text-slate-600 mb-6 sm:text-lg bg-slate-50 p-4 rounded-lg"
        ></p>
        <div class="grid gap-6 md:grid-cols-2 mt-8">
          <div class="bg-white rounded-xl shadow p-4">
            <h3 class="text-lg font-semibold mb-2">Net Worth Over Time</h3>
            <canvas
              id="networth-chart"
              aria-label="Net Worth line chart"
              role="img"
            ></canvas>
          </div>
          <div class="bg-white rounded-xl shadow p-4">
            <h3 class="text-lg font-semibold mb-2">Income Split</h3>
            <canvas
              id="income-split-chart"
              aria-label="Income split stacked bar"
              role="img"
            ></canvas>
          </div>
        </div>
      </div>

      <!-- Lifetime Mode Screen -->
      <div id="lifetime-screen" class="hidden fade-in">
        <div
          class="mb-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-lg p-6 text-white"
        >
          <h2 class="text-3xl font-bold mb-2">Your Life Journey</h2>
          <div
            id="lifetime-timeline"
            class="mt-4 flex items-center justify-between"
          >
            <div class="text-sm">
              <span class="font-semibold">Age:</span>
              <span id="lifetime-age" class="text-xl font-bold ml-2">20</span>
            </div>
            <div
              class="flex-1 mx-6 bg-white bg-opacity-20 rounded-full h-3 overflow-hidden"
            >
              <div
                id="lifetime-progress"
                class="bg-white h-full transition-all duration-300"
                style="width: 0%"
              ></div>
            </div>
            <div class="text-sm">
              <span class="font-semibold">Target:</span>
              <span class="text-xl font-bold ml-2">67</span>
            </div>
          </div>
        </div>

        <div class="grid md:grid-cols-3 gap-6 mb-6">
          <!-- Household Panel -->
          <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
              <svg
                class="w-5 h-5 mr-2 text-indigo-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                ></path>
              </svg>
              Household
            </h3>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-slate-600">Partner:</span>
                <span
                  id="household-partner"
                  class="font-semibold text-slate-800"
                  >No</span
                >
              </div>
              <div class="flex justify-between">
                <span class="text-slate-600">Children:</span>
                <span
                  id="household-children"
                  class="font-semibold text-slate-800"
                  >0</span
                >
              </div>
              <div class="flex justify-between">
                <span class="text-slate-600">Childcare:</span>
                <span
                  id="household-childcare"
                  class="font-semibold text-green-600"
                  >$0/mo</span
                >
              </div>
            </div>
          </div>

          <!-- Finances Panel -->
          <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
              <svg
                class="w-5 h-5 mr-2 text-green-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
              Finances
            </h3>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-slate-600">Cash:</span>
                <span id="lifetime-cash" class="font-semibold text-slate-800"
                  >$0</span
                >
              </div>
              <div class="flex justify-between">
                <span class="text-slate-600">Investments:</span>
                <span
                  id="lifetime-investments"
                  class="font-semibold text-blue-600"
                  >$0</span
                >
              </div>
              <div class="flex justify-between">
                <span class="text-slate-600">Home Equity:</span>
                <span id="lifetime-equity" class="font-semibold text-purple-600"
                  >$0</span
                >
              </div>
            </div>
          </div>

          <!-- Loans Panel -->
          <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
              <svg
                class="w-5 h-5 mr-2 text-red-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"
                ></path>
              </svg>
              Loans
            </h3>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-slate-600">Total Balance:</span>
                <span
                  id="lifetime-loan-balance"
                  class="font-semibold text-red-600"
                  >$0</span
                >
              </div>
              <div class="flex justify-between">
                <span class="text-slate-600">Monthly Payment:</span>
                <span
                  id="lifetime-loan-payment"
                  class="font-semibold text-slate-800"
                  >$0/mo</span
                >
              </div>
              <div class="flex justify-between">
                <span class="text-slate-600">Mortgage:</span>
                <span
                  id="lifetime-mortgage"
                  class="font-semibold text-slate-800"
                  >$0/mo</span
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Event Log -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
          <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
            <svg
              class="w-5 h-5 mr-2 text-amber-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            Recent Events
          </h3>
          <div id="lifetime-events" class="space-y-2 max-h-48 overflow-y-auto">
            <p class="text-slate-500 text-sm italic">
              Your life story will appear here...
            </p>
          </div>
        </div>

        <!-- Controls -->
        <div class="flex justify-center gap-4">
          <button
            id="lifetime-pause"
            class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all"
          >
            Pause
          </button>
          <button
            id="lifetime-resume"
            class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all"
          >
            Resume
          </button>
        </div>
      </div>

      <!-- Modals -->
      <div
        id="profile-modal"
        class="modal hidden absolute inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50 opacity-0 transform scale-95"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md mx-auto"
        >
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-slate-800">Your Profile</h3>
            <button
              id="hide-profile-button"
              class="text-slate-500 hover:text-slate-800 text-3xl font-bold"
            >
              &times;
            </button>
          </div>
          <div id="profile-main-view">
            <div class="space-y-4">
              <div>
                <h4 class="font-semibold text-slate-600">Profession:</h4>
                <p id="profile-profession" class="text-slate-800"></p>
              </div>
              <div>
                <h4 class="font-semibold text-slate-600">Qualifications:</h4>
                <p id="profile-qualifications" class="text-slate-800"></p>
              </div>
              <div>
                <h4 class="font-semibold text-slate-600">Lifestyle:</h4>
                <ul
                  id="profile-lifestyle"
                  class="list-disc list-inside text-slate-800"
                ></ul>
              </div>
              <div class="flex gap-4 pt-4 border-t">
                <button
                  id="change-career-button"
                  class="flex-1 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700"
                >
                  Change Career
                </button>
                <button
                  id="change-lifestyle-button"
                  class="flex-1 bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300"
                >
                  Adjust Lifestyle
                </button>
              </div>
            </div>
          </div>
          <div id="profile-action-view" class="hidden">
            <h3
              id="action-title"
              class="text-xl font-bold text-slate-800 mb-4"
            ></h3>
            <div id="action-options-container" class="space-y-3"></div>
          </div>
        </div>
      </div>

      <!-- Lifetime Checkpoint Modal -->
      <div
        id="checkpoint-modal"
        class="modal hidden absolute inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50 opacity-0 transform scale-95"
      >
        <div
          class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl shadow-2xl p-8 max-w-2xl mx-auto"
        >
          <div class="text-center mb-6">
            <div class="inline-block bg-indigo-100 rounded-full p-3 mb-4">
              <svg
                class="w-12 h-12 text-indigo-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"
                ></path>
              </svg>
            </div>
            <h3 class="text-3xl font-bold text-slate-800 mb-2">
              Life Checkpoint
            </h3>
            <p
              id="checkpoint-age"
              class="text-xl text-indigo-600 font-semibold mb-4"
            >
              Age 25
            </p>
            <p class="text-slate-600">
              Take a moment to make an important decision about your future.
            </p>
          </div>

          <div class="bg-white rounded-xl p-6 mb-6">
            <h4 class="font-bold text-slate-800 mb-4">
              Your Current Situation:
            </h4>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <span class="text-slate-600">Net Worth:</span>
                <span
                  id="checkpoint-networth"
                  class="font-semibold text-slate-800 ml-2"
                  >$0</span
                >
              </div>
              <div>
                <span class="text-slate-600">Monthly Income:</span>
                <span
                  id="checkpoint-income"
                  class="font-semibold text-green-600 ml-2"
                  >$0</span
                >
              </div>
              <div>
                <span class="text-slate-600">Loan Balance:</span>
                <span
                  id="checkpoint-loans"
                  class="font-semibold text-red-600 ml-2"
                  >$0</span
                >
              </div>
              <div>
                <span class="text-slate-600">Home Equity:</span>
                <span
                  id="checkpoint-equity"
                  class="font-semibold text-purple-600 ml-2"
                  >$0</span
                >
              </div>
            </div>
          </div>

          <div id="checkpoint-choices" class="space-y-3">
            <!-- Choices populated by JS -->
          </div>
        </div>
      </div>

      <div
        id="confirmation-modal"
        class="modal hidden absolute inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50 opacity-0 transform scale-95"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-lg mx-auto"
        >
          <h3 class="text-2xl font-bold text-slate-800 mb-3">
            Confirm Your Choice
          </h3>
          <p class="text-slate-600 mb-4">
            This choice will have the following immediate effects:
          </p>
          <div
            id="confirmation-effects"
            class="text-left space-y-2 mb-6 bg-slate-50 p-4 rounded-lg"
          ></div>
          <div class="flex justify-center gap-4">
            <button
              id="confirm-choice-button"
              class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700"
            >
              Confirm
            </button>
            <button
              id="cancel-choice-button"
              class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>

      <div
        id="breakdown-modal"
        class="modal hidden absolute inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50 opacity-0 transform scale-95"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm mx-auto"
        >
          <div class="flex justify-between items-center mb-4">
            <h3
              id="breakdown-title"
              class="text-xl font-bold text-slate-800"
            ></h3>
            <button
              id="hide-breakdown-button"
              class="text-slate-500 hover:text-slate-800 text-3xl font-bold"
            >
              &times;
            </button>
          </div>
          <ul id="breakdown-list" class="space-y-2"></ul>
        </div>
      </div>

      <div
        id="debt-modal"
        class="modal hidden absolute inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50 opacity-0 transform scale-95"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-lg mx-auto"
        >
          <h3 id="debt-title" class="text-2xl font-bold text-yellow-500 mb-3">
            Unaffordable Choice
          </h3>
          <p id="debt-description" class="text-slate-600 mb-4"></p>
          <div id="debt-buttons" class="flex justify-center gap-4">
            <button
              id="take-debt-button"
              class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700"
            >
              Take Loan
            </button>
            <button
              id="cancel-debt-button"
              class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>

      <div
        id="event-modal"
        class="modal hidden absolute inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-30 opacity-0 transform scale-95"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-6 text-center max-w-sm mx-auto"
        >
          <h3 class="text-xl font-bold text-indigo-600 mb-2">
            A Life Event Occurred!
          </h3>
          <p id="event-text" class="text-slate-600"></p>
        </div>
      </div>

      <div
        id="major-event-modal"
        class="modal hidden absolute inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-40 opacity-0 transform scale-95"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-lg mx-auto"
        >
          <h3 class="text-2xl font-bold text-red-600 mb-3">
            A Major Life Event!
          </h3>
          <p id="major-event-description" class="text-slate-600 mb-4"></p>
          <h4
            id="major-event-question"
            class="text-lg font-semibold text-slate-800 mb-4"
          ></h4>
          <div id="major-event-choices" class="grid grid-cols-1 gap-3"></div>
        </div>
      </div>

      <!-- Stage Modal for multi-question stages -->
      <div
        id="stage-modal"
        class="modal hidden fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50"
      >
        <div
          class="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl mx-auto w-full"
        >
          <div class="mb-4">
            <h3
              id="stage-title"
              class="text-2xl font-bold text-indigo-600 mb-1"
            >
              Stage Title
            </h3>
            <p id="stage-progress" class="text-sm text-slate-500">
              Question 1 of 2
            </p>
          </div>

          <div id="stage-question-container">
            <h4
              id="stage-question-prompt"
              class="text-lg font-semibold text-slate-800 mb-4"
            >
              Question prompt here
            </h4>
            <div id="stage-choices-container" class="grid grid-cols-1 gap-3">
              <!-- Choice buttons will be inserted here -->
            </div>
          </div>

          <div class="mt-6 text-center">
            <p class="text-xs text-slate-400">
              These choices will shape your lifetime journey
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Data containers loaded via fetch (front-end only)
        let costOfLiving = null;
        let careers = [];
        let scenarios = [];
        // Lightweight helpers for preview (mirror of sim/economy.js behavior)
        function calcRegionMultiplier(region) {
          if (region === 'LOW') return 1.0;
          if (region === 'MED') return 1.25;
          if (region === 'HIGH') return 1.6;
          return 1.0;
        }
        function buildMonthlyExpenses(player, regionCfg, regionMult) {
          const basket = regionCfg.basket;
          const expenses = {};
          // NO expenses.rent here â€“ housing is injected later via getMonthlyHousingCost
          expenses.utilities = basket.utilities * regionMult;
          expenses.groceries =
            (player.has_child
              ? basket.groceries_family
              : basket.groceries_single) * regionMult;
          expenses.transport =
            (player.has_car ? basket.transport_car : basket.transport_transit) *
            regionMult;
          expenses.health = basket.health * regionMult;
          expenses.phone = basket.phone;
          expenses.internet = basket.internet;
          expenses.misc = basket.misc * regionMult;
          if (player.recurringAdjustments) {
            for (const adj of player.recurringAdjustments) {
              expenses[adj.key] = (expenses[adj.key] || 0) + adj.amount;
            }
          }
          return expenses;
        }

        // ========== SHARED BUDGET SYSTEM ==========
        // Single source of truth for budget calculations
        const DEFAULT_BUDGET = {
          utilities: 138,
          groceries: 275,
          transport: 100,
          health: 175,
          phone: 45,
          internet: 50,
          misc: 100,
          rent: 0, // updated when dwelling is chosen
        };

        // Phase 8: Update the year summary panel with detailed breakdown
        const updateSummaryPanel = () => {
          const totalSalary = Object.values(gameState.salaryBreakdown).reduce(
            (sum, item) => sum + item.amount,
            0
          );
          const savingsRate = readSavingsRateFromUI();
          const savedAmount = Math.round(totalSalary * savingsRate);

          // Calculate essentials and lifestyle based on current lifestyle level
          let housingCostPercent = 0.3;
          let foodTransportPercent = 0.18;
          if (gameState.lifestyleLevel === 'high') {
            housingCostPercent = 0.3;
            foodTransportPercent = 0.18;
          } else if (gameState.lifestyleLevel === 'normal') {
            housingCostPercent = 0.22;
            foodTransportPercent = 0.12;
          } else if (gameState.lifestyleLevel === 'low') {
            housingCostPercent = 0.22;
            foodTransportPercent = 0.08;
          } else if (gameState.lifestyleLevel === 'downgraded_home') {
            housingCostPercent = 0.05;
            foodTransportPercent = 0.08;
          }

          const essentials = Math.round(
            totalSalary * (housingCostPercent + foodTransportPercent)
          );
          const afterSavingsAndEssentials =
            totalSalary - savedAmount - essentials;
          const lifestyleBudget = Math.max(0, afterSavingsAndEssentials);

          const netWorth =
            (gameState.cash || 0) +
            (gameState.savingsBalance || 0) -
            (gameState.debt || 0);

          const ageEl = document.getElementById('summary-age');
          if (ageEl)
            ageEl.textContent = window.playerState?.age ?? gameState.currentAge;
          document.getElementById(
            'summary-salary'
          ).textContent = `$${Math.round(totalSalary).toLocaleString()}`;
          document.getElementById(
            'summary-savings-rate'
          ).textContent = `${Math.round(
            savingsRate * 100
          )}% ($${savedAmount.toLocaleString()})`;
          document.getElementById(
            'summary-saved'
          ).textContent = `$${savedAmount.toLocaleString()}`;
          document.getElementById(
            'summary-essentials'
          ).textContent = `$${essentials.toLocaleString()}`;
          document.getElementById(
            'summary-lifestyle'
          ).textContent = `$${lifestyleBudget.toLocaleString()}`;
          document.getElementById('summary-debt').textContent = `$${Math.round(
            gameState.debt || 0
          ).toLocaleString()}`;
          document.getElementById(
            'summary-net-worth'
          ).textContent = `$${Math.round(netWorth).toLocaleString()}`;
          document.getElementById('summary-happiness').textContent = Math.round(
            gameState.happiness || 50
          );
        };

        let budget = { ...DEFAULT_BUDGET };

        function getMonthlyExpenses(b) {
          return Object.values(b).reduce(
            (sum, value) => sum + Number(value || 0),
            0
          );
        }

        function getAnnualExpenses(b) {
          return getMonthlyExpenses(b) * 12;
        }

        function updateBudgetFromExpenses(expenses) {
          // Update budget object from computed expenses
          budget = {
            utilities: Math.round(expenses.utilities || 0),
            groceries: Math.round(expenses.groceries || 0),
            transport: Math.round(expenses.transport || 0),
            health: Math.round(expenses.health || 0),
            phone: Math.round(expenses.phone || 0),
            internet: Math.round(expenses.internet || 0),
            misc: Math.round(expenses.misc || 0),
            rent: Math.round(expenses.rent || 0),
          };
        }

        function syncExpenseBreakdownFromBudget() {
          // Sync gameState.expenseBreakdown from the shared budget
          gameState.expenseBreakdown = {};
          for (const [key, value] of Object.entries(budget)) {
            if (value > 0) {
              const label = key.charAt(0).toUpperCase() + key.slice(1);
              gameState.expenseBreakdown[key] = {
                label: label,
                amount: value * 12, // Convert monthly to annual
              };
            }
          }
        }

        // ========== LIFETIME MODE HELPERS ==========
        // Clock/Age tracking
        function initClock(
          birthYear,
          ageMonths,
          retirementTargetAge = 67,
          maxYears = 50
        ) {
          return {
            birthYear,
            ageMonths,
            startAgeMonths: ageMonths, // track where we began
            currentYear: birthYear + Math.floor(ageMonths / 12),
            currentMonth: 0,
            retirementAge: retirementTargetAge,
            maxYears,
          };
        }
        function advanceOneMonth(clock) {
          clock.ageMonths++;
          clock.currentMonth++;
          clock.currentYear =
            clock.birthYear + Math.floor(clock.ageMonths / 12);
        }
        function getAgeYears(clock) {
          return Math.floor(clock.ageMonths / 12);
        }
        function shouldPauseForCheckpoint(clock, lastCheckpoint) {
          const age = getAgeYears(clock);
          return age >= 25 && age % 5 === 0 && age !== lastCheckpoint;
        }
        function isRetirementAge(clock) {
          return getAgeYears(clock) >= clock.retirementAge;
        }
        function reachedEnd(clock) {
          const yearsElapsed = (clock.ageMonths - clock.startAgeMonths) / 12;
          return yearsElapsed >= clock.maxYears;
        }
        function formatAge(ageMonths) {
          const years = Math.floor(ageMonths / 12);
          const months = ageMonths % 12;
          return `${years} years ${months} months`;
        }

        // Household
        function initHousehold() {
          return { partner: false, children: [] };
        }
        function addPartner(household) {
          household.partner = true;
        }
        function removePartner(household) {
          household.partner = false;
        }
        function addChild(household, childcareCost) {
          household.children.push({ ageMonths: 0, childcareCost });
        }
        function advanceHouseholdOneMonth(household) {
          household.children.forEach((child) => child.ageMonths++);
        }
        function getActiveChildcareCosts(household) {
          return household.children
            .filter((child) => child.ageMonths < 48)
            .reduce((sum, child) => sum + child.childcareCost, 0);
        }
        function applySharedExpenses(expenses, hasPartner) {
          if (!hasPartner) return expenses;
          const sharedKeys = [
            'utilities',
            'groceries',
            'transport',
            'internet',
            'misc',
          ];
          sharedKeys.forEach((key) => {
            if (expenses[key]) expenses[key] *= 0.75; // 25% reduction
          });
          return expenses;
        }

        // Housing
        function initHousing() {
          return { owned: false };
        }
        function canAffordHome(grossIncome, homePrice, downPaymentPct) {
          const maxPrice = grossIncome * 12 * 3.5;
          const downPayment = homePrice * downPaymentPct;
          return homePrice <= maxPrice;
        }
        function purchaseHome(
          housing,
          player,
          homePrice,
          downPaymentPct,
          apr,
          termMonths,
          closingCostPct
        ) {
          const downPayment = homePrice * downPaymentPct;
          const closingCosts = homePrice * closingCostPct;
          const totalUpfront = downPayment + closingCosts;

          if (player.cash < totalUpfront) return false;

          player.cash -= totalUpfront;
          housing.owned = true;
          housing.purchasePrice = homePrice;
          housing.currentValue = homePrice;
          housing.principal = homePrice - downPayment;
          housing.apr = apr;
          housing.termMonths = termMonths;
          housing.monthsPaid = 0;
          housing.monthlyPayment = mortgagePayment(
            housing.principal,
            apr,
            termMonths
          );

          player.owns_home = true;
          // Do NOT mutate player.dwelling - keep that strictly for renting

          return true;
        }
        function mortgagePayment(principal, apr, termMonths) {
          if (principal <= 0 || termMonths <= 0) return 0;
          const monthlyRate = apr / 12;
          if (monthlyRate === 0) return principal / termMonths;
          return (
            (principal *
              (monthlyRate * Math.pow(1 + monthlyRate, termMonths))) /
            (Math.pow(1 + monthlyRate, termMonths) - 1)
          );
        }
        function advanceMortgageOneMonth(housing, appreciationRate) {
          if (!housing.owned || housing.principal <= 0) return;

          const interest = (housing.principal * housing.apr) / 12;
          const principalPaid = Math.min(
            housing.monthlyPayment - interest,
            housing.principal
          );
          housing.principal -= principalPaid;
          housing.monthsPaid++;

          // Annual appreciation applied monthly
          housing.currentValue *= 1 + appreciationRate;
        }
        function getHomeEquity(housing) {
          if (!housing.owned) return 0;
          return housing.currentValue - housing.principal;
        }
        function sellHome(housing, sellingCostPct) {
          if (!housing.owned) return 0;
          const sellingCosts = housing.currentValue * sellingCostPct;
          const netProceeds =
            housing.currentValue - housing.principal - sellingCosts;
          housing.owned = false;
          return Math.max(0, netProceeds);
        }
        function getMonthlyHousingCost(player, housing, basket, regionMult) {
          if (!player.dwelling) return 0; // Rent rule: $0 until dwelling chosen

          if (housing.owned) {
            const mortgage = housing.monthlyPayment || 0;
            const propertyTax = (housing.currentValue * 0.012) / 12; // 1.2% annual
            const insurance = (housing.currentValue * 0.005) / 12; // 0.5% annual
            const maintenance = (housing.currentValue * 0.01) / 12; // 1% annual
            return mortgage + propertyTax + insurance + maintenance;
          } else {
            return basket[player.dwelling] * regionMult;
          }
        }

        // Loans
        function initLoans() {
          return { student: [], car: [], personal: [] };
        }
        function addLoan(
          loans,
          type,
          { principal, apr, termMonths, label = '' }
        ) {
          if (!loans[type]) loans[type] = [];
          loans[type].push({
            label: label || `${type} loan`,
            originalPrincipal: principal,
            principal,
            apr,
            termMonths,
            monthsPaid: 0,
            monthlyPayment: calculateMonthlyPayment(principal, apr, termMonths),
          });
        }
        function calculateMonthlyPayment(principal, apr, termMonths) {
          if (principal <= 0 || termMonths <= 0) return 0;
          const monthlyRate = apr / 12;
          if (monthlyRate === 0) return principal / termMonths;
          return (
            (principal *
              (monthlyRate * Math.pow(1 + monthlyRate, termMonths))) /
            (Math.pow(1 + monthlyRate, termMonths) - 1)
          );
        }
        function advanceLoansOneMonth(loans) {
          let totalPayment = 0;
          let totalInterest = 0;

          ['student', 'car', 'personal'].forEach((type) => {
            if (!loans[type]) return;
            loans[type] = loans[type].filter((loan) => {
              if (loan.principal <= 0) return false;
              const interest = (loan.principal * loan.apr) / 12;
              const principalPaid = Math.min(
                loan.monthlyPayment - interest,
                loan.principal
              );
              loan.principal -= principalPaid;
              loan.monthsPaid++;
              totalPayment += loan.monthlyPayment;
              totalInterest += interest;
              return loan.principal > 0.01;
            });
          });

          return { totalPayment, totalInterest };
        }
        function getTotalLoanBalance(loans) {
          let total = 0;
          ['student', 'car', 'personal'].forEach((type) => {
            if (!loans[type]) return;
            loans[type].forEach((loan) => {
              total += loan.principal;
            });
          });
          return total;
        }

        // Event log
        function initEventLog() {
          return { history: [], lastOccurrence: {} };
        }

        // Retirement
        function estimateSocialSecurity(avgMonthlyWage, retirementConfig) {
          const annualWage = avgMonthlyWage * 12;
          const bands = retirementConfig.ss_replacement_bands;
          let ssAnnual = 0;
          let remaining = annualWage;

          for (const band of bands) {
            if (remaining <= 0) break;
            const covered = Math.min(remaining, band.up_to);
            ssAnnual += covered * band.rate;
            remaining -= covered;
          }

          return ssAnnual / 12;
        }
        function calculateWithdrawal(investments, retirementConfig, ageYears) {
          const balance = investments || 0;
          const policy = retirementConfig.withdrawal_policy;
          let rate = policy.floor;
          if (ageYears > 75) rate = policy.ceiling;
          else if (ageYears > 70) rate = (policy.floor + policy.ceiling) / 2;
          return (balance * rate) / 12;
        }
        function getHealthInsuranceCost(ageYears, retirementConfig) {
          if (ageYears >= retirementConfig.medicare_eligible_age) {
            return retirementConfig.medicare_monthly_cost;
          }
          return retirementConfig.pre_medicare_insurance_monthly;
        }
        function initRetirementIncome(player, careerState, retirementConfig) {
          const ageYears = Math.floor(player.ageMonths / 12);
          const avgWage =
            careerState.currentBasePay /
            (careerState.type === 'salary' ? 12 : 1);

          return {
            social_security: estimateSocialSecurity(avgWage, retirementConfig),
            pension: 0, // TODO: implement pension calculation
            withdrawal: calculateWithdrawal(
              player.investments,
              retirementConfig,
              ageYears
            ),
            health_insurance: getHealthInsuranceCost(
              ageYears,
              retirementConfig
            ),
          };
        }
        function gradeRetirementOutcome(
          netWorth,
          monthlyIncome,
          monthlyExpenses,
          ageAtRetirement
        ) {
          const replacementRatio = monthlyIncome / monthlyExpenses;
          if (
            netWorth >= 500000 &&
            replacementRatio >= 1.0 &&
            ageAtRetirement <= 67
          )
            return 'A';
          if (netWorth >= 300000 && replacementRatio >= 0.8) return 'B';
          if (netWorth >= 100000 && replacementRatio >= 0.6) return 'C';
          if (netWorth >= 0 && replacementRatio >= 0.4) return 'D';
          return 'F';
        }

        // ========== STAGE SYSTEM 2.0 ==========
        let STAGES = { stages: [] };
        const completedStages = new Set();
        const stageHistory = []; // { time, stageId, questionId, choiceLabel }
        let currentStageModal = null;

        async function loadStages() {
          try {
            const response = await fetch('../data/stages.json');
            const data = await response.json();
            STAGES = data;
            console.log(`Loaded ${STAGES.stages.length} stages`);
            // Inject expansion stages if not already present
            const existingIds = new Set(STAGES.stages.map((s) => s.id));
            const expansionStages = [
              {
                id: 'early_life_expansion',
                order: 1.5,
                question:
                  'Early Life Expansion: How do you set your foundation?',
                answers: [
                  {
                    text: 'Take a part-time job',
                    consequence: 'Small income bump, slightly less free time.',
                    effects: {
                      special_effect: 'early_part_time_job',
                      salary_boost: { id: 'main_job', amount: 0 },
                    },
                  },
                  {
                    text: 'Focus fully on school',
                    consequence: 'No income now, slight happiness boost.',
                    effects: { special_effect: 'early_focus_school' },
                  },
                  {
                    text: 'Move out early',
                    consequence: 'Lifestyle normal, happiness +4.',
                    effects: {
                      special_effect: 'move_out_family',
                      set_lifestyle_level: 'normal',
                      happiness: 4,
                    },
                  },
                  {
                    text: 'Stay with family to save',
                    consequence: 'Lower expenses, slight happiness loss.',
                    effects: {
                      special_effect: 'stay_with_family',
                      set_lifestyle_level: 'low',
                      happiness: -3,
                    },
                  },
                ],
              },
              {
                id: 'mid_life_expansion',
                order: 8.5,
                question:
                  'Mid Life Expansion: Adjust your lifestyle and work balance?',
                answers: [
                  {
                    text: 'Upgrade apartment',
                    consequence: 'Higher expenses, happiness +6.',
                    effects: {
                      special_effect: 'upgrade_apartment',
                      set_lifestyle_level: 'high',
                      happiness: 6,
                    },
                  },
                  {
                    text: 'Keep current place',
                    consequence: 'Stable costs, minor comfort.',
                    effects: { special_effect: 'keep_apartment', happiness: 1 },
                  },
                  {
                    text: 'Buy a used car',
                    consequence: 'Adds transport expense, happiness +4.',
                    effects: {
                      special_effect: 'buy_used_car',
                      expense_add: {
                        id: 'used_car',
                        label: 'Used Car Costs',
                        amount: 3500,
                      },
                      happiness: 4,
                    },
                  },
                  {
                    text: 'Stick with public transport',
                    consequence: 'Lower cost, slight convenience loss.',
                    effects: {
                      special_effect: 'keep_public_transport',
                      happiness: -2,
                    },
                  },
                  {
                    text: 'Start a side hustle',
                    consequence: '+4% income, -3 happiness.',
                    effects: {
                      special_effect: 'side_hustle',
                      salary_boost: { id: 'main_job', amount: 0 },
                      happiness: -3,
                    },
                  },
                  {
                    text: 'Prioritize leisure time',
                    consequence: 'No income bump, happiness +8.',
                    effects: { special_effect: 'more_leisure', happiness: 8 },
                  },
                ],
              },
              {
                id: 'later_life_expansion',
                order: 13.5,
                question: 'Later Life Expansion: Strategic financial choices?',
                answers: [
                  {
                    text: 'Pay down debt aggressively',
                    consequence: 'Use cash now, reduce future burden.',
                    effects: {
                      special_effect: 'pay_down_debt_aggressive',
                      cash_change: -3000,
                      debt_change: -3000,
                      happiness: -2,
                    },
                  },
                  {
                    text: 'Help family financially',
                    consequence: 'Cash -$4k, happiness +6.',
                    effects: {
                      special_effect: 'help_family_financially',
                      cash_change: -4000,
                      happiness: 6,
                    },
                  },
                  {
                    text: 'Take stressful promotion',
                    consequence: '+6% income, happiness -10.',
                    effects: {
                      special_effect: 'major_promotion',
                      salary_boost: { id: 'main_job', amount: 0 },
                      happiness: -10,
                    },
                  },
                  {
                    text: 'Stay in current role',
                    consequence: 'Stability, happiness +4.',
                    effects: {
                      special_effect: 'stay_in_role',
                      happiness: 4,
                      burnout_change: -5,
                    },
                  },
                ],
              },
            ];
            expansionStages.forEach((st) => {
              if (!existingIds.has(st.id)) STAGES.stages.push(st);
            });
          } catch (err) {
            console.error('Failed to load stages.json:', err);
            STAGES = { stages: [] };
          }
        }

        async function loadData() {
          const [col, car, sc, lel, ret] = await Promise.all([
            fetch('../config/cost_of_living.json').then((r) => r.json()),
            fetch('../data/careers.json').then((r) => r.json()),
            fetch('../data/scenarios.json').then((r) => r.json()),
            fetch('../data/life_events_long.json').then((r) => r.json()),
            fetch('../data/retirement.json').then((r) => r.json()),
            loadStages(), // Load stages config
          ]);
          costOfLiving = col;
          careers = car;
          scenarios = sc;
          window.lifeEventsLong = lel;
          window.retirementConfig = ret;
        }
        // After data loads, populate selectors and preview
        (async function initSelectors() {
          await loadData();
          const scenarioSelect = document.getElementById('scenario-select');
          scenarios.forEach((s) => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = s.label;
            scenarioSelect.appendChild(opt);
          });
          const careerSelect = document.getElementById('career-select');
          careers.forEach((c) => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.title;
            careerSelect.appendChild(opt);
          });
          function updateBudgetPreview() {
            // Use default MED region and no dwelling until stages set them
            const region = 'MED';
            const dwelling = null;
            const regionMult = calcRegionMultiplier(region);
            const basket = costOfLiving.regions[region].basket;
            const previewPlayer = {
              dwelling,
              has_child: false,
              recurringAdjustments: [],
            };
            const expenses = buildMonthlyExpenses(
              previewPlayer,
              costOfLiving.regions[region],
              regionMult
            );
            // Update shared budget with computed expenses
            updateBudgetFromExpenses(expenses);

            const lines = [];
            for (const [k, v] of Object.entries(budget)) {
              if (k === 'rent' && !dwelling) continue; // badge covers rent when not selected
              lines.push(
                `<span>${k.charAt(0).toUpperCase() + k.slice(1)}: $${Math.round(
                  v
                )}</span>`
              );
            }
            const monthlyTotal = getMonthlyExpenses(budget);
            const annualTotal = getAnnualExpenses(budget);
            document.getElementById('budget-preview-content').innerHTML =
              lines.join(' &bull; ') +
              `<br/><strong>Monthly: $${Math.round(
                monthlyTotal
              )} | Annual: $${Math.round(
                annualTotal
              ).toLocaleString()}</strong>`;
            const rentBadge = document.getElementById('rent-badge');
            rentBadge.textContent = 'Rent: $0 (choose a dwelling)';
            rentBadge.className =
              'inline-block mt-2 px-2 py-1 rounded bg-green-100 text-green-700 text-xs font-semibold';
          }
          // Remove event listeners for hidden selectors
          updateBudgetPreview();
        })();
        const avatarIcons = {
          briefcase: `<svg class="avatar-icon w-10 h-10 text-amber-700 bg-white p-1.5 rounded-full shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>`,
          wrench: `<svg class="avatar-icon w-10 h-10 text-sky-600 bg-white p-1.5 rounded-full shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>`,
          palette: `<svg class="avatar-icon w-10 h-10 text-purple-500 bg-white p-1.5 rounded-full shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path></svg>`,
          health: `<svg class="avatar-icon w-10 h-10 text-green-500 bg-white p-1.5 rounded-full shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>`,
          apartment: `<svg class="avatar-icon w-full h-full text-slate-200 opacity-50" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd"></path></svg>`,
          house: `<svg class="avatar-icon w-full h-full text-slate-200 opacity-50" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>`,
          nomad: `<svg class="avatar-icon w-full h-full text-slate-200 opacity-50" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.72 7 7.25 7 8.5c0 1.25.488 2.78 1.668 3.177a6.01 6.01 0 01-1.415 2.553c-.328.328-.328.86 0 1.188a.839.839 0 001.188 0l1.414-1.414a.839.839 0 000-1.188l-1.414-1.414a.839.839 0 00-1.188 0l-.328.328a4.509 4.509 0 00-1.255 2.25l-.328.328a.839.839 0 000 1.188l1.414 1.414a.839.839 0 001.188 0l1.414-1.414a.839.839 0 000-1.188l-1.414-1.414a.839.839 0 00-1.188 0l-.328.328A4.509 4.509 0 008.5 11c-1.25 0-2.78-.488-3.177-1.668a6.01 6.01 0 012.553-1.415c.328-.328.86-.328 1.188 0a.839.839 0 001.188-1.188l-1.414-1.414a.839.839 0 00-1.188 0l-1.414 1.414a.839.839 0 000 1.188l1.414 1.414a.839.839 0 001.188 0l.328-.328a4.509 4.509 0 001.255-2.25l-.328-.328a.839.839 0 000-1.188l-1.414-1.414a.839.839 0 00-1.188 0l-1.414 1.414a.839.839 0 000 1.188l1.414 1.414a.839.839 0 001.188 0l.328-.328c.34-.34.62-.72.836-1.12a5.99 5.99 0 01-.432-6.848 6.012 6.012 0 01-2.706 1.912c-.328.328-.86.328-1.188 0a.839.839 0 00-1.188 1.188l1.414 1.414a.839.839 0 001.188 0l1.414-1.414a.839.839 0 000-1.188l-1.414-1.414a.839.839 0 00-1.188 0z" clip-rule="evenodd"></path></svg>`,
          family: `<svg class="avatar-icon w-9 h-9 text-red-500 bg-white p-1.5 rounded-full shadow-md" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>`,
          pet: `<svg class="avatar-icon w-9 h-9 text-orange-500 bg-white p-1.5 rounded-full shadow-md" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 14.95a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 3v1a1 1 0 11-2 0V3a1 1 0 112 0z"></path><path d="M12.25 10.25a.75.75 0 010-1.5.75.75 0 010 1.5zM10 12.25a.75.75 0 01-1.5 0 .75.75 0 011.5 0zM7.75 10.25a.75.75 0 010-1.5.75.75 0 010 1.5z"></path></svg>`,
        };

        const personalityQuestions = [
          {
            question:
              'When facing a difficult problem, you are more likely to:',
            answers: [
              {
                text: 'Rely on a logical, data-driven approach.',
                type: 'ambitious',
              },
              {
                text: 'Trust your intuition and creativity.',
                type: 'creative',
              },
              {
                text: 'Consult with friends and family for advice.',
                type: 'guardian',
              },
              {
                text: 'Take a bold risk and see what happens.',
                type: 'adventurous',
              },
            ],
          },
          {
            question: 'A perfect weekend involves:',
            answers: [
              {
                text: 'Networking and working on a side project.',
                type: 'ambitious',
              },
              {
                text: 'Visiting a new city or trying an extreme sport.',
                type: 'adventurous',
              },
              {
                text: 'Spending quality time with loved ones at home.',
                type: 'guardian',
              },
              {
                text: 'Visiting a museum or working on a creative hobby.',
                type: 'creative',
              },
            ],
          },
          {
            question:
              'You receive an unexpected $5,000. Your first instinct is to:',
            answers: [
              { text: 'Invest it for long-term growth.', type: 'ambitious' },
              { text: 'Book a spontaneous trip abroad.', type: 'adventurous' },
              {
                text: 'Put it in an emergency fund or pay off debt.',
                type: 'guardian',
              },
              {
                text: 'Buy a new instrument or high-end art supplies.',
                type: 'creative',
              },
            ],
          },
          {
            question: 'Success is best measured by:',
            answers: [
              {
                text: 'Your professional title and income.',
                type: 'ambitious',
              },
              {
                text: 'The impact you have on your community.',
                type: 'guardian',
              },
              {
                text: 'The variety and richness of your experiences.',
                type: 'adventurous',
              },
              { text: 'The quality of the work you create.', type: 'creative' },
            ],
          },
          {
            question:
              'You are offered a promotion that requires moving away from your family.',
            answers: [
              { text: 'Take it without hesitation.', type: 'ambitious' },
              {
                text: 'Decline it; your relationships are more important.',
                type: 'guardian',
              },
              {
                text: 'See it as an exciting new adventure.',
                type: 'adventurous',
              },
              {
                text: 'Worry it will disrupt your creative flow.',
                type: 'creative',
              },
            ],
          },
          {
            question: 'When it comes to your living space, you prioritize:',
            answers: [
              {
                text: 'Proximity to work and important city hubs.',
                type: 'ambitious',
              },
              {
                text: 'A unique space that reflects your personality.',
                type: 'creative',
              },
              { text: 'Comfort, safety, and stability.', type: 'guardian' },
              {
                text: 'Minimalism, so you can pack up and leave easily.',
                type: 'adventurous',
              },
            ],
          },
          {
            question: 'Your ideal job would be:',
            answers: [
              { text: 'A high-powered executive role.', type: 'ambitious' },
              { text: 'A freelance artist or musician.', type: 'creative' },
              { text: 'A teacher or a nurse.', type: 'guardian' },
              {
                text: 'A travel blogger or a tour guide.',
                type: 'adventurous',
              },
            ],
          },
          {
            question: 'You feel most fulfilled when you are:',
            answers: [
              { text: 'Achieving a difficult goal.', type: 'ambitious' },
              { text: 'Creating something new.', type: 'creative' },
              { text: 'Helping someone in need.', type: 'guardian' },
              { text: 'Exploring an unfamiliar place.', type: 'adventurous' },
            ],
          },
          {
            question: 'In a team project, you are usually the one who:',
            answers: [
              {
                text: 'Takes charge and directs the strategy.',
                type: 'ambitious',
              },
              {
                text: 'Makes sure everyone feels heard and supported.',
                type: 'guardian',
              },
              {
                text: 'Comes up with the most unconventional ideas.',
                type: 'creative',
              },
              {
                text: 'Pushes the team to try a new, untested approach.',
                type: 'adventurous',
              },
            ],
          },
          {
            question: 'Looking back on your life, you would regret not having:',
            answers: [
              {
                text: 'Reached your full career potential.',
                type: 'ambitious',
              },
              {
                text: 'Taken more risks and traveled more.',
                type: 'adventurous',
              },
              {
                text: 'Built strong, lasting relationships.',
                type: 'guardian',
              },
              {
                text: 'Dedicated more time to your passions.',
                type: 'creative',
              },
            ],
          },
        ];

        const gameData = [
          {
            time_skip: 0,
            question: 'Stage 1: Choose your career sector.',
            back: false,
            answers: [
              {
                text: 'Technology',
                consequence: 'High growth, high demand, but competitive.',
                effects: { sector: 'tech' },
              },
              {
                text: 'Skilled Trades',
                consequence: 'Good job security, physically demanding.',
                effects: { sector: 'trades' },
              },
              {
                text: 'Creative Arts',
                consequence: 'High passion, high risk, low initial stability.',
                effects: { sector: 'creative' },
              },
              {
                text: 'Healthcare',
                consequence: 'Stable, meaningful, but high stress.',
                effects: { sector: 'health' },
              },
            ],
          },
          {
            condition: (gs) => gs.sector === 'tech',
            back: true,
            time_skip: 4,
            question: 'Stage 2 (Tech): Choose your profession.',
            answers: [
              {
                text: 'Help Desk Support',
                consequence: 'No loan. Salary: $32k/yr. Entry-level support.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  salary_add: {
                    id: 'main_job',
                    label: 'Help Desk Support',
                    amount: 32000,
                  },
                  avatar: { type: 'item', icon: 'briefcase' },
                  happiness: 2,
                  add_qualification: 'GED + CompTIA A+',
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Junior Web Developer',
                consequence: 'Loan: $8k. Salary: $42k/yr. Build websites.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 800,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Jr Web Developer',
                    amount: 42000,
                  },
                  avatar: { type: 'item', icon: 'briefcase' },
                  creditScore_change: -10,
                  happiness: 3,
                  add_qualification: 'Coding Bootcamp',
                  personality_match: 'creative',
                },
              },
              {
                text: 'Data Analyst',
                consequence: 'Loan: $40k. Salary: $60k/yr. Analyze data.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 4000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Data Analyst',
                    amount: 60000,
                  },
                  avatar: { type: 'item', icon: 'briefcase' },
                  creditScore_change: -25,
                  happiness: 2,
                  add_qualification: 'B.S. Data Science',
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Network Administrator',
                consequence: 'Loan: $30k. Salary: $58k/yr. Manage networks.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 3000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Network Admin',
                    amount: 58000,
                  },
                  avatar: { type: 'item', icon: 'briefcase' },
                  creditScore_change: -20,
                  happiness: 1,
                  add_qualification: 'Associate IT',
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Cybersecurity Analyst',
                consequence: 'Loan: $60k. Salary: $80k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 6000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Cybersecurity Analyst',
                    amount: 80000,
                  },
                  avatar: { type: 'item', icon: 'briefcase' },
                  creditScore_change: -30,
                  add_qualification: 'B.S. IT Security',
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Software Engineer',
                consequence:
                  'Loan: $70k. Salary: $95k/yr. Build complex systems.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 7000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Software Engineer',
                    amount: 95000,
                  },
                  avatar: { type: 'item', icon: 'briefcase' },
                  creditScore_change: -35,
                  happiness: 3,
                  add_qualification: 'B.S. CompSci',
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'AI/ML Specialist',
                consequence: 'Loan: $80k. Salary: $90k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 8000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'AI Specialist',
                    amount: 90000,
                  },
                  avatar: { type: 'item', icon: 'briefcase' },
                  creditScore_change: -30,
                  add_qualification: 'B.S. CompSci + ML',
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'UX/UI Designer',
                consequence: 'Loan: $50k. Salary: $70k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 5000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'UX/UI Designer',
                    amount: 70000,
                  },
                  avatar: { type: 'item', icon: 'palette' },
                  creditScore_change: -25,
                  happiness: 4,
                  add_qualification: 'B.A. Design',
                  personality_match: 'creative',
                },
              },
            ],
          },
          {
            condition: (gs) => gs.sector === 'trades',
            back: true,
            time_skip: 2,
            question: 'Stage 2 (Trades): Choose your profession.',
            answers: [
              {
                text: 'General Construction Worker',
                consequence: 'No loan. Salary: $35k/yr. Entry-level labor.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  salary_add: {
                    id: 'main_job',
                    label: 'Construction Worker',
                    amount: 35000,
                  },
                  avatar: { type: 'item', icon: 'wrench' },
                  happiness: 1,
                  add_qualification: 'On-the-job training',
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Plumber',
                consequence: 'Loan: $18k. Salary: $58k/yr. Steady demand.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 1800,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Plumber',
                    amount: 58000,
                  },
                  avatar: { type: 'item', icon: 'wrench' },
                  creditScore_change: -18,
                  happiness: 2,
                  add_qualification: 'Trade Certification',
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Carpenter',
                consequence: 'Loan: $15k. Salary: $52k/yr. Build structures.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 1500,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Carpenter',
                    amount: 52000,
                  },
                  avatar: { type: 'item', icon: 'wrench' },
                  creditScore_change: -15,
                  happiness: 3,
                  add_qualification: 'Apprenticeship',
                  personality_match: 'creative',
                },
              },
              {
                text: 'Welder',
                consequence: 'Loan: $12k. Salary: $48k/yr. Metalwork.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 1200,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Welder',
                    amount: 48000,
                  },
                  avatar: { type: 'item', icon: 'wrench' },
                  creditScore_change: -12,
                  happiness: 2,
                  add_qualification: 'Welding Certificate',
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Electrician',
                consequence: 'Loan: $25k. Salary: $65k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 2500,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Electrician',
                    amount: 65000,
                  },
                  avatar: { type: 'item', icon: 'wrench' },
                  creditScore_change: -20,
                  add_qualification: 'Journeyman License',
                  personality_match: 'guardian',
                },
              },
              {
                text: 'HVAC Technician',
                consequence: 'Loan: $20k. Salary: $55k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 2000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'HVAC Tech',
                    amount: 55000,
                  },
                  avatar: { type: 'item', icon: 'wrench' },
                  creditScore_change: -20,
                  add_qualification: 'Trade Certification',
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Automotive Technician',
                consequence: 'Loan: $22k. Salary: $50k/yr. Fix vehicles.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 2200,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Auto Mechanic',
                    amount: 50000,
                  },
                  avatar: { type: 'item', icon: 'wrench' },
                  creditScore_change: -18,
                  happiness: 2,
                  add_qualification: 'ASE Certification',
                  personality_match: 'guardian',
                },
              },
            ],
          },
          {
            condition: (gs) => gs.sector === 'creative',
            back: true,
            time_skip: 4,
            question: 'Stage 2 (Creative): Choose your profession.',
            answers: [
              {
                text: 'Freelance Artist',
                consequence:
                  'Cost: $3k. Salary: $28k/yr. Highly variable income.',
                effects: {
                  career_type: 'creator',
                  career_level: 1,
                  cash_change: -3000,
                  salary_add: {
                    id: 'main_job',
                    label: 'Freelance Artist',
                    amount: 28000,
                  },
                  happiness: 8,
                  avatar: { type: 'item', icon: 'palette' },
                  personality_match: 'adventurous',
                },
              },
              {
                text: 'Social Media Manager',
                consequence:
                  'Loan: $25k. Salary: $45k/yr. Manage brand presence.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 2500,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Social Media Mgr',
                    amount: 45000,
                  },
                  avatar: { type: 'item', icon: 'palette' },
                  creditScore_change: -20,
                  happiness: 5,
                  add_qualification: 'Marketing Cert',
                  personality_match: 'creative',
                },
              },
              {
                text: 'Photographer',
                consequence:
                  'Cost: $8k. Salary: $38k/yr. Events and portraits.',
                effects: {
                  career_type: 'creator',
                  career_level: 1,
                  cash_change: -8000,
                  salary_add: {
                    id: 'main_job',
                    label: 'Photographer',
                    amount: 38000,
                  },
                  happiness: 7,
                  avatar: { type: 'item', icon: 'palette' },
                  personality_match: 'adventurous',
                },
              },
              {
                text: 'Graphic Designer',
                consequence: 'Loan: $40k. Salary: $50k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 4000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Graphic Designer',
                    amount: 50000,
                  },
                  avatar: { type: 'item', icon: 'palette' },
                  creditScore_change: -25,
                  add_qualification: 'B.F.A.',
                  personality_match: 'creative',
                },
              },
              {
                text: 'Content Creator',
                consequence: 'Cost: $5k. Salary: Highly volatile.',
                effects: {
                  career_type: 'creator',
                  career_level: 1,
                  cash_change: -5000,
                  salary_add: {
                    id: 'main_job',
                    label: 'Content Creator',
                    amount: 30000,
                  },
                  happiness: 10,
                  avatar: { type: 'item', icon: 'palette' },
                  personality_match: 'adventurous',
                },
              },
              {
                text: 'Video Editor',
                consequence: 'Loan: $30k. Salary: $48k/yr. Edit video content.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 3000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Video Editor',
                    amount: 48000,
                  },
                  avatar: { type: 'item', icon: 'palette' },
                  creditScore_change: -22,
                  happiness: 4,
                  add_qualification: 'Film/Media Degree',
                  personality_match: 'creative',
                },
              },
              {
                text: 'Writer/Journalist',
                consequence: 'Loan: $35k. Salary: $48k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 3500,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Writer',
                    amount: 48000,
                  },
                  avatar: { type: 'item', icon: 'palette' },
                  creditScore_change: -25,
                  add_qualification: 'B.A. English',
                  personality_match: 'creative',
                },
              },
              {
                text: 'Music Teacher',
                consequence:
                  'Loan: $45k. Salary: $52k/yr. Teach music lessons.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 4500,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Music Teacher',
                    amount: 52000,
                  },
                  avatar: { type: 'item', icon: 'palette' },
                  creditScore_change: -28,
                  happiness: 6,
                  add_qualification: 'B.A. Music Ed',
                  personality_match: 'guardian',
                },
              },
            ],
          },
          {
            condition: (gs) => gs.sector === 'health',
            back: true,
            time_skip: 4,
            question: 'Stage 2 (Health): Choose your profession.',
            answers: [
              {
                text: 'Home Health Aide',
                consequence: 'Loan: $3k. Salary: $30k/yr. Care for elderly.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 300,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Home Health Aide',
                    amount: 30000,
                  },
                  avatar: { type: 'item', icon: 'health' },
                  creditScore_change: -5,
                  happiness: 5,
                  add_qualification: 'Basic Training',
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Medical Assistant',
                consequence: 'Loan: $10k. Salary: $40k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 1000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Medical Assistant',
                    amount: 40000,
                  },
                  avatar: { type: 'item', icon: 'health' },
                  creditScore_change: -10,
                  add_qualification: 'Certificate',
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Dental Hygienist',
                consequence: 'Loan: $35k. Salary: $68k/yr. Clean teeth.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 3500,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Dental Hygienist',
                    amount: 68000,
                  },
                  avatar: { type: 'item', icon: 'health' },
                  creditScore_change: -25,
                  happiness: 3,
                  add_qualification: 'Associate Degree',
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Radiology Technician',
                consequence:
                  'Loan: $40k. Salary: $62k/yr. Operate imaging equipment.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 4000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Rad Tech',
                    amount: 62000,
                  },
                  avatar: { type: 'item', icon: 'health' },
                  creditScore_change: -28,
                  happiness: 2,
                  add_qualification: 'Associate + License',
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Registered Nurse',
                consequence: 'Loan: $60k. Salary: $75k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 6000,
                  },
                  salary_add: { id: 'main_job', label: 'Nurse', amount: 75000 },
                  avatar: { type: 'item', icon: 'health' },
                  creditScore_change: -30,
                  add_qualification: 'B.S.N.',
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Physical Therapist',
                consequence: 'Loan: $100k. Salary: $90k/yr. Rehab patients.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 10000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Physical Therapist',
                    amount: 90000,
                  },
                  avatar: { type: 'item', icon: 'health' },
                  creditScore_change: -45,
                  happiness: 4,
                  add_qualification: 'DPT',
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Pharmacist',
                consequence: 'Loan: $150k. Salary: $120k/yr.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 15000,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Pharmacist',
                    amount: 120000,
                  },
                  avatar: { type: 'item', icon: 'health' },
                  creditScore_change: -50,
                  add_qualification: 'Pharm.D.',
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Paramedic/EMT',
                consequence: 'Loan: $15k. Salary: $45k/yr. Emergency response.',
                effects: {
                  career_type: 'stable',
                  career_level: 1,
                  expense_add: {
                    id: 'student_loan',
                    label: 'Student Loan',
                    amount: 1500,
                  },
                  salary_add: {
                    id: 'main_job',
                    label: 'Paramedic',
                    amount: 45000,
                  },
                  avatar: { type: 'item', icon: 'health' },
                  creditScore_change: -12,
                  happiness: 6,
                  add_qualification: 'EMT/Paramedic Cert',
                  personality_match: 'adventurous',
                },
              },
            ],
          },
          {
            time_skip: 3,
            question: 'Stage 3: Where will you live for the next few years?',
            answers: [
              {
                text: 'Live with Family',
                consequence:
                  'Expenses: +$3.6k/yr. Low independence, save money.',
                effects: {
                  housing_type: 'family',
                  expense_add: {
                    id: 'housing',
                    label: 'Housing',
                    amount: 3600,
                  },
                  happiness: -2,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Supportive Housing / Shelter',
                consequence:
                  'Expenses: +$4.8k/yr. Rules and curfews, very affordable.',
                effects: {
                  housing_type: 'supportive',
                  expense_add: {
                    id: 'housing',
                    label: 'Housing',
                    amount: 4800,
                  },
                  happiness: -3,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Rent a Room in Shared Apartment',
                consequence: 'Expenses: +$12k/yr. Split costs, less privacy.',
                effects: {
                  housing_type: 'rent',
                  expense_add: {
                    id: 'housing',
                    label: 'Housing',
                    amount: 12000,
                  },
                  happiness: 1,
                  avatar: { type: 'bg', icon: 'apartment' },
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Rent a Small Studio',
                consequence: 'Expenses: +$21k/yr. Privacy, but expensive.',
                effects: {
                  housing_type: 'rent',
                  expense_add: {
                    id: 'housing',
                    label: 'Housing',
                    amount: 21000,
                  },
                  happiness: 4,
                  avatar: { type: 'bg', icon: 'apartment' },
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Rent a 1-Bedroom Apartment',
                consequence: 'Expenses: +$28k/yr. Comfortable space.',
                effects: {
                  housing_type: 'rent',
                  expense_add: {
                    id: 'housing',
                    label: 'Housing',
                    amount: 28000,
                  },
                  happiness: 6,
                  avatar: { type: 'bg', icon: 'apartment' },
                  personality_match: 'creative',
                },
              },
              {
                text: 'Rent a Downtown Apartment',
                consequence: 'Expenses: +$36k/yr. Great social life.',
                effects: {
                  housing_type: 'rent',
                  expense_add: {
                    id: 'housing',
                    label: 'Housing',
                    amount: 36000,
                  },
                  happiness: 10,
                  avatar: { type: 'bg', icon: 'apartment' },
                  personality_match: 'adventurous',
                },
              },
              {
                text: 'Live in Your Car / Van',
                consequence:
                  'Expenses: +$1.2k/yr. Extreme savings, no stability.',
                effects: {
                  housing_type: 'nomad',
                  expense_add: {
                    id: 'housing',
                    label: 'Housing',
                    amount: 1200,
                  },
                  happiness: -5,
                  avatar: { type: 'bg', icon: 'nomad' },
                  personality_match: 'adventurous',
                },
              },
            ],
          },
          {
            time_skip: 1,
            question: 'Stage 3B: How will you get around?',
            answers: [
              {
                text: 'Public Transit Pass',
                consequence: 'Expenses: +$1.6k/yr. Affordable, eco-friendly.',
                effects: {
                  expense_add: {
                    id: 'transport',
                    label: 'Transportation',
                    amount: 1600,
                  },
                  happiness: 0,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Bike and Walking',
                consequence:
                  'Expenses: +$240/yr. Healthy, but weather-dependent.',
                effects: {
                  expense_add: {
                    id: 'transport',
                    label: 'Transportation',
                    amount: 240,
                  },
                  happiness: 3,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Rideshare / Carpool',
                consequence: 'Expenses: +$2.4k/yr. Flexible but unreliable.',
                effects: {
                  expense_add: {
                    id: 'transport',
                    label: 'Transportation',
                    amount: 2400,
                  },
                  happiness: 1,
                  personality_match: 'creative',
                },
              },
              {
                text: 'Buy a Used Car',
                consequence:
                  'Cost: $5k down. Expenses: +$4.2k/yr. Independence!',
                effects: {
                  cash_change: -5000,
                  expense_add: {
                    id: 'transport',
                    label: 'Transportation',
                    amount: 4200,
                  },
                  happiness: 5,
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Buy a New Car',
                consequence: 'Cost: $8k down. Expenses: +$6k/yr. Reliable.',
                effects: {
                  cash_change: -8000,
                  expense_add: {
                    id: 'transport',
                    label: 'Transportation',
                    amount: 6000,
                  },
                  happiness: 8,
                  creditScore_change: -15,
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Lease a Car',
                consequence: 'Expenses: +$5k/yr. New car, no ownership.',
                effects: {
                  expense_add: {
                    id: 'transport',
                    label: 'Transportation',
                    amount: 5000,
                  },
                  happiness: 6,
                  personality_match: 'adventurous',
                },
              },
            ],
          },
          {
            time_skip: 2,
            question: 'Stage 4: Start contributing to your retirement?',
            answers: [
              {
                text: 'Yes, 10% of my salary',
                consequence: 'Aggressive savings for a secure future.',
                effects: {
                  special_effect: 'start_401k',
                  rate: 0.1,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Yes, 5% of my salary',
                consequence: 'A modest start to saving.',
                effects: {
                  special_effect: 'start_401k',
                  rate: 0.05,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'No, I need the cash right now',
                consequence:
                  "You'll have more spending money, but may regret it later.",
                effects: { happiness: -5, personality_match: 'adventurous' },
              },
            ],
          },
          {
            time_skip: 3,
            question: 'Stage 5: How do you handle your finances?',
            answers: [
              {
                text: 'Invest in a crypto/stock portfolio (High-Risk)',
                consequence: 'Gamble: Huge potential gains or massive losses.',
                effects: {
                  set_investment_multiplier: 1.7,
                  set_investment_risk: 0.5,
                  personality_match: 'adventurous',
                },
              },
              {
                text: 'Invest in Index Funds (Safe)',
                consequence: 'Benefit: Slow, steady, reliable growth.',
                effects: {
                  set_investment_multiplier: 1.1,
                  set_investment_risk: 0.1,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Invest in Real Estate',
                consequence: 'Cost: $20k down. Builds equity.',
                effects: {
                  cash_change: -20000,
                  equity_change: 40000,
                  expense_add: {
                    id: 'rental',
                    label: 'Rental Property',
                    amount: 5000,
                  },
                  creditScore_change: -15,
                  personality_match: 'ambitious',
                },
              },
            ],
          },
          {
            time_skip: 2,
            question: 'Stage 6: What about relationships?',
            answers: [
              {
                text: 'Stay Single and Independent',
                consequence: 'No extra expenses. Maximum freedom.',
                effects: {
                  happiness: 3,
                  personality_match: 'adventurous',
                },
              },
              {
                text: 'Get Married / Long-term Partner',
                consequence: 'Expenses: +$5k/yr. Deep companionship.',
                effects: {
                  expense_add: {
                    id: 'partner',
                    label: 'Partner Costs',
                    amount: 5000,
                  },
                  happiness: 20,
                  avatar: { type: 'accessory', icon: 'family' },
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Date Casually',
                consequence: 'Expenses: +$2k/yr. Social life boost.',
                effects: {
                  expense_add: {
                    id: 'dating',
                    label: 'Dating',
                    amount: 2000,
                  },
                  happiness: 8,
                  personality_match: 'adventurous',
                },
              },
              {
                text: 'Adopt a Pet',
                consequence: 'Expenses: +$2k/yr. Great companionship.',
                effects: {
                  expense_add: { id: 'pet', label: 'Pet Costs', amount: 2000 },
                  happiness: 10,
                  avatar: { type: 'accessory', icon: 'pet' },
                  personality_match: 'creative',
                },
              },
              {
                text: 'Focus on your career for now',
                consequence: 'Career boost +8%. Less social connection.',
                effects: {
                  salary_boost: { id: 'main_job', amount: 0 },
                  special_effect: 'career_focus',
                  happiness: -5,
                  career_level_change: 1,
                  burnout_change: 5,
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Build a Close Friend Group',
                consequence: 'Expenses: +$1.5k/yr. Strong social support.',
                effects: {
                  expense_add: {
                    id: 'social',
                    label: 'Social Activities',
                    amount: 1500,
                  },
                  happiness: 12,
                  personality_match: 'creative',
                },
              },
            ],
          },
          {
            condition: (gs) => gs.expenseBreakdown.student_loan,
            time_skip: 2,
            question:
              'Stage 7: You have student loans. How do you approach them?',
            answers: [
              {
                text: 'Pay aggressively to eliminate them',
                consequence: 'Cost: $50k now. Frees up cash flow for good.',
                effects: {
                  cash_change: -50000,
                  expense_remove: 'student_loan',
                  happiness: 10,
                  creditScore_change: 50,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Continue making minimum payments',
                consequence: 'Benefit: Keep your cash for other things.',
                effects: {},
              },
              {
                text: 'Refinance for a lower payment',
                consequence: 'Lowers yearly cost, but extends the loan.',
                effects: {
                  expense_boost: { id: 'student_loan', amount: -2000 },
                },
              },
            ],
          },
          {
            condition: (gs) => gs.housingType !== 'own',
            time_skip: 2,
            question:
              "Stage 8: You've been renting. What's your next housing move?",
            answers: [
              {
                text: 'Buy a starter home',
                consequence: 'Cost: $25k down. Expenses: +$30k/yr mortgage.',
                effects: {
                  cash_change: -25000,
                  housing_type: 'own',
                  expense_remove: 'housing',
                  expense_add: {
                    id: 'housing',
                    label: 'Mortgage',
                    amount: 30000,
                  },
                  equity_change: 50000,
                  avatar: { type: 'bg', icon: 'house' },
                  creditScore_change: -20,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Buy a condo',
                consequence:
                  'Cost: $15k down. Expenses: +$22k/yr mortgage & fees.',
                effects: {
                  cash_change: -15000,
                  housing_type: 'own',
                  expense_remove: 'housing',
                  expense_add: {
                    id: 'housing',
                    label: 'Mortgage',
                    amount: 22000,
                  },
                  equity_change: 30000,
                  avatar: { type: 'bg', icon: 'apartment' },
                  creditScore_change: -15,
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Move to a nicer apartment',
                consequence: 'Expenses: +$12k/yr. Upgrade your lifestyle.',
                effects: {
                  expense_boost: { id: 'housing', amount: 12000 },
                  happiness: 5,
                  personality_match: 'creative',
                },
              },
            ],
          },
          {
            time_skip: 2,
            question:
              'Stage 9: Your company offers a professional development course.',
            answers: [
              {
                text: "Take it. It's an investment in yourself.",
                consequence: 'Cost: $5k. Could lead to a promotion.',
                effects: {
                  cash_change: -5000,
                  career_level_change: 1,
                  burnout_change: 5,
                  personality_match: 'ambitious',
                },
              },
              {
                text: "Decline. You'd rather have the free time.",
                consequence: 'No cost, but a missed opportunity?',
                effects: {
                  burnout_change: -5,
                  personality_match: 'adventurous',
                },
              },
            ],
          },
          {
            condition: (gs) => gs.avatar.accessory === 'family',
            time_skip: 2,
            question: "Stage 10: You're married. Time to think about kids?",
            answers: [
              {
                text: 'Yes, have a child',
                consequence: 'Expenses: +$20k/yr. A new chapter begins!',
                effects: {
                  expense_add: {
                    id: 'child1',
                    label: 'Child 1 Costs',
                    amount: 20000,
                  },
                  happiness: 25,
                  children_add: 1,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Not right now, focus on us',
                consequence: 'Enjoy your time as a couple.',
                effects: { happiness: 5 },
              },
            ],
          },
          {
            time_skip: 2,
            question: 'Stage 11: How do you spend your free time?',
            answers: [
              {
                text: 'Work Overtime for Extra Money',
                consequence: 'Salary: +$8k/yr. Less free time, more burnout.',
                effects: {
                  salary_boost: { id: 'main_job', amount: 8000 },
                  happiness: -8,
                  burnout_change: 10,
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Start a Side Hustle',
                consequence:
                  'Potential income: +$5k/yr. Takes time and energy.',
                effects: {
                  salary_add: {
                    id: 'side_hustle',
                    label: 'Side Hustle',
                    amount: 5000,
                  },
                  happiness: 5,
                  burnout_change: 5,
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'On expensive hobbies and travel',
                consequence: 'Expenses: +$10k/yr. Live life to the fullest!',
                effects: {
                  expense_add: {
                    id: 'hobbies',
                    label: 'Hobbies',
                    amount: 10000,
                  },
                  happiness: 15,
                  burnout_change: -10,
                  personality_match: 'adventurous',
                },
              },
              {
                text: 'On affordable hobbies (reading, gaming, hiking)',
                consequence: 'Expenses: +$1k/yr. Low cost, high reward.',
                effects: {
                  expense_add: {
                    id: 'hobbies',
                    label: 'Hobbies',
                    amount: 1000,
                  },
                  happiness: 10,
                  burnout_change: -5,
                  personality_match: 'creative',
                },
              },
              {
                text: 'Volunteering in your community',
                consequence: 'Great for happiness, meaningful connections.',
                effects: {
                  happiness: 10,
                  burnout_change: -3,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Fitness and wellness activities',
                consequence: 'Expenses: +$2k/yr. Better health and energy.',
                effects: {
                  expense_add: {
                    id: 'fitness',
                    label: 'Fitness',
                    amount: 2000,
                  },
                  happiness: 12,
                  burnout_change: -8,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Spend time with family and friends',
                consequence: 'Expenses: +$3k/yr. Strong relationships.',
                effects: {
                  expense_add: {
                    id: 'social',
                    label: 'Social',
                    amount: 3000,
                  },
                  happiness: 14,
                  burnout_change: -6,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Just relax at home / do nothing',
                consequence: 'No cost. Recharge, but might feel isolated.',
                effects: {
                  happiness: 2,
                  burnout_change: -4,
                  personality_match: 'creative',
                },
              },
            ],
          },
          {
            time_skip: 2,
            question: 'Stage 12: A new technology is disrupting your field.',
            answers: [
              {
                text: 'Adapt and learn the new skills',
                consequence: 'Salary: +6% raise. Stay relevant.',
                effects: {
                  salary_boost: { id: 'main_job', amount: 0 },
                  special_effect: 'tech_adaptation',
                  career_level_change: 1,
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Ignore it and hope for the best',
                consequence: 'Risk: Your skills could become obsolete.',
                effects: {
                  salary_boost: {
                    id: 'main_job',
                    amount: Math.random() > 0.4 ? -30000 : 0,
                  },
                  happiness: -5,
                },
              },
            ],
          },
          {
            condition: (gs) => gs.children.length > 0 && gs.children.length < 3,
            time_skip: 2,
            question:
              'Stage 13: You have a child. Do you want to have another?',
            answers: [
              {
                text: 'Yes, have another child',
                consequence: 'Expenses: +$18k/yr. A growing family!',
                effects: {
                  special_effect: 'add_child',
                  personality_match: 'guardian',
                },
              },
              {
                text: 'No, one is enough',
                consequence: 'Focus your resources and energy.',
                effects: { happiness: 5 },
              },
            ],
          },
          {
            time_skip: 2,
            question:
              "Stage 14: You're entering mid-life. What is your career focus?",
            answers: [
              {
                text: 'Push for a major promotion',
                consequence: 'Salary: +6% raise. High stress.',
                effects: {
                  career_level_change: 1,
                  salary_boost: { id: 'main_job', amount: 0 },
                  special_effect: 'major_promotion',
                  happiness: -10,
                  burnout_change: 15,
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Switch to a less stressful job',
                consequence: 'Salary: -15%. Better work-life balance.',
                effects: {
                  career_level_change: -1,
                  salary_boost: { id: 'main_job', amount: 0 },
                  special_effect: 'downshift_career',
                  happiness: 20,
                  burnout_change: -10,
                  personality_match: 'guardian',
                },
              },
            ],
          },
          {
            time_skip: 2,
            question: 'Stage 15: Your parents are aging and need some support.',
            answers: [
              {
                text: 'Help them financially',
                consequence: 'Expenses: +$10k/yr. A sense of duty.',
                effects: {
                  expense_add: {
                    id: 'parents',
                    label: 'Parent Support',
                    amount: 10000,
                  },
                  happiness: 5,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Offer your time and support',
                consequence: 'No direct cost, but emotionally taxing.',
                effects: {
                  happiness: 5,
                  burnout_change: 5,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Do nothing',
                consequence: 'Strained relationships.',
                effects: { happiness: -10 },
              },
            ],
          },
          {
            time_skip: 2,
            question:
              "Stage 16: You're established. How do you spend surplus income?",
            answers: [
              {
                text: 'Luxury Lifestyle',
                consequence: 'Expenses: +$30k/yr. Live for today.',
                effects: {
                  expense_add: { id: 'luxury', label: 'Luxury', amount: 30000 },
                  happiness: 15,
                  personality_match: 'adventurous',
                },
              },
              {
                text: 'Save Aggressively for Retirement',
                consequence: 'Benefit: +$100k to retirement. Live frugally.',
                effects: {
                  retirement_change: 100000,
                  happiness: -5,
                  personality_match: 'ambitious',
                },
              },
            ],
          },
          {
            condition: (gs) => gs.housingType === 'own',
            time_skip: 2,
            question: 'Stage 17: Your home has appreciated. What do you do?',
            answers: [
              {
                text: 'Sell and upgrade to a bigger house',
                consequence: 'Expenses: +$20k/yr. More space, more costs.',
                effects: {
                  cash_change: (gs) => gs.equity * 0.5,
                  equity_change: (gs) => gs.equity * 0.7,
                  expense_boost: { id: 'housing', amount: 20000 },
                  personality_match: 'ambitious',
                },
              },
              {
                text: 'Stay put and enjoy the low mortgage',
                consequence: 'Benefit: Financial stability.',
                effects: { happiness: 10, personality_match: 'guardian' },
              },
            ],
          },
          {
            time_skip: 2,
            question: "Stage 18: You're a senior in your field.",
            answers: [
              {
                text: 'Mentor junior colleagues',
                consequence: 'Share your knowledge and give back.',
                effects: {
                  happiness: 15,
                  career_level_change: 1,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Coast to retirement',
                consequence: 'Less stress, but you might get bored.',
                effects: {
                  burnout_change: -10,
                  personality_match: 'adventurous',
                },
              },
            ],
          },
          {
            time_skip: 2,
            question: 'Stage 19: Thinking about your legacy.',
            answers: [
              {
                text: 'Start a scholarship or donate to charity',
                consequence: 'Cost: $50k. Make a difference.',
                effects: {
                  cash_change: -50000,
                  happiness: 20,
                  personality_match: 'guardian',
                },
              },
              {
                text: 'Focus on family and travel',
                consequence: 'Enjoy the fruits of your labor.',
                effects: {
                  expense_add: { id: 'travel', label: 'Travel', amount: 15000 },
                  happiness: 15,
                  personality_match: 'adventurous',
                },
              },
            ],
          },
          {
            time_skip: 2,
            question:
              "Stage 20: You are approaching retirement. What's your final plan?",
            answers: [
              {
                text: 'Retire completely',
                consequence: 'No more salary. Ultimate freedom.',
                effects: {
                  happiness: 25,
                  salary_remove: 'main_job',
                  salary_remove: 'side_hustle',
                  personality_match: 'adventurous',
                },
              },
              {
                text: 'Work part-time in a fun job',
                consequence: 'Salary set to $25k/yr. Stay active.',
                effects: {
                  salary_remove: 'main_job',
                  salary_remove: 'side_hustle',
                  salary_add: {
                    id: 'main_job',
                    label: 'Part-time Job',
                    amount: 25000,
                  },
                  happiness: 10,
                  personality_match: 'creative',
                },
              },
            ],
          },
        ];

        const minorEvents = [
          {
            description:
              'The stock market has a great year! Your investments grow.',
            effects: { cash_change: (c) => c * 0.1, happiness: 5 },
          },
          {
            description:
              'Inflation is high this year, increasing all your expenses by 10%.',
            effects: { expense_boost_all: 0.1, happiness: -5 },
          },
          {
            description: 'You win a small lottery prize! $5k windfall.',
            effects: { cash_change: 5000, happiness: 10 },
          },
          {
            description: 'Your car breaks down, requiring an expensive repair.',
            effects: {
              cash_change: -8000,
              happiness: -5,
              creditScore_change: -10,
            },
          },
          {
            description: 'Minor promotion at work! +5% raise.',
            effects: {
              salary_boost: { id: 'main_job', amount: 0 },
              special_effect: 'minor_promotion',
              happiness: 10,
              career_level_change: 1,
            },
          },
          {
            description:
              'Your insurance premiums skyrocketed after a policy change.',
            effects: {
              expense_add: {
                id: 'insurance',
                label: 'Insurance Hike',
                amount: 5000,
              },
              happiness: -5,
            },
          },
          {
            description:
              'The housing market is booming, increasing your home equity.',
            effects: { equity_change: 30000, happiness: 5 },
          },
          {
            description: 'You discover an amazing, inexpensive new hobby.',
            effects: { happiness: 10 },
          },
          {
            description:
              'A water pipe bursts in your home, requiring a costly fix.',
            effects: {
              cash_change: -10000,
              happiness: -5,
              creditScore_change: -15,
            },
          },
          {
            description: 'You receive a tax refund!',
            effects: { cash_change: 3500, happiness: 5 },
          },
          {
            description: 'A friend asks you for a loan.',
            effects: { cash_change: -2000, happiness: 2 },
          },
          {
            description: 'Your employer offers free training courses.',
            effects: {
              happiness: 5,
              career_level_change: 0.5,
            },
          },
          {
            description: 'You get a surprise medical bill.',
            effects: {
              cash_change: -4000,
              happiness: -3,
            },
          },
          {
            description: 'Your landlord increases rent unexpectedly.',
            effects: {
              expense_boost: { id: 'housing', amount: 2400 },
              happiness: -4,
            },
          },
          {
            description:
              'You find a great deal on groceries and save money this year.',
            effects: {
              expense_boost: { id: 'groceries', amount: -1200 },
              happiness: 2,
            },
          },
          {
            description: 'Your company gives everyone a one-time bonus!',
            effects: { cash_change: 5000, happiness: 8 },
          },
          {
            description: 'You have to replace your phone unexpectedly.',
            effects: { cash_change: -800, happiness: -2 },
          },
          {
            description: 'A friend invites you on an all-expenses-paid trip!',
            effects: { happiness: 15 },
          },
          {
            description:
              'You get audited by the IRS. Nothing wrong, but stressful.',
            effects: { happiness: -8, cash_change: -1500 },
          },
          {
            description: 'You inherit a small amount from a distant relative.',
            effects: { cash_change: 12000, happiness: 3 },
          },
          {
            description:
              'Your credit card gets stolen and there are fraudulent charges.',
            effects: {
              cash_change: -2500,
              happiness: -5,
              creditScore_change: -5,
            },
          },
          {
            description: 'You get a parking ticket.',
            effects: { cash_change: -150, happiness: -1 },
          },
          {
            description: 'Your pet needs expensive veterinary care.',
            effects: { cash_change: -3000, happiness: -4 },
          },
          {
            description: 'You land a lucrative freelance project!',
            effects: {
              cash_change: 7000,
              happiness: 6,
            },
          },
          {
            description:
              'Your utility bills are lower this year due to conservation.',
            effects: {
              expense_boost: { id: 'utilities', amount: -600 },
              happiness: 2,
            },
          },
          {
            description: 'A family member needs financial help urgently.',
            effects: { cash_change: -5000, happiness: 1 },
          },
          {
            description: 'You get a free gym membership through work!',
            effects: {
              happiness: 6,
              expense_boost: { id: 'fitness', amount: -2000 },
            },
          },
          {
            description: 'Your home appliance breaks and needs replacement.',
            effects: { cash_change: -1200, happiness: -3 },
          },
          {
            description: 'You win a raffle at a local event!',
            effects: { cash_change: 500, happiness: 4 },
          },
          {
            description: 'Your employer cuts hours across the board.',
            effects: {
              salary_boost: { id: 'main_job', amount: -8000 },
              happiness: -10,
            },
          },
          {
            description:
              'You get a generous gift from family for the holidays.',
            effects: { cash_change: 2000, happiness: 7 },
          },
          {
            description:
              'Your student loan interest rate drops due to refinancing.',
            effects: {
              expense_boost: { id: 'student_loan', amount: -1000 },
              happiness: 5,
            },
          },
          {
            description:
              'You accidentally damage your apartment and lose your security deposit.',
            effects: { cash_change: -1500, happiness: -4 },
          },
          {
            description: 'Your skills become more valuable! +7% raise.',
            effects: {
              salary_boost: { id: 'main_job', amount: 0 },
              special_effect: 'skill_premium',
              happiness: 8,
            },
          },
          {
            description: 'You have to attend a mandatory unpaid training.',
            effects: { happiness: -3 },
          },
          {
            description:
              'A close friend helps you with a major life task for free.',
            effects: { happiness: 10 },
          },
          {
            description: 'Your neighborhood coffee shop closes down.',
            effects: { happiness: -2 },
          },
          {
            description: 'You discover a subscription you forgot to cancel.',
            effects: { cash_change: -600, happiness: -3 },
          },
          {
            description: 'Your company offers profit-sharing this year!',
            effects: { cash_change: 8000, happiness: 10 },
          },
          {
            description: 'You get jury duty and lose work time.',
            effects: { cash_change: -800, happiness: -4 },
          },
          {
            description: 'A mentor at work takes you under their wing.',
            effects: {
              happiness: 8,
              career_level_change: 0.5,
            },
          },
          {
            description:
              'Your favorite restaurant has a special promotion all year!',
            effects: {
              expense_boost: { id: 'groceries', amount: -800 },
              happiness: 3,
            },
          },
          {
            description:
              'You take a free online course that opens new opportunities.',
            effects: { happiness: 5 },
          },
          {
            description: 'Your internet provider raises prices.',
            effects: {
              expense_boost: { id: 'internet', amount: 240 },
              happiness: -2,
            },
          },
          {
            description:
              'You get recognized at work for excellent performance!',
            effects: {
              happiness: 12,
              salary_boost: { id: 'main_job', amount: 5000 },
            },
          },
          {
            description: 'Your commute time increases due to traffic changes.',
            effects: { happiness: -5 },
          },
          {
            description:
              "You volunteer for a cause you care about and it's deeply fulfilling.",
            effects: { happiness: 15 },
          },
          {
            description:
              'Your building has a pest problem requiring treatment.',
            effects: { cash_change: -800, happiness: -6 },
          },
          {
            description: 'You sell some old items and make unexpected cash!',
            effects: { cash_change: 1200, happiness: 3 },
          },
        ];

        const majorEvents = [
          {
            description:
              'A catastrophic market crash occurs, wiping out 40% of your invested cash.',
            question: 'This is devastating. How do you respond?',
            choices: [
              {
                text: 'Panic and sell everything to prevent further loss.',
                consequence: 'Locks in your losses permanently.',
                effects: { cash_change: (c) => c * -0.1, happiness: -25 },
              },
              {
                text: 'Stay the course and hope for recovery.',
                consequence:
                  'A test of nerve. It could get worse before it gets better.',
                effects: { happiness: -15, set_investment_risk: 0.7 },
              },
              {
                text: 'Delay retirement and start saving aggressively.',
                consequence: 'Work extra years. +$8k income boost.',
                effects: {
                  salary_boost: { id: 'main_job', amount: 8000 },
                  happiness: -20,
                },
              },
            ],
          },
          {
            description:
              'A global pandemic occurs. Your field is in high demand, but you face immense stress and burnout risk.',
            question: 'Your work-life balance is gone. What do you do?',
            choices: [
              {
                text: 'Work insane hours to capitalize on the opportunity.',
                consequence: 'Extreme overtime. +$12k/yr, huge stress.',
                effects: {
                  salary_boost: { id: 'main_job', amount: 12000 },
                  happiness: -30,
                  burnout_change: 20,
                },
              },
              {
                text: 'Quit your job to protect your mental health.',
                consequence: 'A drastic move for self-preservation.',
                effects: {
                  salary_remove: 'main_job',
                  cash_change: -10000,
                  happiness: 20,
                },
              },
              {
                text: 'Negotiate for better conditions or hazard pay.',
                consequence: 'Risky negotiation. 50% chance +$8k.',
                effects: {
                  salary_boost: {
                    id: 'main_job',
                    amount: Math.random() > 0.5 ? 8000 : 0,
                  },
                  happiness: 5,
                },
              },
            ],
          },
          {
            description:
              "You've been diagnosed with a serious but manageable health condition.",
            question:
              'This changes your perspective. How do you adjust your life?',
            choices: [
              {
                text: 'Prioritize health above all. Reduce work hours and stress.',
                consequence: 'Part-time shift. -15% income.',
                effects: {
                  salary_boost: { id: 'main_job', amount: 0 },
                  special_effect: 'health_reduction',
                  happiness: 20,
                  burnout_change: -15,
                },
              },
              {
                text: 'Sell your large house and downsize.',
                consequence: 'Gain cash, lose equity, lower expenses.',
                effects: {
                  cash_change: 100000,
                  equity_change: (e) => -e,
                  expense_remove: 'housing',
                  expense_add: {
                    id: 'housing',
                    label: 'New Housing',
                    amount: 18000,
                  },
                  happiness: 10,
                  avatar: { type: 'bg', icon: 'apartment' },
                },
              },
              {
                text: "Ignore the doctor's advice and keep pushing hard at work.",
                consequence: 'High risk of future health crises.',
                effects: {
                  happiness: Math.random() > 0.3 ? -40 : -15,
                  burnout_change: 10,
                },
              },
            ],
          },
        ];

        const childEvents = [
          {
            description:
              'Your child is a gifted athlete! Lessons and travel cost an extra $5k/yr.',
            effects: {
              expense_add: {
                id: 'child_sports',
                label: 'Child Sports',
                amount: 5000,
              },
              happiness: 10,
            },
          },
          {
            description:
              "Uh oh, braces are needed. That's a one-time $8,000 cost.",
            effects: { cash_change: -8000, happiness: -5 },
          },
          {
            description:
              'Your child wins a university scholarship, saving you $50,000 in future costs!',
            effects: { cash_change: 50000, happiness: 25 },
          },
          {
            description:
              'Your child needs a tutor, adding $4k/yr to your expenses.',
            effects: {
              expense_add: {
                id: 'child_tutor',
                label: 'Child Tutor',
                amount: 4000,
              },
              happiness: -5,
            },
          },
        ];

        let currentQuestionIndex = 0;
        let gameState = {
          cash: 5000,
          savingsRate: 0.2, // default 20% (Option B baseline)
          savingsBalance: 0, // accumulated savings
          debt: 0, // total debt
          retirement: 0,
          equity: 0,
          salaryBreakdown: {},
          expenseBreakdown: {
            // Will be populated from budget after personality test
          },
          happiness: 50,
          stress: 20, // Add stress tracking
          lifestyleLevel: 'normal', // 'high', 'normal', 'low', 'downgraded_home'
          forcedDowngradeCount: 0, // how many times they've been downgraded
          lostCar: false, // track if car was repossessed
          rentIncrease: 0, // track rent increases from events
          justDowngraded: false, // flag to prevent events after downgrade
          flags: new Set(), // Stage requirements tracking
          investment_multiplier: 1.0,
          investment_risk: 0,
          avatar: { bg: null, item: null, accessory: null },
          currentAge: 18,
          currentYear: 2025,
          housingType: null,
          children: [],
          careerType: null,
          sector: null,
          careerLevel: 0,
          burnout: 0,
          creditScore: 650,
          qualifications: [],
          personality: null,
          personalityScores: {
            ambitious: 0,
            guardian: 0,
            creative: 0,
            adventurous: 0,
          },
        };
        // Player view model used for age-driven UI (age may start >18)
        if (!window.playerState) {
          const initialAgeEl = document.getElementById('startAge');
          const initialAge = initialAgeEl
            ? parseInt(initialAgeEl.value, 10)
            : 18;
          const ageSafe =
            !isNaN(initialAge) && initialAge >= 16 && initialAge <= 65
              ? initialAge
              : 18;
          window.playerState = { age: ageSafe };
          gameState.currentAge = ageSafe; // sync game state with chosen age
        }
        let filteredGameData = [];
        let currentEffects = {};
        let personalityQuizIndex = 0;

        const startScreen = document.getElementById('start-screen'),
          quizScreen = document.getElementById('quiz-screen'),
          resultScreen = document.getElementById('result-screen');
        const questionText = document.getElementById('question-text'),
          answersContainer = document.getElementById('answers-container');
        const progressBar = document.getElementById('progress-bar');
        const cashStat = document.getElementById('cash-stat'),
          retirementStat = document.getElementById('retirement-stat'),
          salaryStat = document.getElementById('salary-stat'),
          expenseStat = document.getElementById('expense-stat'),
          happinessStat = document.getElementById('happiness-stat');
        const creditScoreValue = document.getElementById('credit-stat-value'),
          creditScoreRank = document.getElementById('credit-stat-rank');
        const eventModal = document.getElementById('event-modal'),
          eventText = document.getElementById('event-text');
        const majorEventModal = document.getElementById('major-event-modal'),
          majorEventDescription = document.getElementById(
            'major-event-description'
          ),
          majorEventQuestion = document.getElementById('major-event-question'),
          majorEventChoices = document.getElementById('major-event-choices');
        const startError = document.getElementById('start-error');
        const breakdownModal = document.getElementById('breakdown-modal');
        const debtModal = document.getElementById('debt-modal');
        const backButton = document.getElementById('back-button');
        const profileModal = document.getElementById('profile-modal');
        const confirmationModal = document.getElementById('confirmation-modal');
        const personalityQuizScreen = document.getElementById(
          'personality-quiz-screen'
        );

        // Override startQuiz to use new selectors and configs (after data is loaded)
        const startQuiz = () => {
          const startAgeInput = document.getElementById('startAge');
          const startYearInput = document.getElementById('startYear');
          const startAge = parseInt(startAgeInput.value, 10);
          const startYear = parseInt(startYearInput.value, 10);

          if (!startAge || !startYear || startAge < 1 || startYear < 1950) {
            startError.classList.remove('hidden');
            return;
          }
          startError.classList.add('hidden');

          // Silent defaults - Student scenario, MED region
          const DEFAULT_SCENARIO_ID = 'student';
          const DEFAULT_REGION = 'MED';
          const scenario =
            scenarios.find((s) => s.id === DEFAULT_SCENARIO_ID) || {};
          const dwelling = null; // no rent until stage chooses it

          const player = {
            region: DEFAULT_REGION,
            cash: scenario.starting_cash ?? 500,
            debt: scenario.starting_debt ?? 0,
            has_child: scenario.has_child ?? false,
            dwelling, // <- null means $0 rent
            recurringAdjustments: [],
            tempIncome: [],
            rentMultiplier: 1,
            ageMonths: startAge * 12,
            investments: 0,
            monthsWorked: 0,
            happiness: 50,
            stress: 20,
            flags: new Set(),
          };

          // Career is chosen in stages; initialize a blank shell so lifetime mode won't choke
          let careerState = {
            currentTitle: 'Unemployed',
            currentBasePay: 0,
            type: 'salary',
            hours_per_week: 40,
            raise: { cola: 0.02, merit: [0.0, 0.0] },
            promotion: [],
            monthsInRole: 0,
          };

          const birthYear = startYear - startAge;
          window.lifetimeClock = initClock(birthYear, player.ageMonths, 67, 50);
          window.lifetimeHousehold = initHousehold();
          window.lifetimeHousing = initHousing();
          window.lifetimeLoans = initLoans();
          window.lifetimeEventLog = initEventLog();
          window.lifetimeAutoAdvance = false;
          window.lifetimeLastCheckpoint = 0;

          window.lifeSimPlayer = player;
          window.lifeSimCareer = careerState;
          window.lifeSimScenarioGoal = scenario.goal ?? null;

          // Sync chosen starting age into gameState & playerState
          gameState.currentAge = startAge;
          if (window.playerState) {
            window.playerState.age = startAge;
          } else {
            window.playerState = { age: startAge };
          }

          // Hide start screen and trigger Stage 1 immediately
          startScreen.classList.add('hidden');

          // Stage 1 is not age-locked, so trigger it now
          const stage1 = STAGES.stages.find((s) => s.id === 'stage_1_start');
          if (stage1) {
            openStageModal(stage1);
          } else {
            // Fallback: show personality quiz directly
            personalityQuizScreen.classList.remove('hidden');
            personalityQuizScreen.classList.add('fade-in');
            displayPersonalityQuestion();
          }
        };

        const displayPersonalityQuestion = () => {
          if (personalityQuizIndex < personalityQuestions.length) {
            const stage = personalityQuestions[personalityQuizIndex];
            document.getElementById('personality-question-text').textContent =
              stage.question;
            const container = document.getElementById(
              'personality-answers-container'
            );
            container.innerHTML = '';
            stage.answers.forEach((answer) => {
              const button = document.createElement('button');
              button.className =
                'w-full text-center p-4 rounded-lg bg-slate-100 hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200 font-semibold';
              button.textContent = answer.text;
              button.onclick = () => {
                gameState.personalityScores[answer.type]++;
                personalityQuizIndex++;
                displayPersonalityQuestion();
              };
              container.appendChild(button);
            });
            document.getElementById(
              'personality-progress-bar'
            ).style.width = `${
              (personalityQuizIndex / personalityQuestions.length) * 100
            }%`;
          } else {
            const scores = gameState.personalityScores;
            const personality = Object.keys(scores).reduce((a, b) =>
              scores[a] > scores[b] ? a : b
            );
            gameState.personality = personality;
            startMainGame();
          }
        };

        const startMainGame = () => {
          personalityQuizScreen.classList.add('hidden');

          // Sync expense breakdown from the shared budget
          syncExpenseBreakdownFromBudget();

          // Check if we need to return to stage modal
          if (window.returnToStageAfterPersonality && currentStageModal) {
            window.returnToStageAfterPersonality = false;

            // Store personality in player
            window.lifeSimPlayer.personality = gameState.personality;

            // Show stage modal again and move to next question
            document.getElementById('stage-modal').classList.remove('hidden');
            document.getElementById('stage-modal').classList.add('flex');
            showStageQuestion(currentStageModal.currentQuestionIndex + 1);
          } else {
            // Normal flow: start main game
            quizScreen.classList.remove('hidden');
            quizScreen.classList.add('fade-in');
            displayQuestion();
          }
        };

        const filterGameStages = () => {
          filteredGameData = gameData.filter((stage) => {
            if (stage.condition) {
              return stage.condition(gameState);
            }
            return true;
          });
        };

        const showBreakdown = (type) => {
          const data =
            type === 'salary'
              ? gameState.salaryBreakdown
              : gameState.expenseBreakdown;
          const title =
            type === 'salary' ? 'Salary Breakdown' : 'Expense Breakdown';
          const listEl = document.getElementById('breakdown-list');

          document.getElementById('breakdown-title').textContent = title;
          listEl.innerHTML = '';

          if (Object.keys(data).length === 0) {
            const li = document.createElement('li');
            li.className = 'text-slate-500';
            li.textContent = 'No items to display.';
            listEl.appendChild(li);
          } else {
            Object.values(data).forEach((item) => {
              const li = document.createElement('li');
              li.className = 'flex justify-between items-center text-slate-700';
              const sign = type === 'expenses' ? '-' : '+';
              li.innerHTML = `<span>${
                item.label
              }</span><span class="font-semibold">${sign}$${item.amount.toLocaleString()}/yr</span>`;
              listEl.appendChild(li);
            });
          }
          breakdownModal.classList.remove('hidden');
          setTimeout(() => {
            breakdownModal.classList.remove('opacity-0', 'scale-95');
          }, 10);
        };

        const hideBreakdown = () => {
          breakdownModal.classList.add('opacity-0', 'scale-95');
          setTimeout(() => {
            breakdownModal.classList.add('hidden');
          }, 300);
        };

        const showProfileModal = () => {
          document.getElementById('profile-profession').textContent =
            gameState.salaryBreakdown.main_job?.label || 'Unemployed';
          document.getElementById('profile-qualifications').textContent =
            gameState.qualifications.join(', ') || 'None';

          const lifestyleList = document.getElementById('profile-lifestyle');
          lifestyleList.innerHTML = '';
          const lifestyleItems = Object.keys(gameState.expenseBreakdown)
            .filter((key) =>
              ['hobbies', 'luxury', 'travel', 'pet', 'partner'].includes(key)
            )
            .map((key) => gameState.expenseBreakdown[key].label);

          if (lifestyleItems.length > 0) {
            lifestyleItems.forEach((item) => {
              const li = document.createElement('li');
              li.textContent = item;
              lifestyleList.appendChild(li);
            });
          } else {
            const li = document.createElement('li');
            li.textContent = 'A simple life.';
            lifestyleList.appendChild(li);
          }

          document
            .getElementById('profile-main-view')
            .classList.remove('hidden');
          document
            .getElementById('profile-action-view')
            .classList.add('hidden');
          profileModal.classList.remove('hidden');
          setTimeout(() => {
            profileModal.classList.remove('opacity-0', 'scale-95');
          }, 10);
        };

        const hideProfileModal = () => {
          profileModal.classList.add('opacity-0', 'scale-95');
          setTimeout(() => {
            profileModal.classList.add('hidden');
          }, 300);
        };

        const showActionModal = (type) => {
          document.getElementById('profile-main-view').classList.add('hidden');
          const actionView = document.getElementById('profile-action-view');
          actionView.classList.remove('hidden');
          const container = document.getElementById('action-options-container');
          const title = document.getElementById('action-title');
          container.innerHTML = '';

          if (type === 'career') {
            title.textContent = 'Change Career';
            const backToSchool = document.createElement('button');
            backToSchool.className =
              'w-full text-left p-4 rounded-lg bg-slate-100 hover:bg-indigo-100';
            backToSchool.innerHTML = `<span class="answer-text font-semibold">Go back to school (4 years)</span><span class="answer-consequence">Cost: $80k. Reset your career path.</span>`;
            backToSchool.onclick = () => {
              selectAnswer({
                cash_change: -80000,
                time_skip: 4,
                salary_remove: 'main_job',
                salary_remove: 'side_hustle',
                sector: null,
                career_type: null,
                career_level: 0,
                qualifications: [],
              });
              hideProfileModal();
            };
            container.appendChild(backToSchool);
          } else {
            // lifestyle
            title.textContent = 'Adjust Lifestyle';
            const addHobby = document.createElement('button');
            addHobby.className =
              'w-full text-left p-4 rounded-lg bg-slate-100 hover:bg-indigo-100';
            addHobby.innerHTML = `<span class="answer-text font-semibold">Take up an expensive hobby</span><span class="answer-consequence">Expenses: +$10k/yr. Happiness +15</span>`;
            addHobby.onclick = () => {
              applyEffects({
                expense_add: { id: 'hobbies', label: 'Hobbies', amount: 10000 },
                happiness: 15,
              });
              hideProfileModal();
              updateFinancialsUI();
            };
            container.appendChild(addHobby);

            if (gameState.expenseBreakdown.hobbies) {
              const removeHobby = document.createElement('button');
              removeHobby.className =
                'w-full text-left p-4 rounded-lg bg-slate-100 hover:bg-indigo-100';
              removeHobby.innerHTML = `<span class="answer-text font-semibold">Drop expensive hobby</span><span class="answer-consequence">Expenses: -$10k/yr. Happiness -10</span>`;
              removeHobby.onclick = () => {
                const amountToRemove =
                  gameState.expenseBreakdown.hobbies.amount;
                applyEffects({ expense_remove: 'hobbies', happiness: -10 });
                hideProfileModal();
                updateFinancialsUI();
              };
              container.appendChild(removeHobby);
            }
          }
        };

        const updateAvatar = () => {
          const bgContainer = document.getElementById('avatar-bg');
          const itemContainer = document.getElementById('avatar-item');
          const accessoryContainer =
            document.getElementById('avatar-accessory');
          const newBg = gameState.avatar.bg
            ? avatarIcons[gameState.avatar.bg]
            : '';
          const newItem = gameState.avatar.item
            ? avatarIcons[gameState.avatar.item]
            : '';
          const newAccessory = gameState.avatar.accessory
            ? avatarIcons[gameState.avatar.accessory]
            : '';
          if (bgContainer.innerHTML !== newBg) bgContainer.innerHTML = newBg;
          if (itemContainer.innerHTML !== newItem)
            itemContainer.innerHTML = newItem;
          if (accessoryContainer.innerHTML !== newAccessory)
            accessoryContainer.innerHTML = newAccessory;
        };

        const updateTimeline = () => {
          const ageDisplay = window.playerState?.age ?? gameState.currentAge;
          document.getElementById(
            'current-age'
          ).textContent = `Age: ${ageDisplay}`;
          document.getElementById(
            'current-year'
          ).textContent = `Year: ${gameState.currentYear}`;
        };

        const updateFinancialsUI = () => {
          const totalSalary = Object.values(gameState.salaryBreakdown).reduce(
            (sum, item) => sum + item.amount,
            0
          );
          const totalExpenses = Object.values(
            gameState.expenseBreakdown
          ).reduce((sum, item) => sum + item.amount, 0);

          // Phase 8: Updated UI with new stats
          cashStat.textContent = `$${Math.round(
            gameState.cash
          ).toLocaleString()}`;

          const savingsStat = document.getElementById('savings-stat');
          if (savingsStat) {
            savingsStat.textContent = `$${Math.round(
              gameState.savingsBalance || 0
            ).toLocaleString()}`;
          }

          const debtStat = document.getElementById('debt-stat');
          if (debtStat) {
            debtStat.textContent = `$${Math.round(
              gameState.debt || 0
            ).toLocaleString()}`;
            debtStat.style.color = gameState.debt > 0 ? '#dc2626' : '#059669';
          }

          salaryStat.textContent = `$${Math.round(totalSalary / 1000)}k/yr`;

          const happinessStatValue = document.getElementById(
            'happiness-stat-value'
          );
          if (happinessStatValue) {
            happinessStatValue.textContent = Math.round(
              gameState.happiness || 50
            );
          }

          // Keep emoji display if it exists
          if (happinessStat) {
            let happinessEmoji = 'ðŸ˜';
            if (gameState.happiness >= 80) happinessEmoji = 'ðŸ˜';
            else if (gameState.happiness >= 60) happinessEmoji = 'ðŸ˜Š';
            else if (gameState.happiness < 40) happinessEmoji = 'ðŸ˜’';
            else if (gameState.happiness < 25) happinessEmoji = 'ðŸ˜«';
            happinessStat.textContent = happinessEmoji;
          }
        };

        // Helper: clamp value between min and max
        function clamp(val, min, max) {
          return Math.min(max, Math.max(min, val));
        }

        // Helper: read starting age (supports multiple selectors)
        function readStartingAgeFromUI() {
          const el = document.querySelector(
            '#startAge, #starting-age, select[name="startingAge"], input[name="startingAge"]:checked'
          );
          if (!el) return 18;
          const val = parseInt(el.value, 10);
          if (Number.isNaN(val) || val < 16 || val > 65) return 18;
          return val;
        }

        // Helper: read savings rate from UI
        function readSavingsRateFromUI() {
          const radios = document.querySelectorAll('input[name="savingsRate"]');
          for (const r of radios) {
            if (r.checked) {
              const val = parseFloat(r.value);
              if (!isNaN(val)) {
                return val;
              }
            }
          }
          return 0.2; // default 20%
        }

        // Phase 4: New money flow per year (Option B tuned)
        function applyYearEconomy() {
          const salary = Object.values(gameState.salaryBreakdown).reduce(
            (sum, item) => sum + item.amount,
            0
          );
          const savingsRate = gameState.savingsRate || 0.2;

          // Step 1: calculate savings for the year
          const yearSavings = Math.max(0, salary * savingsRate);
          gameState.savingsBalance += yearSavings;

          // Money left to cover everything else
          let spendingMoney = Math.max(0, salary - yearSavings);

          // Step 2: calculate essential expenses as % of salary
          const housingPct =
            gameState.lifestyleLevel === 'high'
              ? 0.3
              : gameState.lifestyleLevel === 'downgraded_home'
              ? 0.05
              : 0.22; // normal
          const foodTransportPct =
            gameState.lifestyleLevel === 'high'
              ? 0.18
              : gameState.lifestyleLevel === 'downgraded_home'
              ? 0.08
              : 0.12;

          const housingCost =
            salary * housingPct + (gameState.rentIncrease || 0);
          const foodTransportCost = salary * foodTransportPct;
          const essentialCosts = housingCost + foodTransportCost;

          // Step 3: debt interest (4% annual for Option B)
          const interestRate = 0.04;
          const interest =
            gameState.debt > 0 ? gameState.debt * interestRate : 0;
          gameState.debt += interest;

          // Step 4: pay essentials and interest from spendingMoney
          let totalCosts = essentialCosts + interest;
          spendingMoney -= totalCosts;

          // Step 5: lifestyle budget = whatever is left after essentials + interest
          const lifestyleBudget = Math.max(0, spendingMoney);

          // Track cash as net liquid cash change
          gameState.cash += lifestyleBudget;

          // If spending money went negative, it becomes debt
          if (spendingMoney < 0) {
            gameState.debt += Math.abs(spendingMoney);
          }

          // Apply happiness adjustments based on savings and lifestyle
          applyHappinessChanges(savingsRate, lifestyleBudget, salary);

          // Check for potential lifestyle downgrade if things are too tight
          enforceDowngradesIfNeeded(lifestyleBudget);
        }

        // Phase 5: Happiness system
        function applyHappinessChanges(savingsRate, lifestyleBudget, salary) {
          let delta = 0;

          // Savings rate happiness
          if (savingsRate <= 0.1) delta += 2; // comfort spender
          else if (savingsRate <= 0.2) delta += 0; // balanced
          else if (savingsRate <= 0.3) delta += 1; // disciplined
          else if (savingsRate <= 0.4) delta -= 2; // feels restrictive
          else delta -= 4; // extreme saver

          // Lifestyle budget happiness, relative to salary
          const budgetRatio = salary > 0 ? lifestyleBudget / salary : 0;
          if (budgetRatio < 0.1) delta -= 4;
          else if (budgetRatio > 0.25) delta += 3;

          // Apply downgrade penalty (small ongoing stress if downgraded)
          if (gameState.lifestyleLevel === 'downgraded_home') {
            delta -= 1;
          }

          gameState.happiness = clamp(
            (gameState.happiness || 70) + delta,
            0,
            100
          );
        }

        // Phase 6: Forced lifestyle downgrades
        function enforceDowngradesIfNeeded(lifestyleBudget) {
          const debt = gameState.debt || 0;
          const cash = gameState.cash || 0;

          // Reset downgrade flag
          gameState.justDowngraded = false;

          // Lose car example
          if (
            !gameState.lostCar &&
            gameState.lifestyleLevel !== 'downgraded_home' &&
            lifestyleBudget < 1500 &&
            debt > 8000 &&
            cash < 1000
          ) {
            gameState.lostCar = true;
            gameState.lifestyleLevel = 'low';
            showGameMessage(
              'ðŸš—ðŸ’” Your car was repossessed because you fell behind on payments. Transportation just got harder.'
            );
            gameState.happiness = clamp(gameState.happiness - 6, 0, 100);
            gameState.justDowngraded = true;
            return;
          }

          // Move back home example (bigger downgrade)
          if (
            gameState.lifestyleLevel !== 'downgraded_home' &&
            lifestyleBudget < 2000 &&
            debt > 15000 &&
            cash < 3000
          ) {
            gameState.lifestyleLevel = 'downgraded_home';
            gameState.forcedDowngradeCount =
              (gameState.forcedDowngradeCount || 0) + 1;
            showGameMessage(
              'ðŸ ðŸ˜” Things got too tight. You moved back home with family to cut costs.'
            );
            gameState.happiness = clamp(gameState.happiness - 10, 0, 100);
            gameState.justDowngraded = true;
          }
        }

        // Helper: show game message
        function showGameMessage(text) {
          // Reuse existing event modal for messages
          eventText.textContent = text;
          eventModal.classList.remove('hidden');
          eventModal.style.display = 'flex';
          setTimeout(() => {
            eventModal.classList.remove('opacity-0', 'scale-95');
          }, 10);

          setTimeout(() => {
            eventModal.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
              eventModal.classList.add('hidden');
              eventModal.style.display = 'none';
            }, 300);
          }, 3000);
        }

        const runTimeSkipUpdate = (years) => {
          if (!years) return;

          // Read savings rate from UI before processing years
          gameState.savingsRate = readSavingsRateFromUI();

          for (let i = 0; i < years; i++) {
            // Creator career volatility (reduced from extreme values)
            if (
              gameState.careerType === 'creator' &&
              gameState.salaryBreakdown.main_job
            ) {
              const baseAmount = 35000 + gameState.careerLevel * 4000;
              const variance = Math.random() > 0.65 ? 1.4 : 0.7;
              gameState.salaryBreakdown.main_job.amount = Math.round(
                baseAmount * variance
              );
            }

            // Apply new economy system
            applyYearEconomy();

            // Modest inflation on fixed expenses
            const inflationRate = 0.02;
            Object.keys(gameState.expenseBreakdown).forEach((key) => {
              if (key !== 'student_loan' && !key.startsWith('loan_'))
                gameState.expenseBreakdown[key].amount *= 1 + inflationRate;
            });

            // Market fluctuation for equity (smaller)
            const marketFluctuation = (Math.random() - 0.48) / 12;
            gameState.equity *= 1 + marketFluctuation;

            // Investment returns (more conservative)
            if (gameState.cash > 0 && gameState.investment_multiplier > 1.0) {
              let investedAmount = gameState.cash * 0.3;
              let investmentReturn =
                investedAmount * (gameState.investment_multiplier - 1) * 0.5;
              if (Math.random() < gameState.investment_risk) {
                gameState.cash -= investmentReturn * 1.5;
              } else {
                gameState.cash += investmentReturn;
              }
            }

            // Retirement growth (more modest)
            if (gameState.retirement > 0) {
              gameState.retirement *= 1.06;
            }

            // Credit score updates
            if (
              gameState.cash > 0 &&
              Object.keys(gameState.expenseBreakdown).some((k) =>
                k.includes('loan')
              )
            ) {
              updateCreditScore(2);
            } else if (gameState.cash < 0) {
              updateCreditScore(-3);
            }

            gameState.currentAge++;
            if (window.playerState)
              window.playerState.age = gameState.currentAge;
            gameState.currentYear++;
            gameState.children.forEach((child) => child.age++);
          }

          if (gameState.burnout >= 25) {
            triggerBurnoutEvent();
            gameState.burnout = 0;
          }
        };

        const displayQuestion = () => {
          if (currentQuestionIndex > 0) {
            const prevStage = filteredGameData[currentQuestionIndex - 1];
            runTimeSkipUpdate(prevStage.time_skip);
          }
          filterGameStages();
          updateAvatar();
          updateTimeline();
          updateSummaryPanel();
          updateFinancialsUI();

          if (currentQuestionIndex < filteredGameData.length) {
            const stage = filteredGameData[currentQuestionIndex];
            questionText.textContent = stage.question;
            answersContainer.innerHTML = '';

            if (stage.back) {
              backButton.classList.remove('hidden');
            } else {
              backButton.classList.add('hidden');
            }

            stage.answers.forEach((answer) => {
              const button = document.createElement('button');

              button.className =
                'w-full text-left p-4 rounded-lg bg-slate-100 hover:bg-indigo-100 hover:ring-2 hover:ring-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200';
              button.addEventListener('click', () => {
                showConfirmation(answer.effects);
              });

              const answerTextEl = document.createElement('span');
              answerTextEl.className = 'answer-text font-semibold';
              answerTextEl.textContent = answer.text;
              const consequenceText = document.createElement('span');
              consequenceText.className = 'answer-consequence';
              consequenceText.textContent = answer.consequence;
              button.appendChild(answerTextEl);
              button.appendChild(consequenceText);
              answersContainer.appendChild(button);
            });

            if (stage.question.includes('How do you handle your finances?')) {
              if (gameState.cash < 2000) {
                answersContainer
                  .querySelectorAll('button')
                  .forEach((button) => {
                    button.disabled = true;
                    button.classList.add('cursor-not-allowed', 'text-gray-400');
                  });
                const noInvest = document.createElement('p');
                noInvest.className = 'md:col-span-2 text-center text-slate-500';
                noInvest.textContent =
                  'You need at least $2,000 cash to start investing.';
                answersContainer.appendChild(noInvest);
              }
            }

            updateProgressBar();
          } else {
            showResult();
          }
        };

        const showConfirmation = (effects) => {
          currentEffects = effects;
          const effectsContainer = document.getElementById(
            'confirmation-effects'
          );
          effectsContainer.innerHTML = '';

          const addEffectToList = (label, value, color = 'text-slate-800') => {
            const p = document.createElement('p');
            p.className = `flex justify-between ${color}`;
            p.innerHTML = `<span>${label}:</span><span class="font-bold">${value}</span>`;
            effectsContainer.appendChild(p);
          };

          if (effects.cash_change && typeof effects.cash_change === 'number')
            addEffectToList(
              'Cash',
              `${
                effects.cash_change > 0 ? '+' : ''
              }$${effects.cash_change.toLocaleString()}`,
              effects.cash_change > 0 ? 'text-green-600' : 'text-red-600'
            );
          if (effects.expense_add)
            addEffectToList(
              'Annual Expenses',
              `+$${effects.expense_add.amount.toLocaleString()}`,
              'text-red-600'
            );
          if (effects.salary_add)
            addEffectToList(
              'Annual Salary',
              `+$${effects.salary_add.amount.toLocaleString()}`,
              'text-green-600'
            );

          let happinessChange = effects.happiness || 0;
          if (effects.personality_match) {
            if (effects.personality_match === gameState.personality) {
              happinessChange *= 1.5;
            } else {
              happinessChange *= 0.5;
            }
          }
          happinessChange = Math.round(happinessChange);
          if (happinessChange !== 0)
            addEffectToList(
              'Happiness',
              `${happinessChange > 0 ? '+' : ''}${happinessChange}`,
              happinessChange > 0 ? 'text-green-600' : 'text-red-600'
            );

          if (effectsContainer.innerHTML === '') {
            const p = document.createElement('p');
            p.className = `text-slate-600`;
            p.textContent = 'No immediate financial or happiness changes.';
            effectsContainer.appendChild(p);
          }

          confirmationModal.classList.remove('hidden');
          setTimeout(
            () => confirmationModal.classList.remove('opacity-0', 'scale-95'),
            10
          );
        };

        const hideConfirmationModal = () => {
          confirmationModal.classList.add('opacity-0', 'scale-95');
          setTimeout(() => confirmationModal.classList.add('hidden'), 300);
        };

        const confirmAndProceed = () => {
          hideConfirmationModal();
          let cost = 0;
          if (currentEffects.cash_change && currentEffects.cash_change < 0) {
            cost = Math.abs(currentEffects.cash_change);
          }
          if (cost > 0 && gameState.cash < cost) {
            promptForDebt(cost, currentEffects);
          } else {
            selectAnswer(currentEffects);
          }
        };

        const promptForDebt = (cost, effects) => {
          const debtAmount = cost - gameState.cash;
          const debtButtons = document.getElementById('debt-buttons');
          const debtTitle = document.getElementById('debt-title');

          if (gameState.creditScore < 580) {
            // Poor credit
            document.getElementById(
              'debt-description'
            ).textContent = `You are short $${debtAmount.toLocaleString()}. Unfortunately, with a poor credit score of ${
              gameState.creditScore
            }, your loan application was denied.`;
            debtButtons.classList.add('hidden');
            debtTitle.textContent = 'Loan Denied';
          } else {
            debtButtons.classList.remove('hidden');
            debtTitle.textContent = 'Unaffordable Choice';
            let interestRate = 0.25; // Fair credit
            if (gameState.creditScore >= 670) interestRate = 0.2; // Good
            if (gameState.creditScore >= 740) interestRate = 0.15; // Very Good/Excellent

            const debtPayment = Math.round(debtAmount * interestRate);
            document.getElementById(
              'debt-description'
            ).textContent = `You are short $${debtAmount.toLocaleString()}. Based on your credit score, you can take a high-interest personal loan. This will add $${debtPayment.toLocaleString()}/yr to your expenses and cause significant stress.`;

            const takeDebtButton = document.getElementById('take-debt-button');

            const takeDebtHandler = () => {
              const loanEffects = {
                cash_change: debtAmount,
                expense_add: {
                  id: `loan_${Math.random()}`,
                  label: 'Personal Loan',
                  amount: debtPayment,
                },
                happiness: -20,
                creditScore_change: -50,
              };
              const finalEffects = {
                ...effects,
                ...loanEffects,
                cash_change: (effects.cash_change || 0) + debtAmount,
              };
              selectAnswer(finalEffects);
              hideDebtModal();
            };
            takeDebtButton.onclick = takeDebtHandler;
          }

          debtModal.classList.remove('hidden');
          setTimeout(
            () => debtModal.classList.remove('opacity-0', 'scale-95'),
            10
          );
        };

        const hideDebtModal = () => {
          debtModal.classList.add('opacity-0', 'scale-95');
          setTimeout(() => debtModal.classList.add('hidden'), 300);
        };

        const updateCreditScore = (change) => {
          gameState.creditScore += change;
          if (gameState.creditScore > 850) gameState.creditScore = 850;
          if (gameState.creditScore < 300) gameState.creditScore = 300;
        };

        const applyEffects = (effects) => {
          if (!effects) return;

          let happinessChange = effects.happiness || 0;
          if (effects.personality_match) {
            if (effects.personality_match === gameState.personality) {
              happinessChange *= 1.5;
            } else {
              happinessChange *= 0.5;
            }
          }
          gameState.happiness += Math.round(happinessChange);

          if (effects.special_effect === 'add_child') {
            const childNum = gameState.children.length + 1;
            gameState.expenseBreakdown[`child${childNum}`] = {
              label: `Child ${childNum} Costs`,
              amount: 18000,
            };
            gameState.children.push({ age: 0 });
          }
          if (effects.special_effect === 'start_401k') {
            const totalSalary = Object.values(gameState.salaryBreakdown).reduce(
              (sum, item) => sum + item.amount,
              0
            );
            const contribution = totalSalary * effects.rate;
            gameState.expenseBreakdown['401k'] = {
              label: '401k Contribution',
              amount: contribution,
            };
            gameState.retirement += contribution;
            if (effects.special_effect === 'tech_adaptation') {
              // +6% salary raise for adapting to technology
              if (gameState.salaryBreakdown['main_job']) {
                const currentSalary =
                  gameState.salaryBreakdown['main_job'].amount;
                gameState.salaryBreakdown['main_job'].amount = Math.round(
                  currentSalary * 1.06
                );
              }
            }
            if (effects.special_effect === 'major_promotion') {
              // +6% salary raise for mid-career promotion
              if (gameState.salaryBreakdown['main_job']) {
                const currentSalary =
                  gameState.salaryBreakdown['main_job'].amount;
                gameState.salaryBreakdown['main_job'].amount = Math.round(
                  currentSalary * 1.06
                );
              }
            }
            if (effects.special_effect === 'downshift_career') {
              // -15% salary reduction for less stressful job
              if (gameState.salaryBreakdown['main_job']) {
                const currentSalary =
                  gameState.salaryBreakdown['main_job'].amount;
                gameState.salaryBreakdown['main_job'].amount = Math.round(
                  currentSalary * 0.85
                );
                if (effects.special_effect === 'health_reduction') {
                  // -15% salary reduction for health-related part-time shift
                  if (effects.special_effect === 'minor_promotion') {
                    // +5% salary raise for unexpected minor promotion
                    if (gameState.salaryBreakdown['main_job']) {
                      const currentSalary =
                        gameState.salaryBreakdown['main_job'].amount;
                      gameState.salaryBreakdown['main_job'].amount = Math.round(
                        currentSalary * 1.05
                      );
                      if (effects.special_effect === 'career_focus') {
                        // +8% salary raise for focusing on career over social life
                        if (gameState.salaryBreakdown['main_job']) {
                          const currentSalary =
                            gameState.salaryBreakdown['main_job'].amount;
                          gameState.salaryBreakdown['main_job'].amount =
                            Math.round(currentSalary * 1.08);
                        }
                      }
                      if (effects.special_effect === 'skill_premium') {
                        // +7% salary raise when skills become more valuable
                        if (gameState.salaryBreakdown['main_job']) {
                          const currentSalary =
                            gameState.salaryBreakdown['main_job'].amount;
                          gameState.salaryBreakdown['main_job'].amount =
                            Math.round(currentSalary * 1.07);
                        }
                      }
                    }
                  }
                  if (gameState.salaryBreakdown['main_job']) {
                    const currentSalary =
                      gameState.salaryBreakdown['main_job'].amount;
                    gameState.salaryBreakdown['main_job'].amount = Math.round(
                      currentSalary * 0.85
                    );
                  }
                }
              }
            }
          }

          if (effects.cash_change)
            gameState.cash +=
              typeof effects.cash_change === 'function'
                ? effects.cash_change(gameState.cash)
                : effects.cash_change;
          if (effects.equity_change)
            gameState.equity +=
              typeof effects.equity_change === 'function'
                ? effects.equity_change(gameState.equity)
                : effects.equity_change;
          if (effects.set_investment_multiplier)
            gameState.investment_multiplier = effects.set_investment_multiplier;
          if (effects.set_investment_risk)
            gameState.investment_risk = effects.set_investment_risk;

          if (effects.salary_add)
            gameState.salaryBreakdown[effects.salary_add.id] = {
              label: effects.salary_add.label,
              amount: effects.salary_add.amount,
            };
          if (effects.salary_remove) {
            const ids = Array.isArray(effects.salary_remove)
              ? effects.salary_remove
              : [effects.salary_remove];
            ids.forEach((id) => {
              if (gameState.salaryBreakdown[id]) {
                delete gameState.salaryBreakdown[id];
              }
            });
          }
          if (
            effects.salary_boost &&
            gameState.salaryBreakdown[effects.salary_boost.id]
          )
            gameState.salaryBreakdown[effects.salary_boost.id].amount +=
              effects.salary_boost.amount;

          if (effects.expense_add)
            gameState.expenseBreakdown[effects.expense_add.id] = {
              label: effects.expense_add.label,
              amount: effects.expense_add.amount,
            };
          if (
            effects.expense_remove &&
            gameState.expenseBreakdown[effects.expense_remove]
          )
            delete gameState.expenseBreakdown[effects.expense_remove];
          if (
            effects.expense_boost &&
            gameState.expenseBreakdown[effects.expense_boost.id]
          )
            gameState.expenseBreakdown[effects.expense_boost.id].amount +=
              effects.expense_boost.amount;
          if (effects.expense_boost_all) {
            for (const key in gameState.expenseBreakdown) {
              gameState.expenseBreakdown[key].amount *=
                1 + effects.expense_boost_all;
            }
          }
          if (effects.retirement_change)
            gameState.retirement += effects.retirement_change;
          if (effects.career_level_change)
            gameState.careerLevel += effects.career_level_change;
          if (effects.burnout_change)
            gameState.burnout += effects.burnout_change;
          if (effects.creditScore_change)
            updateCreditScore(effects.creditScore_change);

          if (effects.children_add) {
            for (let i = 0; i < effects.children_add; i++) {
              gameState.children.push({ age: 0 });
            }
          }
          // Economy extensions
          if (effects.debt_change) {
            gameState.debt += effects.debt_change;
            if (gameState.debt < 0) gameState.debt = 0;
          }
          if (effects.set_lifestyle_level) {
            gameState.lifestyleLevel = effects.set_lifestyle_level;
          }
          // New salary percentage special effects
          const boostMainSalaryBy = (pct) => {
            if (gameState.salaryBreakdown.main_job) {
              const cur = gameState.salaryBreakdown.main_job.amount;
              gameState.salaryBreakdown.main_job.amount = Math.round(
                cur * (1 + pct)
              );
            }
          };
          switch (effects.special_effect) {
            case 'early_part_time_job':
              boostMainSalaryBy(0.02);
              gameState.happiness = clamp(gameState.happiness - 2, 0, 100);
              break;
            case 'early_focus_school':
              gameState.happiness = clamp(gameState.happiness + 5, 0, 100);
              break;
            case 'move_out_family':
              gameState.lifestyleLevel = 'normal';
              gameState.happiness = clamp(gameState.happiness + 4, 0, 100);
              break;
            case 'stay_with_family':
              gameState.lifestyleLevel = 'low';
              gameState.happiness = clamp(gameState.happiness - 3, 0, 100);
              break;
            case 'community_college':
              boostMainSalaryBy(0.04);
              gameState.happiness = clamp(gameState.happiness - 2, 0, 100);
              break;
            case 'four_year_college':
              boostMainSalaryBy(0.06);
              gameState.happiness = clamp(gameState.happiness - 4, 0, 100);
              break;
            case 'upgrade_apartment':
              gameState.lifestyleLevel = 'high';
              gameState.happiness = clamp(gameState.happiness + 6, 0, 100);
              break;
            case 'keep_apartment':
              gameState.happiness = clamp(gameState.happiness + 1, 0, 100);
              break;
            case 'buy_used_car':
              gameState.happiness = clamp(gameState.happiness + 4, 0, 100);
              break;
            case 'keep_public_transport':
              gameState.happiness = clamp(gameState.happiness - 2, 0, 100);
              break;
            case 'side_hustle':
              boostMainSalaryBy(0.04);
              gameState.happiness = clamp(gameState.happiness - 3, 0, 100);
              break;
            case 'more_leisure':
              gameState.happiness = clamp(gameState.happiness + 8, 0, 100);
              break;
            case 'pay_down_debt_aggressive':
              gameState.happiness = clamp(gameState.happiness - 2, 0, 100);
              break;
            case 'help_family_financially':
              gameState.happiness = clamp(gameState.happiness + 6, 0, 100);
              break;
          }
          if (effects.housing_type)
            gameState.housingType = effects.housing_type;
          if (effects.career_type) gameState.careerType = effects.career_type;
          if (effects.sector) gameState.sector = effects.sector;
          if (effects.avatar)
            gameState.avatar[effects.avatar.type] = effects.avatar.icon;
          if (effects.add_qualification)
            gameState.qualifications.push(effects.add_qualification);
        };

        const selectAnswer = (effects) => {
          applyEffects(effects);
          currentQuestionIndex++;

          // Phase 7: Rarer but meaningful events
          const majorEventChance = 0.05; // reduced from 0.15
          const minorEventChance = 0.1; // reduced from 0.2
          const childEventChance = 0.15; // reduced from 0.25

          if (gameState.careerType) {
            // Skip events if just downgraded
            if (gameState.justDowngraded) {
              continueToNextQuestion();
            } else if (
              gameState.children.length > 0 &&
              Math.random() < childEventChance
            ) {
              triggerChildEvent();
            } else if (
              Math.random() < majorEventChance &&
              currentQuestionIndex < filteredGameData.length - 2 &&
              currentQuestionIndex > 2
            ) {
              triggerMajorEvent();
            } else if (
              Math.random() < minorEventChance &&
              currentQuestionIndex < filteredGameData.length
            ) {
              triggerMinorEvent();
            } else {
              continueToNextQuestion();
            }
          } else {
            continueToNextQuestion();
          }
        };

        const goBack = () => {
          gameState.sector = null;
          currentQuestionIndex = 0;
          continueToNextQuestion();
        };

        const continueToNextQuestion = () => {
          quizScreen.classList.remove('fade-in');
          void quizScreen.offsetWidth;
          quizScreen.classList.add('fade-in');
          displayQuestion();
        };

        const triggerMinorEvent = () => {
          const event =
            minorEvents[Math.floor(Math.random() * minorEvents.length)];
          applyEffects(event.effects);
          eventText.textContent = event.description;

          eventModal.classList.remove('hidden');
          eventModal.style.display = 'flex';
          setTimeout(() => {
            eventModal.classList.remove('opacity-0', 'scale-95');
          }, 10);

          setTimeout(() => {
            eventModal.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
              eventModal.classList.add('hidden');
              eventModal.style.display = 'none';
              continueToNextQuestion();
            }, 300);
          }, 3000);
        };

        const triggerChildEvent = () => {
          const event =
            childEvents[Math.floor(Math.random() * childEvents.length)];
          applyEffects(event.effects);
          eventText.textContent = `A Child Event: ${event.description}`;

          eventModal.classList.remove('hidden');
          eventModal.style.display = 'flex';
          setTimeout(() => {
            eventModal.classList.remove('opacity-0', 'scale-95');
          }, 10);

          setTimeout(() => {
            eventModal.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
              eventModal.classList.add('hidden');
              eventModal.style.display = 'none';
              continueToNextQuestion();
            }, 300);
          }, 3000);
        };

        const triggerBurnoutEvent = () => {
          eventText.textContent =
            "You've pushed yourself too hard and burned out! You're forced to take a lower-stress, lower-paying job to recover.";
          applyEffects({
            salary_remove: 'main_job',
            salary_add: {
              id: 'main_job',
              label: 'Recovery Job',
              amount: 40000,
            },
            happiness: -20,
            salary_remove: 'side_hustle',
          });

          eventModal.classList.remove('hidden');
          eventModal.style.display = 'flex';
          setTimeout(() => {
            eventModal.classList.remove('opacity-0', 'scale-95');
          }, 10);

          setTimeout(() => {
            eventModal.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
              eventModal.classList.add('hidden');
              eventModal.style.display = 'none';
              continueToNextQuestion();
            }, 300);
          }, 3500);
        };

        const triggerMajorEvent = () => {
          const event =
            majorEvents[Math.floor(Math.random() * majorEvents.length)];
          majorEventDescription.textContent = event.description;
          majorEventQuestion.textContent = event.question;
          majorEventChoices.innerHTML = '';

          event.choices.forEach((choice) => {
            const button = document.createElement('button');
            button.className =
              'w-full text-left p-3 rounded-lg bg-slate-200 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-red-500 transition-all duration-200';

            const answerTextEl = document.createElement('span');
            answerTextEl.className = 'answer-text font-semibold';
            answerTextEl.textContent = choice.text;

            const consequenceText = document.createElement('span');
            consequenceText.className = 'answer-consequence text-slate-600';
            consequenceText.textContent = choice.consequence;

            button.appendChild(answerTextEl);
            button.appendChild(consequenceText);
            button.addEventListener('click', () =>
              resolveMajorEvent(choice.effects)
            );
            majorEventChoices.appendChild(button);
          });

          majorEventModal.classList.remove('hidden');
          majorEventModal.style.display = 'flex';
          setTimeout(() => {
            majorEventModal.classList.remove('opacity-0', 'scale-95');
          }, 10);
        };

        const resolveMajorEvent = (effects) => {
          applyEffects(effects);
          majorEventModal.classList.add('opacity-0', 'scale-95');
          setTimeout(() => {
            majorEventModal.classList.add('hidden');
            majorEventModal.style.display = 'none';
            continueToNextQuestion();
          }, 300);
        };

        const updateProgressBar = () => {
          progressBar.style.width = `${
            (filteredGameData.indexOf(filteredGameData[currentQuestionIndex]) /
              filteredGameData.length) *
            100
          }%`;
        };

        const showResult = () => {
          // Simplified final stats (Life Journey disabled)
          let finalNetWorth = Math.round(
            gameState.cash + gameState.equity + gameState.retirement
          );
          updateFinancialsUI();
          resultScreen.classList.remove('hidden');
          quizScreen.classList.add('hidden');
          const finalHappiness = gameState.happiness;
          const finalAge = window.playerState?.age ?? gameState.currentAge;
          const totalSalary = Object.values(gameState.salaryBreakdown).reduce(
            (s, i) => s + i.amount,
            0
          );

          const summaryHTML = `
            <div class="text-left space-y-2">
              <p><strong>Age:</strong> ${finalAge}</p>
              <p><strong>Final Net Worth:</strong> $${finalNetWorth.toLocaleString()}</p>
              <p><strong>Final Happiness:</strong> ${finalHappiness}</p>
              <p><strong>Annual Salary:</strong> $${Math.round(
                totalSalary
              ).toLocaleString()}</p>
              <p><strong>Savings Balance:</strong> $${Math.round(
                gameState.savingsBalance || 0
              ).toLocaleString()}</p>
              <p><strong>Debt:</strong> $${Math.round(
                gameState.debt || 0
              ).toLocaleString()}</p>
            </div>`;
          document.getElementById('result-description').innerHTML = summaryHTML;
          const stageSummary = `
            <div class="mt-6 bg-white rounded-xl shadow p-4">
              <h3 class="text-lg font-semibold mb-2">Your Key Choices</h3>
              <ul class="list-disc list-inside text-slate-700">
                <li>Sector: ${gameState.sector || 'â€”'}</li>
                <li>First Profession: ${
                  gameState.salaryBreakdown.main_job?.label || 'â€”'
                }</li>
                <li>Housing Path: ${
                  gameState.housingType ||
                  (window.lifeSimPlayer?.owns_home
                    ? 'Own'
                    : 'Rent / Not chosen')
                }</li>
                <li>Investing Style: ${
                  gameState.investment_multiplier > 1.2
                    ? 'High Risk'
                    : gameState.investment_multiplier > 1.05
                    ? 'Index / Balanced'
                    : 'None'
                }</li>
              </ul>
            </div>
          `;

          document.getElementById('result-description').innerHTML =
            description + personalitySummary + stageSummary;
        };

        document
          .getElementById('start-button')
          .addEventListener('click', startQuiz);
        document
          .getElementById('salary-breakdown-button')
          .addEventListener('click', () => showBreakdown('salary'));
        document
          .getElementById('expenses-breakdown-button')
          .addEventListener('click', () => showBreakdown('expenses'));
        document
          .getElementById('hide-breakdown-button')
          .addEventListener('click', hideBreakdown);
        document
          .getElementById('cancel-debt-button')
          .addEventListener('click', hideDebtModal);
        document
          .getElementById('back-button')
          .addEventListener('click', goBack);
        document
          .getElementById('avatar-button')
          .addEventListener('click', showProfileModal);
        document
          .getElementById('hide-profile-button')
          .addEventListener('click', hideProfileModal);
        document
          .getElementById('change-career-button')
          .addEventListener('click', () => showActionModal('career'));
        document
          .getElementById('change-lifestyle-button')
          .addEventListener('click', () => showActionModal('lifestyle'));
        document
          .getElementById('confirm-choice-button')
          .addEventListener('click', confirmAndProceed);
        document
          .getElementById('cancel-choice-button')
          .addEventListener('click', hideConfirmationModal);

        // ========== STAGE SCHEDULER ==========
        function maybeTriggerStage(clock, player) {
          for (const s of STAGES.stages) {
            if (completedStages.has(s.id)) continue;

            const age = Math.floor(clock.ageMonths / 12);
            const inWindow =
              (s.age_min == null || age >= s.age_min) &&
              (s.age_max == null || age <= s.age_max);
            if (!inWindow) continue;

            // Check stage-level requires
            if (s.requires && s.requires.length > 0) {
              const hasAll = s.requires.every((f) => player.flags?.has(f));
              if (!hasAll) continue;
            }

            // Trigger this stage
            window.lifetimeAutoAdvance = false;
            openStageModal(s);
            return true; // Trigger one stage at a time
          }
          return false;
        }

        function pauseAutoAdvance() {
          window.lifetimeAutoAdvance = false;
        }

        function resumeAutoAdvance() {
          window.lifetimeAutoAdvance = true;
        }

        // ========== STAGE MODAL UI ==========
        function openStageModal(stage) {
          currentStageModal = {
            stage,
            currentQuestionIndex: 0,
            answers: {}, // { questionId: choiceIndex }
          };

          const modal = document.getElementById('stage-modal');
          const titleEl = document.getElementById('stage-title');
          const progressEl = document.getElementById('stage-progress');

          titleEl.textContent = stage.title;
          modal.classList.remove('hidden');
          modal.classList.add('flex');

          showStageQuestion(0);
        }

        function showStageQuestion(qIndex) {
          const stage = currentStageModal.stage;
          const questions = stage.questions;

          if (qIndex >= questions.length) {
            // All questions answered, apply effects and close
            closeStageModal();
            return;
          }

          const question = questions[qIndex];
          currentStageModal.currentQuestionIndex = qIndex;

          const progressEl = document.getElementById('stage-progress');
          const promptEl = document.getElementById('stage-question-prompt');
          const choicesContainer = document.getElementById(
            'stage-choices-container'
          );

          progressEl.textContent = `Question ${qIndex + 1} of ${
            questions.length
          }`;

          // Handle personality type question
          if (question.type === 'personality') {
            promptEl.textContent = question.prompt;
            choicesContainer.innerHTML = `
              <p class="text-slate-600 mb-4">The personality quiz determines your tendencies throughout life.</p>
              <button onclick="startPersonalityQuizInStage()" 
                class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition">
                Take Personality Quiz
              </button>
            `;
            return;
          }

          promptEl.textContent = question.prompt;
          choicesContainer.innerHTML = '';

          const player = window.lifeSimPlayer;

          question.choices.forEach((choice, idx) => {
            const meetsRequires = checkChoiceRequires(
              choice.requires || [],
              player
            );
            const button = document.createElement('button');
            button.className = `p-4 rounded-lg border-2 transition text-left ${
              meetsRequires
                ? 'border-slate-200 hover:border-indigo-500 hover:bg-indigo-50'
                : 'border-slate-100 bg-slate-50 text-slate-400 cursor-not-allowed'
            }`;
            button.disabled = !meetsRequires;

            let html = `<div class="font-semibold text-slate-800">${choice.label}</div>`;

            // Show why unavailable
            if (
              !meetsRequires &&
              choice.requires &&
              choice.requires.length > 0
            ) {
              html += `<div class="text-xs text-red-500 mt-1">Requires: ${choice.requires.join(
                ', '
              )}</div>`;
            }

            // Show effects preview
            const effects = choice.effects || {};
            let effectsPrev = [];
            if (effects.happiness)
              effectsPrev.push(
                `Happiness ${effects.happiness > 0 ? '+' : ''}${
                  effects.happiness
                }`
              );
            if (effects.stress)
              effectsPrev.push(
                `Stress ${effects.stress > 0 ? '+' : ''}${effects.stress}`
              );
            if (effects.loan_add)
              effectsPrev.push(`Loan +$${effects.loan_add}`);
            if (effects.monthly_cost_add)
              effectsPrev.push(`Cost +$${effects.monthly_cost_add}/mo`);
            if (effects.income_add_monthly)
              effectsPrev.push(`Income +$${effects.income_add_monthly}/mo`);
            if (effectsPrev.length > 0) {
              html += `<div class="text-xs text-slate-500 mt-1">${effectsPrev.join(
                ' â€¢ '
              )}</div>`;
            }

            button.innerHTML = html;

            if (meetsRequires) {
              button.onclick = () => selectStageChoice(question, choice, idx);
            }

            choicesContainer.appendChild(button);
          });
        }

        function checkChoiceRequires(requires, player) {
          if (!requires || requires.length === 0) return true;
          return requires.every((r) => {
            if (r === 'owns_home') return player.owns_home === true;
            return player.flags?.has(r);
          });
        }

        function selectStageChoice(question, choice, choiceIndex) {
          // Record choice
          currentStageModal.answers[question.id] = choiceIndex;

          // Log to event history
          const clock = window.lifetimeClock;
          const age = Math.floor(clock.ageMonths / 12);
          stageHistory.push({
            time: `Age ${age}`,
            stageId: currentStageModal.stage.id,
            stageTitle: currentStageModal.stage.title,
            questionId: question.id,
            choiceLabel: choice.label,
          });

          // Apply effects
          applyStageEffects(choice.effects || {});

          // Move to next question
          showStageQuestion(currentStageModal.currentQuestionIndex + 1);
        }

        function closeStageModal() {
          const modal = document.getElementById('stage-modal');
          modal.classList.add('hidden');
          modal.classList.remove('flex');

          // Mark stage complete
          const stageId = currentStageModal.stage.id;
          completedStages.add(stageId);
          currentStageModal = null;

          // Special handling for Stage 1: Start lifetime mode
          if (stageId === 'stage_1_start') {
            startLifetimeMode();
          } else {
            // For other stages: Resume auto-advance
            resumeAutoAdvance();
          }
        }

        // Handle personality quiz within stage
        window.startPersonalityQuizInStage = function () {
          // Close stage modal temporarily
          document.getElementById('stage-modal').classList.add('hidden');

          // Show personality quiz in quiz screen
          quizScreen.classList.remove('hidden');
          personalityQuizIndex = 0;
          showPersonalityQuestion();

          // Set flag to return to stage after personality
          window.returnToStageAfterPersonality = true;
        };

        // ========== STAGE EFFECTS HANDLER ==========
        function applyStageEffects(e) {
          const player = window.lifeSimPlayer;
          const careerState = window.lifeSimCareer;
          const clock = window.lifetimeClock;
          const housing = window.lifetimeHousing;
          const loans = window.lifetimeLoans;
          const eventLog = window.lifetimeEventLog;

          if (!player) return;

          // Flags
          if (e.set_flag && Array.isArray(e.set_flag)) {
            if (!player.flags) player.flags = new Set();
            e.set_flag.forEach((f) => player.flags.add(f));
          }

          // Loans
          if (e.loan_add && e.loan_add > 0) {
            const newLoan = {
              id: `stage_loan_${Date.now()}`,
              principal: e.loan_add,
              balance: e.loan_add,
              apr: 0.06,
              termMonths: 36,
              monthlyPayment: calcMonthlyPayment(e.loan_add, 0.06, 36),
            };
            loans.push(newLoan);
            player.cash += e.loan_add;
            addEventToLog(eventLog, clock, `Took loan: $${e.loan_add}`);
          }

          // Recurring costs
          if (e.monthly_cost_add) {
            if (!player.recurringAdjustments) player.recurringAdjustments = [];
            player.recurringAdjustments.push({
              key: `stage_cost_${Date.now()}`,
              amount: e.monthly_cost_add,
            });
          }

          // Temporary income
          if (e.income_add_monthly) {
            if (!player.tempIncome) player.tempIncome = [];
            player.tempIncome.push({
              key: `stage_income_${Date.now()}`,
              amount: e.income_add_monthly,
              months: 24, // Default 2 years
            });
          }

          // Income multiplier (overtime)
          if (e.income_multiplier) {
            player.incomeMultiplier = e.income_multiplier;
          }

          // Dwelling (rent starts)
          if (e.dwelling) {
            player.dwelling = e.dwelling;
            addEventToLog(eventLog, clock, `Moved to: ${e.dwelling}`);

            // Update shared budget with actual rent cost
            if (costOfLiving && player.region) {
              const regionCfg = costOfLiving.regions[player.region];
              const regionMult = calcRegionMultiplier(player.region);
              const basket = regionCfg.basket;
              const rentKey = `rent_${e.dwelling}`; // e.g., "rent_studio", "rent_1br"
              if (basket[rentKey]) {
                budget.rent = basket[rentKey] * regionMult;
                // Sync budget to gameState.expenseBreakdown for header display
                syncExpenseBreakdownFromBudget();
                // Update UI to reflect new expenses immediately
                if (typeof updateFinancialsUI === 'function') {
                  updateFinancialsUI();
                }
              }
            }
          }

          // Shared expenses (partner)
          if (typeof e.shared_expenses_pct === 'number') {
            player.shared_expenses_pct = e.shared_expenses_pct;
          }

          // Childcare
          if (e.childcare_months && e.childcare_cost) {
            if (!player.childcare) player.childcare = { months: 0, cost: 0 };
            player.childcare.months = e.childcare_months;
            player.childcare.cost = e.childcare_cost;
          }

          // Home purchase attempt
          if (e.home_attempt) {
            attemptHomePurchase(player, housing, loans, eventLog, clock);
          }

          // Refinance attempt
          if (e.refi_attempt && player.owns_home) {
            attemptRefi(player, housing, loans, eventLog, clock);
          }

          // Downsize
          if (e.downsize && player.owns_home) {
            attemptDownsize(player, housing, eventLog, clock);
          }

          // Career set (from catalog)
          if (e.career_set) {
            setCareerFromCatalog(
              e.career_set,
              player,
              careerState,
              eventLog,
              clock
            );
          }

          // Career change (picker)
          if (e.career_change) {
            // Flag for career change - can be handled in next checkpoint
            player.careerChangePending = true;
          }

          // Promotion push
          if (e.promotion_push) {
            player.promotionPush = true;
            if (e.training_cost) {
              player.cash -= e.training_cost;
              addEventToLog(
                eventLog,
                clock,
                `Training cost: $${e.training_cost}`
              );
            }
          }

          // Retraining cost
          if (e.retraining_cost) {
            player.cash -= e.retraining_cost;
            addEventToLog(
              eventLog,
              clock,
              `Retraining cost: $${e.retraining_cost}`
            );
          }

          // Retirement contribution
          if (typeof e.retire_contrib_pct === 'number') {
            player.retireContribPct = e.retire_contrib_pct;
          }

          // Retirement age preference
          if (e.retire_age) {
            clock.retirementAge = e.retire_age;
          }

          // Health risk
          if (e.health_risk_down) {
            player.healthRisk = Math.max(0, (player.healthRisk || 0.1) - 0.05);
          }

          // Annual costs
          if (e.annual_travel_cost) {
            if (!player.recurringAnnual) player.recurringAnnual = {};
            player.recurringAnnual.travel = e.annual_travel_cost;
          }

          // Transport
          if (e.transport) {
            player.transport = e.transport;
          }

          // Happiness & Stress (with personality modifiers)
          adjustHappiness(e.happiness || 0, e.stress || 0, e);
        }

        // Helper: Calculate monthly loan payment
        function calcMonthlyPayment(principal, apr, termMonths) {
          if (termMonths === 0 || apr === 0)
            return principal / (termMonths || 1);
          const r = apr / 12;
          return (
            (principal * r * Math.pow(1 + r, termMonths)) /
            (Math.pow(1 + r, termMonths) - 1)
          );
        }

        // Helper: Home purchase attempt
        function attemptHomePurchase(player, housing, loans, eventLog, clock) {
          // Simplified: Check if player has enough for down payment
          const homePrice = 250000;
          const downPayment = homePrice * 0.2; // 20%

          if (player.cash >= downPayment && player.creditScore >= 620) {
            player.cash -= downPayment;
            player.owns_home = true;
            housing.owned = true; // Mark housing as owned
            housing.homeValue = homePrice;
            housing.mortgage = homePrice - downPayment;
            housing.mortgagePayment = calcMonthlyPayment(
              housing.mortgage,
              0.045,
              360
            );

            // Clear rent from budget since home is now owned
            budget.rent = 0;
            syncExpenseBreakdownFromBudget();
            if (typeof updateFinancialsUI === 'function') {
              updateFinancialsUI();
            }

            addEventToLog(
              eventLog,
              clock,
              `Purchased home for $${homePrice.toLocaleString()}`
            );
          } else {
            addEventToLog(
              eventLog,
              clock,
              `Home purchase denied - insufficient funds or credit`
            );
          }
        }

        // Helper: Refinance attempt
        function attemptRefi(player, housing, loans, eventLog, clock) {
          if (housing.mortgage > 0 && player.creditScore >= 680) {
            const oldPayment = housing.mortgagePayment;
            const remainingMonths = 300; // Assume 25 years left
            housing.mortgagePayment = calcMonthlyPayment(
              housing.mortgage,
              0.035,
              remainingMonths
            );
            const savings = oldPayment - housing.mortgagePayment;

            addEventToLog(
              eventLog,
              clock,
              `Refinanced mortgage, saving $${Math.round(savings)}/mo`
            );
          }
        }

        // Helper: Downsize home
        function attemptDownsize(player, housing, eventLog, clock) {
          if (player.owns_home) {
            const salePrice = housing.homeValue || 250000;
            const equity = salePrice - (housing.mortgage || 0);
            player.cash += equity;

            // Move to smaller rental
            player.owns_home = false;
            player.dwelling = 'studio';
            housing.homeValue = 0;
            housing.mortgage = 0;
            housing.mortgagePayment = 0;

            addEventToLog(
              eventLog,
              clock,
              `Downsized: gained $${Math.round(equity).toLocaleString()} equity`
            );
          }
        }

        // Helper: Set career from catalog
        function setCareerFromCatalog(
          careerId,
          player,
          careerState,
          eventLog,
          clock
        ) {
          // Map career IDs to salary data
          const careerCatalog = {
            hvac_apprentice: {
              title: 'HVAC Apprentice',
              pay: 35000,
              type: 'salary',
            },
            student_pt: {
              title: 'Part-Time Student Worker',
              pay: 15,
              type: 'hourly',
              hours: 20,
            },
            retail_associate: {
              title: 'Retail Associate',
              pay: 16,
              type: 'hourly',
              hours: 40,
            },
          };

          const career = careerCatalog[careerId];
          if (career) {
            careerState.currentTitle = career.title;
            careerState.currentBasePay = career.pay;
            careerState.type = career.type;
            if (career.hours) careerState.hours_per_week = career.hours;

            addEventToLog(eventLog, clock, `Started career: ${career.title}`);
          }
        }

        // Helper: Add event to log
        function addEventToLog(eventLog, clock, message) {
          if (eventLog) {
            eventLog.push({
              age: Math.floor(clock.ageMonths / 12),
              month: clock.ageMonths % 12,
              message,
            });
          }
        }

        // Helper: Adjust happiness with personality modifiers
        function adjustHappiness(baseDelta, stressDelta, effects = {}) {
          const player = window.lifeSimPlayer;
          if (!player) return;

          const p = gameState.personality || player.personality;
          let bonus = 0;

          // Personality bonuses
          if (
            p === 'ambitious' &&
            (effects.promotion_push || player.promotionPush)
          ) {
            bonus += 1;
          }
          if (
            p === 'creative' &&
            (effects.career_change || player.flags?.has('has_pet'))
          ) {
            bonus += 1;
          }
          if (
            p === 'guardian' &&
            (player.dwelling || player.flags?.has('partner'))
          ) {
            bonus += 1;
          }
          if (
            p === 'adventurous' &&
            (effects.annual_travel_cost || effects.career_change)
          ) {
            bonus += 1;
          }

          player.happiness = Math.min(
            100,
            Math.max(0, (player.happiness || 50) + baseDelta + bonus)
          );
          player.stress = Math.min(
            100,
            Math.max(0, (player.stress || 20) + stressDelta)
          );
        }

        // Helper: clamp utility
        function clamp(val, min, max) {
          return Math.min(max, Math.max(min, val));
        }

        // Helper: Get info about next upcoming stage
        function getNextStageInfo(clock, player) {
          const currentAge = Math.floor(clock.ageMonths / 12);

          for (const s of STAGES.stages) {
            if (completedStages.has(s.id)) continue;
            if (s.age_min == null) continue; // Already passed unlocked stages

            if (s.age_min > currentAge) {
              // Check if requirements would be met
              if (s.requires && s.requires.length > 0) {
                const hasAll = s.requires.every((f) => player.flags?.has(f));
                if (!hasAll) continue;
              }
              return s;
            }
          }
          return null;
        }

        // ========== LIFETIME MODE FUNCTIONS ==========
        let lifetimeTickInterval = null;

        function startLifetimeMode() {
          quizScreen.classList.add('hidden');
          document.getElementById('lifetime-screen').classList.remove('hidden');
          document.getElementById('lifetime-screen').classList.add('fade-in');

          // Initialize happiness tracking
          window.lifetimeHappinessHistory = [];
          window.lifetimeLastHappinessYear = null;

          window.lifetimeAutoAdvance = true;
          lifetimeTickInterval = setInterval(lifetimeTick, 100); // 100ms per month
        }

        function lifetimeTick() {
          if (!window.lifetimeAutoAdvance) return;

          const player = window.lifeSimPlayer;
          const careerState = window.lifeSimCareer;
          const clock = window.lifetimeClock;
          const household = window.lifetimeHousehold;
          const housing = window.lifetimeHousing;
          const loans = window.lifetimeLoans;
          const eventLog = window.lifetimeEventLog;
          const retCfg = window.retirementConfig;

          if (!player || !careerState || !clock) return;

          // Advance time
          advanceOneMonth(clock);
          const ageYears = getAgeYears(clock);
          player.ageMonths = clock.ageMonths;

          // Track happiness annually
          if (
            clock.ageMonths % 12 === 0 &&
            ageYears !== window.lifetimeLastHappinessYear
          ) {
            window.lifetimeLastHappinessYear = ageYears;
            window.lifetimeHappinessHistory.push({
              age: ageYears,
              happiness: player.happiness || 50,
            });
          }

          // Check for stage triggers (age-gated decisions)
          if (maybeTriggerStage(clock, player)) {
            return; // Stage modal will resume auto-advance when done
          }

          // Check for checkpoint pause
          if (shouldPauseForCheckpoint(clock, window.lifetimeLastCheckpoint)) {
            window.lifetimeAutoAdvance = false;
            window.lifetimeLastCheckpoint = ageYears;
            showCheckpointModal(ageYears);
            return;
          }

          // Check for retirement
          if (!player.isRetired && isRetirementAge(clock)) {
            player.isRetired = true;
            player.retirementIncome = initRetirementIncome(
              player,
              careerState,
              retCfg
            );
            addEventToLog(eventLog, clock, `Retired at age ${ageYears}!`);
          }

          // Check for end
          if (reachedEnd(clock)) {
            window.lifetimeAutoAdvance = false;
            clearInterval(lifetimeTickInterval);
            showRetirementOutcome();
            return;
          }

          // Monthly simulation logic
          const isEmployed = !player.unemployed;
          const regionCfg = costOfLiving.regions[player.region];
          const regionMult = calcRegionMultiplier(player.region);

          // Income
          let gross = 0;
          if (player.isRetired) {
            const retIncome = player.retirementIncome;
            gross =
              retIncome.social_security +
              retIncome.pension +
              retIncome.withdrawal;
            player.cash += gross - retIncome.health_insurance;
          } else if (player.unemployed) {
            const lastWage =
              careerState.type === 'salary'
                ? careerState.currentBasePay / 12
                : careerState.currentBasePay *
                  careerState.hours_per_week *
                  4.33;
            gross = lastWage * (player.unemploymentBenefit || 0.45);
            player.cash += gross;
            if (player.unemploymentRemaining) {
              player.unemploymentRemaining--;
              if (player.unemploymentRemaining <= 0) player.unemployed = false;
            }
          } else {
            gross =
              careerState.type === 'salary'
                ? careerState.currentBasePay / 12
                : careerState.currentBasePay *
                  careerState.hours_per_week *
                  4.33;
            player.cash += gross * 0.7; // Simplified net (70% take-home)
            player.monthsWorked = (player.monthsWorked || 0) + 1;

            // Raises (only if employed)
            const perfScore = 1.0;
            if (ageYears < 55) {
              const colaRate = (careerState.raise.cola || 0.02) / 12;
              const meritRate =
                ((careerState.raise.merit[0] + careerState.raise.merit[1]) /
                  2 /
                  12) *
                perfScore;
              careerState.currentBasePay *= 1 + colaRate + meritRate;
              careerState.monthsInRole++;
            } else {
              // Plateau: only COLA
              const colaRate = (careerState.raise.cola || 0.02) / 12;
              careerState.currentBasePay *= 1 + colaRate;
            }
          }

          // Household
          advanceHouseholdOneMonth(household);
          const childcareCosts = getActiveChildcareCosts(household);

          // Housing
          if (housing.owned) {
            advanceMortgageOneMonth(housing, 0.03 / 12); // 3% annual appreciation
          }

          // Loans
          const { totalPayment: loanPayment } = advanceLoansOneMonth(loans);

          // Investments
          if (
            isEmployed &&
            !player.isRetired &&
            player.investmentContribution
          ) {
            const contribution = player.investmentContribution || 100;
            player.cash -= contribution;
            const employerMatch = contribution * 0.03; // 3% match
            const totalContribution = contribution + employerMatch;
            player.investments = (player.investments || 0) + totalContribution;

            // Monthly return (simplified)
            const monthlyReturn = retCfg.investment.mean_return / 12;
            player.investments *= 1 + monthlyReturn;
          }

          // Expenses
          let expenses = buildMonthlyExpenses(player, regionCfg, regionMult);
          expenses = applySharedExpenses(expenses, household.partner);
          expenses.childcare = childcareCosts;
          expenses.housing = getMonthlyHousingCost(
            player,
            housing,
            regionCfg.basket,
            regionMult
          );
          expenses.loans = loanPayment;

          const totalExpenses = Object.values(expenses).reduce(
            (a, b) => a + b,
            0
          );
          player.cash -= totalExpenses;

          // Update UI every month
          updateLifetimeUI();

          // Log year-end summary
          if (clock.currentMonth % 12 === 0) {
            console.log(
              `Year ${clock.currentYear}: Age ${ageYears}, Cash $${Math.round(
                player.cash
              )}, Investments $${Math.round(player.investments || 0)}`
            );
          }
        }

        function lifetimeProgressPct(clock) {
          const start = clock.startAgeMonths / 12;
          const end = clock.retirementAge;
          const current = getAgeYears(clock);
          return Math.min(100, ((current - start) / (end - start)) * 100);
        }

        function updateLifetimeUI() {
          const player = window.lifeSimPlayer;
          const clock = window.lifetimeClock;
          const household = window.lifetimeHousehold;
          const housing = window.lifetimeHousing;
          const loans = window.lifetimeLoans;

          if (!player || !clock) return;

          const ageYears = getAgeYears(clock);
          const progress = lifetimeProgressPct(clock);

          document.getElementById('lifetime-age').textContent = ageYears;
          document.getElementById(
            'lifetime-progress'
          ).style.width = `${progress}%`;

          document.getElementById('household-partner').textContent =
            household.partner ? 'Yes' : 'No';
          document.getElementById('household-children').textContent =
            household.children.length;
          document.getElementById(
            'household-childcare'
          ).textContent = `$${Math.round(
            getActiveChildcareCosts(household)
          )}/mo`;

          document.getElementById('lifetime-cash').textContent = `$${Math.round(
            player.cash
          ).toLocaleString()}`;
          document.getElementById(
            'lifetime-investments'
          ).textContent = `$${Math.round(
            player.investments || 0
          ).toLocaleString()}`;
          document.getElementById(
            'lifetime-equity'
          ).textContent = `$${Math.round(
            getHomeEquity(housing)
          ).toLocaleString()}`;

          const loanBalance = getTotalLoanBalance(loans);
          document.getElementById(
            'lifetime-loan-balance'
          ).textContent = `$${Math.round(loanBalance).toLocaleString()}`;

          let totalLoanPayment = 0;
          ['student', 'car', 'personal'].forEach((type) => {
            if (loans[type]) {
              loans[type].forEach((loan) => {
                totalLoanPayment += loan.monthlyPayment;
              });
            }
          });
          document.getElementById(
            'lifetime-loan-payment'
          ).textContent = `$${Math.round(totalLoanPayment)}/mo`;
          document.getElementById('lifetime-mortgage').textContent =
            housing.owned
              ? `$${Math.round(housing.monthlyPayment || 0)}/mo`
              : '$0/mo';
        }

        function showCheckpointModal(age) {
          const player = window.lifeSimPlayer;
          const housing = window.lifetimeHousing;
          const loans = window.lifetimeLoans;
          const careerState = window.lifeSimCareer;
          const clock = window.lifetimeClock;

          const modal = document.getElementById('checkpoint-modal');
          document.getElementById('checkpoint-age').textContent = `Age ${age}`;

          // Calculate next stage trigger
          const nextStageInfo = getNextStageInfo(clock, player);
          if (nextStageInfo) {
            const monthsUntil = (nextStageInfo.age_min - age) * 12;
            if (monthsUntil > 0 && monthsUntil <= 120) {
              // Within 10 years
              const statusText = document.createElement('p');
              statusText.className = 'text-xs text-indigo-500 mt-2';
              statusText.textContent = `Next decision: ${
                nextStageInfo.title
              } (in ~${Math.ceil(monthsUntil)} months)`;
              document.getElementById('checkpoint-age').after(statusText);
            }
          }

          const netWorth =
            player.cash +
            (player.investments || 0) +
            getHomeEquity(housing) -
            getTotalLoanBalance(loans);
          const monthlyIncome =
            careerState.type === 'salary'
              ? careerState.currentBasePay / 12
              : careerState.currentBasePay * careerState.hours_per_week * 4.33;

          document.getElementById(
            'checkpoint-networth'
          ).textContent = `$${Math.round(netWorth).toLocaleString()}`;
          document.getElementById(
            'checkpoint-income'
          ).textContent = `$${Math.round(monthlyIncome).toLocaleString()}/mo`;
          document.getElementById(
            'checkpoint-loans'
          ).textContent = `$${Math.round(
            getTotalLoanBalance(loans)
          ).toLocaleString()}`;
          document.getElementById(
            'checkpoint-equity'
          ).textContent = `$${Math.round(
            getHomeEquity(housing)
          ).toLocaleString()}`;

          // Generate choices
          const choicesEl = document.getElementById('checkpoint-choices');
          choicesEl.innerHTML = '';

          const choices = [
            {
              label: 'Continue as planned',
              description: 'Stay the course with your current strategy.',
              action: () => resumeLifetime(),
            },
          ];

          // Conditional choices
          if (getTotalLoanBalance(loans) > 0 && player.cash > 1000) {
            choices.push({
              label: 'Make extra loan payment ($1,000)',
              description: 'Reduce your highest-interest debt.',
              action: () => {
                player.cash -= 1000;
                // Pay on highest APR loan
                let maxAPR = 0;
                let targetType = null;
                let targetLoan = null;
                ['student', 'car', 'personal'].forEach((type) => {
                  if (loans[type] && loans[type].length > 0) {
                    const loan = loans[type][0];
                    if (loan.apr > maxAPR) {
                      maxAPR = loan.apr;
                      targetType = type;
                      targetLoan = loan;
                    }
                  }
                });
                if (targetLoan) {
                  const payment = Math.min(1000, targetLoan.principal);
                  targetLoan.principal -= payment;
                  addEventToLog(
                    window.lifetimeEventLog,
                    window.lifetimeClock,
                    `Made extra $${payment} payment on ${targetType} loan`
                  );
                }
                resumeLifetime();
              },
            });
          }

          if (!housing.owned && player.cash > 10000 && age < 50) {
            const retCfg = window.retirementConfig;
            const grossIncome = monthlyIncome * 12;
            const homePrice = grossIncome * 3.0; // Conservative estimate
            choices.push({
              label: `Consider buying a home (~$${Math.round(
                homePrice / 1000
              )}k)`,
              description: 'Build equity instead of renting.',
              action: () => {
                const success = purchaseHome(
                  housing,
                  player,
                  homePrice,
                  0.2, // 20% down
                  retCfg.housing_purchase.apr,
                  retCfg.housing_purchase.term_years * 12,
                  retCfg.housing_purchase.closing_cost_pct
                );
                if (success) {
                  addEventToLog(
                    window.lifetimeEventLog,
                    window.lifetimeClock,
                    `Purchased home for $${Math.round(
                      homePrice
                    ).toLocaleString()}`
                  );
                }
                resumeLifetime();
              },
            });
          }

          if (age % 10 === 0 && player.investmentContribution < 500) {
            choices.push({
              label: 'Increase retirement contributions',
              description: 'Boost your monthly investment by $100.',
              action: () => {
                player.investmentContribution =
                  (player.investmentContribution || 100) + 100;
                addEventToLog(
                  window.lifetimeEventLog,
                  window.lifetimeClock,
                  `Increased retirement contributions to $${player.investmentContribution}/mo`
                );
                resumeLifetime();
              },
            });
          }

          choices.forEach((choice) => {
            const btn = document.createElement('button');
            btn.className =
              'w-full text-left p-4 rounded-lg bg-white hover:bg-indigo-50 border-2 border-slate-200 hover:border-indigo-400 transition-all';
            btn.innerHTML = `
              <div class="font-bold text-slate-800 mb-1">${choice.label}</div>
              <div class="text-sm text-slate-600">${choice.description}</div>
            `;
            btn.onclick = choice.action;
            choicesEl.appendChild(btn);
          });

          modal.classList.remove('hidden');
          modal.classList.add('flex');
          setTimeout(() => {
            modal.style.opacity = '1';
            modal.style.transform = 'scale(1)';
          }, 10);
        }

        function resumeLifetime() {
          const modal = document.getElementById('checkpoint-modal');
          modal.style.opacity = '0';
          modal.style.transform = 'scale(0.95)';
          setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
          }, 300);

          window.lifetimeAutoAdvance = true;
        }

        function addEventToLog(eventLog, clock, description) {
          const ageYears = getAgeYears(clock);
          eventLog.history.push({
            month: clock.currentMonth,
            year: clock.currentYear,
            ageYears,
            description,
          });

          // Update UI
          const eventsEl = document.getElementById('lifetime-events');
          const recentEvents = eventLog.history.slice(-10).reverse();
          eventsEl.innerHTML = recentEvents
            .map(
              (e) =>
                `<div class="text-sm"><span class="font-semibold text-indigo-600">Age ${e.ageYears}:</span> ${e.description}</div>`
            )
            .join('');
        }

        function showRetirementOutcome() {
          const player = window.lifeSimPlayer;
          const housing = window.lifetimeHousing;
          const loans = window.lifetimeLoans;
          const clock = window.lifetimeClock;

          const netWorth =
            player.cash +
            (player.investments || 0) +
            getHomeEquity(housing) -
            getTotalLoanBalance(loans);
          const retIncome = player.retirementIncome;
          const monthlyIncome = retIncome
            ? retIncome.social_security +
              retIncome.pension +
              retIncome.withdrawal
            : 0;
          const monthlyExpenses = 3000; // Simplified

          const grade = gradeRetirementOutcome(
            netWorth,
            monthlyIncome,
            monthlyExpenses,
            getAgeYears(clock)
          );

          document.getElementById('lifetime-screen').classList.add('hidden');
          resultScreen.classList.remove('hidden');
          resultScreen.classList.add('fade-in');

          document.getElementById(
            'result-title'
          ).textContent = `Retirement Grade: ${grade}`;

          // Build stage summary HTML
          let stageSummaryHTML = '';
          if (stageHistory.length > 0) {
            stageSummaryHTML = `
              <div class="mt-6 p-4 bg-indigo-50 rounded-lg">
                <h4 class="font-bold text-indigo-900 mb-3">ðŸŽ¯ Your Life Journey - Key Decisions</h4>
                <div class="space-y-2 text-sm">
            `;

            // Group by stage
            const stageMap = {};
            stageHistory.forEach((entry) => {
              if (!stageMap[entry.stageId]) {
                stageMap[entry.stageId] = {
                  title: entry.stageTitle,
                  time: entry.time,
                  choices: [],
                };
              }
              stageMap[entry.stageId].choices.push(entry.choiceLabel);
            });

            Object.values(stageMap).forEach((stage) => {
              stageSummaryHTML += `
                <div class="bg-white p-3 rounded">
                  <p class="font-semibold text-indigo-700">${
                    stage.title
                  } <span class="text-xs text-slate-500">(${
                stage.time
              })</span></p>
                  <ul class="list-disc list-inside text-slate-600 ml-2">
                    ${stage.choices
                      .map((c) => `<li class="text-xs">${c}</li>`)
                      .join('')}
                  </ul>
                </div>
              `;
            });

            stageSummaryHTML += `
                </div>
              </div>
            `;
          }

          // Build happiness curve HTML
          let happinessCurveHTML = '';
          if (
            window.lifetimeHappinessHistory &&
            window.lifetimeHappinessHistory.length > 0
          ) {
            const data = window.lifetimeHappinessHistory;
            const maxVal = Math.max(...data.map((d) => d.happiness));
            const minVal = Math.min(...data.map((d) => d.happiness));
            const range = maxVal - minVal || 1;

            happinessCurveHTML = `
              <div class="mt-6 p-4 bg-purple-50 rounded-lg">
                <h4 class="font-bold text-purple-900 mb-3">ðŸ˜Š Happiness Over Time</h4>
                <div class="relative h-32 bg-white rounded p-2">
                  <svg class="w-full h-full" viewBox="0 0 400 100" preserveAspectRatio="none">
                    <polyline
                      fill="none"
                      stroke="#8b5cf6"
                      stroke-width="2"
                      points="${data
                        .map((d, i) => {
                          const x = (i / (data.length - 1)) * 400;
                          const y = 100 - ((d.happiness - minVal) / range) * 80;
                          return `${x},${y}`;
                        })
                        .join(' ')}"
                    />
                  </svg>
                  <div class="text-xs text-slate-500 mt-1 flex justify-between">
                    <span>Start</span>
                    <span>Average: ${Math.round(
                      data.reduce((sum, d) => sum + d.happiness, 0) /
                        data.length
                    )}</span>
                    <span>End</span>
                  </div>
                </div>
              </div>
            `;
          }

          document.getElementById('result-description').innerHTML = `
            <div class="text-left space-y-2">
              <p><strong>Net Worth:</strong> $${Math.round(
                netWorth
              ).toLocaleString()}</p>
              <p><strong>Monthly Retirement Income:</strong> $${Math.round(
                monthlyIncome
              ).toLocaleString()}</p>
              <p><strong>Social Security:</strong> $${Math.round(
                retIncome.social_security
              ).toLocaleString()}/mo</p>
              <p><strong>Investment Withdrawals:</strong> $${Math.round(
                retIncome.withdrawal
              ).toLocaleString()}/mo</p>
              <p><strong>Income Replacement:</strong> ${Math.round(
                (monthlyIncome / monthlyExpenses) * 100
              )}%</p>
              <p class="mt-4 text-slate-700">${getGradeMessage(grade)}</p>
            </div>
            ${stageSummaryHTML}
            ${happinessCurveHTML}
          `;
        }

        function getGradeMessage(grade) {
          const messages = {
            A: 'Excellent! You built substantial wealth and have a comfortable retirement ahead.',
            B: 'Well done! You have a solid retirement plan with good income replacement.',
            C: 'Not bad! Your retirement is secure, though you may need to be mindful of spending.',
            D: 'Challenging. Your retirement income is tight, and you may need to make adjustments.',
            F: 'Difficult situation. Consider working longer or finding additional income sources.',
          };
          return (
            messages[grade] || 'Your retirement outcome has been calculated.'
          );
        }

        // Pause/Resume buttons
        document
          .getElementById('lifetime-pause')
          .addEventListener('click', () => {
            window.lifetimeAutoAdvance = false;
            document.getElementById('lifetime-pause').classList.add('hidden');
            document
              .getElementById('lifetime-resume')
              .classList.remove('hidden');
          });

        document
          .getElementById('lifetime-resume')
          .addEventListener('click', () => {
            window.lifetimeAutoAdvance = true;
            document.getElementById('lifetime-resume').classList.add('hidden');
            document
              .getElementById('lifetime-pause')
              .classList.remove('hidden');
          });

        // Lifetime Mode button (added dynamically to result screen)
        document.addEventListener('click', (e) => {
          if (e.target && e.target.id === 'start-lifetime-button') {
            resultScreen.classList.add('hidden');

            // Initialize investment contribution if not set
            if (!window.lifeSimPlayer.investmentContribution) {
              window.lifeSimPlayer.investmentContribution = 100; // Default $100/mo
            }

            startLifetimeMode();
          }
        });

        // Expose startLifetimeMode globally for testing
        window.startLifetimeMode = startLifetimeMode;
      });
    </script>
  </body>
</html>
